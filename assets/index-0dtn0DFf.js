const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-YDRpzjTi.js","assets/vendor-WQejLG7Y.js","assets/index-BUY2Cjej.js","assets/index-DudN4ZLF.css"])))=>i.map(i=>d[i]);
import{r as n,aR as rs,S as je,_ as hn,aj as te,ar as tt,ah as z,j as e,ak as Ue,aS as gn,an as Be,am as fn,ac as ce,ad as le,aM as $t,al as Te,aB as xn,aD as rt,ai as Fe,T as lt,aT as gs,c as pt,Y as Pe,ao as ve,aF as Qe,at as yn,aU as fs,B as U,aV as bn,ax as Ms,aW as jn,P as $e,n as us,L as vn,aG as Fs,aA as Lt,ap as ot,aH as Cn,af as Ze,aK as vt,k as Ke,aX as wn,a9 as Re,aY as Wt,aZ as Nn,a6 as Ie,aJ as Le,d as it,a_ as An,a$ as Sn,b0 as Tn,b1 as Os,b2 as In,b3 as Rs,a7 as V,s as kn,b4 as Vs,b5 as En,b6 as os,b7 as Ln,b8 as Gt,b9 as _s,ba as Pn,bb as Dn,bc as Mn,Q as Fn,av as On,aQ as xs,a8 as Rn,W as $s,bd as Us,be as Vn,bf as _n,aO as $n,bg as ct,bh as Un,aq as Bn,R as Bs,bi as Gs,bj as Gn,ag as Yn,bk as Kn,ay as Wn,bl as Hn,ae as qn}from"./vendor-WQejLG7Y.js";import{u as oe,_ as Jn,a as ys,P as zn}from"./useLendingValues-FIBZ4h3R.js";import{g as Qn,a as Yt}from"./asset-psWvgQPY.js";import{d as Ys,g as nt,f as ze,n as W,u as Xe,a as Zn,h as Xn,e as ea}from"./index-BUY2Cjej.js";import{d as Ks}from"./data.service-BjjAEJBf.js";import{p as Q}from"./pool.service-DXigxJcB.js";import{f as Ht,d as Ws,e as ls,E as ta,j as sa}from"./index-YDRpzjTi.js";import{u as Ve}from"./fetchList-Dx9pDj27.js";import{u as na,D as aa}from"./drawdown-Bpn74TcE.js";import{u as at,c as kt}from"./util.service-DGlW4vEA.js";import{N as bs}from"./NoteTokenBadge-BIE4nR0X.js";import{R as ft,a as ie,n as Kt,p as Me,b as js,d as De}from"./app-q0ws3Yx0.js";import{w as ra}from"./web3-KXi-5q2W.js";import{R as oa,A as la,a as ia,f as ca,b as da,c as ua,s as ms,D as ma,C as pa,P as ha,M as ga,d as fa,i as Et,S as Hs,U as xa,e as ya,T as ba,g as ja,u as va,I as Ca,h as vs,j as qs,k as xt,l as Oe,m as wa,F as Na,n as Aa}from"./index.esm-DBiWbtWd.js";import{q as ps}from"./base-CumTa13P.js";import{K as st}from"./KeyValueRow-CBv3cjEJ.js";import{F as X,S as Ne}from"./SelectFromSource-BeAMiId5.js";import{a as Sa,A as Qt}from"./assetStatus-D1v3GkIP.js";import{c as It}from"./company.service-DgXvkGEz.js";import{s as Ut}from"./scorecard.service-xSgAmy6z.js";import{P as Ta,D as Ia,l as ee,e as ka,E as is,a as Bt}from"./pdf-DFr8ztBQ.js";import{M as Js}from"./myDocumentsModal-_TegKspg.js";import{u as zs}from"./useAsyncRetry-CUd0kvgC.js";import{a as Cs}from"./attachment.service-CbFqwko5.js";import{r as Ea,a as Qs,d as ut}from"./debt-order.service-d2JwBDtB.js";import{b as mt}from"./bank.service-B_Z2xVIm.js";import{u as La}from"./useAsync-Dl5FScg5.js";import{t as Pa,a as Da,g as Zs}from"./explorer-BDD-Qifw.js";import{u as Ma}from"./useCopyToClipboard-ChYDdG2_.js";import{S as Fa}from"./index-DvfaoUYF.js";import{I as Pt,a as Oa,b as Ra}from"./investorDrawer-DiX6z8wE.js";import{N as Va}from"./NetworkMismatchAlert-BTQA0hRA.js";import"./AntdIcon-Bh4kV9XY.js";import"./useAsyncFn-DMoxp3xu.js";import"./admin.service-hizXY1il.js";import"./kycProgress-CsJgu1it.js";function Xs({poolContractAddress:t,decimals:s}){const[a,r]=n.useState(void 0),[i,l]=n.useState(!1),o=n.useCallback(async()=>{l(!0);try{const h=await(await Ht(t)).methods.reserve().call();r(h)}catch(p){console.log({e:p})}l(!1)},[t]);n.useEffect(()=>{t&&o()},[o,t]);const c=n.useMemo(()=>{if(!rs(a))return new je(a).dividedBy(new je(10).pow(s)).toString()},[a,s]);return{reserveBalance:a,formattedBalance:c,loading:i}}function _a({poolContractAddress:t,decimals:s}){const[a,r]=n.useState(0),[i,l]=n.useState(!1),o=n.useCallback(async()=>{l(!0);try{if(!t)return 0;const{abi:c}=await hn(async()=>{const{abi:u}=await import("./index-YDRpzjTi.js").then(d=>d.S);return{abi:u}},__vite__mapDeps([0,1,2,3])),h=await new ra.eth.Contract(c,Ys.contracts.SecuritizationPoolValueService).methods.getExpectedAssetsValue(t).call().then(u=>te(tt(u,s),2));r(h)}catch(c){console.log({e:c})}l(!1)},[s,t]);return n.useEffect(()=>{t&&o()},[o,t]),{reserveBalance:a,formattedBalance:a,loading:i}}const $a=(t=[],s=18)=>t.map(a=>({name:a.poolId,date:ca(da(a.dateTimestamp,new Date(a.dateTimestamp).getTimezoneOffset()),"yyyy/MM/dd"),amt:ze(new je(a.poolValue),s)})),Ua=()=>{var I,v,N,C,M,m;const{pool:t,poolData:s}=oe(),[a,r]=n.useState(void 0),i=nt(z(t,"currency.shortCode","")),[l,o]=n.useState([]),{formattedBalance:c}=Xs({poolContractAddress:t.poolContractAddress,decimals:((I=t==null?void 0:t.currency)==null?void 0:I.decimals)||18}),{formattedBalance:p}=_a({poolContractAddress:t.poolContractAddress,decimals:((v=t==null?void 0:t.currency)==null?void 0:v.decimals)||18}),h=async()=>{var b;try{const E=await Q.getPoolValues(t.id);o($a(E,(b=t==null?void 0:t.currency)==null?void 0:b.decimals))}catch{o([])}},u=n.useMemo(()=>z(t,"poolEvents[0]"),[t]),d=n.useMemo(()=>!!z(u,"juniorNotesTokenAddress"),[u]),f=n.useMemo(()=>!!z(u,"notesTokenAddress"),[u]),y=n.useMemo(()=>{var b;if(s.sotTargetAmount||s.jotTargetAmount)return ze(new je(s.sotTargetAmount).plus(s.jotTargetAmount),((b=t==null?void 0:t.currency)==null?void 0:b.decimals)||18)},[(N=t==null?void 0:t.currency)==null?void 0:N.decimals,s.jotTargetAmount,s.sotTargetAmount]);n.useMemo(()=>{var b;if(s.poolValueAssets)return ze(new je(s.poolValueAssets).plus(s.poolReserve),((b=t==null?void 0:t.currency)==null?void 0:b.decimals)||18)},[(C=t==null?void 0:t.currency)==null?void 0:C.decimals,s.poolReserve,s.poolValueAssets]);const g=n.useMemo(()=>{var b;if(s.sotTargetAmount||s.jotTargetAmount)return ze(new je(s.sotTargetAmount).plus(s.jotTargetAmount).minus(new je(s.sotCurrencyRaised).plus(s.jotCurrencyRaised)),((b=t==null?void 0:t.currency)==null?void 0:b.decimals)||18)},[(M=t==null?void 0:t.currency)==null?void 0:M.decimals,s.jotTargetAmount,s.sotTargetAmount,s.totalSupplyOfJOT,s.totalSupplyOfSOT]),x=n.useMemo(()=>Number(t.interestRateSot)/ft||0,[t==null?void 0:t.interestRateSot]);return n.useEffect(()=>{at.getPoolBalance(t).then(b=>{r(b)}),h()},[t]),e.jsx(Ue,{className:"bg-gradient-to-b from-cyan-500 to-green-500 mb-6 border-0 [&>.ant-card-body]:p-0.5 overflow-hidden",children:e.jsxs("div",{className:"bg-gray-50 p-6 rounded-[14px]",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("span",{className:"text-lg font-bold",children:`${t.name??""} `}),e.jsxs("div",{className:"tag-group",children:[d&&e.jsx(bs,{noteType:"Junior"}),f&&e.jsx(bs,{noteType:"Senior"}),"  ",e.jsx("a",{href:`${Ys.explorerUrl}/address/${t==null?void 0:t.poolContractAddress}`,target:"_blank",className:"text-blue-500 underline",rel:"noreferrer",children:e.jsx(gn,{})})]})]}),t.shortDescription&&e.jsx("div",{className:"text-gray-500",children:String(t.shortDescription).length>150?String(t.shortDescription).substring(0,150)+"...":t.shortDescription})]}),e.jsxs("div",{children:[e.jsx("span",{children:"Originated by"}),e.jsx("span",{className:"font-bold ml-1",children:(m=t==null?void 0:t.originatorCompany)==null?void 0:m.companyLegalName})]})]}),e.jsx("hr",{className:"h-px my-4 bg-gray-200 border-0"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:" flex-1 grid grid-cols-4 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col justify-start h-40",children:[e.jsxs("p",{className:"text-gray-500 text-xs m-0",children:["Total Value Locked(",i,")"]}),e.jsx("p",{className:"text-xl font-bold m-0",children:rs(a)?e.jsx(Be.Button,{loading:!0,active:!0}):W(a||0)}),e.jsx(oa,{className:"w-full h-20",children:e.jsxs(la,{width:500,height:100,data:l,syncId:"anyId",margin:{top:10,right:30,left:0,bottom:0},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"colorUv",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#1ED76080",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#21BFFA00",stopOpacity:0})]})}),e.jsx(ia,{type:"monotone",dataKey:"amt",stroke:"#1ED760",fill:"url(#colorUv)"})]})})]})}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 text-xs m-0",children:"Projected APY (%)"}),e.jsx("p",{className:"text-md font-bold m-0",children:d?"Variable":`${x}%`})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 text-xs m-0 mt-3",children:["Pool Reserve (",i,")"]}),e.jsx("p",{className:"text-md font-bold m-0",children:rs(c)?e.jsx(Be.Button,{loading:!0,active:!0}):W(c||0)})]})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-500 text-xs m-0",children:"First loss buffer (%)"}),e.jsx("p",{className:"text-md font-bold m-0",children:t.minFirstLossCushion/ft})]}),e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-gray-500 text-xs m-0 mt-3",children:["NAV (",i,")"]}),e.jsx("p",{className:"text-md font-bold m-0",children:W(p||0)})]})]})]}),e.jsx("div",{className:"flex flex-col justify-start",children:u&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-gray-500 text-xs m-0",children:["Investment capacity (",i,")"]}),e.jsx("p",{className:"text-md font-bold m-0",children:g===0?"Oversubscribed":W(g)})]})})]}),e.jsx("div",{className:"flex flex-col justify-start items-center",children:u&&e.jsx(fn,{strokeLinecap:"butt",strokeWidth:"10",type:"circle",strokeColor:"#1AB752",size:125,percent:te((y-g)/y*100,2),format:b=>e.jsxs("div",{className:"text-sm font-bold",children:[b,"%"]})})})]})]})})},Ba=()=>{var x,I,v,N,C,M,m;const{pool:t,note:s,isLoadingNote:a,poolData:r,tab:i}=oe(),l=nt(z(t,"currency.shortCode",""));console.log("tab",i);const o=n.useMemo(()=>!!(s!=null&&s.notesTokenAddress),[s]),c=n.useMemo(()=>(s==null?void 0:s.notesTokenAddress)||(s==null?void 0:s.juniorNotesTokenAddress),[s==null?void 0:s.juniorNotesTokenAddress,s==null?void 0:s.notesTokenAddress]),p=n.useMemo(()=>{var b;return ze(new je(r.getSeniorDebt||0).minus(r.getBeginningSeniorDebt||0),(b=t==null?void 0:t.currency)==null?void 0:b.decimals)},[(x=t==null?void 0:t.currency)==null?void 0:x.decimals,r.getBeginningSeniorDebt,r.getSeniorDebt]),h=n.useMemo(()=>{var b;return ze(new je(r.totalSupplyOfSOT||0),((b=t==null?void 0:t.currency)==null?void 0:b.decimals)||18)},[(I=t==null?void 0:t.currency)==null?void 0:I.decimals,r.totalSupplyOfSOT]),u=n.useMemo(()=>{var b;return ze(new je(r.totalSupplyOfJOT||0),((b=t==null?void 0:t.currency)==null?void 0:b.decimals)||18)},[(v=t==null?void 0:t.currency)==null?void 0:v.decimals,r.totalSupplyOfJOT]),d=n.useMemo(()=>{var b,E;return ze(new je(((b=r.tokenPrices)==null?void 0:b.sotPrice)||0),((E=t==null?void 0:t.currency)==null?void 0:E.decimals)||18)},[(N=t==null?void 0:t.currency)==null?void 0:N.decimals,(C=r.tokenPrices)==null?void 0:C.sotPrice]),f=n.useMemo(()=>{var b,E;return ze(new je(((b=r.tokenPrices)==null?void 0:b.jotPrice)||0),((E=t==null?void 0:t.currency)==null?void 0:E.decimals)||18)},[(M=t==null?void 0:t.currency)==null?void 0:M.decimals,(m=r.tokenPrices)==null?void 0:m.jotPrice]);if(a)return e.jsx(Be,{loading:a});if(!c)return e.jsx(ce,{gutter:16,className:"px-6",children:e.jsx(le,{xs:24,lg:24,children:e.jsx($t,{children:"Notes not issued"})})});const y=(r.currentMinFirstLoss||0)/1e4,g=r.minFirstLossCushion/ft;return i!==qe.notes?null:e.jsxs(ce,{gutter:16,children:[o&&e.jsx(le,{xs:12,lg:12,children:e.jsxs(Ue,{className:"relative bg-gray-50",children:[e.jsx("div",{className:"w-1.5 h-8 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0 top-5"}),e.jsx("div",{className:"border-b-2 text-lg font-bold",children:"Senior Tranche (SOT)"}),e.jsx(Te,{className:"my-2"}),e.jsx(st,{label:`Amount outstanding (${l})`,value:`${W(h||0)}`}),e.jsx(st,{label:`Coupon - ${W((r.sotInterest||0)/1e4,2)}% APR (${l})`,value:`${W(Math.max(te(p,2),0))}`}),e.jsx(st,{label:`Current price (${l})`,value:`${W(te(d,4))}`}),e.jsx(st,{label:`Current value (${l})`,value:`${W(te(h*d,2)||0)}`}),e.jsxs(Ue,{className:"bg-gray-200 p-0",children:[e.jsxs("label",{htmlFor:"small-range",className:"block mb-2 text-xs font-medium text-gray-90",children:["Senior is protected by ",y,"% first loss buffer (",g,"% minimum)"]}),e.jsx("div",{className:"mt-12 px-2",children:e.jsx(xn,{value:y,tooltip:i===qe.notes&&{prefixCls:"slider-tooltip ant-tooltip",getPopupContainer:b=>b.parentNode,formatter:()=>e.jsxs("div",{className:"text-xs",children:[y,"%"]}),open:!0}||{}})})]})]})}),e.jsx(le,{xs:12,lg:12,children:e.jsxs(Ue,{className:"bg-gray-50",children:[e.jsx("div",{className:"w-1.5 h-8 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0 top-5"}),e.jsx("div",{className:"border-b-2 text-lg font-bold",children:"Junior Tranche (JOT)"}),e.jsx(Te,{className:"my-2"}),e.jsx(st,{label:"Token outstanding",value:`${W(u||0)}`}),e.jsx(st,{label:`Current price (${l})`,value:`${W(f,4)}`}),e.jsx(st,{label:`Current value (${l})`,value:`${W((u||0)*f)}`})]})})]})},Ga=()=>{const{poolHistories:t,isLoadingNote:s,pool:a,note:r}=oe(),i=a.currency.decimals;console.log("poolHistories",t);const l=[{title:"Date",dataIndex:"createdTimestamp",defaultSortOrder:"ascend",sorter:(o,c)=>c.createdTimestamp-o.createdTimestamp,render:o=>Fe(parseInt(o)*1e3).format("HH:mm:ss DD/MM/YYYY")},{title:"Address",dataIndex:"from",render:o=>e.jsx("a",{href:Da(o),target:"_blank",rel:"noreferrer",children:Pa(o,6,4,10)})},{title:"Activity",dataIndex:"transactionType",render:(o,c)=>{switch(o){case"REPAY":return"Loan repayment";case 3:return`Invoice repayment - #${z(c,"content.openItemId")}`;case 4:return"Pool setup";case 5:return"Tokenize collaterals";case 6:return"Transfer collaterals to pool";case 7:return"Change of control";case 8:return"Issuance of note";case 9:return"Issuance of junior note";case 10:return"Import collaterals";case 11:return"Export collaterals";case"SOT_PURCHASE":return`Invest ${r.ticker}_SOT`;case"DRAWDOWN":return"Drawdown";case"JOT_PURCHASE":return`Invest ${r.ticker}_JOT`;case"EPOCH_WITHDRAW":return"Epoch withdraw";case 2:default:return"Note redeemed"}}},{title:"Value",dataIndex:"amount",render:o=>o===null?"":o>0?`${W(te(o/10**i,2))}`:o<0?`${W(te(o/10**i,2))}`:"0"},{title:"",dataIndex:"createdTransactionHash",render:o=>e.jsx(e.Fragment,{children:o&&e.jsx("a",{target:"_blank",rel:"noreferrer",href:Zs(o),children:"Explorer"})})}];return e.jsx("div",{className:"w-full overflow-x-auto z-10",children:e.jsx(rt,{columns:l,dataSource:t||[],pagination:!1,size:"small",scroll:{x:"100%"},loading:s,className:"w-full border-none overflow-x-auto",rowKey:o=>o.id})})},ws=4,He={ACTIVE:1,FUll:2,OUT_OF_RANGE:3},Zt={[He.ACTIVE]:"text-green-500",[He.FUll]:"text-yellow-500",[He.OUT_OF_RANGE]:"text-red-500"},Ns={[He.ACTIVE]:"bg-green-500",[He.FUll]:"bg-yellow-500",[He.OUT_OF_RANGE]:"bg-red-500"},Ya=()=>{const{pool:t,poolData:s,setPoolParametersModalVisible:a,setPoolParameterMinFirstLossModalVisible:r}=oe(),i=nt(z(t,"currency.shortCode","")),l=z(t,"currency.decimals",18),{isPoolAdmin:o}=Xe(y=>y),c=n.useMemo(()=>tt((s==null?void 0:s.debtCeiling)||0,l),[l,s==null?void 0:s.debtCeiling]),p=n.useMemo(()=>tt(new je(s==null?void 0:s.jotCurrencyRaised).plus(s==null?void 0:s.sotCurrencyRaised),l),[l,s==null?void 0:s.jotCurrencyRaised,s==null?void 0:s.sotCurrencyRaised]),h=n.useMemo(()=>+p<+c?He.ACTIVE:+p==+c?He.FUll:He.OUT_OF_RANGE,[c,p]),u=n.useMemo(()=>tt((s==null?void 0:s.minFirstLossCushion)||0,ws),[s==null?void 0:s.minFirstLossCushion]),d=n.useMemo(()=>tt((s==null?void 0:s.currentMinFirstLoss)||0,ws),[s==null?void 0:s.currentMinFirstLoss]),f=n.useMemo(()=>+d>+u?He.ACTIVE:He.OUT_OF_RANGE,[u,d]);return e.jsxs("div",{className:"flex flex-wrap gap-3 justify-between",children:[e.jsxs(Ue,{className:"bg-gray-50 grow",children:[e.jsxs("div",{className:"border-b-2 text-md font-bold",children:["Debt ceiling (",i,")"]}),e.jsx(Te,{className:"my-2"}),e.jsxs("div",{className:"flex justify-between items-center gap-2",children:[e.jsx("div",{className:"grow",children:e.jsxs("div",{className:"flex justify-between my-4",children:[e.jsx("span",{className:"text-gray-400 text-md shrink-0 mr-3",children:`Target Value (${i})`}),e.jsx("span",{className:"text-gray-800 text-md",children:W(te(c,2))})]})}),o&&e.jsx("button",{className:"text-xs border-none rounded-2xl h-6 w-12 cursor-pointer bg-[#25272614]",onClick:()=>a(!0),children:"Edit"})]}),e.jsx(st,{label:e.jsxs(e.Fragment,{children:["Actual Value (",i,")",e.jsx(lt,{title:"Total investment amount of JOT and SOT",trigger:"click",children:e.jsx(gs,{className:"cursor-pointer ml-1"})})]}),value:e.jsxs($t,{className:`flex items-center gap-2 text-xs ${Zt[h]}`,children:[e.jsx("div",{className:`w-2.5 h-2.5 rounded-full ${Ns[h]}`}),W(te(p,2))]})}),[He.OUT_OF_RANGE,He.FUll].includes(h)&&e.jsx($t,{className:`${Zt[h]} text-xs`,children:"Debt ceiling reached! No more investment can be made."})]}),e.jsxs(Ue,{className:"bg-gray-50 grow",children:[e.jsx("div",{className:"border-b-2 text-md font-bold",children:"Minimum first loss"}),e.jsx(Te,{className:"my-2"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{className:"grow",children:e.jsx(st,{label:"Target Value",value:`${W(u)}%`})}),o&&e.jsx("button",{className:"text-xs border-none rounded-2xl h-6 w-12 cursor-pointer bg-[#25272614]",onClick:()=>r(!0),children:"Edit"})]}),e.jsx(st,{label:e.jsxs(e.Fragment,{children:["Actual Value",e.jsx(lt,{title:"Outstanding investment amount of JOT over the total investment (%)",trigger:"click",children:e.jsx(gs,{className:"cursor-pointer ml-1"})})]}),value:e.jsxs($t,{className:`flex items-center gap-2 text-xs ${Zt[f]}`,children:[e.jsx("div",{className:`w-2.5 h-2.5 rounded-full ${Ns[f]}`}),W(te(d,2)),"%"]})})]})]})};function Ot({index:t,onClick:s,title:a}){return e.jsxs("div",{className:"flex items-center justify-start gap-2 py-3 border-0 border-b border-solid border-gray-100 cursor-pointer",onClick:s,children:[e.jsx("div",{className:"w-5 h-5 flex items-center justify-center rounded-full border border-solid border-green-500 text-xs",children:t}),e.jsx("div",{children:a})]})}var en=(t=>(t[t.PENDING_ASSETS=0]="PENDING_ASSETS",t[t.ACTIVE=1]="ACTIVE",t[t.SELLING=2]="SELLING",t[t.PENDING_PAYMENT=3]="PENDING_PAYMENT",t[t.PAID_BY_BUYER=4]="PAID_BY_BUYER",t[t.SOLD=5]="SOLD",t[t.CLOSED=6]="CLOSED",t[t.BUYER_SIGNING=7]="BUYER_SIGNING",t[t.CONFIRM_SELLING=8]="CONFIRM_SELLING",t))(en||{});const Xt=({condition:t=!0,title:s,onClick:a})=>t?{title:s,onClick:a}:null;function tn({defaultActiveKey:t,isShowFull:s,setShowFull:a}){const{closePool:r,openPool:i,pool:l,setBankAccountModalVisible:o,setDrawDownVisible:c,setEditPoolModalVisible:p,setEpochSettingVisible:h,setNoteUpdateVisible:u,setPoolSweepVisible:d,setPoolUpdateVisible:f,setRepaymentModalVisible:y,setSecurityModalVisible:g,setShowUploadModal:x,setUpdatingAssets:I,setNotiModalVisible:v,poolData:N}=oe(),C=pt(),{isOriginator:M,isIssuer:m}=Xe(O=>O),[b,E]=n.useState(!1),$=n.useCallback(()=>!M&&!l.uploadAssetLegalDocumentId?(Pe.error("Pool owner hasn't setup Collateral Purchase Agreement"),!1):!0,[M,l.uploadAssetLegalDocumentId]),D=m||M,A=m||M,S=!M,R=n.useMemo(()=>D?[{condition:m,title:"Link wallet to pool",onClick:()=>{o(!0)}},{condition:!0,title:"View risk score",onClick:()=>{C(`/pool-setting/${l.id}/assets?tab=risk_score`)}},{condition:m,title:"Review pool info",onClick:()=>{p(!0)}},{condition:m,title:"Create pool notification",onClick:()=>{v(!0)}},{condition:m,title:"Close pool from view",onClick:()=>{ve.confirm({title:"Close pool from view",content:e.jsx("p",{children:"Are you sure you want to close this pool?"}),closable:!0,maskClosable:!0,styles:{content:{borderRadius:24,backgroundColor:"#F0F0F0"}},okText:"OK",icon:null,centered:!0,okButtonProps:{className:"bg-[#1ED760] hover:bg-[#1ED760] shadow-none h-10 text-black w-20",style:{backgroundColor:"#1ED760"},type:"primary"},cancelButtonProps:{className:"bg-[#25272614] shadow-none h-10 w-20"},cancelText:"Cancel",width:"30vw",style:{minWidth:500},onOk:r})}},{condition:m&&l.status==en.CLOSED,title:"Open to view",onClick:()=>{ve.confirm({title:"Open pool to view",content:e.jsx("p",{children:"Are you sure you want to open this pool?"}),closable:!0,maskClosable:!0,styles:{content:{borderRadius:24,backgroundColor:"#F0F0F0"}},okText:"OK",icon:null,centered:!0,okButtonProps:{className:"bg-[#1ED760] hover:bg-[#1ED760] shadow-none h-10 text-black w-20",style:{backgroundColor:"#1ED760"},type:"primary"},cancelButtonProps:{className:"bg-[#25272614] shadow-none h-10 w-20"},cancelText:"Cancel",width:"30vw",style:{minWidth:500},onOk:i})}}].map(w=>Xt(w)).filter(Boolean):[],[D,m,o,C,l.id,p,v,r]),L=n.useMemo(()=>{if(!S)return[];const O=!!z(l,"poolEvents[0]")&&!z(l,"poolEvents[0].canceledAt");return[{condition:!0,title:"Review investment target",onClick:()=>{C(`/pool-setting/${l.id}/notes?tab=pool_parameters`)}},{condition:m,title:"Generate and sign doc",onClick:()=>{C(`/pool-setting/${l.id}/settings?tab=doc_generated`)}},{condition:m&&!O,title:"Issue note",onClick:()=>{g(!0)}},{condition:m&&O,title:"Update note",onClick:()=>{u(!0)}},{condition:m,title:"Manage reserve",onClick:()=>{d(!0)}},{condition:m,title:"Manage epoch",onClick:()=>{h(!0)}},{condition:m,title:"Update doc",onClick:()=>{C(`/pool-setting/${l.id}/settings?tab=doc_template`)}}].map(K=>Xt(K)).filter(Boolean)},[S,l,m,g,u,d,h,C]),F=n.useMemo(()=>A?[{condition:m,title:"Generate and sign doc",onClick:()=>{C(`/pool-setting/${l.id}/settings?tab=doc_template`)}},{condition:m,title:"Manage originator",onClick:()=>{f(!0)}},{condition:m,title:"Manage collateral filter",onClick:()=>{C(`/pool-setting/${l.id}/assets?tab=filter`)}},{condition:M,title:"Upload collaterals",onClick:()=>{$()&&(I(!1),x(!0))}},{condition:M,title:"Drawdown",onClick:()=>{c(!0)}},{condition:M,title:"Repay",onClick:()=>{$()&&y(!0)}}].map(w=>Xt(w)).filter(Boolean):[],[A,m,M,C,l.id,f,$,I,x,c,y]),j=n.useMemo(()=>[!Qe(R)&&{key:"pools_setting",label:e.jsx("div",{className:"font-bold",children:"Pool settings"}),children:e.jsx("div",{className:"flex flex-col pb-4",children:R.map((O,w)=>e.jsx(Ot,{index:w+1,title:O.title,onClick:O.onClick},w))}),className:"border-0 !border-b !border-solid !border-gray-200"},!Qe(L)&&{key:"issue_note",label:e.jsx("div",{className:"font-bold",children:"Issue notes"}),className:"border-0 !border-b !border-solid !border-gray-200",children:e.jsx("div",{className:"flex flex-col pb-4",children:L.map((O,w)=>{if(O.title==="Update note"){const K=Number(tt((N==null?void 0:N.minFirstLossCushion)||0,4))>=100;return e.jsx(yn,{overlayInnerStyle:{padding:7},arrow:!1,placement:"bottom",open:b,trigger:"click",content:e.jsxs("div",{className:"flex flex-col",children:[!K&&e.jsxs("button",{className:"rounded-lg group border-none cursor-pointer bg-white hover:bg-[#25272614] py-3 px-3",onClick:()=>{u("SOT"),E(!1)},children:["Update Senior note"," ",e.jsx(fs,{className:"invisible group-hover:visible ml-2",style:{color:"#818884"}})]}),e.jsxs("button",{className:"rounded-lg group border-none cursor-pointer bg-white hover:bg-[#25272614] py-3 px-3",onClick:()=>{u("JOT"),E(!1)},children:["Update Junior note"," ",e.jsx(fs,{className:"invisible group-hover:visible ml-2",style:{color:"#818884"}})]})]}),children:e.jsx(Ot,{index:w+1,title:O.title,onClick:()=>E(!b)})},w)}return e.jsx(Ot,{index:w+1,title:O.title,onClick:O.onClick},w)})})},!Qe(F)&&{key:"manage_assets",label:e.jsx("div",{className:"font-bold",children:"Manage assets"}),className:"border-0 !rounded-none",children:e.jsx("div",{className:"flex flex-col pb-4",children:F.map((O,w)=>e.jsx(Ot,{index:w+1,title:O.title,onClick:O.onClick},w))})}].filter(Boolean),[b,L,F,N==null?void 0:N.minFirstLossCushion,R,u]);return e.jsxs("div",{className:`bg-gray-50 rounded-2xl border-gray-200 border border-solid relative ${s&&"w-full"||"w-0.5 border-0 border-r-2 border-green-500 h-96"}`,children:[e.jsx(U,{className:"flex items-center justify-center p-0 bg-green-400 absolute -right-4 top-8",icon:e.jsx(bn,{rotate:s?0:180}),onClick:()=>{a(!s)}}),e.jsxs("div",{className:s&&"visible"||"invisible",children:[e.jsxs("div",{className:"p-4 border-0 border-b border-solid border-gray-200",children:[e.jsx("div",{className:"text-lg font-bold mb-2",children:"Manage pool"}),e.jsx("div",{className:"text-md text-gray-400",children:"Follow this list to initialize pool"})]}),e.jsx(Ms,{defaultActiveKey:t,accordion:!0,expandIcon:({isActive:O})=>e.jsx(jn,{rotate:O?90:0}),ghost:!0,onChange:O=>{console.log(O)},expandIconPosition:"end",items:j})]})]})}tn.propTypes={defaultActiveKey:$e.arrayOf($e.oneOf(["pools_setting","issue_note","manage_assets"]))};function Ct({defaultActiveKey:t,children:s}){const{isIssuer:a,isOriginator:r}=Xe(c=>c),i=n.useMemo(()=>a||r,[a,r]),[l,o]=n.useState(!0);return e.jsx(ce,{gutter:24,children:e.jsx(le,{span:24,children:e.jsxs("div",{className:"flex w-full gap-6",children:[i&&e.jsx("div",{className:`flex-none ${l&&"w-[280px]"||"w-[10px]"}`,children:e.jsx(tn,{defaultActiveKey:t,isShowFull:l,setShowFull:o})}),e.jsx("div",{className:"flex-1 max-w-full overflow-hidden",children:e.jsx(Ue,{className:"pool-setting-tabs bg-gray-50",children:s})})]})})})}Ct.propTypes={defaultActiveKey:$e.arrayOf($e.oneOf(["pools_setting","issue_note","manage_assets"]))};const Ka=[{name:"Notes",key:"notes"},{name:"Transactions",key:"transactions"},{name:"Pool Parameters",key:"pool_parameters"}];function Wa(){const t=us(),s=pt(),{isLoadingNote:a}=oe(),r=ps.parse(t.search),i=["notes","transactions","pool_parameters"].includes(r.tab)&&r.tab||"notes";return e.jsx(Ct,{defaultActiveKey:["issue_note"],children:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex gap-2 mb-4",children:Ka.map(l=>e.jsx(U,{className:`${i===l.key&&"bg-green-500"||"bg-gray-200"} !rounded-lg text-xs`,onClick:()=>{s(t.pathname+`?tab=${l.key}`)},children:l.name},l.key))}),!a&&e.jsxs(e.Fragment,{children:[i==="notes"&&e.jsx(Ba,{}),i==="transactions"&&e.jsx(Ga,{}),i==="pool_parameters"&&e.jsx(Ya,{})]})]})})}const Ha=()=>{const{isSuperAdmin:t,isPoolAdmin:s,isIssuer:a}=Xe(f=>f),{pool:r,tab:i,setTab:l}=oe(),o=n.useMemo(()=>r.isOriginator,[r]),c=s||t||r.isServicer||o||r.access&&r.access.includes(0),p=!o,h=!o,u=a,d=[...c?[{key:qe.assets,label:"Assets"}]:[],...p?[{key:qe.notes,label:"Notes"}]:[],...h?[{key:qe.reserve,label:"Reserve"}]:[],...u?[{key:qe.holders,label:"Holders"}]:[],{key:qe.settings,label:"Settings"}];return e.jsx(vn,{className:"bg-white mt-6 px-2",children:e.jsx(Fs,{activeKey:i,onChange:f=>l(f),tabPosition:"top",items:d})})},qa=e.jsx("center",{children:e.jsx(Lt,{size:"small"})}),sn=({pool:t,assets:s,assetType:a,onNextStep:r,setExtraInfo:i=()=>{}})=>{const l=pt(),[o,c]=n.useState([]),[p,h]=n.useState([]),u=at.getExtraInfoFromAssets(t,s.map((g,x)=>{let I=g.outstandingPrincipalAmount,v=g.interestRatePercentage;return g.tokenId&&(I=o[x]||0,v=p[x]||0),{...g,outstandingPrincipalAmount:I,interestRatePercentage:v}}));n.useEffect(()=>{i(u)},[o,p]);const d=n.useCallback(async()=>{if(s.length&&t){let g=[];(a===ie.LENDING||a===ie.INVOICE)&&(g=await at.getDebtAssetValues(t.poolContractAddress,s,!0,t.currency.decimals)),console.log("_balances:",g),c(g)}},[a,s,t]),f=n.useCallback(async()=>{const g=s.filter(x=>x.assetType!==ie.NOTE_TOKEN);if(g.length){let x=[];(a===ie.LENDING||a===ie.INVOICE)&&(x=await at.getLoanAndInvoiceInterestRates(g,t)),h(x)}},[a,s,t]);n.useEffect(()=>{d(),f()},[s,d,f]);const y=[{title:"ID",dataIndex:"id",key:"id",render:(g,x)=>x.assetType===ie.NOTE_TOKEN?e.jsx("span",{children:x.id}):e.jsx("span",{onClick:()=>l(`/lending-place/order-contract/${x.id}`),style:{color:"#4bb7f5",cursor:"pointer"},children:x==null?void 0:x.debtOrderContract.externalId})},{title:"Amount",dataIndex:"amount",key:"amount",render:(g,x,I)=>x.assetType==ie.NOTE_TOKEN?x.amount:x.id&&x.tokenId?o.length?W(o[I]):qa:W(x.outstandingPrincipalAmount)},{title:"APR",dataIndex:"interestRatePercentage",key:"interestRatePercentage",render:(g,x,I)=>x.assetType==ie.NOTE_TOKEN?x.type===Kt.SENIOR?`${x.interestRatePercentage}%`:"N/A":p.length?`${W(p[I])}%`:null},{title:"Financing date",dataIndex:"debtOrderContract.financingTimestamp",key:"debtOrderContract.financingTimestamp",width:"14%",render:(g,x)=>{var I;return Fe.unix((I=x==null?void 0:x.debtOrderContract)==null?void 0:I.financingTimestamp).format("DD/MM/YYYY")}},{title:"Maturity Date",dataIndex:"paymentDueDate",key:"paymentDueDate",render:(g,x)=>x.assetType==ie.NOTE_TOKEN?"Perpetual":Fe(z(x,"debtOrderContract.debtOrderContractInfo.finalMaturityDate")).format("DD/MM/YYYY")},{title:"Status",dataIndex:"status",key:"status",render:(g,x)=>e.jsx(Sa,{type:Qn(x)})}];return e.jsxs("div",{children:[e.jsx(rt,{style:{marginTop:15},bordered:!0,dataSource:s,columns:y,pagination:!0,scroll:{y:350,x:1e3},rowKey:g=>g.id}),r?e.jsx(U,{type:"primary",size:"large",style:{width:"100%",marginTop:20},onClick:r,children:"Continue"}):null]})},{Step:es}=ot,As={[ie.LENDING]:"SME Loans",[ie.INVOICE]:"Invoices"},Ja={"<":"$lt",">=":"$gte",between:"$between"},za=t=>{let s={};return t.forEach(a=>{const r=a.conditions[0],i={[Ja[r.operation]]:r.operation==="between"?[parseFloat(r.value1),parseFloat(r.value2)]:parseFloat(r.value)};a.key==="AND"?s={...s,[r.variable]:i}:s={$or:[{...s},{[r.variable]:i}]}}),s},Qa=({pool:t={},visible:s,onClose:a})=>{const[r,i]=n.useState(0),[l,o]=n.useState(!1),[c,p]=n.useState([]),[h,u]=n.useState([{key:"AND",conditions:[{}]}]);n.useEffect(()=>{s&&i(0),u([{key:"AND",conditions:[{}]}])},[s]);const d=n.useMemo(()=>{let f=!0;return h.forEach(y=>{y.conditions.forEach(g=>{(g.variable===void 0||!g.operation)&&(f=!1),g.operation==="between"&&(!g.value1||!g.value2)&&(f=!1),g.operation!=="between"&&!g.value&&(f=!1)})}),f},[h]);return e.jsx(ve,{onCancel:()=>{a()},footer:null,width:"100vw",open:s,style:{top:0,minWidth:r===1?1100:650,paddingBottom:0},children:e.jsxs("div",{style:{height:`calc(100vh - ${r===1?20:100}px)`,width:r===1?1100:650,margin:"0 auto",marginTop:r===1?20:100},children:[e.jsxs(ot,{progressDot:!0,current:r,children:[e.jsx(es,{title:"Filter"}),e.jsx(es,{title:"Review"}),e.jsx(es,{title:"Transfer"})]}),s&&r===0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{children:"Collateral Filtering Criteria"}),e.jsx(X,{readonly:!0,placeholder:"Collateral type",id:"assetType",value:As[t.assetType]})]}),s&&r===1&&e.jsx(sn,{pool:t,assets:c,assetType:t.assetType}),s&&r===2&&e.jsxs(e.Fragment,{children:[e.jsx("div",{children:"Transfer"}),e.jsx("center",{style:{fontSize:16,color:"#070A0E",padding:"0 50px",marginBottom:50},children:e.jsxs("labe",{children:["We are transferring your ",c.length," collaterals to the pool now.",e.jsx("br",{})," We will notify you when the transfer is complete."]})})]}),e.jsx("div",{style:{width:"100%",marginTop:20},children:e.jsxs(U,{loading:l,disabled:r===0&&!d,onClick:async()=>{if(r===2)location.reload();else{if(r===0){o(!0);const f=za(h),g=As[t.assetType]==="Invoices"?ie.INVOICE:ie.LENDING,x=await Q.getAssetsByCriteria(g,f);o(!1),p(x)}if(r===1){if(!c.length)return i(r-1);o(!0),await Q.transferAssetsToPool(t.id,c.map(f=>f.id)),o(!1)}i(r+1)}},type:"primary",style:{width:"100%"},children:[r===0&&"Continue",r===1&&(c.length?"Transfer to Pool":"Back to Filer collaterals"),r===2&&"Go to Pool collaterals"]})})]})})},Za=()=>{const[t,s]=n.useState(!1),{pool:a,setShowUploadModal:r,reloadPool:i}=oe();return e.jsxs("div",{children:[e.jsx("div",{onClick:()=>{r(!0),i()},children:"+ Transfer Collaterals to Pool"}),e.jsx(Qa,{pool:a,visible:t,onClose:()=>s(!1)})]})};function Xa(){const{pool:t,assets:s}=oe(),[a,r]=n.useState([]);return n.useEffect(()=>{(async()=>{const l=await Ws();if(!t)return;const o=await Q.getPoolTokenAssets(t.id),c=await l.methods.getExternalTokenInfos(t.poolContractAddress).call(),p=(o==null?void 0:o.result)||[],h=await l.methods.getTokenPrices(c.map(d=>d.poolAddress),c.map(d=>d.noteTokenAddress)).call(),u=Cn(c,h,(d,f)=>{var g,x;const y=p.find(I=>{var v,N,C,M,m,b;return((N=(v=I==null?void 0:I.pool)==null?void 0:v.poolAddress)==null?void 0:N.toLowerCase())===((C=d==null?void 0:d.poolAddress)==null?void 0:C.toLowerCase())&&((m=(M=I==null?void 0:I.poolEvent)==null?void 0:M.noteTokenAddress)==null?void 0:m.toLowerCase())===((b=d==null?void 0:d.noteTokenAddress)==null?void 0:b.toLowerCase())});return{id:(g=y==null?void 0:y.poolEvent)!=null&&g.ticker?`${(x=y==null?void 0:y.poolEvent)==null?void 0:x.ticker}_${y!=null&&y.isSot?"SOT":"JOT"}`:"N/A",type:y!=null&&y.isSot?Kt.SENIOR:Kt.JUNIOR,assetType:ie.NOTE_TOKEN,amount:te(tt(d.balance*f,2*t.currency.decimals),4),interestRatePercentage:te(new je(d.apy).dividedBy(ft).toNumber(),2),paymentDueDate:"N/A",poolEvent:y?y==null?void 0:y.poolEvent:{},pool:y?y==null?void 0:y.pool:{}}});r(u)})()},[t]),e.jsx(ce,{gutter:16,children:e.jsxs(le,{xs:24,lg:24,children:[t.isOriginator&&t.status===Me.statuses.PENDING_ASSETS&&e.jsx(Za,{}),t.status!==Me.statuses.PENDING_ASSETS&&e.jsx(e.Fragment,{children:e.jsx(sn,{pool:t,assets:s.concat(a),assetType:t.assetType})})]})})}const{Option:Ss,OptGroup:Ts}=Ze,er=({formula:t,setFormula:s,currentVariables:a})=>e.jsxs("div",{style:{marginTop:10},children:[e.jsx(Te,{children:"Computation"}),e.jsxs("center",{children:[e.jsx(X,{style:{marginTop:20,height:110},placeholder:"Formula",type:"textarea",value:t,onChange:r=>s(r.target.value)}),a.length?e.jsx("div",{style:{marginTop:10},children:"Please define the value for below variables:"}):null,a.map((r,i)=>e.jsxs("div",{children:[r,":"," ",e.jsxs(X,{onChange:l=>{const o=t.replace(r,l);s(o)},type:"select",style:{width:200,marginTop:10,marginLeft:10,display:"inline-block"},showSearch:!0,id:"beneficiary",children:[e.jsx(Ts,{label:"Lending",children:js.calculationFieldsForSMELoans.map(l=>e.jsx(Ss,{value:l.value,children:l.name},l.value))}),e.jsx(Ts,{label:"Invoice",children:js.calculationFieldsForInvoices.map(l=>e.jsx(Ss,{value:l.value,children:l.name},l.value))})]})]},i))]})]}),tr=({actionData:t={},setActionData:s})=>e.jsxs("div",{style:{marginTop:10},children:[e.jsx(Te,{children:"Action"}),e.jsx(vt,{onChange:a=>{s({...t,isEmailNotificationEnable:a.target.checked||!1})},checked:t.isEmailNotificationEnable,children:"Email notification"}),e.jsx("center",{children:e.jsx(X,{style:{marginTop:20,height:110},placeholder:"Recipient emails",type:"textarea",value:t.recipientEmails,onChange:a=>s({...t,recipientEmails:a.target.value})})})]});function At(t,s){let a=s.conditions;for(let r=0;r<t.length;r++){const i=t[r];a=a[i].conditions}return a}const sr=[{name:"Current balance",value:"outstandingPrincipalAmount"},{name:"Original loan balance",value:"principalAmount"}],{Option:We,OptGroup:Zo}=Ze,nn=({level:t=0,operations:s,setConditionGroup:a,rootConditionGroup:r,onChangeCondition:i,onChangeMatchType:l,conditionGroup:o,addCriteria:c,removeCriteria:p,addGroup:h,questionnaires:u,indexList:d,removeGroup:f,assetType:y,isTemplateBuilder:g,isTrigger:x=!1,calculationName:I})=>{const{match:v,conditions:N}=o,C=t%2===0?"bg-gray-50":"bg-gray-100";return e.jsxs(Ue,{className:`mt-4 [&_.ant-select]:!h-10 [&_.ant-input]:!h-10 [&_.ant-card-body]:p-4 ${C}`,children:[e.jsx("div",{className:"[&_.ant-select]:!h-8 text-left inline-block",children:e.jsxs(Ze,{onChange:l,value:v,className:"[&>.ant-select-selector]:!rounded-2xl [&>.ant-select-selector]:!bg-gray-200",children:[e.jsx(We,{value:"ALL",children:"Match ALL"}),e.jsx(We,{value:"ANY",children:"Match ANY"})]})}),e.jsxs("div",{className:"float-right inline-block mr-2",children:[e.jsx(U,{onClick:h,type:"link",className:"px-1 text-green-600",children:"Add group"}),e.jsx(U,{onClick:c,type:"link",className:"px-1 text-green-600 ml-3",children:"Add criteria"}),f&&e.jsx(U,{onClick:f,type:"link",className:"px-2 text-red-600 ml-3",children:"Remove"})]}),e.jsx(Te,{}),N.map((M,m)=>M.match?e.jsx(nn,{level:t+1,isTemplateBuilder:g,assetType:y,operations:s,conditionGroup:M,rootConditionGroup:r,setConditionGroup:a,questionnaires:u,addCriteria:()=>{const b=[...d,m],E=Ke(r,$=>{At(b,$).push({})});a(E)},removeCriteria:b=>{const E=[...d,m],$=Ke(r,D=>{At(E,D).splice(b,1)});a($)},addGroup:()=>{const b=[...d,m],E=Ke(r,$=>{At(b,$).push({conditions:[],match:"ALL"})});a(E)},removeGroup:()=>{const b=Ke(r,E=>{At(d,E).splice(m,1)});a(b)},onChangeCondition:(b,E,$)=>{const D=[...d,m],A=Ke(r,S=>{const R=At(D,S);R[b][E]=$});a(A)},indexList:[...d,m],onChangeMatchType:b=>{const E=Ke(r,$=>{let D=$.conditions;for(let A=0;A<d.length;A++){const S=d[A];D=D[S].conditions}D[m].match=b});a(E)},calculationName:I,isTrigger:x},m):e.jsxs(ce,{style:{marginTop:20},gutter:16,className:`[&_.ant-select-selector]:!${C} [&_.ant-input]:!${C}`,children:[e.jsx(le,{span:7,children:x?e.jsx(X,{type:"select",className:"w-full",value:M.attribute,id:"attribute",placeholder:"Select attribute",onChange:b=>i(m,"attribute",b),children:e.jsx(We,{value:`$${ua(I)}`,children:I})}):e.jsx(X,{type:"select",className:"w-full",value:M.attribute,id:"attribute",placeholder:"Select attribute",onChange:b=>i(m,"attribute",b==="currency.shortCode2"?"currency.shortCode":b),children:sr.map(b=>e.jsx(We,{value:b.value,children:b.name},b.value))})}),e.jsx(le,{span:8,children:e.jsxs(X,{type:"select",className:"w-full",value:M.operation,id:"operation",placeholder:"Select operation",onChange:b=>i(m,"operation",b),children:[e.jsx(We,{value:"equals",children:"equals"}),e.jsx(We,{value:"not equals",children:"not equals"}),e.jsx(We,{value:"greater than",children:"greater than"}),e.jsx(We,{value:"greater than or equals",children:"greater than or equals"}),e.jsx(We,{value:"less than",children:"less than"}),e.jsx(We,{value:"less than or equals",children:"less than or equals"})]})}),e.jsx(le,{span:7,children:M.attribute==="status"?e.jsxs(X,{type:"select",className:"w-full",value:M.value,id:"value",placeholder:"Enter value",onChange:b=>i(m,"value",b),children:[e.jsx(We,{value:"paid",children:"Paid"}),e.jsx(We,{value:"performing",children:"Performing"}),e.jsx(We,{value:"non-performing",children:"Non performing"})]}):e.jsx(X,{type:"input-number-v2",className:"w-full",value:M.value,id:"value",placeholder:"Enter value",onChange:b=>i(m,"value",b)})}),e.jsx(le,{span:2,className:"flex items-center justify-center",children:e.jsx(U,{className:"bg-gray-300 w-8 h-8 px-1",onClick:()=>p(m),children:e.jsx(wn,{className:"text-lg"})})})]},m))]})},{Option:dt}=Ze,we={FILTER:0,CASHFLOW:1,REPORT:2},nr={equals:"$eq","not equals":"$ne","less than":"$lt","less than or equals":"$lte","greater than":"$gt","greater than or equals":"$gte"},ar=({pool:t,isGeneralPurpose:s=!1,assetType:a,questionnaires:r=[],isBlockConditionVisible:i,setBlockConditionVisible:l,conditionGroup:o,setConditionGroup:c,isEditting:p=!1,setEditting:h=()=>{},onSaveAssetFilter:u=()=>{},operations:d=[],criteriaName:f,isViewingClauseDetail:y,isLoadingClause:g,shouldHideRemoveBtn:x,onCancel:I=()=>{},isTemplateBuilder:v=!1,templateId:N,reloadReportTemplate:C=()=>{},filterTemplateId:M=null,reportTemplateId:m=null,clauseDetail:b={},formula:E,setFormula:$,isTrigger:D=!1,currentActionData:A=null})=>{const[S,R]=n.useState(p&&f||""),[L,F]=n.useState(!1),[j,O]=n.useState(!1),[w,K]=n.useState([]),[q,k]=n.useState(0),[H,se]=n.useState([]),[de,ue]=n.useState([]),[fe,xe]=n.useState(null),[ne,me]=n.useState(null),[ye,Ce]=n.useState({}),[et]=Ve(It.getAllCompanies),[Ae,Ge]=n.useState(!1),[P,B]=n.useState(""),[_,J]=n.useState(A||(t&&t.owner?{recipientEmails:t.owner.email}:{}));console.log("templateId",N);const[Z,ae]=n.useState("");n.useEffect(()=>{if(b){if(Ge(b&&b.id?!b.beneficiaryCompanyId:!1),b.reportTemplateId){k(we.REPORT);const G=z(b,"reportContent.calculationFormula","");B(G==="EMPTY_FORMULA"?"":G)}else k(b.calculationFormula?we.CASHFLOW:we.FILTER),B(b.calculationFormula==="EMPTY_FORMULA"?"":b.calculationFormula);b.id&&Ce({...b})}},[b]);const Y=n.useMemo(()=>et.filter(G=>new RegExp(Z,"gi").test(G.companyLegalName)),[Z,et]),pe=n.useCallback(async G=>{const he=await Q.getPoolFilterTemplates(G),Je=await Q.getListReportTemplate(G);se(he),ue(Je)},[]);n.useEffect(()=>{M&&M!==fe&&xe(M)},[M]),n.useEffect(()=>{m&&m!==ne&&me(m)},[m]),n.useEffect(()=>{pe(t?t.id:null)},[t]);const re=async(G,he,Je)=>{const Ye=Ke(o,Ee=>{Ee.conditions[G][he]=Je});c(Ye)},Se=()=>{const G=Ke(o,he=>{he.conditions.push({conditions:[],match:"ALL"})});c(G)},ke=()=>{const G=Ke(o,he=>{he.conditions.push({})});c(G)},_e=G=>{const he=Ke(o,Je=>{Je.conditions.splice(G,1)});c(he)};n.useEffect(()=>{p&&R(f)},[f]),n.useEffect(()=>{if(E||P){const G=at.getVariablesFromFormula(E||P);K(G)}},[E,P]);const be=n.useMemo(()=>{if(!S)return!0;const G=Ye=>!Ye.operation||!Ye.attribute?!0:Ye.value===""||Number.isNaN(+`${Ye.value}`),he=Ye=>Ye.some(Ee=>Nn(Ee.conditions)?he(Ee.conditions):G(Ee));return he(o.conditions)},[S,o.conditions]);return e.jsx(ve,{style:{top:100},mask:!1,open:i,title:"",width:"700px",footer:null,onCancel:()=>{R(""),l(!1),h(!1),y||c({conditions:[{}],match:"ALL"}),Ge(!1),k(we.FILTER),Ce({}),B(""),I()},className:"[&_.ant-select]:!h-10 [&_.ant-input]:!h-10 [&>.ant-modal-content]:rounded-2xl",children:g?e.jsx(Be,{active:!0,loading:!0}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xl font-bold",children:D?`${f} trigger`:p?`Editing ${v?"column":"criteria"}`:`Create new ${v?"column":"criteria"}`}),!D&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-md mt-4 mb-1",children:[v?"Column":"Criteria"," name"]}),e.jsx(Re,{placeholder:`Enter ${v?"column":"criteria"} name`,value:S,onChange:G=>R(G.target.value)})]}),!D&&!v&&s&&e.jsxs("div",{children:[e.jsx("div",{className:"text-md mt-4 mb-1",children:"Criteria type"}),e.jsxs(X,{type:"select",onChange:G=>k(G),value:q,placeholder:"Criteria type",children:[e.jsx(dt,{value:0,children:"Filter"}),e.jsx(dt,{value:1,children:"Cashflow"}),e.jsx(dt,{value:2,children:"Report"})]}),q===we.FILTER&&e.jsxs(X,{type:"select",style:{width:200,marginTop:20,marginLeft:20,display:"inline-block"},onChange:G=>c({...o,filterName:G}),value:o.filterName,placeholder:"Filter type",children:[e.jsx(dt,{value:"exclusionFilter",children:"Exclusions"}),e.jsx(dt,{value:"ineligibleFilter",children:"Ineligibles"}),e.jsx(dt,{value:"reserveFilter",children:"Reserves"})]}),q===we.FILTER&&e.jsx(Ne,{style:{display:"inline-block",width:200,marginLeft:20},placeholder:"Filter template",items:H,nameKey:"templateName",selectedValue:fe,onSelect:G=>xe(G)}),q===we.REPORT&&e.jsx(Ne,{style:{display:"inline-block",width:200,marginLeft:20},placeholder:"Report template",items:de,nameKey:"templateName",selectedValue:ne,onSelect:G=>me(G)})]}),!D&&!v&&q===we.FILTER&&!s&&e.jsxs("div",{children:[e.jsx("div",{className:"text-md mt-4 mb-1",children:"Criteria type"}),e.jsx(X,{type:"select",onChange:G=>c({...o,filterName:G}),value:o.filterName,placeholder:"Filter type",children:e.jsx(dt,{value:"exclusionFilter",children:"Exclusions"})})]}),(!s||s&&(q===we.FILTER||q===we.REPORT))&&e.jsxs(e.Fragment,{children:[e.jsx(Te,{}),e.jsx("div",{className:"text-lg font-bold",children:"Conditions"}),e.jsx(nn,{isTemplateBuilder:v,assetType:a,operations:d,rootConditionGroup:o,conditionGroup:o,setConditionGroup:c,rootGroup:o,addCriteria:ke,removeCriteria:_e,addGroup:Se,questionnaires:r,indexList:[],onChangeCondition:re,onChangeMatchType:G=>{c({...o,match:G})},calculationName:S,isTrigger:D}),e.jsx("div",{className:"mt-5 text-right mr-2",children:Tt(o)})]}),q===we.CASHFLOW&&e.jsxs("center",{children:[e.jsx(X,{style:{width:200,marginTop:10},onChange:G=>Ce({...ye,groupName:G.target.value}),value:ye.groupName,placeholder:"Group name"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(vt,{checked:Ae,onChange:G=>Ge(G.target.checked),children:"Send to the investors"})}),!Ae&&e.jsx(X,{placeholder:"Beneficiary",type:"select",style:{width:200,marginTop:10},autocomplete:!1,onSearch:G=>ae(G),onSelect:G=>{Ce({...ye,beneficiaryCompanyId:G})},value:ye.beneficiaryCompanyId,filterOption:!1,children:Y.map(G=>e.jsx(dt,{value:G.id,children:G.companyLegalName},G.id))})]}),(v||q===we.CASHFLOW&&!Ae||q===we.REPORT)&&e.jsx(er,{assetType:a,formula:E||P,setFormula:$||B,currentVariables:w}),D&&e.jsx(tr,{actionData:_,setActionData:J}),e.jsxs("div",{className:"flex mt-5 text-right items-center justify-between gap-2 mt-2",children:[p&&!D&&!y&&!x&&e.jsx(Wt,{onConfirm:async()=>{O(!0),await Q.deleteAssetFilter(N,o.id),Pe.success("Delete criteria successfully"),C(),O(!1),l(!1)},title:"Are you sure？",okText:"Yes",cancelText:"No",children:e.jsx(U,{type:"danger",className:"flex-1 h-10 bg-gray-300",loading:j,children:"Remove"})}),e.jsx(U,{type:"primary",className:"flex-1 h-10",disabled:be,loading:L,onClick:async()=>{if(F(!0),console.log("generalPurpose, criteriaType",s,q),!s||q===we.FILTER)await u({id:o.id,name:S,poolFilterName:o.filterName,[D?"triggerConditions":"poolFilterConditions"]:St(o),[D?"triggerDisplayFomula":"displayFormula"]:Tt(o),[D?"triggerConditionArr":"poolFilterConditionArr"]:o,templateId:N,filterTemplateId:fe,poolId:t?t.id:null,actionData:_},we.FILTER),v?Pe.success(`${p?"Update":"Create new"} column successfully`):Pe.success(`${p?"Update":"Create new"} clause successfully`);else if(q===we.CASHFLOW){const G=[...t.cashFlow];G.includes(ye.groupName)||G.push(ye.groupName);const he=await Q.createUpdateCashflow({id:ye.id,beneficiaryCompanyId:Ae?null:ye.beneficiaryCompanyId,cashFlow:G,name:S,groupName:ye.groupName,calculationFormula:Ae?"EMPTY_FORMULA":P,poolId:t?t.id:null,assetType:t.assetType,actionData:_});await u(null,we.CASHFLOW,he),Pe.success(`${p?"Update":"Create new"} clause successfully`)}else q===we.REPORT&&(await u({id:o.id,name:S,poolFilterName:o.filterName,poolFilterConditions:St(o),displayFormula:Tt(o),poolFilterConditionArr:o,templateId:N,reportTemplateId:ne,reportContent:{calculationFormula:P,conditions:St(o),poolFilterConditions:St(o),displayFormula:Tt(o),poolFilterConditionArr:o},poolId:t?t.id:null,calculationFormula:Ae?"EMPTY_FORMULA":P,actionData:_},we.REPORT),Pe.success(`${p?"Update":"Create new"} clause successfully`));F(!1),l(!1),C()},children:"Save"})]})]})})};function St(t){let s={};const a=t.match==="ALL"?"AND":"OR";return t.conditions.map(r=>{if(r.match)s={...s,[`$${r.match==="ALL"?"and":"or"}`]:[{...St(r)}]};else{const i={[nr[r.operation]]:isNaN(r.value)?r.value:parseFloat(r.value)};s={...s,[r.attribute]:i}}}),{[`$${a==="AND"?"and":"or"}`]:Object.keys(s).map(r=>({[r]:s[r]}))}}function Tt(t){let s="";const a=t.match==="ALL"?" AND ":" OR ";return t.conditions.map(r=>{r.match?s+=` (${Tt(r)})${a}`:s+=""+rr(r.operation,r.attribute,r.value)+a}),s.substr(s.length-5)===" AND "?s=s.slice(0,-5):s.substr(s.length-4)===" OR "&&(s=s.slice(0,-4)),s}function rr(t,s="",a=""){let r="";switch(isNaN(a)&&(a=`"${a}"`),console.log(t),t){case"equals":r=`${s} = "${a}"`;break;case"not equals":r=`${s} ≠ "${a}"`;break;case"greater than or equals":r=`${s} ≥ "${a}"`;break;case"greater than":r=`${s} > "${a}"`;break;case"less than":r=`${s} < "${a}"`;break;case"less than or equals":r=`${s} ≤ "${a}"`;break;case"contains":r=`Contains(${s}, "${a}")`;break;case"does not contains":r=`NotContains(${s}, "${a}")`;break}return r}const or=()=>{const{message:t}=Ie.useApp(),{pool:s}=oe(),{isIssuer:a}=Xe(m=>m),[r,i,l]=Ve(Q.getPoolFilterTemplates,s.id),o=n.useMemo(()=>Qe(r)?null:r.find(({isMain:m})=>m===1),[r]),c=n.useCallback(async()=>{const m=await Q.createUpdateFilterTemplate({name:`${s.name} - filter`,isMain:!0,poolId:s.id,assetType:s.assetType});return await l(),m},[s.assetType,s.id,s.name,l]),[p,h]=n.useState(!1),[u,d]=n.useState({conditions:[{}],match:"ALL",name:""}),[f,y]=n.useState(!1),[g,x]=n.useState({}),I=n.useCallback(async m=>{await Q.createUpdateAssetFilter(o==null?void 0:o.id,m.poolFilterName,m),l()},[l,o==null?void 0:o.id]),v=n.useCallback(async m=>{await Q.deleteAssetFilter(o==null?void 0:o.id,m),l()},[l,o==null?void 0:o.id]),N=n.useMemo(()=>(o==null?void 0:o.exclusionFilter)||[],[o==null?void 0:o.exclusionFilter]),C=m=>{d({...m.poolFilterConditionArr,name:m.name,id:m.id}),y(!0),h(!0)},M=n.useRef(!1);return n.useEffect(()=>{!i&&!(o!=null&&o.id)&&M.current===!1&&(M.current=!0,c())},[c,i,o==null?void 0:o.id]),e.jsxs(e.Fragment,{children:[i&&e.jsx(Be,{}),!i&&e.jsxs(Ue,{className:"bg-gray-50",title:"Excluded collaterals",extra:a?e.jsx(U,{className:"bg-gray-200",onClick:()=>{h(!0),d({conditions:[{}],match:"ALL",name:"",filterName:"exclusionFilter"})},children:"Add criteria"}):null,children:[!i&&!(o!=null&&o.id)&&M.current===!0&&e.jsx("p",{children:"Filter not found!"}),!i&&(o==null?void 0:o.id)&&e.jsxs(e.Fragment,{children:[Qe(N)&&e.jsx("p",{children:"No condition found!"}),!Qe(N)&&N.map((m,b)=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-200 p-2 rounded-lg px-3 mb-2",children:[e.jsx("div",{className:"font-bold",children:`${b+1}. ${m.name}`}),e.jsx("div",{className:"flex gap-2",children:a&&e.jsxs(e.Fragment,{children:[e.jsx(U,{type:"link",className:"text-green-500 px-1",onClick:()=>C(m),children:"Edit"}),e.jsx(Wt,{onConfirm:async()=>{x({...g,[m.id]:!0}),await v(m.id),x({...g,[m.id]:!0}),t.success("Delete criteria successfully")},title:"Are you sure？",okText:"Yes",cancelText:"No",children:e.jsx(U,{type:"link",className:"text-red-500 px-1",children:g[m.id]?e.jsx(Lt,{size:"small"}):"Remove"})})]})})]},b))]})]}),p&&e.jsx(ar,{assetType:s.assetType,conditionGroup:u,setConditionGroup:d,isBlockConditionVisible:p,setBlockConditionVisible:m=>{h(m),!m&&y(!1)},reloadReportTemplate:l,onSaveAssetFilter:I,isEditting:f,setEditting:y,criteriaName:u.name,templateId:o==null?void 0:o.id,currencyShortCode:z("pool","currency.shortCode")})]})},lr=({scorecards:t,isLoading:s})=>{var i;console.log(t);const a=((i=t==null?void 0:t[0])==null?void 0:i.discountRate)??void 0,r=n.useMemo(()=>[{title:"Date",width:120,dataIndex:"updatedAt",render:l=>Fe(l).format("DD/MM/YYYY")},{title:"Risk score",dataIndex:"name",width:"120px"},{title:"Days past due",dataIndex:"daysPastDue",render:(l,o,c)=>c===t.length-1?`>=${l}`:`${l} - <${t[c+1].daysPastDue}`},{title:"Advance rate (%)",dataIndex:"advanceRate",align:"right"},{title:"Interest rate (%)",dataIndex:"interestRate",align:"right"},{title:"Probability of default (%)",dataIndex:"probabilityOfDefault",align:"right"},{title:"Loss given default (%)",dataIndex:"lossGivenDefault",align:"right"}].filter(Boolean),[t]);return e.jsxs("div",{className:"flex flex-col items-stretch",children:[e.jsxs(ce,{className:"flex items-center gap-2",children:[e.jsx("div",{className:"font-semibold",children:"Discount rate"}),e.jsx(Le,{autoComplete:"off",placeholder:"Discount rate",precision:2,suffix:"%",min:0,size:"middle",readOnly:!0,value:a})]}),e.jsx(rt,{scroll:{x:1100},pagination:!1,loading:s,dataSource:t.map(l=>({...l,key:l.name})),columns:r})]})},ir=()=>{const{pool:t}=oe(),[s,a]=n.useState(!1),[r,i]=n.useState([]);return n.useEffect(()=>{const l=async()=>{a(!0);try{const o=await Ut.getScorecards(t.id);o&&i(o.map(c=>(delete c.children,{...c,isNewest:!0})))}catch(o){console.error(o)}a(!1)};t.id&&l()},[t.id]),e.jsx("div",{className:"z-10",children:e.jsx(lr,{scorecards:r,isLoading:s})})},cr=[{name:"Assets",key:"assets"},{name:"Filter",key:"filter"},{name:"Risk score",key:"risk_score"}];function dr(){const{notification:t}=Ie.useApp(),{address:s}=it(),{isLoadingNote:a,setRiskScorecardModalVisible:r,pool:i,assets:l}=oe(),o=us(),[c,p]=n.useState(!1),{isPoolAdmin:h}=Xe(g=>g),u=pt(),d=ps.parse(o.search),f=["assets","risk_score","filter"].includes(d.tab)&&d.tab||"assets",y=async()=>{if(l.length)try{p(!0),await Q.updateCredioAssetRatings(i==null?void 0:i.poolContractAddress,s,l.map(g=>g.tokenId)),t.success({message:"Update asset ratings successfully!"})}catch(g){t.error({message:"Failed to update asset ratings",description:g.message})}finally{p(!1)}};return e.jsx(Ct,{defaultActiveKey:["manage_assets"],children:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex mb-4 justify-between",children:[e.jsx("div",{className:"flex gap-2 items-center",children:cr.map(g=>e.jsx(U,{className:`${f===g.key&&"bg-green-500"||"bg-gray-200"} !rounded-lg text-xs`,onClick:()=>{u(o.pathname+`?tab=${g.key}`)},children:g.name},g.key))}),f==="risk_score"&&h&&e.jsx(U,{onClick:()=>{r(!0)},children:"Edit"}),f==="assets"&&e.jsx(U,{loading:c,onClick:y,disabled:!l.length,children:"Update asset ratings with Credio"})]}),!a&&f==="assets"&&e.jsx(Xa,{}),!a&&f==="filter"&&e.jsx(or,{}),f==="risk_score"&&e.jsx(ir,{})]})})}const an=({visible:t,onClose:s,documentId:a,defaultHtmlParse:r})=>{const[i,l]=n.useState(null),[o,c]=n.useState(!1),[p,h]=n.useState(!1),u=async f=>{try{c(!0);const{sasUrl:y}=await ee.getSignedDocumentAttachment(f),g=await ee.getDocumentContentViaURL(y);l(g)}catch(y){console.log("getDocumentDetail error",y)}finally{c(!1)}};n.useEffect(()=>{a&&u(a)},[a]);const d=async()=>{i&&(h(!0),await ka(i),h(!1))};return e.jsx(ve,{onCancel:s,footer:null,width:"100vw",open:t,style:{top:0,padding:0},children:e.jsx(ce,{children:e.jsx(le,{xs:{span:18,offset:3},children:e.jsxs("div",{style:{height:"calc(100vh - 70px)",width:"100%",marginTop:20},children:[o&&e.jsx(Be,{active:!0,loading:!0}),!o&&i&&e.jsxs(e.Fragment,{children:[e.jsx(U,{style:{marginRight:10,marginBottom:20},onClick:d,loading:p,children:"Download"}),r?e.jsx("div",{className:"w-full bg-white overflow-y-auto",style:{maxHeight:"calc(100vh - 120px)"},id:"doc-content",children:Ta(i)}):e.jsx(Ia,{doc:i})]})]})})})})};an.propTypes={visible:$e.bool,onClose:$e.func,documentId:$e.string,defaultHtmlParse:$e.bool};const ur={[De.category.LEGAL]:"Legal document",[De.category.GENERAL]:"General document"},mr=({pool:t={},category:s,isNeedReload:a})=>{const{setDraftingDocModalVisible:r}=oe(),{notification:i}=Ie.useApp(),{isIssuer:l,isOriginator:o}=Xe(A=>A),[c,p]=n.useState({}),[h,u]=n.useState(!1),[d,f]=n.useState(null),[y,g]=n.useState(null),[x,I]=n.useState({}),{loading:v,value:N=[],retry:C}=zs(async()=>{if(!t.id||!a)return;const A=await ee.getLegalList(t.id,s);return(await ee.getDocumentsMetadata(A.map(R=>R.id))).forEach(({id:R,numberOfSignedDocuments:L})=>{const F=A.find(j=>j.id===R);F&&(F.numberOfSignedDocuments=L)}),A},[t.id,s,a]),M=(A,S)=>{I(R=>({...R,[A]:{...R[A]??{},...S}}))},m=async A=>{try{p({...c,[A]:!0}),await ee.deleteDoc(A),C(),i.success({description:"Document has been deleted!"})}catch(S){S!=null&&S.message&&i.error({description:S==null?void 0:S.message})}finally{p({...c,[A]:!1})}},b=A=>{f({documentId:A.id,isSign:A.isSign}),u(!0)},E=A=>{g(A)},$=async(A,S)=>{if(A)try{M(S.id,{loading:!0});const R=await ee.getAllInvestorsSignedDocumentsByPool(S.id,S.poolId);M(S.id,{data:R})}catch{i.error({description:"Failed to load signed documents"})}finally{M(S.id,{loading:!1})}},D=[{title:"Document name",dataIndex:"name",width:150,key:"name"},{title:"Category",dataIndex:"category",width:100,key:"category",render(A,S){return ur[z(S,"category")]}},{title:"Date created",dataIndex:"createdAt",width:100,key:"createdAt",render:A=>Fe(A).format("DD/MM/YYYY")},{title:"Date updated",dataIndex:"updatedAt",width:100,key:"updatedAt",render:A=>Fe(A).format("DD/MM/YYYY")},{title:"Action",width:100,render:(A,S)=>e.jsxs("div",{children:[e.jsx(lt,{placement:"top",title:"View detail",children:e.jsx(U,{type:"text",icon:e.jsx(Tn,{}),onClick:()=>b(S)})}),l&&S.numberOfSignedDocuments===0&&e.jsx(lt,{placement:"top",title:"Delete document",children:e.jsx(Wt,{onConfirm:()=>m(S.id),title:"Are you sure？",okText:"Yes",cancelText:"No",children:c[S.id]?e.jsx(Lt,{size:"small"}):e.jsx(U,{type:"text",icon:e.jsx(Os,{style:{color:"red"}})})})})]})},{title:"Publish",dataIndex:"isPublish",key:"isPublish",width:100,render:(A,S)=>e.jsx(vt,{checked:A,disabled:o,onChange:async()=>{try{await ee.publishDocs(S.id,!A),C(),i.success({description:"Publish status has been updated"})}catch(R){console.log({err:R}),R!=null&&R.message&&i.error({description:R==null?void 0:R.message})}}})}];return e.jsxs("div",{children:[e.jsx(rt,{loading:v,dataSource:N,columns:D,rowKey:A=>A.id,expandable:{onExpand:$,expandIcon:({expanded:A,onExpand:S,record:R})=>R.numberOfSignedDocuments===0||R.category===De.category.GENERAL?null:A?e.jsx(An,{onClick:L=>S(R,L)}):e.jsx(Sn,{onClick:L=>S(R,L)}),expandedRowRender:A=>{if(!x[A.id])return null;const{loading:S,data:R}=x[A.id];return e.jsx(pr,{loading:S,data:R,onClick:L=>{E(L.id)}})}},pagination:!1}),h&&e.jsx(Js,{defaultHtmlParse:!0,poolId:t.id,visible:h,onClose:()=>{u(!1)},reloadGeneratedList:C,preSelectedDocumentId:d==null?void 0:d.documentId,isSign:d==null?void 0:d.isSign,investorSigned:d==null?void 0:d.investorSigned,disableCreateNew:!0,shouldSign:!0,onCreateNewDocument:()=>r(!0)}),y&&e.jsx(an,{defaultHtmlParse:!0,visible:!0,onClose:()=>g(null),documentId:y})]})},pr=({onClick:t,loading:s,data:a})=>{const r=[{title:"Date",dataIndex:"updatedAt",key:"updatedAt",render:i=>Fe(i).format("DD/MM/YYYY HH:mm:ss")},{title:"Name",dataIndex:"name",key:"name"},{title:"Status",dataIndex:"signatureAttached",key:"signatureAttached",render:()=>"Signed"}];return e.jsx(rt,{loading:s,columns:r.concat([{render:(i,l)=>e.jsx(U,{type:"link",onClick:()=>t(l),children:"View detail"})}]),dataSource:a??[],rowKey:i=>i.id})},hr=()=>{const{pool:t}=oe();return e.jsx(mr,{pool:t,isNeedReload:!0})},gr=({setResult:t})=>{const[s,a]=n.useState(!1),r=i=>{const l=i.target.files[0],o=new FileReader;l&&(a(!0),o.onload=async function(c){const p=c.target.result,h={type:"document",mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"},u=await ee.getPresignedURL(h),{key:d,url:f}=u;await ee.uploadFileByPresignedUrl(f,p);const{url:y}=await ee.getPrivateUrlFromUploadedFile({key:d}),{url:g}=await ee.getConvertedFileByPrivateUrl({url:y}),x=await ee.getHtmlPageFromDownloadablePrivateUrl(g);x&&t(x),a(!1)},o.readAsArrayBuffer(l))};return e.jsxs("div",{className:"relative mb-4",children:[e.jsx(Re,{id:"convert-doc",type:"file",onChange:r,accept:".docx",className:"!hidden",disabled:s}),e.jsx("label",{htmlFor:"convert-doc",children:e.jsxs("span",{className:"rounded-lg py-2 px-3 inline-block border border-solid border-gray-200 cursor-pointer hover:border-green-300",children:[s?e.jsx(Lt,{indicator:e.jsx(In,{style:{fontSize:16,marginRight:"4px"},spin:!0})}):e.jsx(Rs,{className:"mr-1 text-lg"}),"Import docx"]})})]})},fr=({templateDetails:t,setTemplateDetails:s})=>e.jsx(Ue,{children:e.jsxs(V,{wrapperCol:{span:24},labelCol:{span:24},children:[e.jsx(V.Item,{label:"Name",className:"mb-4",children:e.jsx(Re,{placeholder:"Name",id:"name",value:t.name,onChange:a=>s({...t,name:a.target.value})})}),e.jsx(V.Item,{label:"Version",className:"mb-4",children:e.jsx(Re,{placeholder:"Version",id:"version",value:t.version,onChange:a=>s({...t,version:a.target.value})})}),e.jsx(V.Item,{label:"Description",className:"mb-4",children:e.jsx(Re,{placeholder:"Description",id:"desc",value:t.desc,onChange:a=>s({...t,desc:a.target.value})})}),e.jsx(V.Item,{label:"Category",className:"mb-4",children:e.jsx(Ze,{placeholder:"Category",id:"category",value:t.category,onChange:a=>s({...t,category:a}),options:[{value:De.category.LEGAL,label:e.jsx("span",{children:"Legal template"})},{value:De.category.GENERAL,label:e.jsx("span",{children:"General template"})}]})}),e.jsx(V.Item,{label:"Draft",className:"mb-4",children:e.jsx(vt,{checked:t.isDraft,onChange:a=>s({...t,isDraft:a.target.checked}),children:"Indicates draft version of template. No valid legal documents will be created from it if checked."})}),e.jsx(V.Item,{label:"Private",className:"mb-4",children:e.jsx(vt,{checked:t.isPrivate,defaultChecked:t.isPrivate,onChange:a=>s({...t,isPrivate:a.target.checked}),children:"Will not be seen by anyone else on the profile."})})]})}),Rt=ms.input`
  border: 0;
  background-image: linear-gradient(#009688, #009688), linear-gradient(#d2d2d2, #d2d2d2);
  background-size:
    0 2px,
    100% 1.5px;
  font-size: 15px;
  background-repeat: no-repeat;
  background-position:
    center bottom,
    center calc(100% - 1px);
  background-color: rgba(0, 0, 0, 0);
  transition: background 0s ease-out;
  padding: 0;
  float: none;
  box-shadow: none;
  border-radius: 0;
  display: block;
  width: 100%;
  height: 34px;
  line-height: 1.42857;
  color: #555555;
  outline: none;

  ::placeholder {
    color: #a9a9a9;
  }

  &:focus {
    outline: none;
    background-image: linear-gradient(#009688, #009688), linear-gradient(#d2d2d2, #d2d2d2);
    background-size:
      100% 2px,
      100% 1px;
    box-shadow: none;
    transition-duration: 0.3s;
    padding: 0;
    float: none;
    border: 0;
    border-radius: 0;
  }
`,Is=ms.select`
  border: 0;
  box-shadow: none;
  border-radius: 0;
  background-image: linear-gradient(#009688, #009688), linear-gradient(#d2d2d2, #d2d2d2);
  background-size:
    0 2px,
    100% 1.5px;
  font-size: 15px;
  background-repeat: no-repeat;
  background-position:
    center bottom,
    center calc(100% - 1px);
  background-color: rgba(0, 0, 0, 0);
  transition: background 0s ease-out;
  padding: 0;
  float: none;
  display: block;
  width: 100%;
  height: 34px;
  line-height: 1.42857;
  color: #555555;
  outline: none;

  &:focus {
    outline: none;
  }
`,rn=({onChangeQuestion:t,item:s,index:a,blockConditions:r,onlyOne:i=!1})=>e.jsx("div",{style:{paddingLeft:i?0:100},children:e.jsxs(ce,{children:[!i&&e.jsx(le,{span:3,children:e.jsx("div",{style:{paddingTop:7,textAlign:"right",fontWeight:"bold",paddingRight:20,color:"rgba(0, 0, 0, 0.84)",textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden"},children:s.variableDisplay})}),e.jsxs(le,{span:i?24:21,children:[e.jsx(Rt,{value:s.content,onChange:l=>t(a,"content",l.target.value),placeholder:"Type related question"}),e.jsx(Rt,{value:s.hint,onChange:l=>t(a,"hint",l.target.value),placeholder:"Type question hint"}),s.answerType==="select"&&e.jsx(Rt,{value:s.options?s.options.selections:"",onChange:l=>t(a,"options.selections",l.target.value),placeholder:"Type options separated by ;"}),e.jsxs(ce,{gutter:32,children:[e.jsx(le,{span:8,children:e.jsxs(Is,{value:s.answerType,onChange:l=>t(a,"answerType",l.target.value),children:[e.jsx("option",{value:"text",children:"Text"}),e.jsx("option",{value:"currency",children:"Currency"}),e.jsx("option",{value:"number",children:"Number"}),e.jsx("option",{value:"date",children:"Date"}),e.jsx("option",{value:"select",children:"Select"})]})}),e.jsx(le,{span:16,children:e.jsx(Rt,{value:s.defaultValue,onChange:l=>t(a,"defaultValue",l.target.value),placeholder:"Insert a default value"})})]}),e.jsx(ce,{style:{marginTop:10},children:e.jsx(vt,{checked:s.isRequired,onChange:l=>t(a,"isRequired",l.target.checked),children:"Required field"})}),e.jsx(ce,{style:{marginTop:10},children:e.jsxs(Is,{style:{width:300},value:s.showCondition,onChange:l=>{t(a,"showOnlyWithBlockId",l.target.value),t(a,"showCondition",l.target.value)},children:[e.jsx("option",{value:null,children:"Always displayed"}),e.jsx("optgroup",{label:"-- Visibility conditions --"}),Object.keys(r||[]).map(l=>{if(l&&r[l])return e.jsx("option",{value:r[l].blockKey,children:r[l].displayFormula},r[l])})]})})]})]})}),xr=({isQuestionDrawerVisible:t,selectedWord:s,onClose:a,blockConditions:r,onSave:i=()=>{}})=>{const[l,o]=n.useState([]),[c,p]=n.useState(null),[h,u]=n.useState(!1),[d,f]=n.useState([]),{text:y,id:g}=s??{};n.useEffect(()=>{let v=!0;return(async()=>{try{const{data:N}=await Q.getPoolQuestionKey();v&&f(N)}catch(N){console.error(N)}})(),()=>{v=!1}},[]);const x=()=>{c&&(i({fieldId:c,selectedWord:s}),a())},I=()=>{is.dispatch(Bt.EDITOR_CANCEL_MARK_WORD),a()};return e.jsxs(kn,{maskClosable:!1,closeIcon:!1,open:!!t,title:h?"Questionnaire setting":"Variable mapping",placement:"right",width:400,onClose:a,children:[e.jsx(Vs,{style:{marginBottom:10},checked:h,onChange:async v=>{u(v)},checkedChildren:"Custom value",unCheckedChildren:"Mapping fields"}),e.jsx("div",{style:{margin:"20px 0 10px 0"},children:y}),h?e.jsx(rn,{onlyOne:!0,onChangeQuestion:(v,N,C)=>{const M=Ke(l,m=>{N==="options.selections"?m[v].options={...m[v].options||{},selections:C}:m[v][N]=C});o(M)},item:l[0],index:0,blockConditions:r}):e.jsx(Ne,{style:{width:220},placeholder:"Variable mapping",items:d,nameKey:"name",selectedValue:c,onSelect:v=>{p(v)}}),e.jsxs("div",{style:{marginTop:20,textAlign:"right"},children:[e.jsx(U,{onClick:I,children:"Cancel"}),e.jsx(U,{onClick:x,style:{marginLeft:10},type:"primary",children:"Save"})]})]})},yr=ms.div`
  background-color: white;
  margin: 1px 0 10px;
  padding: 8px;
  border-radius: 3px;
  border: 1px solid #ddd;
  height: 230px;
`,br=(t,s,a)=>{const r=Array.from(t),[i]=r.splice(s,1);return r.splice(a,0,i),r},jr=({questionnaires:t,setQuestionnaires:s,blockConditions:a,isLegalDocument:r,answers:i,setAnswers:l=()=>{}})=>{const o=p=>{if(!p.destination)return;const h=br(t,p.source.index,p.destination.index),u=Ke(h,d=>{d.forEach((f,y)=>f.variableOrder=y)});s(u)},c=async(p,h,u)=>{const d=Ke(t,g=>{h==="options.selections"?g[p].options={...g[p].options||{},selections:u}:g[p][h]=u}),f=t[p]||{id:null},y=Ke(i,g=>{g[f.id]={...g[f.id]||{},value:u}});s(d),l(y)};return e.jsx(ma,{onDragEnd:o,children:e.jsx(pa,{droppableId:"droppable",children:(p,h)=>e.jsxs("div",{...p.droppableProps,ref:p.innerRef,children:[t.map((u,d)=>{if(!at.checkIsMappingValue(u.defaultValue)){if(u.showOnlyWithBlockId&&!u.showCondition){const f=Object.keys(a).find(y=>a[y].id===u.showOnlyWithBlockId);f&&c(d,"showCondition",a[f].blockKey)}return e.jsx(ha,{draggableId:u.questionId||`${u.id}`,index:d,children:(f,y)=>e.jsxs(yr,{ref:f.innerRef,...f.draggableProps,children:[e.jsx(ga,{className:"m-3 float-left",...f.dragHandleProps}),e.jsx(rn,{blockConditions:a,onChangeQuestion:c,item:u,index:d})]})},u.questionId||`${u.id}`)}}),p.placeholder]})})})},ts="data-fieldid",vr=({pool:t,templateId:s,shouldCreateNewTemplate:a,answers:r,setShouldCreateNewTemplate:i=()=>{},closeModal:l=()=>{},reloadTemplates:o=()=>{},setTemplateId:c=()=>{},setAnswers:p=()=>{},onGenerateDocument:h=u=>{}})=>{const{message:u}=Ie.useApp(),[d,f]=n.useState(!1),[y,g]=n.useState(null),[x,I]=n.useState(!1),[v,N]=n.useState(!1),[C,M]=n.useState({category:De.category.LEGAL}),[m,b]=n.useState([]),[E,$]=n.useState([]),[D,A]=n.useState([]),[S,R]=n.useState(null),[L,F]=n.useState({}),[j,O]=n.useState(!1),[w,K]=n.useState({}),q=P=>{const B=[];for(let _=0;_<P.length;_++){const J=P[_],Z=J.getAttribute("id"),ae=J.getAttribute(ts),Y=J.textContent;B.push({questionId:`_${Math.floor(Math.random()*1e12)}`,variableId:Z,variableOrder:_,variableDisplay:Y,variableNumber:1,defaultValue:ae})}return B},k=()=>{if(!S)return[];const{markers:P}=H();return q(P)},H=()=>{const B=(S==null?void 0:S.getData()).replaceAll("<p>&nbsp;</p>",""),_=new DOMParser().parseFromString(B,"text/html"),J=_.querySelectorAll("mark[id]");for(const ae of J){const Y=w[ae.id];Y&&ae.setAttribute(ts,Y.fieldId)}return{content:_.body.innerHTML,markers:J}},se=async P=>{f(!0);try{const B=await ee.getTemplateDetailV1(P),[_]=await Promise.allSettled([ee.getBlocks(P)]);await de(P);const J=_.status=="fulfilled"?_.value:[];if(B.documentFile.uniqueKey){const Z={};try{const ae=await ee.getDocumentContentURL(P);await ue(ae.sasUrl),J.map(Y=>{Z[Y.blockKey]={...Y.content,id:Y.id}})}catch(ae){console.log("err on set data",ae)}$(Z)}M(B),f(!1)}catch(B){console.log("err: ",B)}},de=async P=>{const B=await ee.getQuestionList(P);b(B)},ue=async P=>{const B=await ee.getDocumentContentViaURL(P);g(B)},fe=async()=>{try{N(!0),await h(C)}finally{N(!1)}},xe=async(P="")=>{if(!S)return;const{content:B}=H();let _="",J="";if(B){if(P){const{sasUrl:Z}=await ee.getUploadTemplateFileUrl(s);_=Z,J=P}else{const{sasUrl:Z,uniqueKey:ae}=await Cs.getFileUploadUrl("legal-template","legal-template",B.length,"text/html");_=Z,J=ae}return await Cs.upload(_,B),J}return""},ne=P=>{const B=[];if(Object.keys(E).forEach(_=>{E[_]&&E[_].blockKey&&B.push({id:E[_].id,showIfNotAnswer:E[_].showIfNotAnswer,blockKey:E[_].blockKey,content:E[_],formula:E[_].formula,displayFormula:E[_].displayFormula})}),P&&typeof P.content=="string"){const _={showIfNotAnswer:P.showIfNotAnswer,blockKey:P.blockKey,content:P,formula:P.formula,displayFormula:P.displayFormula,clauseId:P.clauseId};B.push(_),$({...E,[P.blockKey]:_})}return B},me=async P=>{const B=await ee.getBlocks(P),_={};return B.map(J=>{_[J.blockKey]={...J.content,id:J.id}}),$(_),_},ye=async(P="")=>{if(!P||!S)return;const B=await me(P),_=k();await ee.postQuestions({templateId:P,questions:_.map((J,Z)=>{let ae=null;return J.showCondition&&B[J.showCondition]&&(ae=B[J.showCondition].id),{...J,showOnlyWithBlockId:ae}})})},Ce=async(P=[],B=[])=>{const _=await xe(),J=await ee.createNewTemplate({...C,poolId:t?t.id:null,category:C.category||0,documentFile:{uniqueKey:_},legalClauseIds:B});await ee.postNewBlocks({templateId:J.id,blocks:P.map(Z=>({...Z,id:void 0}))}),await ye(J.id),c(J.id),u.success("Create new template successfully"),i(!1),l(),M({category:De.category.LEGAL}),t||history.push("/legal-documents")},et=async(P=[])=>{const B=ne(P),{content:_}=H(),J=_.match(/clause-id\\="(\d+)"/g)||[],Z={...C.legalClauseIds||{}};J.forEach(Y=>{const pe=Y.match(/\d+/)[0];Z[pe]||(Z[pe]=+pe)});let ae=Jn.get(C,"documentFile.uniqueKey","");ae=await xe(ae),await ee.updateTemplate(C.id,{...C,poolId:t?t.id:null,documentFile:{uniqueKey:ae},legalClauseIds:Z}),await Promise.all([ee.postNewBlocks({templateId:s,blocks:B}),ee.deleteBlocks({templateId:s,blockIds:D})]),A([]),await ye(s),await de(s),u.success("Update template successfully"),o()},Ae=async(P=null)=>{const{content:B}=H();if(!B.trim()){u.error("Template content cannot be empty!");return}const _=B.match(/clause-id\\="(\d+)"/g)||[],J={...C.legalClauseIds||{}};_.forEach(ae=>{const Y=ae.match(/\d+/)[0];J[Y]||(J[Y]=+Y)}),console.log("onCreateUpdateTemplate - results: ",_),I(!0);const Z=ne(P);!s||a?await Ce(Z,J):await et(),I(!1)},Ge=({fieldId:P,selectedWord:B})=>{P&&K(_=>({..._,[B.id]:{...B,fieldId:P}}))};return n.useEffect(()=>{if(y){const B=new DOMParser().parseFromString(y,"text/html").querySelectorAll("mark[id]");for(const _ of B){const J=_.getAttribute(ts),Z=_.getAttribute("id"),ae=_.textContent;J&&Z&&K(Y=>({...Y,[Z]:{text:ae,id:Z,fieldId:J}}))}}},[y]),n.useEffect(()=>{s&&se(s)},[s]),n.useEffect(()=>(is.subscribe(Bt.LEGAL_EDITOR_MARK_A_WORD,({text:P,id:B})=>{const _=k();b(_),F({text:P,id:B}),O(!0)}),()=>{is.unSubscribeEvents([Bt.LEGAL_EDITOR_MARK_A_WORD,Bt.LEGAL_EDITOR_REMOVE_A_MARKER])}),[S,m]),e.jsxs(e.Fragment,{children:[d?e.jsx(Be,{loading:!0,active:!0}):e.jsxs("div",{className:"relative mt-2",children:[e.jsx(Fs,{animated:{tabPane:!1,inkBar:!0},defaultActiveKey:"Overview",items:[{key:"Overview",label:"Overview",children:e.jsx(fr,{templateDetails:C,setTemplateDetails:M})},{key:"Template",label:"Template",style:{height:500},forceRender:!0,children:e.jsxs("div",{className:"h-full",children:[e.jsx(gr,{setResult:g}),e.jsx(fa,{setEditorState:R,content:y})]})},{key:"questionnaires",label:"Questionnaires",style:{height:500},children:e.jsx("div",{className:"h-full",children:e.jsx(jr,{questionnaires:m,setQuestionnaires:b,answers:r,setAnswers:p})})}],className:"font-semibold h-full"}),e.jsxs(ce,{className:"absolute top-1 right-0",children:[e.jsxs(U,{className:"mr-2",loading:x,disabled:!C.name||!C.version,onClick:Ae,size:"large",type:"primary",children:[e.jsx(En,{})," Save template"]}),!a&&e.jsx(U,{loading:v,onClick:fe,size:"large",type:"dashed",children:"Generate document"})]})]}),j&&e.jsx(xr,{isQuestionDrawerVisible:j,blockConditions:E,selectedWord:L,onClose:()=>O(!1),onSave:Ge})]})},Cr={[De.category.LEGAL]:"Legal template",[De.category.GENERAL]:"General template"},wr=({pool:t,reloadPool:s})=>{const{isSuperAdmin:a,isIssuer:r}=Xe(D=>D),[i,l,o]=Ve(ee.getTemplateList,t?t.id:null),[c,p]=n.useState({}),[h,u]=n.useState(!1),[d,f]=n.useState(null),[y,g]=n.useState(!1),[x,I]=n.useState(null),[v,N]=n.useState({}),[C,M]=n.useState(new Set),m=()=>{u(!1),f(null),o()},b=async D=>{M(A=>new Set(A).add(D.id));try{let A=x;if(!A){const R=await ee.createNewDocument({id:x,vaultId:t==null?void 0:t.id,templateId:D.id,name:D.name});I(R.id),A=R.id}const S=[];Object.keys(v).map(R=>S.push({questionId:R,value:v[R].value,id:v[R].id})),await ee.createAnswers({documentId:A,answers:S}),Pe.success("Generated document successfully"),m()}catch(A){console.log(A),Pe.error("Please check your anwsers again")}finally{M(A=>(A.delete(D.id),new Set(A)))}},E=async D=>{try{p({...c,[D]:!0}),await ee.deleteTemplate(D),o(),Pe.success("Delete template successfully")}catch(A){console.log(A),Pe.error("Something wrong! Cannot delete template")}finally{p({...c,[D]:!1})}},$=[{title:"Template title",dataIndex:"name",key:"name"},{title:"Category",dataIndex:"category",key:"category",render(D){return Cr[D]}},{title:"Date updated",dataIndex:"updatedAt",key:"updatedAt",render:D=>Fe(D).format("DD/MM/YYYY")},{title:"Action",key:"action",render:(D,A)=>{const S=a||r;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(lt,{placement:"top",title:"Edit document",children:e.jsx(U,{type:"text",icon:e.jsx(os,{}),onClick:()=>{f(A.id),g(!1),u(!0)}})}),e.jsx(lt,{placement:"top",title:"Generate document",children:e.jsx(U,{type:"text",icon:e.jsx(Ln,{}),loading:C.has(A.id),onClick:()=>b(A)})}),S&&e.jsx(lt,{placement:"top",title:"Delete document",children:e.jsx(Wt,{onConfirm:()=>E(A.id),title:"Are you sure？",okText:"Yes",cancelText:"No",children:c[A.id]?e.jsx(Lt,{size:"small"}):e.jsx(U,{type:"text",icon:e.jsx(Os,{style:{color:"red"}})})})})]})}}];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("div",{className:"absolute right-0 -top-12",children:e.jsxs(U,{className:"!bg-transparent border-solid border-[#1ED760] border-2 text-black !rounded-xl shadow-none",onClick:()=>{u(!0),g(!0)},type:"primary",children:[e.jsx(Rs,{})," New Template"]})}),e.jsx(rt,{dataSource:i,columns:$,loading:l,pagination:!1,rowKey:D=>D.id})]}),h&&e.jsx(ve,{onCancel:()=>{u(!1),f(null)},footer:null,width:"70%",open:h,style:{top:0},centered:!0,children:e.jsx("div",{className:"pt-5 h-screen overflow-auto",children:e.jsx(vr,{shouldCreateNewTemplate:y,closeModal:m,setTemplateId:f,templateId:d,pool:t,reloadPool:s,reloadTemplates:o,setShouldCreateNewTemplate:g,onGenerateDocument:b,answers:v,setAnswers:N})})})]})},Nr=()=>{const{pool:t,reloadPool:s}=oe();return e.jsx(ce,{gutter:16,style:{padding:"0 24px"},children:e.jsx(le,{xs:24,lg:24,children:e.jsx(wr,{pool:t,reloadPool:()=>{s()}})})})};function Ar(){const{isOriginator:t}=Xe(c=>c),{isLoadingNote:s}=oe(),a=ps.parse(window.location.search),r=pt(),i=us(),l=[{name:"Doc generated",key:"doc_generated"},!t&&{name:"Doc template",key:"doc_template"}].filter(Boolean),o=["doc_generated","doc_template"].includes(a.tab)&&a.tab||"doc_generated";return e.jsx(Ct,{defaultActiveKey:["pools_setting"],children:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex gap-2 mb-4",children:l.map(c=>e.jsx(U,{className:`${o===c.key&&"bg-green-500"||"bg-gray-200"} !rounded-lg text-xs`,onClick:()=>{r(i.pathname+`?tab=${c.key}`)},children:c.name},c.key))}),!s&&o==="doc_generated"&&e.jsx(hr,{}),!s&&o==="doc_template"&&e.jsx(Nr,{})]})})}const Sr=function({pool:t,visible:s,onClose:a}){const{message:r}=Ie.useApp(),[i,l]=n.useState(0),[o,c]=n.useState(0),[p,h]=n.useState(!0),u=t.id,[d,f]=n.useState(!1),y=async()=>{var I,v;h(!0);try{const N=await Q.getEpochSetting(u);l(((I=N==null?void 0:N.result)==null?void 0:I.epochInterval)||0),c(((v=N==null?void 0:N.result)==null?void 0:v.epochInterval)||0)}catch(N){console.log(N)}h(!1)};n.useEffect(()=>{y()},[]);const g=async()=>{f(!0);try{await Q.updateEpochSetting(u,parseInt(o)),l(o),a(),r.success("Update epoch successfully")}catch{r.error("Update epoch failed")}f(!1)},x={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(ve,{onCancel:a,footer:null,width:"35vw",centered:!0,style:{minWidth:410},open:s,styles:x,children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-lg mb-6",children:"Set epoch duration"}),p?e.jsx(Be,{}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2",children:"Epoch duration"}),e.jsx("div",{children:e.jsx(Re,{value:o,placeholder:"Enter number",onChange:I=>c(I.target.value),suffix:"days",type:"number"})}),e.jsx("div",{className:"mt-8",children:e.jsx(U,{className:"shadow-none w-full mb-1 h-10",type:"primary",onClick:()=>g(),disabled:o===i,loading:d,children:"Submit"})})]})]})})},Tr={"document currency":"invoiceCurrency",ledger:"ledger",country:"country","document reference":"openItemId","parent (trust) number":"parentTrustNumber","account number":"accountRefNumber","invoice date":"invoiceDate","net value":"netAmount","vat amount":"taxAmount","gross value":"grossAmount","eligible value":"eligibleAmount","primary ineligible":"eligibleForPool","primary ineligible reason":"ineligibleReason.primaryIneligible","ineligible - approved receivables debtor jurisdiction":"ineligibleReason.approvedReceivablesDebtorJurisdiction","ineligible - debtor insolvency":"ineligibleReason.debtorInsolvency","ineligible - receivables ageing":"ineligibleReason.receivablesAgeing","ineligible - payment term":"ineligibleReason.paymentTerm","ineligible - cross ageing":"ineligibleReason.crossAgeing","ineligible - other ineligible":"ineligibleReason.other","exclusion - intercompany trade":"exclusionReason.intercompanyTrade","exclusion - debtor contract issues - re ban on assignment and confidentiality":"exclusionReason.debtorContractIssues","exclusion - debtor unapproved jurisdiction":"exclusionReason.debtorUnapprovedJurisdiction","customer email":"buyerEmail","matched customer name":"buyerName","payment due date":"invoiceDueDate","invoice due date":"invoiceDueDate","open item id":"openItemId","debtor id":"debtorId","purchase/sales order":"purchaseSalesOrder","dispute code":"disputeCode","ineligible invoice flag":"ineligibleFlag","selling entity code":"sellingEntityCode","payment method":"externalPaymentMethod","external payment method":"externalPaymentMethod","external status":"externalStatus","invoice status":"externalStatus","debtor name":"debtorName","debtor address 1":"debtorAddress1","debtor address 2":"debtorAddress2","debtor address 3":"debtorAddress3","debtor address 4":"debtorAddress4","debtor address1":"debtorAddress1","debtor address2":"debtorAddress2","debtor address3":"debtorAddress3","debtor address4":"debtorAddress4","debtor country":"debtorCountry","debtor contact name":"debtorContactName","debtor contact phone number":"debtorContactPhoneNumber","debtor entity registered number":"debtorEntityRegisteredNumber","asset score":"riskscore"},Ir={"pool cut-off date":"poolCutoffDate","pool identifier":"poolIdentifier","loan identifier":"loanIdentifier",originator:"originator","servicer identifier":"servicerIdentifier","servicer name":"servicerName","borrower identifier":"borrowerIdentifier","group company identifier":"groupCompanyIdentifier",country:"country",postcode:"postcode","borrower basel iii segment":"borrowerSegment","loan origination date":"startedDate","borrower email":"debtorEmail","original loan balance":"principalAmount","current balance":"outstandingPrincipalAmount","loan denomination currency":"currencySymbol","obligor legal form / business type":"businessType","current interest rate":"interestRatePercentage","final maturity date":"finalMaturityDate","liquidation ratio":"liquidationRatio","min collateral ratio":"minCollateralRatio","originator affiliate":"originatorAffiliate","asset type":"assetType",seniority:"seniority","bank internal loss given default (lgd) estimate":"LGD","nace industry code":"NACEIndustryCode","securitised loan amount":"securitisedLoanAmount","type of loan":"typeOfLoan","balloon amount":"balloonAmount","payment type":"paymentType","principal payment frequency":"principalPaymentFrequency","interest payment frequency":"interestPaymentFrequency","amortization type":"amortizationType","interest cap rate":"interestCapRate","interest floor rate":"interestFloorRate","interest rate type":"interestRateType","current interest rate index":"currentInterestRateIndex","current interest rate margin":"currentInterestRateMargin","interest reset period":"interestResetPeriod","interest arrears amount":"interestArrearsAmount","number of days in interest arrears":"numberOfDaysInInterestArrears","principal arrears amount":"principalArrearsAmount","number of days in principal arrears":"numberOfDaysInPrincipalArrears","default date":"defaultDate","default amount":"defaultAmount","cumulative recoveries":"cumulativeRecoveries","allocated losses":"allocatedLosses","date loss allocated":"dateLossAllocated","loan hedged":"loanHedged","asset score":"riskscore"},kr={"pool cut-off date":"poolCutoffDate","cut-off date":"poolCutoffDate","cross collateralisation in counterparty group":"nplCounterpartyInfo.crossCollateralisationInCounterpartyGroup","counterparty role":"nplCounterpartyInfo.counterpartyRole","legal type of counterparty":"nplCounterpartyInfo.legalTypeOfCounterparty","date of last contact":"nplCounterpartyInfo.dateOfLastContact","name of insolvency/restructuring proceedings":"nplCounterpartyInfo.nameOfInsolvencyRestructuringProceedings","additional name of insolvency/restructuring proceedings":"nplCounterpartyInfo.additionalNameOfInsolvencyRestructuringProceedings","legal procedure type":"nplCounterpartyInfo.legalProcedureType","description of legal procedure type":"nplCounterpartyInfo.descriptionOfLegalProcedureType","commencement date of insolvency/restructuring proceedings":"nplCounterpartyInfo.commencementDateOfInsolvencyRestructuringProceedings","stage reached in insolvency/restructuring procedure":"nplCounterpartyInfo.stageReachedInInsolvencyRestructuringProcedure","additional stage reached in insolvency/restructuring procedure":"nplCounterpartyInfo.additionalStageReachedInInsolvencyRestructuringProcedure","insolvency practitioner appointed":"nplCounterpartyInfo.insolvencyPractitionerAppointed","date of appointment":"nplCounterpartyInfo.dateOfAppointment","proof of claim filed by the seller":"nplCounterpartyInfo.proofOfClaimFiledByTheSeller","distribution made to the seller":"nplCounterpartyInfo.distributionMadeToTheSeller","notice for procedure termination":"nplCounterpartyInfo.noticeForProcedureTermination","date of external demand issuance":"nplCounterpartyInfo.dateOfExternalDemandIssuance","date when reservation of rights letter was issued":"nplCounterpartyInfo.dateWhenReservationOfRightsLetterWasIssued","jurisdiction of court":"nplCounterpartyInfo.jurisdictionOfCourt","date of obtaining order for possession":"nplCounterpartyInfo.dateOfObtainingOrderForPossession","comments on other litigation related process":"nplCounterpartyInfo.commentsOnOtherLitigationRelatedProcess","date origination":"startedDate","asset class":"assetType",purpose:"purpose","amortization type":"amortizationType","loan currency":"currencySymbol","principal balance":"principalAmount","total balance":"outstandingPrincipalAmount","current interest rate":"interestRatePercentage","current interest rate type":"interestRateType","current interest margin":"currentInterestRateMargin","interest cap rate":"interestCapRate","interest floor rate":"interestFloorRate","principal payment frequency":"principalPaymentFrequency","interest payment frequency":"interestPaymentFrequency","date of default":"defaultDate","balance at default":"defaultAmount","governing law of loan agreement":"nplInfo.governingLawOfLoanAgreement","product type":"nplInfo.productType","description of bespoke repayment":"nplInfo.descriptionOfBespokeRepayment","final bullet repayment":"nplInfo.finalBulletRepayment","current maturity date":"nplInfo.currentMaturityDate","description of current interest rate type":"nplInfo.descriptionOfCurrentInterestRateType","current interest base rate":"nplInfo.currentInterestBaseRate","legal balance":"nplInfo.legalBalance","current interest rate reference":"nplInfo.currentInterestRateReference","start date of interest only period":"nplInfo.startDateOfInterestOnlyPeriod","end date of interest only period":"nplInfo.endDateOfInterestOnlyPeriod","start date of current fixed interest period":"nplInfo.startDateOfCurrentFixedInterestPeriod","end date of current fixed interest period":"nplInfo.endDateOfCurrentFixedInterestPeriod","current reversion interest rate":"nplInfo.currentReversionInterestRate","last payment date":"nplInfo.lastPaymentDate","last payment amount":"nplInfo.lastPaymentAmount","interest payment frequency":"nplInfo.interestPaymentFrequency","total past-due amount":"nplInfo.totalPastDueAmount","days in past-due":"nplInfo.daysInPastDue","loan status":"nplInfo.loanStatus","non-performing reason":"nplInfo.nonPerformingReason","charge-off date":"nplInfo.chargeoffDate","syndicated loan":"nplInfo.syndicatedLoan","syndicated portion":"nplInfo.syndicatedPortion",securitised:"nplInfo.securitised","marp applicable":"nplInfo.marpApplicable","marp entry":"nplInfo.marpEntry","marp status":"nplInfo.marpStatus","history of legal unpaid balances":"nplInplHistoricalInfo.historyOfLegalUnpaidBalances","history of past - due balances":"nplInplHistoricalInfo.historyOfPastDueBalances","history of total repayments":"nplInplHistoricalInfo.historyOfTotalRepayments","history of repayments - not from asset sales":"nplInplHistoricalInfo.historyOfRepaymentsNotFromAssetSales","history of repayments - from asset sales":"nplInplHistoricalInfo.historyOfRepaymentsFromAssetSales","type of identifier":"nplExternalCollection.typeOfIdentifier","cash recoveries":"nplExternalCollection.cashRecoveries","costs accrued":"nplExternalCollection.costsAccrued","repayment plan":"nplExternalCollection.repaymentPlan","type of identifier":"nplForbearance.typeOfIdentifier","type of forbearance":"nplForbearance.typeOfForbearance","description of forbearance":"nplForbearance.descriptionOfForbearance","date of first forbearance":"nplForbearance.dateOfFirstForbearance","number of historical forbearance":"nplForbearance.numberOfHistoricalForbearance","principal forgiveness":"nplForbearance.principalForgiveness","date of principal forgiveness":"nplForbearance.dateOfPrincipalForgiveness","start date of forbearance":"nplForbearance.startDateOfForbearance","end date of forbearance":"nplForbearance.endDateOfForbearance","repayment amount under forbearance":"nplForbearance.repaymentAmountUnderForbearance","repayment frequency under forbearance":"nplForbearance.repaymentFrequencyUnderForbearance","type of property":"nplPropertyCollateral.typeOfProperty","type of occupancy":"nplPropertyCollateral.typeOfOccupancy","address of property":"nplPropertyCollateral.addressOfProperty","city of property":"nplPropertyCollateral.cityOfProperty","geographic region of property":"nplPropertyCollateral.geographicRegionOfProperty","property postcode":"nplPropertyCollateral.propertyPostcode","property country":"nplPropertyCollateral.propertyCountry",tenure:"nplPropertyCollateral.tenure","remaining term of leasehold":"nplPropertyCollateral.remainingTermOfLeasehold","building area (m2)":"nplPropertyCollateral.buildingAreaM","building area (m2) lettable":"nplPropertyCollateral.buildingAreaMLettable","building area (m2) occupied":"nplPropertyCollateral.buildingAreaMOccupied","land area (m2)":"nplPropertyCollateral.landAreaM","latest valuation amount":"nplPropertyCollateral.latestValuationAmount","date of latest valuation":"nplPropertyCollateral.dateOfLatestValuation","internal/external latest valuation":"nplPropertyCollateral.internalExternalLatestValuation","type of latest valuation":"nplPropertyCollateral.typeOfLatestValuation","latest estimated rental value":"nplPropertyCollateral.latestEstimatedRentalValue","current annual passing rent":"nplPropertyCollateral.currentAnnualPassingRent","current opex and overheads":"nplPropertyCollateral.currentOpexAndOverheads","planned capex next 12m":"nplPropertyCollateral.plannedCapexNextM","current net operating income":"nplPropertyCollateral.currentNetOperatingIncome","amount of vat payable":"nplPropertyCollateral.amountOfVatPayable","completion of property":"nplPropertyCollateral.completionOfProperty","percentage complete":"nplPropertyCollateral.percentageComplete","enforcement status":"nplPropertyCollateral.enforcementStatus","enforcement status third parties":"nplPropertyCollateral.enforcementStatusThirdParties","mortgage amount":"nplRelationshipInfo.mortgageAmount","lien position":"nplRelationshipInfo.lienPosition","higher ranking loan":"nplRelationshipInfo.higherRankingLoan","collateral type":"nplNonPropertyCollateral.collateralType",description:"nplNonPropertyCollateral.description","currency of collateral":"nplNonPropertyCollateral.currencyOfCollateral","guarantee amount":"nplNonPropertyCollateral.guaranteeAmount","latest valuation amount":"nplNonPropertyCollateral.latestValuationAmount","date of latest valuation":"nplNonPropertyCollateral.dateOfLatestValuation","type of latest valuation":"nplNonPropertyCollateral.typeOfLatestValuation","enforcement status":"nplNonPropertyCollateral.enforcementStatus","lien position":"nplRelationshipNonProperty.lienPosition","higher ranking loan":"nplRelationshipNonProperty.higherRankingLoan","currency of enforcement":"nplEnforcement.currencyOfEnforcement","indicator of enforcement":"nplEnforcement.indicatorOfEnforcement","enforcement description":"nplEnforcement.enforcementDescription","court appraisal amount":"nplEnforcement.courtAppraisalAmount","date of court appraisal":"nplEnforcement.dateOfCourtAppraisal","current market status":"nplEnforcement.currentMarketStatus","on market price":"nplEnforcement.onMarketPrice","offer price":"nplEnforcement.offerPrice","sale agreed price":"nplEnforcement.saleAgreedPrice","gross sale proceeds":"nplEnforcement.grossSaleProceeds","costs at end of sale":"nplEnforcement.costsAtEndOfSale","net sale proceeds":"nplEnforcement.netSaleProceeds","collateral repossessed date":"nplEnforcement.collateralRepossessedDate","prepare property for sale date":"nplEnforcement.preparePropertyForSaleDate","property on market date":"nplEnforcement.propertyOnMarketDate","on market offer date":"nplEnforcement.onMarketOfferDate","sale agreed date":"nplEnforcement.saleAgreedDate","contracted date":"nplEnforcement.contractedDate","sold date":"nplEnforcement.soldDate","first auction date":"nplEnforcement.firstAuctionDate","court auction reserve price for first auction":"nplEnforcement.courtAuctionReservePriceForFirstAuction","next auction date":"nplEnforcement.nextAuctionDate","court auction reserve price for next auction":"nplEnforcement.courtAuctionReservePriceForNextAuction","last auction date":"nplEnforcement.lastAuctionDate","court auction reserve price for last auction":"nplEnforcement.courtAuctionReservePriceForLastAuction","number of failed auctions":"nplEnforcement.numberOfFailedAuctions","indicator of receivership":"nplEnforcement.indicatorOfReceivership","pool identifier":"poolIdentifier","loan identifier":"loanIdentifier",originator:"originator","servicer identifier":"servicerIdentifier","servicer name":"servicerName","borrower identifier":"borrowerIdentifier","group company identifier":"groupCompanyIdentifier",country:"country",postcode:"postcode","business type":"businessType","borrower basel iii segment":"borrowerSegment","borrower email":"debtorEmail","obligor legal form / business type":"businessType","obligor legal form":"businessType","business type":"businessType","final maturity date":"finalMaturityDate","liquidation ratio":"liquidationRatio","min collateral ratio":"minCollateralRatio","originator affiliate":"originatorAffiliate",seniority:"seniority","bank internal loss given default (lgd) estimate":"LGD","nace industry code":"NACEIndustryCode","securitised loan amount":"securitisedLoanAmount","type of loan":"typeOfLoan","balloon amount":"balloonAmount","payment type":"paymentType","current interest rate index":"currentInterestRateIndex","interest reset period":"interestResetPeriod","interest arrears amount":"interestArrearsAmount","number of days in interest arrears":"numberOfDaysInInterestArrears","principal arrears amount":"principalArrearsAmount","number of days in principal arrears":"numberOfDaysInPrincipalArrears","cumulative recoveries":"cumulativeRecoveries","allocated losses":"allocatedLosses","date loss allocated":"dateLossAllocated","loan hedged":"loanHedged"},on=[{id:1,name:"SME Loans",labelsMapping:Ir},{id:2,name:"Invoices",labelsMapping:Tr},{id:3,name:"SME NPL",labelsMapping:kr}],Er=["startedDate","currencySymbol","loanIdentifier","finalMaturityDate","outstandingPrincipalAmount","principalAmount"],ln={PLEDGE:1};function cs({isUnrecognizedColumn:t,label:s,onEdit:a}){return t?e.jsxs("div",{onClick:a,className:"cursor-pointer",children:[e.jsx("span",{className:"text-red-400 mr-1",children:"Not recognized"}),e.jsx(os,{})]}):e.jsxs("div",{onClick:a,className:"cursor-pointer",children:[e.jsx("span",{className:"mr-1",children:s||""}),e.jsx(os,{})]})}const cn=n.createContext({stepAction:{next:()=>{},prev:()=>{},force:()=>{}},currentStep:0,isFetchingAssetMapping:!1,rawFile:{},setRawFile:()=>{},assetsMapping:{},setAssetsMapping:()=>{},columns:[],setColumns:()=>{},assets:[],setAssets:()=>{},selectedColumn:null,setSelectedColumn:()=>{},validator:null,setValidator:()=>{},validationType:3,setValidationType:()=>{},assetPurpose:ln.PLEDGE,setAssetPurpose:()=>{},dataset:null,setDataset:()=>{},dataType:"ACTUAL",setDataType:()=>{},memberMetadata:null,isUploading:!1,setUploading:()=>{},assetsClass:null,mappingAsset:()=>{},resetMapping:()=>{},validateInvoiceAssets:()=>{},agreementModalVisible:!1,setAgreementModalVisible:()=>{},startUploading:()=>{},selectedAssets:[],setSelectedAssets:()=>{}}),dn=({children:t,countries:s})=>{var Ge;const{address:a}=it(),{message:r,notification:i}=Ie.useApp(),{pool:l}=oe(),[o,c]=n.useState(ln.PLEDGE),[p,h]=n.useState(null),[u,d]=n.useState("ACTUAL"),[f,y]=n.useState(3),[g,x]=n.useState(null),[I,v]=n.useState({}),[N,C]=n.useState(null),[M,m]=n.useState([]),[b,E]=n.useState([]),[$,D]=n.useState(null),[A,S]=n.useState(!1),[R,L]=n.useState(!1),[F,j]=n.useState([]),[O,w]=n.useState(!0),[K,q]=n.useState(0),[k,H]=n.useState(""),se=n.useMemo(()=>on.find(P=>P.id===ie.LENDING),[]),[de,ue]=n.useState(Ea(se.labelsMapping)),fe=n.useRef(null),xe=n.useCallback(async()=>{try{const P=await Zn.getProfile();if(D(P.data.metadata),P.data.metadata&&P.data.metadata.assetsMapping&&P.data.metadata.assetsMapping[ie.LENDING]){const B=P.data.metadata.assetsMapping[ie.LENDING];fe.current=Qs(se.labelsMapping,B),ue(fe.current)}}catch(P){console.log(P)}w(!1)},[se.labelsMapping]),ne=async()=>{const{walletAddress:P}=await mt.getLinkedWallet();console.log("{ walletAddress: linkedWalletAddress }: ",{walletAddress:P}),H(P)};n.useEffect(()=>{ne()},[]),n.useEffect(()=>{xe()},[xe]);const me=n.useCallback(()=>{K!==3&&q(K+1)},[K]),ye=n.useCallback(()=>{K!=0&&q(K-1)},[K]),Ce=(P,B)=>{const _=B||de,J=P.data[0].map((Y,pe)=>{var re,Se;return Y&&(Y=(re=Y==null?void 0:Y.trim)==null?void 0:re.call(Y)),_[(Se=Y==null?void 0:Y.toLowerCase)==null?void 0:Se.call(Y)]?Y:`NOT_RECOGNIZED_${pe}`}),Z=[];for(let Y=1;Y<P.data.length;Y++){const pe={};P.data[Y].forEach((re,Se)=>{var be;const ke=J[Se],_e=(be=ke==null?void 0:ke.toLowerCase)==null?void 0:be.call(ke);pe[_[_e]||ke]=re}),Z.push(pe)}const ae=J.map((Y,pe)=>{var _e;const re=(_e=Y==null?void 0:Y.toLowerCase)==null?void 0:_e.call(Y),Se=Y.includes("NOT_RECOGNIZED_"),ke=(()=>{if(se!=null&&se.labelsMapping&&_[re]){const be=Object.keys(se==null?void 0:se.labelsMapping).find(G=>(se==null?void 0:se.labelsMapping[G])===_[re]);return be?Gt(be):Gt(re)}return P.data[0][pe]})();return{title:e.jsx(cs,{isUnrecognizedColumn:Se,label:ke,onEdit:()=>{C(pe)}}),dataIndex:_[re]||Y,key:_[re]||Y,width:200,wordWrap:"break-word",wordBreak:"break-word",originalLabel:P.data[0][pe]}});m(ae),E(Z)},et=()=>{Ce(I,fe.current),ue(fe.current)},Ae=n.useCallback(async(P,B)=>{var _,J,Z,ae;if(!P)return L(!0);S(!0);try{const Y=(_=l==null?void 0:l.validatorMember)==null?void 0:_.email;let pe=null;switch(u==="TEST"&&p&&(pe=p),se.id){case 2:{(await Et.bulkUploadTransfer(l.id,{dataset:pe,receivableItems:Et.makeFormDataForBulkUpload(F,{countries:s,needToBeAcceptedByBuyer:f===2}),approverEmail:Y,approveNeeded:f!==3,assetPurpose:o,signature:P,signerName:B})).message==="success"&&q(4);break}case 3:await ut.bulkUploadTransfer(l.id,{dataset:pe,data:ut.makeFormDataForNplBulkUpload(F,{countries:s}),approverEmail:Y,approveNeeded:f!==3,assetPurpose:o,signature:P,signerName:B});break;case 1:default:{if(a&&((J=a==null?void 0:a.toLowerCase)==null?void 0:J.call(a))!==((Z=k==null?void 0:k.toLowerCase)==null?void 0:Z.call(k)))return i.error({message:`Current wallet address is not valid. Please connect to wallet ${k}`});const re=await ut.bulkUploadTransfer(l.id,{dataset:pe,data:ut.makeFormDataForBulkUpload(F,{countries:s}),approverEmail:Y,approveNeeded:f!==3,assetPurpose:o,signature:P,signerName:B,LATReceiver:k}),Se=Object.keys(re.errors||{}).filter(ke=>{var _e,be;return((be=(_e=re==null?void 0:re.errors)==null?void 0:_e[ke])==null?void 0:be.length)>0}).length||0;if(Se>0)throw new Error(`${Se} collaterals have been failed to upload`);if(((ae=re==null?void 0:re.debtOrderContracts)==null?void 0:ae.length)>0){const _e={dataset:null,data:(re==null?void 0:re.debtOrderContracts).map(be=>be.id),approverEmail:Y,approveNeeded:f!==3,assetPurpose:o,LATReceiver:k};await ut.getMintLATParam(l==null?void 0:l.id,_e)}q(4)}}S(!1),L(!1)}catch(Y){console.log("Upload-lending error: ",Y),r.error("Fail to upload collaterals"),L(!1),S(!1)}},[(Ge=l==null?void 0:l.validatorMember)==null?void 0:Ge.email,l.id,u,p,se.id,F,s,f,o,a]);return e.jsxs(cn.Provider,{value:{stepAction:{next:me,prev:ye,force:P=>{q(P)}},currentStep:K,rawFile:I,setRawFile:v,assetsMapping:de,setAssetsMapping:ue,columns:M,setColumns:m,assets:b,setAssets:E,selectedColumn:N,setSelectedColumn:C,validator:g,setValidator:x,validationType:f,setValidationType:y,assetPurpose:o,setAssetPurpose:c,dataset:p,setDataset:h,dataType:u,setDataType:d,memberMetadata:$,isUploading:A,setUploading:S,assetsClass:se,mappingAsset:Ce,resetMapping:et,agreementModalVisible:R,setAgreementModalVisible:L,startUploading:Ae,countries:s,selectedAssets:F,setSelectedAssets:j,isFetchingAssetMapping:O},children:[e.jsx(e.Fragment,{children:t}),!!R&&e.jsx(Hs,{legalDocumentId:l.uploadAssetLegalDocumentId,visible:R,needSigner:!0,onClose:()=>{L(!1)},onSubmit:Ae})]})};dn.propTypes={children:$e.element};const ht=()=>n.useContext(cn);function Lr({validatorCompanyId:t}){const[s,a]=n.useState([]),r=n.useCallback(async i=>{const l=await It.getUsersByCompanyId(i);a(l)},[]);return n.useEffect(()=>{t&&r(t)},[r,t]),{validators:s}}const{Option:ss}=Ze;function Pr(){const{stepAction:t,validationType:s,setValidationType:a,validator:r,setValidator:i,setRawFile:l,mappingAsset:o,isFetchingAssetMapping:c}=ht(),{pool:p}=oe(),{validators:h}=Lr({validatorCompanyId:p.validatorCompanyId}),[u,d]=n.useState({}),[f,y]=n.useState(!1);n.useEffect(()=>{const{validatorMemberId:v}=p;let N;v?N=1:N=3,a(N),i(v)},[p,a,i]);const g=n.useCallback(v=>{const N=v.target.files[0];d({name:N.name,file:N})},[]),x=n.useMemo(()=>on.find(v=>v.id===ie.LENDING),[]),I=()=>{y(!0),ya.parse(u.file,{skipEmptyLines:!0,complete:function(v){l(v),o(v),y(!1),t.next()}})};return e.jsx(ce,{gutter:[16],children:e.jsx(le,{xs:24,md:{span:20,offset:2},children:e.jsx(Ue,{children:e.jsxs(V,{layout:"vertical",className:"mt-5",children:[e.jsx(V.Item,{label:"CSV File",children:e.jsx(xa,{id:"collateralProjectFile",uploadedFileData:{},fileData:{fileName:u==null?void 0:u.name},onFileChange:v=>g(v),placeholder:"Choose a CSV file",accept:".csv"})}),e.jsx(V.Item,{label:"Approval options",children:e.jsxs(X,{type:"select",value:s,placeholder:"Approval options",disabled:!0,defaultValue:!0,onChange:v=>a(v),children:[e.jsxs(ss,{value:1,children:[x.id===2?"Invoice":"Loan"," to be approved"]}),x.id===2&&e.jsx(ss,{value:2,children:"Invoice to be accepted by Buyer"}),e.jsx(ss,{value:3,children:"No Validator"})]})}),s===1&&e.jsx(V.Item,{label:"Validator",children:e.jsx(Ne,{isMember:!0,type:"select",allowNewValue:!0,items:h,nameKey:"email",disabled:!0,placeholder:"Validator",selectedValue:r,onSelect:v=>{i(v)}})}),e.jsx("div",{className:"flex justify-end mt-5",children:e.jsx(U,{type:"primary",loading:f||c,disabled:c||!(u!=null&&u.file),onClick:()=>{I()},children:"Next"})})]})})})})}const un=({columns:t,datasource:s})=>e.jsx("div",{style:{overflowX:"auto"},children:e.jsx(ba,{bordered:!0,width:t.length*250,headerStyle:{textTransform:"capitalize"},height:300,headerHeight:50,rowHeight:50,rowCount:s.length,rowGetter:({index:a})=>s[a],children:t.map(a=>e.jsx(ja,{headerRenderer:()=>a.title,dataKey:a.dataIndex,width:250},a.dataIndex))})});un.propTypes={columns:$e.array,datasource:$e.array};const Dr=_s.memo(un),{Option:ks}=Ze,Mr=[{name:"number",value:"number"},{name:"text",value:"text"},{name:"date",value:"datetime"},{name:"bool",value:"bool"}],Fr=({onClose:t,selectedColumn:s,onChangeFieldName:a})=>{const{assetsClass:r}=ht(),[i,l]=n.useState({value:null}),[o,c]=n.useState(null),h=(()=>{const d=[{name:"Create a new field...",value:"NEW_FIELD"}];return r!=null&&r.labelsMapping&&Object.keys(r==null?void 0:r.labelsMapping).forEach(f=>{var y,g;d.push({name:(g=(y=Gt(f))==null?void 0:y.replace)==null?void 0:g.call(y,/_/g," "),value:r==null?void 0:r.labelsMapping[f]})}),d})(),u=(d,f)=>f.props.children.toLowerCase().includes(d.toLowerCase());return e.jsxs(ve,{onOk:()=>{a(i.value==="NEW_FIELD"?{value:o,name:o}:i),l({value:null}),c(null)},okText:"Confirm",open:s!==null,okButtonProps:{disabled:i.value===null||i.value==="NEW_FIELD"&&!o},onCancel:()=>{t(),l({value:null}),c(null)},title:"Edit column label",width:500,children:[e.jsx("div",{children:e.jsx("b",{children:"Select a field for this column"})}),e.jsx(Ze,{value:i.value,onChange:d=>{const f=h.find(y=>y.value===d);l(f)},style:{width:300,margin:"5px 0"},showSearch:!0,filterOption:u,children:h.map((d,f)=>e.jsx(ks,{value:d.value,children:d.name},f))}),i.value==="NEW_FIELD"&&e.jsxs(ce,{gutter:12,style:{marginTop:20},children:[e.jsxs(le,{span:12,children:[e.jsx("div",{children:e.jsx("b",{children:"Create a field label"})}),e.jsx(Re,{onChange:d=>c(d.target.value),style:{width:"100%",margin:"5px 0"}})]}),e.jsxs(le,{span:12,children:[e.jsx("div",{children:e.jsx("b",{children:"Select a data type"})}),e.jsx(Ze,{style:{width:"100%",margin:"5px 0"},showSearch:!0,children:Mr.map((d,f)=>e.jsx(ks,{value:d.value,children:d.name},f))})]})]})]})};function Or({isUpdatingAssets:t,countries:s,reloadPool:a,onClose:r}){const{assets:i,columns:l,stepAction:o,isUploading:c,dataset:p,dataType:h,setUploading:u,assetsClass:d,validationType:f,memberMetadata:y,assetsMapping:g,resetMapping:x,selectedColumn:I,setSelectedColumn:v,setAssetsMapping:N,setColumns:C,setAssets:M}=ht(),{pool:m}=oe(),b=n.useMemo(()=>l.filter(({key:F})=>!!F.includes("NOT_RECOGNIZED_")).length,[l]),E=n.useCallback(async()=>{u(!0);let F=null;switch(h==="TEST"&&p&&(F=p),d.id){case 2:await Et.bulkUpdate({dataset:F,data:Et.makeFormDataForBulkUpload(i,{countries:s,needToBeAcceptedByBuyer:f===2})});break;default:await ut.bulkUpdate({dataset:F,data:ut.makeFormDataForBulkUpload(i,{countries:s})})}r(),a(),Pe.success("Update assets successfully"),u(!1)},[u,h,p,d.id,r,a,i,s,f]),$=n.useCallback(({value:F,name:j})=>{const O=l[I].dataIndex,w=l[I].originalLabel.toLowerCase(),K=F,q=F,k=g[K]||q,H=Pn(l.map(ne=>ne.dataIndex).filter(ne=>{var me;return(me=ne==null?void 0:ne.toLowerCase)==null?void 0:me.call(ne).includes("NOT_RECOGNIZED_")}).map(ne=>+ne.split("_")[2]))+1,se={},de=l.findIndex(ne=>ne.key===k);console.log({selectedColumn:I,replaceIndex:H,replaceAnotherColumnIndex:de,columns:l});let ue=!1;I!==de&&(ue=!0,console.log(`NOT_RECOGNIZED_${H}`),se[de]={$set:{title:e.jsx(cs,{isUnrecognizedColumn:!0,label:`NOT_RECOGNIZED_${H}`,onEdit:()=>{v(de)}}),dataIndex:`NOT_RECOGNIZED_${H}`,key:`NOT_RECOGNIZED_${H}`,width:200,wordWrap:"break-word",wordBreak:"break-word",originalLabel:`NOT_RECOGNIZED_${H}`}});const fe=va(l,{[I]:{$set:{title:e.jsx(cs,{isUnrecognizedColumn:!1,label:j,onEdit:()=>{v(I)}}),dataIndex:k,key:k,width:200,wordWrap:"break-word",wordBreak:"break-word",originalLabel:w}},...se});console.log("newColumns",fe);const xe=i.map(ne=>{const me=ne[O];if(delete ne[O],ue){const ye=ne[k];return delete ne[k],{...ne,[`NOT_RECOGNIZED_${H}`]:ye,[k]:me}}else return{...ne,[k]:me}});N(Qs(g,{[w]:g[K]||q})),C(fe),M(xe),v(null)},[l,I,g,i,N,C,M,v]),D=Er,A=n.useMemo(()=>!i||!i[0]?D:Dn(D,Object.keys(i[0])),[i,D]),[S,R]=n.useState(!1),L=n.useCallback(async()=>{if(!(!i||!i[0])&&!(A.length>0))if(t)await E();else{R(!0);const F=y?{...y,assetsMapping:y.assetsMapping?{...y.assetsMapping,[m.assetType]:{...g}}:{[m.assetType]:{...g}}}:{assetsMapping:{[m.assetType]:{...g}}};try{await Yt.createUpdateMemberMetadata(F)}catch(j){console.log(j)}R(!1),h==="TEST"?o.force(3):o.force(2)}},[i,g,h,A.length,t,y,m.assetType,E,o]);return e.jsx(ce,{gutter:[16],children:e.jsxs(le,{xs:24,children:[e.jsxs(Ue,{className:"mb-4",children:[e.jsxs("div",{className:"flex flex-row justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:"Assets recognized"}),e.jsx("div",{className:"font-bold",children:i.length})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:"Columns will be imported."}),e.jsx("div",{className:"font-bold",children:l.length-b})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:"columns will NOT be imported."}),e.jsx("div",{className:"font-bold",children:b})]}),e.jsx("div",{children:e.jsx(U,{onClick:x,children:"Reset Mapping"})})]}),e.jsx(Te,{}),e.jsxs("div",{className:"font-bold",children:["Required Fields (",D.length-A.length,"/",D.length,")",e.jsx("div",{className:"flex flex-row gap-4 flex-wrap mt-4",children:(D==null?void 0:D.length)&&D.map(F=>{var O,w;const j=Object.keys((d==null?void 0:d.labelsMapping)||{}).find(K=>(d==null?void 0:d.labelsMapping[K])===F);return e.jsxs("div",{className:"flex gap-1",children:[e.jsx(Mn,{style:{color:A.includes(F)?"red":"#00cc68"}}),e.jsx("div",{children:(w=(O=Gt(j))==null?void 0:O.replace)==null?void 0:w.call(O,/_/g," ")})]},F)})})]})]}),e.jsxs(Ue,{children:[e.jsx(Dr,{columns:l,datasource:i}),e.jsxs("div",{className:"flex justify-end mt-4",children:[e.jsx(U,{onClick:()=>{o.force(0)},className:"mr-2",children:"Previous"}),e.jsx(U,{loading:c||S,onClick:L,disabled:A.length>0||S,type:"primary",children:t?"Update assets":h==="ACTUAL"?"Next":"Import assets"})]}),e.jsx(Fr,{selectedColumn:I,onClose:()=>v(null),onChangeFieldName:$})]})]})})}function Rr(){const{assets:t,countries:s,validationType:a,assetPurpose:r}=ht(),{pool:i,calculateDrawdownAmount:l}=oe(),[o,c]=n.useState(!1),p=n.useCallback(async()=>{c(!0);try{const u={receivableItems:Et.makeFormDataForBulkUpload(t,{countries:s,needToBeAcceptedByBuyer:a===2}),assetPurpose:r};return await Yt.validateUploadingInvoiceAssets(i==null?void 0:i.id,u)}finally{c(!1)}},[r,t,s,i==null?void 0:i.id,a]),h=n.useCallback(async u=>{c(!0);try{const d={...u||{},data:ut.makeFormDataForBulkUpload(t,{countries:s}),assetPurpose:r},f=await Yt.validateUploadingLoanAssets(i==null?void 0:i.id,d);return f.errors&&(f.errors=f.errors.map(y=>Fn([y]))),f}finally{c(!1)}},[r,t,l,s,i==null?void 0:i.id]);return{validateInvoiceAssets:p,validateLoanAssets:h,loading:o}}function Vr({isOpen:t,onClose:s,errors:a,onContinue:r}){const{assets:i}=ht(),l=n.useMemo(()=>{const o=(i||[]).length,c=o-a.length;return{totalAsset:o,totalValidAsset:c,isAllowContinue:c>0}},[i,a]);return e.jsxs(ve,{open:t,title:"Cannot import collaterals",onOk:s,onCancel:s,footer:[e.jsx(U,{onClick:s,children:"Close"},"back"),l.isAllowContinue&&e.jsx(U,{type:"primary",onClick:r,children:l.totalAsset===l.totalValidAsset&&"Continue"||"Continue Anyway"},"ok")||!1].filter(Boolean),children:[e.jsxs("div",{style:{fontSize:20,marginBottom:4,fontWeight:"bold"},children:[l.totalValidAsset,"/",l.totalAsset," collaterals valid"]}),!Qe(a)&&a.map(o=>e.jsxs("p",{children:[Number(o.rowId)+1,": ",o.msg]},o.rowId))]})}const Es=(t,s,a,r,i)=>{const l=[],o=!t.id,c=nt(z(t,"currency.shortCode")),p=t.assets.reduce((h,u)=>h+(u.outstandingPrincipalAmount||0),0);return o||l.push({id:"avc1",title:e.jsx("b",{children:"Total Assets"}),isTitleOnly:!0,GBP:`${c} ${W(z(i,"totalAssetsAmount",0))}`,assetsCount:W(z(i,"totalAssets",0))}),l.push({id:"avc2",title:e.jsx("b",{children:"Excluded Assets"}),filterType:"exclusionFilter"}),s.map((h,u)=>{l.push({id:h.id,title:`${u+1}. ${h.name}`,GBP:`${c} ${W(z(i,`excludedAssets[${h.id}].excludedAmount`,0))}`,assetsCount:W(z(i,`excludedAssets[${h.id}].excludedAssets`,0)),criteria:h})}),o||l.push({id:"avc3",title:"Total Excluded Assets",GBP:`${c} ${W(z(i,"excludedAssets.totalValue.totalExcludedValue",0))}`,assetsCount:W(z(i,"excludedAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),o||l.push({id:"avc4",title:"Total 'Included' Outstanding Balance",GBP:`${c} ${W(z(i,"totalAssetsAmount",0)-z(i,"excludedAssets.totalValue.totalExcludedValue",0))}`,assetsCount:W(z(i,"totalAssets",0)-z(i,"excludedAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),l.push({id:"avc5",title:e.jsx("b",{children:"Ineligible Assets"}),filterType:"ineligibleFilter"}),a.map((h,u)=>{l.push({id:h.id,title:`${u+1}. ${h.name}`,GBP:`${c} ${W(z(i,`ineligibleAssets[${h.id}].excludedAmount`,0))}`,assetsCount:W(z(i,`ineligibleAssets[${h.id}].excludedAssets`,0)),criteria:h})}),o||l.push({id:"avc6",title:"Total Ineligible Assets",GBP:`${c} ${W(z(i,"ineligibleAssets.totalValue.totalExcludedValue",0))}`,assetsCount:W(z(i,"ineligibleAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),l.push({id:"avc7",title:e.jsx("b",{children:"Reserve Assets"}),filterType:"reserveFilter"}),r.map((h,u)=>{l.push({id:h.id,title:`${u+1}. ${h.name}`,GBP:`${c} ${W(z(i,`reserveAssets[${h.id}].excludedAmount`,0))}`,assetsCount:W(z(i,`reserveAssets[${h.id}].excludedAssets`,0)),criteria:h})}),o||l.push({id:"avc8",title:"Total Reserve Assets",GBP:`${c} ${W(z(i,"reserveAssets.totalValue.totalExcludedValue",0))}`,assetsCount:W(z(i,"reserveAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),o||l.push({id:"avc9",title:"Net Ineligible Assets Balance",GBP:`${c} ${W(p-z(i,"ineligibleAssets.totalValue.totalExcludedValue",0)-z(i,"reserveAssets.totalValue.totalExcludedValue",0))}`,assetsCount:W(z(i,"totalAssets",0)-z(i,"excludedAssets.totalValue.totalExcludedAssets",0)-z(i,"ineligibleAssets.totalValue.totalExcludedAssets",0)-z(i,"reserveAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),l},_r=()=>{const{notification:t}=Ie.useApp(),{pool:s}=oe(),{stepAction:a,assets:r,setAssets:i}=ht(),[l,o]=n.useState(!1),{validateLoanAssets:c,loading:p}=Rr(),[h,u]=n.useState(!1),[d,f]=n.useState(null),[y,g]=Ve(Q.getPoolFilterTemplates,s.id),x=n.useMemo(()=>Qe(y)?null:y.find(({isMain:S})=>S===1),[y]);console.log("filterTemplates:",y);const[I,v]=n.useState({}),[N,C]=n.useState(!1),M=n.useCallback(async S=>{var R,L;C(!0);try{const F=await c({templateId:S});v(F==null?void 0:F.assetsReport)}catch(F){t.error({description:((L=(R=F==null?void 0:F.response)==null?void 0:R.data)==null?void 0:L.message)??"Something wrong. Please try again"})}finally{C(!1)}},[c]);n.useEffect(()=>{s.id&&(x!=null&&x.id)&&!g&&M(x==null?void 0:x.id)},[s,x,M,g]);const m=n.useMemo(()=>(x==null?void 0:x.exclusionFilter)||[],[x==null?void 0:x.exclusionFilter]),b=n.useMemo(()=>(x==null?void 0:x.ineligibleFilter)||[],[x==null?void 0:x.ineligibleFilter]),E=n.useMemo(()=>(x==null?void 0:x.reserveFilter)||[],[x==null?void 0:x.reserveFilter]),$=s.id?Es(s,m,b,E,I):Es({assets:[],id:null},m,b,E,{}),D=s.id?[{title:"",dataIndex:"title",key:"title"},{title:"# Assets",dataIndex:"assetsCount",key:"assetsCount"},{title:"Outstanding Amount",dataIndex:"GBP",key:"GBP"}]:[{title:"",dataIndex:"title",key:"title"}],A=async()=>{var S,R;o(!0),f(null);try{const L=await c();if(Qe(L==null?void 0:L.errors))a.next();else{const F=Object.keys(L.errors).filter(j=>!Qe(L.errors[j])).map(j=>({rowId:Number(j),msg:L.errors[j].join(", ")}));if(!Qe(F)){u(!0),f(F);return}a.next()}}catch(L){t.error({description:((R=(S=L==null?void 0:L.response)==null?void 0:S.data)==null?void 0:R.message)??"Something wrong. Please try again"})}finally{o(!1)}};return e.jsx(ce,{gutter:[16],children:e.jsxs(le,{xs:24,children:[x!=null&&x.id?e.jsx(rt,{loading:N,dataSource:$,columns:D,pagination:!1,rowKey:S=>S.id}):e.jsx(Be,{active:!0}),e.jsxs("div",{className:"flex justify-end mt-4",children:[e.jsx(U,{onClick:()=>{a.prev()},className:"mr-4",children:"Previous"}),e.jsx(U,{type:"primary",loading:g||p||l,disabled:g||p||l,onClick:A,children:"Next"})]}),h&&e.jsx(Vr,{isOpen:h,onClose:()=>{u(!1)},errors:d||[],onContinue:()=>{const S=d.map(L=>+L.rowId),R=r.filter((L,F)=>!S.includes(F));i(R),setTimeout(()=>{a.next()})}})]})})},$r={[ie.LENDING]:"green",[ie.INVOICE]:"red",[ie.NOTE_TOKEN]:"blue"};function Ur(t,s){switch(t){case ie.LENDING:return"Loan";case ie.INVOICE:return"Invoice";case ie.NOTE_TOKEN:return s===Kt.SENIOR?"SOT":"JOT";default:return"No Data"}}function Br(){const{assets:t,startUploading:s,isUploading:a,stepAction:r,setSelectedAssets:i}=ht(),{pool:l,calculateDrawdownAmount:o}=oe(),[c,p]=n.useState(t.map((d,f)=>f));n.useEffect(()=>{i(t)},[t,i]);const h={selectedRowKeys:c,onChange:(d,f)=>{console.log(d),p(d),i(f)}},u=n.useMemo(()=>[{title:"Loan ID",dataIndex:"loanIdentifier"},{title:"Asset Type",dataIndex:"assetType",render:d=>e.jsx(On,{color:$r[d],children:Ur(ie.LENDING)})},{title:"Outstanding balance",dataIndex:"outstandingPrincipalAmount",render:d=>d},{title:"Expected drawdown amount",dataIndex:"Expected drawdown amount",render:(d,f)=>o({finalMaturityDate:f.finalMaturityDate,amount:f.outstandingPrincipalAmount})},{title:"Loan Denomination Currency",dataIndex:"currencySymbol",render:d=>d},{title:"Loan Origination Date",dataIndex:"startedDate"},{title:"Final Maturity Date",dataIndex:"finalMaturityDate"}],[o]);return e.jsx(ce,{gutter:[16],children:e.jsxs(le,{xs:24,children:[e.jsx(rt,{pagination:!1,scroll:{y:600,x:800},rowSelection:h,columns:u,dataSource:t.map((d,f)=>({key:f,...d}))}),e.jsxs("div",{className:"flex justify-end mt-4",children:[e.jsx(U,{onClick:()=>{r.prev()},className:"mr-2",children:"Previous"}),e.jsx(U,{type:"primary",loading:a,disabled:a,onClick:()=>{a||s()},children:"Upload"})]})]})})}function Gr(){const t=pt();return e.jsx(ce,{gutter:[16],children:e.jsx(le,{xs:24,md:{span:20,offset:2},children:e.jsx(Ue,{children:e.jsx("div",{children:e.jsxs("center",{style:{fontSize:24,color:"black",marginBottom:20},children:[e.jsx("img",{src:Ca,alt:"img-success"}),e.jsx("div",{className:"font-bold mt-4 mb-4",children:"Assets uploaded"}),e.jsx("div",{className:"text-xs text-pool-card-info mb-4",children:"Once approved, your assets are ready to be minted and financed"}),e.jsx(U,{type:"primary",onClick:()=>{t("/portfolio/assets")},style:{marginTop:20},children:"Go to the asset dashboard"})]})})})})})}const mn=({onClose:t,isOpen:s,isUpdatingAssets:a,reloadPool:r})=>{const{currentStep:i,stepAction:l}=ht(),[o]=Ve(Ks.getCountries),c=n.useMemo(()=>{if(!s&&!o)return null;switch(i){case 0:return e.jsx(Pr,{});case 1:return e.jsx(Or,{isUpdatingAssets:a,countries:o,reloadPool:r,onClose:t});case 2:return e.jsx(_r,{reloadPool:r});case 3:return e.jsx(Br,{});case 4:return e.jsx(Gr,{})}},[o,i,s,a,t,r]);return e.jsx(ve,{onCancel:()=>{t(),l.force(0)},footer:null,width:"100vw",style:{top:0,paddingBottom:0},open:s,className:"h-screen upload-asset-modal",children:e.jsx(ce,{children:e.jsxs(le,{xs:{span:24},md:{span:16,offset:4},children:[e.jsx("div",{className:"flex justify-between",children:e.jsx("span",{className:"text-4xl font-bold",children:"Upload Collaterals"})}),e.jsx(Te,{}),e.jsxs(ot,{current:i,className:"mb-8",children:[e.jsx(ot.Step,{title:"Upload Data File"}),e.jsx(ot.Step,{title:"Map Data Fields"}),e.jsx(ot.Step,{title:"Review & Filter"}),e.jsx(ot.Step,{title:"Confirm upload"})]}),e.jsx("div",{children:c})]})})})};mn.propTypes={onClose:$e.func,isOpen:$e.bool,isUpdatingAssets:$e.bool,reloadPool:$e.func};const Yr=t=>e.jsx(dn,{countries:t.countries,children:e.jsx(mn,{...t})}),Kr=({pool:t,event:s,auctionOverview:a,trusteeCompany:r,servicerCompany:i,currency:l={},enableJuniorToken:o=!1,enableSeniorToken:c=!1,canShowSeniorConfig:p=!0})=>{t.assetType,ie.LENDING,n.useMemo(()=>at.getExtraInfoFromAssets(t),[t]);const[h,u]=n.useState(!1),[d,f]=n.useState(null),{setDraftingDocModalVisible:y}=oe(),g=n.useMemo(()=>t.minFirstLossCushion/ft,[t.minFirstLossCushion]);return e.jsxs(e.Fragment,{children:[h&&e.jsx(Js,{defaultHtmlParse:!0,poolId:t.id,showModal:()=>u(!0),visible:h,onClose:()=>u(!1),preSelectedDocumentId:d==null?void 0:d.documentId,disableCreateNew:!0,onCreateNewDocument:()=>y(!0)}),e.jsxs(ce,{gutter:30,style:{padding:20},"data-testid":"sale-note-review",children:[e.jsx(le,{md:24,lg:12,children:e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative h-fit mb-4",children:[e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Note"})}),e.jsx(Te,{className:"my-3"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Note type"}),e.jsx("span",{className:"font-semibold",children:s.targetAmount&&s.juniorTargetAmount?"Dual Note":"Single Note"})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Trustee"}),e.jsx("span",{className:"font-semibold",children:z(r,"companyLegalName","")})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Servicer"}),e.jsx("span",{className:"font-semibold",children:z(i,"companyLegalName","")})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"First loss cushion"}),e.jsxs("span",{className:"font-semibold",children:[g,"%"]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Debt ceiling"}),e.jsxs("span",{className:"font-semibold",children:[W(new je(t.debtCeiling).div(10**l.decimals).toNumber())," ",nt(l.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Expiry date"}),e.jsx("span",{className:"font-semibold",children:s.investmentTerms>0?`${s.investmentTerms} days`:"Perpetual"})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Epoch duration"}),e.jsxs("span",{className:"font-semibold",children:[s.epochInterval," days"]})]})]})]})}),e.jsxs(le,{md:24,lg:12,children:[o&&e.jsx(e.Fragment,{children:e.jsx(ce,{children:e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative w-full",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("b",{style:{color:"black"},children:"Junior Note"}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Target amount"}),e.jsxs("span",{className:"font-semibold",children:[W(s.juniorTargetAmount)," ",nt(l.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Start time"}),e.jsx("span",{className:"font-semibold",children:s.juniorStartTime.format("HH:mm:ss DD/MM/YYYY")})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Initial amount to start SOT sale"}),e.jsxs("span",{className:"font-semibold",children:[s.juniorInitialAmount," ",nt(l.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Minimum Bid"}),e.jsxs("span",{className:"font-semibold",children:[s.juniorMinimumBid," ",nt(l.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Junior subscription agreement"}),e.jsx("a",{className:"shrink-0",onClick:()=>{f({documentId:s.juniorLegalDocumentId}),u(!0)},children:e.jsx("span",{className:"text-[#4C7FEF] font-semibold",children:"View document"})})]})]})]})})}),p&&c&&e.jsx(e.Fragment,{children:e.jsxs(ce,{className:"pt-5",children:[e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative w-full",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("b",{style:{color:"black"},children:"Senior Note"}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Target amount"}),e.jsxs("span",{className:"font-semibold",children:[W(s.targetAmount)," ",nt(l.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Start time"}),e.jsx("span",{className:"font-semibold",children:s.startTime.format("HH:mm:ss DD/MM/YYYY")})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"APR"}),e.jsxs("span",{className:"font-semibold",children:[s.apy,"%"]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Minimum Bid"}),e.jsxs("span",{className:"font-semibold",children:[s.minimumBid," ",nt(l.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Senior subscription agreement"}),e.jsx("a",{className:"shrink-0",onClick:()=>{f({documentId:s.legalDocumentId}),u(!0)},children:e.jsx("span",{className:"text-[#4C7FEF] font-semibold",children:"View document"})})]})]})]}),a.eventSaleType===Me.eventSaleTypes.DUTCH_AUCTION&&e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"End time"}),e.jsx("div",{children:Fe(s.endTime).format("DD/MM/YYYY")})]})]})})]})]})]})},{Option:jt}=Ze,{Step:ns}=ot,Ls=10**4,Wr=(t,s,a,r)=>r?s===0&&a===0?!1:s*100/(s+a)>=t:a>0,as=2,Ps=1,Vt=3,Hr=({pool:t,visible:s,onClose:a,reloadPool:r=()=>{}})=>{const{notification:i}=Ie.useApp(),{address:l,connector:o}=it(),[c,p]=n.useState(0),h=n.useMemo(()=>t.minFirstLossCushion/Ls,[t.minFirstLossCushion]),[u,d]=n.useState(Ps),[f,y]=n.useMemo(()=>h===0?[!1,!0]:h===100?[!0,!1]:[!0,!0],[h]),[g,x]=n.useState({firstLossCushion:h,currencyId:t.currencyId}),{bankAccountModalVisible:I,setBankAccountModalVisible:v}=oe(),[N]=Ve(It.getAllCompanies),[C,M]=n.useState(null),[m,b]=n.useState(null),[E,$]=n.useState([]),[D,A]=n.useState(null),[S,R]=n.useState(null),[L,F]=n.useState([]),[j,O]=n.useState({eventSaleType:Me.eventSaleTypes.NORMAL_SALE_SOT,intervalType:"Day",targetAmount:0,juniorTargetAmount:0,juniorInitialAmount:0,juniorMinBid:0}),[w,K]=n.useState(14);n.useEffect(()=>()=>{const ge=g.firstLossCushion;if(!isNaN(ge)&&t.assetValue>0){const T=te((1-ge/100)*t.assetValue,2);O({...j,targetAmount:T,juniorTargetAmount:ge>0?te(t.assetValue-T,2):0})}},[g]);const[q,k]=n.useState(!1),[H,se]=n.useState(!1),[de]=Ve(ee.getDocuments,t.id,De.category.LEGAL,De.status.SIGNED),[ue,fe]=n.useState(null),[xe,ne]=n.useState(null),[me,ye]=n.useState(null),[Ce,et]=n.useState(null),[Ae]=Ve(ee.getDocuments,t.id,De.category.GENERAL),[Ge,P]=n.useState(null),[B,_]=n.useState(null),[J,Z]=n.useState(null),[ae,Y]=n.useState(!1),pe=n.useCallback(async ge=>{const T=await It.getUsersByCompanyId(ge);$(T)},[]),re=t.currency.decimals;n.useEffect(()=>{u==Vt&&(a(),r())},[u]),n.useEffect(()=>{C&&pe(C)},[C]);const[Se,ke]=n.useState("");n.useEffect(()=>{(async()=>{const{walletAddress:T}=await mt.getLinkedWallet();ke(T)})().then()},[]);const _e=n.useCallback(async ge=>{const T=await It.getUsersByCompanyId(ge);F(T)},[]);n.useEffect(()=>{D&&_e(D)},[D]),n.useEffect(()=>{s&&p(0)},[s]);const be=j.eventSaleType===Me.eventSaleTypes.DIRECT_ALLOCATION,G=n.useMemo(()=>h>0&&h<=100,[h]),he=n.useMemo(()=>h>0&&h<100,[h]);console.log("noteSetup - minFirstLoss"),console.log(h);const{loading:Je,value:Ye}=La(async()=>!(t!=null&&t.id)||I?void 0:(await Q.getPoolLinkedWallet(t==null?void 0:t.id)).walletAddress,[t==null?void 0:t.id,I]),Ee=async()=>{k(!0);const ge=j.targetAmount,T=j.juniorTargetAmount,yt=g.firstLossCushion;if(!Wr(yt,T,ge,G)){i.error({message:"SOT Target Amount and JOT Target Amount must satisfy First Loss Cushion"}),k(!1);return}if(t&&t.debtCeiling&&j.juniorTargetAmount+j.targetAmount>Number(t.debtCeiling)){i.error({message:`Issuer can not set target investment amount > Debt ceiling (${t.debtCeiling})`}),k(!1);return}if(c===1){let gt=1;j.intervalType==="Hour"?gt=1/24:j.intervalType==="Minute"&&(gt=1/24/60);const bt={apy:j.apy,assetGeneralDocumentId:J,benchmarkRate:j.benchmarkRate,creditRating:g.creditRating,endTime:j.endTime,eventSaleType:j.eventSaleType,firstLossCushion:g.firstLossCushion,generalDocumentId:Ge,investmentTerms:j.investmentTerm,epochInterval:w,juniorGeneralDocumentId:B,juniorInitialAmount:j.juniorInitialAmount,juniorInvestmentTerm:j.juniorInvestmentTerm,juniorLegalDocumentId:me,juniorEntityLegalDocumentId:Ce,juniorMinimumBid:j.juniorMinBid,juniorStartTime:j.juniorStartTime,juniorTargetAmount:j.juniorTargetAmount,legalDocumentId:ue,entityLegalDocumentId:xe,minimumBid:j.minBid,paymentSchedule:j.paymentSchedule,priceChangePerInterval:j.priceChange,projectedAPY:g.projectedAPY,reservedAPY:j.maxAPY,securityRegistration:g.securityRegistration,seniority:g.seniority,servicerCompanyId:D,servicerMemberId:S,startAPY:j.minAPY,startEarningInterestTime:g.startEarningInterestTime,startTime:j.startTime,targetAmount:j.targetAmount,ticker:g.ticker,timeInterval:j.timeInterval*gt,tranchingAt:g.tranchingAt,trusteeCompanyId:C,trusteeMemberId:m};se(bt)}k(!1),p(c+1)},qt=async()=>{if(k(!0),!await Q.getPoolLinkedWallet(t==null?void 0:t.id))return k(!1),v(!0);try{if(l!=new $s().utils.toChecksumAddress(Se))return k(!1),i.error({message:"Current wallet address is not valid.",description:`Please connect to wallet ${Se}`});const T=H.ticker;await(async()=>{if(h<=0||h>=100||!H.targetAmount)return;const yt=te(H.targetAmount*10**re).toLocaleString("fullwide",{useGrouping:!1}),gt=await ls(),bt=te(j.minBid*10**re).toLocaleString("fullwide",{useGrouping:!1}),Dt={issuerTokenController:Se,pool:t.poolContractAddress,minBidAmount:bt,ticker:T,totalCap:yt,openingTime:te(new Date(H.startTime).getTime()/1e3),saleType:H.eventSaleType};console.log("noteSetup - (event)"),console.log(H);const Mt=yt,Ft=j.apy*Ls;console.log("initialJOTAmount",{tgeParam:Dt,cap:Mt,interestRate:Ft});const zt=await gt.send("setUpTGEForSOT",[Dt,Ft]),pn=await at.waitForTransactionReceipt(zt,o==null?void 0:o.id);await kt(Q.checkSOTEvent,[t.id,pn.transactionHash],3e3)})(),k(!1),Pe.success("The sale is launching, please wait for a few minute."),d(Vt)}catch(T){console.log("ERR",T),Pe.error({title:"Transaction failed",content:T.message}),k(!1)}},wt=async()=>{try{k(!0);const ge=await ls(),T=te(H.juniorTargetAmount*10**re).toLocaleString("fullwide",{useGrouping:!1}),yt=te(H.juniorInitialAmount*10**re).toLocaleString("fullwide",{useGrouping:!1}),gt=te(j.juniorMinBid*10**re).toLocaleString("fullwide",{useGrouping:!1}),bt={issuerTokenController:Se,pool:t.poolContractAddress,minBidAmount:gt,totalCap:T,openingTime:te(new Date(H.juniorStartTime).getTime()/1e3),ticker:H.ticker,saleType:Me.eventSaleTypes.NORMAL_SALE_JOT},Dt=T,Mt=yt;console.log("initialJOTAmount",{tgeParam:bt,jotCap:Dt,initialJOTAmount:Mt});const Ft=await ge.send("setUpTGEForJOT",[bt,Mt]),zt=await at.waitForTransactionReceipt(Ft,o==null?void 0:o.id);await kt(Q.checkJOTEvent,[t.id,zt.transactionHash],3e3),await Q.createEvent(t.id,Us(H,["apy","assetGeneralDocumentId","firstLossCushion","generalDocumentId","investmentTerms","epochInterval","juniorGeneralDocumentId","juniorInvestmentTerm","juniorLegalDocumentId","juniorEntityLegalDocumentId","legalDocumentId","entityLegalDocumentId","servicerCompanyId","servicerMemberId","trusteeCompanyId","trusteeMemberId"])),k(!1),y?d(as):(d(Vt),Pe.success("The sale is launching, please wait for a few minute."))}catch(ge){console.log("ERR",ge),Pe.error({title:"Transaction failed",content:ge.message}),k(!1)}},Nt=!g.firstLossCushion||g.firstLossCushion<=100,Jt=n.useMemo(()=>{switch(c){case 0:return!g.ticker||!C||!m||!D||!S||j.investmentTerm==null||he&&(!Object.values(Me.eventSaleTypes).includes(j.eventSaleType)||!ue||!xe)?!0:G&&(!j.juniorInvestmentTerm==null||!me||!Ce);case 1:{let ge=!0;y&&(j==null?void 0:j.eventSaleType)===Me.eventSaleTypes.NORMAL_SALE_SOT&&(ge=j.apy>0&&j.startTime&&!xs(j.minBid));let T=!0;return f&&(T=!xs(j.juniorMinBid)&&j.juniorStartTime),!ge||!T}}},[j.apy,j.eventSaleType,j.investmentTerm,j.juniorInvestmentTerm,j.juniorMinBid,j.juniorStartTime,j.minBid,j.startTime,c,xe,f,y,G,he,Ce,me,ue,g.ticker,D,S,C,m]),hs={header:{backgroundColor:"transparent"},content:{borderRadius:24,backgroundColor:"#F0F0F0"}};if(!Je&&!Ye)return e.jsx(ve,{centered:!0,title:"Link your wallet",open:s,styles:hs,okText:"Link wallet",icon:null,okButtonProps:{className:"bg-[#1ED760] hover:bg-[#1ED760] shadow-none h-11 text-black w-30",style:{backgroundColor:"#1ED760"},type:"primary"},cancelButtonProps:{className:"bg-[#25272614] shadow-none h-11 w-20",type:"disable"},cancelText:"Cancel",width:"30vw",style:{minWidth:500},onCancel:()=>{a(),p(0)},onOk:()=>v(!0),children:e.jsxs("div",{className:"my-6",children:[e.jsx("p",{children:"You have not link your wallet to the pool yet"}),e.jsx("p",{className:"font-semibold",children:"Please, link the wallet first to continue."})]})});if(!Je&&Ye){let ge;return u==as?ge=e.jsx(U,{className:"shadow-none w-40 h-12",loading:q,disabled:Jt,onClick:()=>qt(),type:"primary",children:"Set up SOT"}):u==Ps&&(ge=e.jsx(U,{className:"shadow-none w-40 h-12",loading:q,disabled:Jt,onClick:()=>wt(),type:"primary",children:y?"Set up JOT":"Issue note"})),e.jsxs(ve,{onCancel:()=>{a(),p(0)},footer:null,width:"64vw",open:s,style:{minWidth:500,paddingBottom:0},styles:hs,children:[ae&&e.jsx(Hs,{visible:ae,onClose:()=>Y(!1),onSubmit:void 0,legalDocumentId:me}),e.jsxs("div",{className:"sm:w-full lg:w-2/3 xl:w-1/2 m-auto mt-5",children:[e.jsxs(ot,{current:c,labelPlacement:"vertical",type:"default",className:"whitespace-nowrap mb-4",children:[e.jsx(ns,{title:"Structure note",className:"font-semibold"}),e.jsx(ns,{title:"Structure sale",className:"font-semibold"}),e.jsx(ns,{title:"Launch sale",className:"font-semibold"})]}),!Je&&!Ye&&e.jsx("div",{style:{marginTop:4},children:e.jsx(Rn,{message:e.jsxs(e.Fragment,{children:["You have not linked wallet to the pool. Pool-2-pool investment cannot be made without linked wallet."," ",e.jsx(U,{variant:"link",onClick:()=>{v(!0)},children:"setup here"})]}),type:"warning",showIcon:!0})}),s&&c===0&&e.jsxs(V,{labelCol:{span:24},wrapperCol:{span:24},"data-testid":"sale-note-setup",children:[e.jsx(V.Item,{name:"ticker",label:"Ticker",className:"mb-4",children:e.jsx(Re,{placeholder:"Ticker",maxLength:10,id:"ticker",value:g.ticker,onChange:T=>x({...g,ticker:T.target.value})})}),e.jsx(V.Item,{name:"general_document",label:"General document",className:"mb-4",children:e.jsx(Ne,{placeholder:"Select/ Enter general document",items:Ae,nameKey:"name",dateKey:"createdAt",selectedValue:Ge,onSelect:T=>{P(T),_(T)}})}),e.jsxs("div",{className:"flex flex-row gap-3",children:[e.jsx("div",{className:"w-1/2",children:e.jsx(V.Item,{label:"Trustee",className:"mb-4",children:e.jsx(vs,{isCompany:!0,notShowAtBegin:!0,items:N,allowNewValue:!1,nameKey:"companyLegalName",placeholder:"Select/ Enter trustee",selectedValue:C,onSelect:T=>M(T)})})}),e.jsx("div",{className:"w-1/2",children:e.jsx(V.Item,{label:"Trustee Email",className:"mb-4",children:e.jsx(Ne,{isMember:!0,items:E||[],allowNewValue:!1,nameKey:"email",placeholder:"Select/ Enter trustee email",selectedValue:m,onSelect:T=>b(T)})})})]}),e.jsxs("div",{className:"flex flex-row gap-3",children:[e.jsx("div",{className:"w-1/2",children:e.jsx(V.Item,{label:"Servicer",className:"mb-4",children:e.jsx(vs,{isCompany:!0,notShowAtBegin:!0,items:N,allowNewValue:!1,nameKey:"companyLegalName",placeholder:"Select/ Enter servicer",selectedValue:D,onSelect:T=>A(T)})})}),e.jsx("div",{className:"w-1/2",children:e.jsx(V.Item,{name:"servicer_email",label:"Servicer Email",className:"mb-4",children:e.jsx(Ne,{isMember:!0,items:L||[],allowNewValue:!1,nameKey:"email",placeholder:"Select/ Enter servicer email",selectedValue:S,onSelect:T=>R(T)})})})]}),e.jsx(V.Item,{label:"First Loss Cushion",className:"mb-4",children:e.jsx(Le,{className:"w-full",suffix:"%",placeholder:"First Loss Cushion (%)",value:g.firstLossCushion,disabled:!0})}),g.tranchingAt=="asset"&&e.jsx(V.Item,{name:"general_document",label:"General document",className:"mb-4",children:e.jsx(Ne,{placeholder:"General document",items:Ae,nameKey:"name",selectedValue:J,onSelect:T=>Z(T)})}),e.jsx(V.Item,{label:"Currency",className:"mb-4",children:e.jsx(Re,{value:t.currency.shortCode,showSearch:!0,id:"currency",placeholder:"Currency",disabled:!0})}),e.jsx(V.Item,{label:"Expiry date",className:"mb-4",children:e.jsx(Le,{min:0,className:"w-full",precision:0,suffix:"Day(s)",value:j.investmentTerm,placeholder:"Expiry date",onChange:T=>O({...j,investmentTerm:T,juniorInvestmentTerm:T})})}),e.jsx(V.Item,{label:"Epoch withdrawal duration",children:e.jsx(Le,{min:0,precision:0,className:"w-full",suffix:"Day(s)",type:"input-number",placeholder:"Epoch withdrawal duration",value:w,onChange:T=>K(T)})}),Nt&&he&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Senior Note"})}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsx(V.Item,{hidden:!0,children:e.jsxs(X,{type:"select",value:j.eventSaleType,style:{width:"100%",marginTop:10},placeholder:"Sale type",onChange:T=>O({...j,eventSaleType:T}),children:[e.jsx(jt,{value:Me.eventSaleTypes.DUTCH_AUCTION,children:"Auction"}),e.jsx(jt,{value:Me.eventSaleTypes.NORMAL_SALE_SOT,children:"Normal Sale"})]})}),e.jsx(V.Item,{label:"Target Amount",className:"mb-4",children:e.jsx(Le,{min:0,className:"w-full",type:"input-number",placeholder:"Target Amount",precision:2,value:j.targetAmount,suffix:t.currency.shortCode,disabled:t.assetValue>0,onChange:T=>O({...j,targetAmount:T})})}),e.jsx(V.Item,{label:"Legal document",className:"mb-4",children:e.jsx(Ne,{placeholder:"Legal document",items:de.filter(T=>T.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:ue,onSelect:T=>fe(T)})}),e.jsx(V.Item,{label:"Corporate Legal document",className:"mb-4",children:e.jsx(Ne,{placeholder:"Corporate Legal document",items:de.filter(T=>T.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:xe,onSelect:T=>ne(T)})})]}),G&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative mt-6",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Junior Note"})}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsx(V.Item,{hidden:!0,children:e.jsx(X,{type:"select",value:j.juniorEventSaleType||Me.eventSaleTypes.DIRECT_ALLOCATION,style:{width:"100%",marginTop:10},placeholder:"Sale type",onChange:T=>O({...j,junioEventSaleType:T}),children:e.jsx(jt,{value:Me.eventSaleTypes.DIRECT_ALLOCATION,children:"Normal Sale"})})}),e.jsx(V.Item,{label:"Target Amount",className:"mb-4",children:e.jsx(Le,{min:0,className:"w-full",type:"input-number",placeholder:"Target Amount",suffix:t.currency.shortCode,precision:2,value:j.juniorTargetAmount,disabled:t.assetValue>0,onChange:T=>O({...j,juniorTargetAmount:T})})}),e.jsx(V.Item,{label:"Initial JOT",className:"mb-4",children:e.jsx(Le,{className:"w-full",min:0,placeholder:"Initial JOT",precision:2,value:j.juniorInitialAmount,suffix:t.currency.shortCode,disabled:t.assetValue>0,onChange:T=>O({...j,juniorInitialAmount:T})})}),e.jsx(V.Item,{label:"Legal document",children:e.jsx(Ne,{placeholder:"Legal document",items:de.filter(T=>T.isSign),nameKey:"name",dateKey:"createdAt",selectedValue:me,onSelect:T=>ye(T)})}),e.jsx(V.Item,{label:"Corporate Legal document",className:"mb-4",children:e.jsx(Ne,{placeholder:"Corporate Legal document",items:de.filter(T=>T.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:Ce,onSelect:T=>et(T)})})]})]}),s&&c===1&&e.jsxs(V,{labelCol:{span:24},wrapperCol:{span:24},children:[Nt&&he&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Senior Note"})}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),!be&&e.jsxs(e.Fragment,{children:[e.jsx(V.Item,{label:"Start time",className:"mb-4",children:e.jsx(X,{type:"date-picker",placeholder:"Select start time",value:j.startTime,onChange:T=>O({...j,startTime:T})})}),j.eventSaleType===Me.eventSaleTypes.DUTCH_AUCTION&&e.jsx(X,{style:{marginTop:20},type:"date-picker",placeholder:"End time",value:j.endTime,onChange:T=>O({...j,endTime:T})})]}),[Me.eventSaleTypes.SIMPLE_SUBSCRIPTION,Me.eventSaleTypes.DIRECT_ALLOCATION,Me.eventSaleTypes.NORMAL_SALE_SOT].includes(j.eventSaleType)?e.jsx(V.Item,{label:"APY",className:"mb-4",children:e.jsx(Le,{className:"w-full",value:j.apy,placeholder:"Enter APY",suffix:"%",onChange:T=>O({...j,apy:T})})}):e.jsxs(e.Fragment,{children:[e.jsx(X,{style:{marginTop:20},placeholder:"Start APY (%)",value:j.minAPY,onChange:T=>O({...j,minAPY:T.target.value})}),e.jsx(X,{style:{width:"100%",marginTop:20},placeholder:"Reserved APY (%)",value:j.maxAPY,onChange:T=>O({...j,maxAPY:T.target.value})}),e.jsxs(ce,{gutter:16,children:[e.jsx(le,{span:12,children:e.jsx(X,{value:j.timeInterval,style:{width:"100%",marginTop:20},placeholder:"Time interval",onChange:T=>O({...j,timeInterval:T.target.value})})}),e.jsx(le,{span:12,children:e.jsxs(X,{type:"select",value:j.intervalType,style:{width:"100%",marginTop:20},placeholder:"Interval Type",onChange:T=>O({...j,intervalType:T}),children:[e.jsx(jt,{value:"Day",children:"Day"}),e.jsx(jt,{value:"Hour",children:"Hour"}),e.jsx(jt,{value:"Minute",children:"Minute"})]})})]}),e.jsx(X,{value:j.priceChange,style:{width:"100%",marginTop:20},placeholder:"Price change at each interval (%)",onChange:T=>O({...j,priceChange:T.target.value})})]}),e.jsx(V.Item,{label:"Minimum Bid",className:"mb-4",children:e.jsx(Le,{className:"w-full",placeholder:"Enter minimum bid",value:j.minBid,onChange:T=>O({...j,minBid:T})})})]}),G&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative mt-6",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Junior Note"})}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsx(V.Item,{className:"mb-4",label:"Start time",children:e.jsx(X,{type:"date-picker",placeholder:"Select start time",value:j.juniorStartTime,onChange:T=>O({...j,juniorStartTime:T})})}),e.jsx(V.Item,{label:"Minimum Bid",className:"mb-4",children:e.jsx(Le,{min:0,className:"w-full",placeholder:"Enter minimum bid",value:j.juniorMinBid,onChange:T=>O({...j,juniorMinBid:T})})})]})]})]}),e.jsx("div",{children:s&&c===2&&e.jsx(Kr,{pool:t,event:H,auctionOverview:j,isDirectAllocation:be,enableJuniorToken:G,enableSeniorToken:he,trusteeCompany:N.find(T=>T.id==C),servicerCompany:N.find(T=>T.id==D),currency:t.currency,canShowSeniorConfig:Nt})}),e.jsxs("div",{className:"w-full flex justify-end gap-4 mt-4",children:[c>0&&u!=Vt&&!(f&&u==as)&&e.jsx(U,{onClick:()=>p(T=>T-1),type:"disable",className:"shadow-none w-40 h-12 bg-[#25272614] hover:bg-[#25272614]",children:"Previous"}),c===0&&e.jsx("div",{}),c==2&&ge,c!=2&&e.jsx(U,{className:"shadow-none w-40 h-12",loading:q,disabled:Jt,onClick:()=>Ee(),type:"primary",children:"Continue"})]})]})}},qr=({pool:t,noteType:s="SOT",poolEvent:a,visible:r,onClose:i,reloadPool:l=()=>{}})=>{const{notification:o,message:c}=Ie.useApp(),p=t.currency.decimals,{connector:h}=it(),[u,d]=n.useState(new je(a.targetAmount).div(10**p).toNumber()),[f,y]=n.useState(new je(a.juniorTargetAmount).div(10**p).toNumber()),[g,x]=n.useState(new je(a.minimumBid).div(10**p).toNumber()),[I,v]=n.useState(new je(a.juniorMinimumBid).div(10**p).toNumber()),[N,C]=n.useState(!1),[M,m]=n.useState(a.legalDocumentId),[b,E]=n.useState(a.entityLegalDocumentId),[$,D]=n.useState(a.generalDocumentId),[A,S]=n.useState(a.juniorLegalDocumentId),[R,L]=n.useState(a.juniorEntityLegalDocumentId),F=a.yieldValue,[j]=Ve(ee.getDocuments,t.id,De.category.LEGAL,De.status.SIGNED),[O]=Ve(ee.getDocuments,t.id,De.category.GENERAL),w=async k=>{if(t&&t.debtCeiling&&k.targetAmount+k.juniorTargetAmount>Number(t.debtCeiling)){o.error({message:`Issuer can not set target investment amount > Debt ceiling (${t.debtCeiling})`});return}if(!isNaN(k.targetAmount)&&k.targetAmount+k.juniorTargetAmount<0)return c.error("Junior minimum bid must not be less than 0");const H=k.targetAmount*10**p,se=k.minimumBid*10**p,de=k.juniorTargetAmount*10**p,ue=k.juniorMinimumBid*10**p,fe=a.targetAmount!==H||a.minimumBid!==se,xe=a.juniorTargetAmount!==de||a.juniorMinimumBid!==ue;if(a.saleEventAddress&&!fe||a.juniorSaleEventAddress&&!xe)return;const{walletAddress:ne}=await mt.getLinkedWallet(),me=[a.saleEventAddress&&{tgeAddress:a.saleEventAddress,totalCap:te(k.targetAmount*10**p).toLocaleString("fullwide",{useGrouping:!1}),minBidAmount:te(k.minimumBid*10**p).toLocaleString("fullwide",{useGrouping:!1})},a.juniorSaleEventAddress&&{tgeAddress:a.juniorSaleEventAddress,totalCap:te(k.juniorTargetAmount*10**p).toLocaleString("fullwide",{useGrouping:!1}),minBidAmount:te(k.juniorMinimumBid*10**p).toLocaleString("fullwide",{useGrouping:!1})}].filter(Boolean),Ce=await(await ls()).send("updateTgeInfo",[me]);await at.waitForTransactionReceipt(Ce,h==null?void 0:h.id)},K=n.useCallback(async()=>{C(!0);try{const k={yieldValue:te(+F,2),targetAmount:te(+u,2),minimumBid:te(+g,2),legalDocumentId:M,entityLegalDocumentId:b,generalDocumentId:$,juniorLegalDocumentId:A,juniorEntityLegalDocumentId:R,juniorTargetAmount:te(+f,2),juniorMinimumBid:te(+I,2)};if(console.log("dataToUpdate",k),isNaN(k.yieldValue)||k.yieldValue<0)return c.error("Yield must not be less than 0");await w(k),await Q.updateNote(t.id,Us(k,["legalDocumentId","entityLegalDocumentId","generalDocumentId","juniorLegalDocumentId","juniorEntityLegalDocumentId"])),i(),l(),c.success("Note issuance has been updated")}catch(k){console.log(k),o.error({message:k.message||"Something went wrong!"})}finally{C(!1)}},[b,$,R,A,I,f,M,c,g,o,i,t.id,l,u,F]),q={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(ve,{onCancel:i,footer:null,width:"40vw",open:r,style:{minWidth:500},styles:q,children:e.jsxs("div",{className:"bg-transparent",children:[e.jsxs("p",{className:"font-medium text-lg mb-6",children:["Update ",s=="SOT"?"senior":"junior"," note issuance"]}),e.jsxs(V,{wrapperCol:{span:24},labelCol:{span:24},children:[e.jsx(V.Item,{label:"Collateral value",children:e.jsx(Le,{placeholder:"Collateral value",value:t.assetValue,disabled:!0})}),s=="SOT"&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative h-fit mb-4",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Senior note"})}),e.jsx(Te,{className:"my-3"}),e.jsx(V.Item,{label:"Debt Ceiling",className:"mb-4",children:e.jsx(Le,{placeholder:"Debt Ceiling",className:"w-full",suffix:t.currency.shortCode,min:0,precision:2,value:W(u),disabled:!0})}),e.jsx(V.Item,{label:"Minimum Bid",className:"mb-4",children:e.jsx(Le,{className:"w-full",placeholder:"Minimum Bid",suffix:t.currency.shortCode,value:g,min:0,onChange:k=>x(k)})}),e.jsx(V.Item,{label:"Legal document",className:"mb-4",children:e.jsx(Ne,{placeholder:"Legal document",items:j.filter(k=>k.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:M,onSelect:k=>m(k)})}),e.jsx(V.Item,{label:"Corporate Legal document",className:"mb-4",children:e.jsx(Ne,{placeholder:"Corporate Legal document",items:j.filter(k=>k.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:b,onSelect:E})}),e.jsx(V.Item,{label:"General document",className:"mb-4",children:e.jsx(Ne,{placeholder:"General document",items:O,nameKey:"name",dateKey:"createdAt",selectedValue:$,onSelect:k=>D(k)})})]}),s=="JOT"&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative h-fit mb-4",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Junior note"})}),e.jsx(Te,{className:"my-3"}),e.jsx(V.Item,{label:"Debt Ceiling",className:"mb-4",children:e.jsx(Le,{min:0,className:"w-full",suffix:t.currency.shortCode,precision:2,placeholder:"Debt Ceiling",value:W(f),disabled:!0})}),e.jsx(V.Item,{label:"Minimum Bid",className:"mb-4",children:e.jsx(Le,{min:0,className:"w-full",suffix:t.currency.shortCode,placeholder:"Minimum Bid",value:I,onChange:k=>v(k)})}),e.jsx(V.Item,{label:"Legal document",className:"mb-4",children:e.jsx(Ne,{placeholder:"Legal document",items:j.filter(k=>k.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:A,onSelect:k=>S(k)})}),e.jsx(V.Item,{label:"Corporate Legal document",className:"mb-4",children:e.jsx(Ne,{placeholder:"Corporate Legal document",items:j.filter(k=>k.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:R,onSelect:L})}),e.jsx(V.Item,{label:"General document",className:"mb-4",children:e.jsx(Ne,{placeholder:"General document",items:O,nameKey:"name",dateKey:"createdAt",selectedValue:$,onSelect:k=>D(k)})})]}),e.jsx("div",{style:{width:"100%",marginTop:20},children:e.jsx(U,{className:"shadow-none w-full mb-4 h-11",loading:N,disabled:!1,onClick:K,type:"primary",children:"Update"})})]})]})})},_t={open:1,close:2,executing:3,executed:4};function Jr(){var S,R;const{pool:t}=oe(),{message:s}=Ie.useApp(),{formattedBalance:a}=Xs({poolContractAddress:t.poolContractAddress,decimals:t.currency.decimals}),r=(S=t==null?void 0:t.currency)==null?void 0:S.shortCode,[i,l]=n.useState([]),[o,c]=n.useState(!1),[p,h]=n.useState({startEpoch:"",endEpoch:"",enabledStartTransaction:!1,formattedSotPrice:"",formattedJotPrice:"",totalSotPrice:"",totalJotPrice:"",totalwithdraw:""}),[u,d]=n.useState(!1),[f,y]=n.useState(!1),[g,x]=n.useState(!1),[I,v]=n.useState(!1),[N,C]=n.useState([]),M=async()=>{d(!0);try{const L=await Q.getListEpochHistory(t.id,[_t.executed]);l(L.filter(F=>F.requestUsd!=0)||[])}catch(L){console.log(L)}d(!1)},m=async()=>{var L,F,j,O;y(!0);try{const w=await Q.getActiveEpoch(t.id),K=await Ws();w!=null&&w.sotTokenAddress&&c(!0);let q=0,k=0;w!=null&&w.jotTokenAddress&&(w!=null&&w.sotTokenAddress)?[q,k]=await K.methods.getTokenPrices([w==null?void 0:w.poolAddress,w==null?void 0:w.poolAddress],[w==null?void 0:w.sotTokenAddress,w==null?void 0:w.jotTokenAddress]).call():w!=null&&w.jotTokenAddress?[k]=await K.methods.getTokenPrices([w==null?void 0:w.poolAddress],[w==null?void 0:w.jotTokenAddress]).call():w!=null&&w.sotTokenAddress&&([q]=await K.methods.getTokenPrices([w==null?void 0:w.poolAddress],[w==null?void 0:w.sotTokenAddress]).call());const H=Number(tt(q,t.currency.decimals)),se=Number(tt(k,t.currency.decimals)),de=Number(tt(w==null?void 0:w.totalSot,t.currency.decimals)),ue=Number(tt(w==null?void 0:w.totalJot,t.currency.decimals)),fe=H*de||0,xe=se*ue||0;h({startEpoch:Fe((L=w==null?void 0:w.epoch)==null?void 0:L.startEpoch).format("DD/MM/YYYY"),endEpoch:Fe.unix((F=w==null?void 0:w.epoch)==null?void 0:F.endEpoch).format("HH:mm DD/MM/YYYY"),enabledStartTransaction:Fe(new Date).isAfter(Fe((j=w==null?void 0:w.epoch)==null?void 0:j.endEpoch)),status:(O=w==null?void 0:w.epoch)==null?void 0:O.status,formattedTotalSot:de,formattedTotalJot:ue,formattedSotPrice:W(H),formattedJotPrice:W(se),totalSotPrice:W(fe),totalJotPrice:W(xe),totalwithdraw:W(fe+xe)})}catch(w){console.log(w)}y(!1)};n.useEffect(()=>{M(),m()},[]);const b=async()=>{x(!0);try{await Q.executeActiveEpoch(t.id),m(),s.success("Epoch execution started")}catch{s.error("Start epoch failed")}x(!1)},E=async L=>{v(!0);try{const F=await Q.getListEpochTransactionHistory(t.id,L);C(F||[])}catch(F){console.log(F)}},$=[{title:"TxHash",dataIndex:"tx",key:"tx",render:L=>e.jsx("a",{target:"_blank",rel:"noreferrer",href:Zs(L),children:L})},{title:"Created At",dataIndex:"createdAt",key:"createdAt",render:L=>Fe.unix(L).format("DD/MM/YYYY HH:mm:ss")}],D=[{title:"Start date",dataIndex:"startTime",key:"startTime",defaultSortOrder:"descend",render:(L,F)=>L?Fe.unix(L).format("DD/MM/YYYY"):Fe.unix(F.startTime).format("DD/MM/YYYY"),sorter:(L,F)=>L.startTime-F.startTime},{title:"Requested",dataIndex:"requestUsd",key:"requestUsd",align:"right",render:L=>W(ze(L,t.currency.decimals))},{title:"Executed",key:"executedUsd",align:"right",dataIndex:"executedUsd",render:L=>W(ze(L,t.currency.decimals))},{title:"% Executed",align:"right",key:"executed",render:(L,F)=>{const j=z(F,"executedUsd",0),O=z(F,"requestUsd",0);return`${te(Number(j)===0?0:Number(j)/Number(O)*100)}%`}},{title:"Rolled over",key:"rolledover",align:"right",render:(L,F)=>{const j=z(F,"executedUsd",0),O=z(F,"requestUsd",0);return`${W(ze(Number(O)-Number(j),t.currency.decimals))}`}},{title:"",key:"option",render:(L,F)=>e.jsx(U,{type:"primary",onClick:()=>E(F==null?void 0:F.epochId),children:"View transactions"})}],A=n.useMemo(()=>Vn(_n(_t,L=>L==p.status)),[p]);return e.jsxs(e.Fragment,{children:[e.jsx(ve,{width:"50%",title:"Epoch execution transactions",open:I,footer:null,onCancel:()=>v(!1),children:e.jsx(rt,{columns:$,dataSource:N||[],pagination:!1,size:"large",rowKey:L=>L.subId})}),f?e.jsx(Be,{active:!0}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex flex-row justify-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"shrink-0 grow bg-gray-50 border border-solid border-[#25272629] rounded-2xl",children:[e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Reserve balance ",(R=t==null?void 0:t.currency)==null?void 0:R.shortCode]}),e.jsx("p",{className:"font-semibold text-lg mt-2",children:W(a)}),e.jsx("div",{className:"h-10",children:p.enabledStartTransaction&&e.jsx(U,{type:"primary",onClick:b,loading:g,disabled:p.status!==_t.close,children:p.status===_t.executing?"Executing":"Start execution"})})]}),e.jsx(Te,{className:"my-0"}),e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"mb-3 text-md font-bold",children:"Current epoch"}),e.jsxs("div",{className:"mb-3 flex flex-row justify-between items-center",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Status"}),e.jsx("span",{className:"text-md font-bold",children:A})]}),e.jsxs("div",{className:"flex flex-row justify-between items-center",children:[e.jsx("span",{className:"text-xs text-gray-500 mr-2",children:"Next epoch end"}),e.jsx("span",{className:"text-md font-bold",children:p.endEpoch})]})]})]}),e.jsxs("div",{className:"basis-[40%] grow bg-gray-50 p-6 border border-solid border-[#25272629] rounded-2xl",children:[e.jsx("div",{className:"text-md font-bold",children:"Withdrawal Request"}),e.jsx(Te,{className:"my-4"}),o&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row justify-between gap-4",children:[e.jsxs("div",{className:"pr-6 gap-1",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"SOT amount"}),e.jsx("div",{className:"text-md font-bold",children:p.formattedTotalSot})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"rounded-full bg-[#25272614] w-6 h-6 flex justify-center items-center",children:e.jsx("div",{className:"border w-2 h-2 border-solid rotate-45"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Token Price (",r,")"]}),e.jsx("div",{className:"text-md font-bold",children:p.formattedSotPrice})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"rounded-full bg-[#25272614] w-6 h-6 flex justify-center items-center",children:e.jsx("div",{className:"border w-2 h-2 border-solid rotate-45"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Withdrawal amount (",r,")"]}),e.jsx("div",{className:"text-md font-bold",children:p.totalSotPrice})]})]})]}),e.jsx(Te,{})]}),e.jsxs("div",{className:"flex flex-row justify-between gap-4",children:[e.jsxs("div",{className:"pr-6",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"JOT amount"}),e.jsx("div",{className:"text-md font-bold",children:p.formattedTotalJot})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"rounded-full bg-[#25272614] w-6 h-6 flex justify-center items-center",children:e.jsx("div",{className:"border w-2 h-2 border-solid rotate-45"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Token Price (",r,")"]}),e.jsx("div",{className:"text-md font-bold",children:p.formattedJotPrice})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"rounded-full bg-[#25272614] w-6 h-6 flex justify-center items-center",children:e.jsx("div",{className:"border w-2 h-2 border-solid rotate-45"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Withdrawal amount (",r,")"]}),e.jsx("div",{className:"text-md font-bold",children:p.totalJotPrice})]})]})]}),e.jsx(Te,{}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsxs("span",{className:"text-md font-bold",children:["Total (",r,")"]}),e.jsx("span",{className:"font-bold text-lg text-[#117B37]",children:p.totalwithdraw})]})]})]})}),e.jsxs(ce,{gutter:[16,16],style:{padding:"12px 24px"},children:[e.jsx(le,{xs:24,lg:24,children:e.jsx("div",{className:"text-md font-bold",children:"Epoch History"})}),e.jsx(le,{xs:24,lg:24,children:e.jsx(rt,{columns:D,dataSource:i||[],loading:u,bodyStyle:{cursor:"pointer",overflowX:"auto"},pagination:!1,size:"middle",rowKey:L=>L.id})})]})]})}function zr(){const{isLoadingNote:t}=oe();return e.jsx(Ct,{defaultActiveKey:["issue_note"],children:e.jsx(e.Fragment,{children:!t&&e.jsx(Jr,{})})})}const Qr=function({pool:t,visible:s,onClose:a}){const{address:r}=it(),{notification:i}=Ie.useApp(),[l,o]=n.useState(null),[c,p]=n.useState(!0),h=t.id,[u,d]=n.useState(!1),[f,y]=Ma(),[g,x]=n.useState(""),I=async()=>{p(!0);try{const C=await Q.getPoolLinkedWallet(h);o(C.walletAddress)}catch(C){console.log(C)}p(!1)},v=async()=>{d(!0);try{const{walletAddress:C}=await mt.getLinkedWallet();if(r!=new $s().utils.toChecksumAddress(C))return d(!1),i.error({message:"Invalid wallet address.",description:`Please connect to wallet ${C}`});const M=await Ht(t.poolContractAddress),{transactionHash:m}=await M.methods.setPot(g).send({from:C,maxPriorityFeePerGas:null,maxFeePerGas:null});await kt(Q.getPoolWalletByTx,[m],3e3)&&await I()}catch(C){console.log("link pool wallet failed: ",C)}d(!1)};qs(()=>I());const N={header:{backgroundColor:"transparent"},content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(ve,{onCancel:a,footer:null,centered:!0,width:"35vw",open:s,title:e.jsx("span",{className:"text-lg bg-tr",children:"Link pool to wallet"}),style:{minWidth:500},styles:N,children:e.jsxs("div",{className:"w-full pt-8",children:[!l&&e.jsxs("div",{className:"my-4",children:["Please ensure your pool wallet meet the following conditions:",e.jsxs("ul",{className:"mt-0 -ml-2",children:[e.jsx("li",{children:"The wallet is not linked to any other pools"}),e.jsx("li",{children:"The wallet is empty of currency tokens"})]})]}),c?e.jsx(Be,{active:!0}):l?e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium my-2 text-[#393C3A]",children:"Linked wallet address"}),e.jsx(Re,{className:"mb-4",value:l,disabled:!0,"data-testid":"pool-link-wallet-token",suffix:e.jsx(lt,{title:l===f.value?"Copied":"Copy",onClick:()=>{y(l.toString())},children:e.jsx("div",{className:"rounded-2xl bg-[#25272614] py-1 px-3 cursor-pointer",children:"Copy"})})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs font-medium mb-2 text-[#393C3A]",children:"Linked wallet address"}),e.jsx("div",{className:"mb-4",children:e.jsx(V,{children:e.jsx(V.Item,{name:"poolWallet",rules:[()=>({validator(C,M){return!M||$n(M)?Promise.resolve():Promise.reject(new Error("Invalid wallet address"))}})],children:e.jsx(Re,{value:g,placeholder:"Enter pool's wallet",onChange:C=>x(C.target.value),"data-testid":"pool-link-wallet-input",suffix:e.jsx(lt,{title:g===f.value?"Copied":"Copy",onClick:()=>{y(g.toString())},children:e.jsx("div",{className:"rounded-2xl bg-[#25272614] py-1 px-3 cursor-pointer",children:"Copy"})})})})})}),e.jsx("div",{children:e.jsx(U,{className:"shadow-none h-10 mt-2",type:"primary",block:!0,disabled:!g,onClick:()=>v(),loading:u,"data-testid":"pool-link-wallet-button",children:"Link wallet"})})]})]})})},Ds=0,Zr=1,Xr=function({pool:t,visible:s,onClose:a}){const{address:r}=it(),{isPoolAdmin:i}=Xe(v=>v),[l,o]=n.useState(!1),[c,p]=n.useState(!1),[h,u]=n.useState([]),[d,f]=n.useState(Ds),{assets:y,reloadPoolAssets:g}=oe(),x=async()=>{if(!i)return ct.error({message:"Invalid wallet address",description:"The linked wallet has no POOL_ADMIN role"});const{walletAddress:v}=await mt.getLinkedWallet();if(String(r).toLowerCase()!==String(v).toLowerCase())return ct.error({message:"Invalid wallet address",description:`Please connect to wallet: ${v} to proceed`});p(!0);try{await Ut.setScorecardsToContract(t.poolContractAddress,h,r),ct.success({message:"Success",description:"Updated scorecards successfully"}),f(Zr)}catch(N){console.error("Error update scorecards",N),ct.error({message:"Error",description:"Something wrong. Unable to update scorecards"})}p(!1)},I=async()=>{if(!i)return ct.error({message:"Invalid wallet address",description:"The linked wallet has no POOL_ADMIN role"});const{walletAddress:v}=await mt.getLinkedWallet();if(String(r).toLowerCase()!==String(v).toLowerCase())return ct.error({message:"Invalid wallet address",description:`Please connect to wallet: ${v} to proceed`});p(!0);try{const N=Un(y,10);for(const C of N)await Ut.updateBatchAssetRiskScore(t.poolContractAddress,C.map(M=>M.tokenId),r);ct.success({message:"Success",description:"Updated all assets successfully"}),window.location.reload()}catch(N){console.error("Error update scorecards",N),ct.error({message:"Error",description:"Something wrong. Unable to update scorecards"})}p(!1)};return n.useEffect(()=>{const v=async()=>{o(!0);try{const N=await Ut.getScorecards(t.id);u(N.map(C=>({...C,isNewest:!0})))}catch(N){console.error(N)}o(!1)};t.id&&v()},[t.id]),e.jsx(ve,{onCancel:a,footer:null,title:"Risk score",centered:!0,width:"fit-content",open:s,style:{top:0,minWidth:900,paddingBottom:0},children:e.jsxs("div",{children:[e.jsx(Fa,{editable:!0,scorecards:h,isLoading:l,setScorecards:u}),e.jsxs("div",{className:"w-full flex items-center flex-col mt-4 gap-4",children:[e.jsx("label",{style:{fontSize:14,color:"#070A0E"},children:"Please review the scorecard carefully before updating!"}),e.jsxs("div",{style:{display:"flex",gap:"12px",width:"360px"},children:[e.jsx(U,{onClick:a,type:"secondary",style:{width:"100%"},children:"Close"}),d==Ds?e.jsx(U,{disabled:l||h.length===0,loading:c,onClick:x,type:"primary",style:{width:"100%"},children:"Update"}):e.jsx(U,{disabled:l||h.length===0,loading:c,onClick:I,type:"primary",style:{width:"100%"},children:"Update asset risk score"})]})]})]})})},eo=ta.abi,to=({pool:t,visible:s,onClose:a})=>{const{address:r}=it(),{notification:i}=Ie.useApp(),[l,o]=n.useState(""),[c,p]=n.useState(!1),[h,u]=n.useState(!1),[d,f]=n.useState(0),[y,g]=n.useState(0),[x,I]=n.useState(null),[v,N]=n.useState(-1),C=async(E,$)=>{const D=await Xn(),A=new D.eth.Contract(eo,E.currency.tokenAddress),{balanceOf:S,allowance:R,decimals:L}=A.methods,F=await Promise.all([S($).call(),L().call()]);let{[0]:j,[1]:O}=F;O=new je(O).toNumber();const w=new je(j).div(Math.pow(10,O)).toNumber();N(O),f(+w);const K=await R($,E.poolContractAddress).call();g(te(K.toString()/10**O,O)),u(K>0),I(A)},M=async()=>{if(v===-1)return;if((r==null?void 0:r.toLowerCase())!==l.toLowerCase())return i.error({message:"Invalid wallet address.",description:`Please connect to wallet ${l}`,style:{width:"calc(100% + 20px)"}});p(!0);const E=+y*Math.pow(10,v);try{await x.methods.approve(t.poolContractAddress,E.toLocaleString("fullwide",{useGrouping:!1})).send({from:l,maxPriorityFeePerGas:null,maxFeePerGas:null}),i.success({message:"Approved spend reserve successfully"})}catch($){console.error($),i.error({message:"Approve failed",description:$.message})}finally{p(!1),a()}};qs(async()=>{const{walletAddress:E}=await Q.getPoolLinkedWallet(t.id);o(E)}),n.useEffect(()=>{t&&!Qe(l)&&C(t,l).catch(console.log)},[t,l]);const m=t==null?void 0:t.currency.shortCode,b={header:{backgroundColor:"transparent"},content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(ve,{onCancel:a,footer:null,centered:!0,width:"35vw",open:s,title:e.jsx("span",{className:"text-lg bg-tr",children:"Manage reserve"}),style:{minWidth:500},styles:b,children:e.jsxs("div",{className:"mt-6",children:[e.jsxs(V,{wrapperCol:{span:24},labelCol:{span:24},children:[e.jsx(V.Item,{label:"External wallet address",children:e.jsx(Re,{value:l,readOnly:!0,disabled:!0})}),e.jsx(V.Item,{label:"Approved spend amount",children:e.jsxs(Bn.Compact,{className:"w-full",children:[e.jsx(Re,{rootClassName:"w-full",className:"w-full",placeholder:"0",value:y,type:"number",onChange:E=>g(Math.min(+E.target.value,d))}),e.jsx(Ze,{style:{width:"20%"},onMouseUp:E=>{E.stopPropagation()},bordered:!0,suffixIcon:e.jsx(Bs,{style:{color:"black"},color:"black"}),value:m,disabled:!1,children:e.jsx(Ze.Option,{value:m,children:m})}),e.jsx(U,{className:"!rounded-r-md shadow-none text-center flex items-center text-xs",type:"primary",onClick:()=>g(d),children:"MAX"})]})})]}),e.jsx("div",{className:"w-full mt-8",children:e.jsx(U,{className:"shadow-none h-10",loading:c,disabled:!x,onClick:()=>M(),type:"primary",style:{width:"100%",marginBottom:20},children:"Submit"})})]})})},so=({pool:t,visible:s,onClose:a,reloadPool:r})=>{const{message:i}=Ie.useApp(),[l,o]=n.useState(!1),[c,p]=n.useState(t.uploadAssetLegalDocumentId),[h]=Ve(ee.getLegalList,t.id,De.category.LEGAL,De.SIGNED);return e.jsx(ve,{onCancel:a,footer:null,width:"fit-content",open:s,centered:!0,style:{top:0,minWidth:500,paddingBottom:0},children:e.jsxs("div",{style:{width:500,margin:"0 auto",marginTop:20},children:[e.jsx("div",{children:"Originator"}),e.jsx(Ne,{style:{width:"100%",marginTop:20},placeholder:"Legal document",items:h,dateKey:"createdAt",nameKey:"name",selectedValue:c,onSelect:u=>p(u)}),e.jsx("div",{style:{width:"100%",marginTop:20},children:e.jsx(U,{loading:l,disabled:!1,onClick:async()=>{o(!0);try{await Q.updateUploadCollateralDocId(t.id,{uploadAssetLegalDocumentId:c}),r(),a(),i.success("Pool is updated succesfully")}catch(u){console.log(u)}finally{o(!1)}},type:"primary",style:{width:"100%",marginBottom:20},children:"Submit"})})]})})},no=function({visible:t,onClose:s}){var I;const{notification:a}=Ie.useApp(),{pool:r,reloadPool:i,poolData:l}=oe(),{isPoolAdmin:o}=Xe(v=>v),{address:c}=it(),p=r.currency.decimals,h=n.useMemo(()=>new je(r.debtCeiling).div(10**p).toNumber(),[r.debtCeiling]),[u,d]=n.useState(h),[f,y]=n.useState(!1),g=async(v,N)=>{try{y(!0);const{walletAddress:C}=await mt.getLinkedWallet();if(String(c).toLowerCase()!==String(C).toLowerCase())throw new Error(`Current wallet address is not valid. Please connect to wallet ${C}`);if(!o)throw new Error("Current wallet address does not have permission to create pool");const M=await Ht(r.poolContractAddress);if(v.debtCeiling){if(Number(v.debtCeiling)<0)throw new Error("Debt Ceiling must be greater than 0");const m=te(v.debtCeiling*10**r.currency.decimals).toLocaleString("fullwide",{useGrouping:!1}),b=await M.methods.setDebtCeiling(m).send({from:c,maxPriorityFeePerGas:null,maxFeePerGas:null});console.log("--->debtCeiling",m,b),await kt(Q.getUpdateDebtCeilingByTx,[b.transactionHash],3e3)}N&&N(),i(),s(),a.success({message:"Pool parameter updated successfully!"})}catch(C){a.error({message:C.message||"Something went wrong"})}y(!1)},x={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(ve,{onCancel:s,footer:null,width:"35vw",centered:!0,style:{minWidth:410},open:t,styles:x,children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-lg mb-6",children:"Edit target value of debt ceiling"}),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2",children:"Target Value"}),e.jsx("div",{children:e.jsx(Le,{className:"w-full",min:0,value:u,placeholder:"Enter number",onChange:v=>d(v),suffix:(I=r==null?void 0:r.currency)==null?void 0:I.shortCode,disabled:!o,type:"number"})}),e.jsx("div",{className:"mt-8",children:e.jsx(U,{className:"shadow-none w-full mb-1 h-10",type:"primary",onClick:()=>g({debtCeiling:u}),disabled:u==h||!u||!o||u<=0,loading:f,children:"Save"})})]})]})})},ao=({isVisible:t,onClose:s})=>{const{notification:a}=Ie.useApp(),{pool:r,reloadPool:i}=oe(),[l,o]=n.useState(!1),[c,p]=n.useState({});n.useEffect(()=>{t&&p({...r,id:r.id,name:r.name,shortDescription:r.shortDescription||"",paragraphSummary:r.paragraphSummary||"",creatorCompanyId:r.creatorCompanyId,poolProfilePhoto:r.poolProfilePhoto})},[t,r]);const h=async()=>{try{o(!0);const d={...c,name:c.name,shortDescription:c.shortDescription,paragraphSummary:c.paragraphSummary};await Q.updatePool(c.id,d),o(!1),s(!1),Pe.success("Update pool successfully"),i()}catch(d){return console.error(d),a.error({message:(d==null?void 0:d.message)||"Something went wrong"})}finally{o(!1)}},u={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(ve,{onCancel:()=>{s(),p({})},footer:null,width:"35vw",centered:!0,open:t,style:{minWidth:500},styles:u,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-lg mb-6",children:"Edit pool information"}),e.jsxs(V,{wrapperCol:{span:24},labelCol:{span:24},children:[e.jsx(V.Item,{label:"Name",className:"mb-4",children:e.jsx(Re,{placeholder:"Name",id:"name",value:c.name,onChange:d=>p({...c,name:d.target.value})})}),e.jsx(V.Item,{label:"Pool in words",className:"mb-3",children:e.jsx(Re.TextArea,{maxLength:350,style:{height:110},placeholder:"Enter text...",type:"textarea",value:c.shortDescription,onChange:d=>{d.target.value.length<=350&&p({...c,shortDescription:d.target.value})}})}),e.jsxs("div",{style:{float:"right",color:"#858585",marginTop:5},children:[z(c,"shortDescription.length",0),"/350"]}),e.jsx("div",{style:{clear:"both"}}),e.jsx(V.Item,{label:"Paragraph summary",className:"w-full",children:e.jsx(Re.TextArea,{className:"w-full",maxLength:350,style:{height:110},placeholder:"Enter text...",type:"textarea",value:c.paragraphSummary,onChange:d=>{d.target.value.length<=350&&p({...c,paragraphSummary:d.target.value})}})}),e.jsxs("div",{style:{float:"right",color:"#858585",marginBottom:10,marginTop:5},children:[z(c,"paragraphSummary.length",0),"/350"]})]}),e.jsx("div",{style:{width:"100%",marginTop:20},children:e.jsx(U,{className:"shadow-none h-12",loading:l,disabled:!c.name||!c.shortDescription,onClick:h,type:"primary",style:{width:"100%"},children:"Update"})})]})})},ro=function({visible:t,onClose:s}){const{notification:a}=Ie.useApp(),{pool:r,reloadPool:i,poolData:l}=oe(),{isPoolAdmin:o}=Xe(x=>x),{address:c}=it(),p=n.useMemo(()=>r.minFirstLossCushion/ft),[h,u]=n.useState(p),[d,f]=n.useState(!1),y=async(x,I)=>{try{f(!0);const{walletAddress:v}=await mt.getLinkedWallet();if(String(c).toLowerCase()!==String(v).toLowerCase())throw new Error(`Current wallet address is not valid. Please connect to wallet ${v}`);if(!o)throw new Error("Current wallet address does not have permission to create pool");const N=await Ht(r.poolContractAddress);if(x.minFirstLossCushion){if(Number(x.minFirstLossCushion)<0||Number(x.minFirstLossCushion)>100)throw new Error("Min First Loss Cushion must be between 0 to 100");const C=te(x.minFirstLossCushion*ft).toLocaleString("fullwide",{useGrouping:!1}),M=await N.methods.setMinFirstLossCushion(C).send({from:c,maxPriorityFeePerGas:null,maxFeePerGas:null});console.log("--->minFirstLossCushion",C,M),await kt(Q.getUpdateMinFirstLossByTx,[M.transactionHash],3e3)}I&&I(),i(),s(),a.success({message:"Pool parameter updated successfully!"})}catch(v){a.error({message:v.message||"Something went wrong"})}f(!1)},g={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(ve,{onCancel:s,footer:null,width:"35vw",centered:!0,style:{minWidth:410},open:t,styles:g,children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-lg mb-6",children:"Edit target value of minimum first loss"}),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2",children:"Target Value"}),e.jsx("div",{children:e.jsx(Le,{className:"w-full",value:h,placeholder:"Enter number",onChange:x=>u(x),min:0,max:100,suffix:"%",disabled:!o,type:"number"})}),e.jsx("div",{className:"mt-8",children:e.jsx(U,{className:"shadow-none w-full mb-1 h-10",type:"primary",onClick:()=>y({minFirstLossCushion:h}),disabled:!o||h==p||!h||h<=0||h>100,loading:d,children:"Save"})})]})]})})},oo=({setLoadingEditor:t})=>{const{control:s}=xt();return e.jsxs("div",{children:[e.jsx(Oe,{control:s,name:"poolCard.label",render:({field:a})=>e.jsx(V.Item,{label:"Label",children:e.jsx(X,{type:"input",...a,placeholder:"Label"})})}),e.jsx(Oe,{control:s,name:"poolCard.content",render:({field:{value:a,onChange:r}})=>e.jsx(V.Item,{label:"Content",children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Pt,{setLoadingEditor:t,content:a??" ",handleEditorChange:r})})})})]})},lo=({setLoadingEditor:t})=>{const{control:s}=xt();return e.jsxs("div",{children:[e.jsx(Oe,{control:s,name:"headline.label",render:({field:a})=>e.jsx(V.Item,{label:"Label",children:e.jsx(X,{...a,type:"input",placeholder:"Label"})})}),e.jsx(Oe,{control:s,name:"headline.content",render:({field:{onChange:a,value:r}})=>e.jsx(V.Item,{label:"Content",children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Pt,{setLoadingEditor:t,content:r??" ",handleEditorChange:a})})})})]})},ds=3,io=({setLoadingEditor:t})=>{const{control:s}=xt();return e.jsx("div",{children:Gs(ds,a=>e.jsxs(_s.Fragment,{children:[e.jsxs("div",{children:[e.jsx(Oe,{control:s,name:`highlight.${a}.label`,render:({field:r})=>e.jsx(V.Item,{label:`Hightlight Label ${a+1}`,children:e.jsx(X,{type:"input",...r,placeholder:`Hightlight Label ${a+1}`})})}),e.jsx(Oe,{control:s,name:`highlight.${a}.content`,render:({field:{onChange:r,value:i}})=>e.jsx(V.Item,{label:`Highlight Content ${a+1}`,children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Pt,{setLoadingEditor:t,content:i??" ",handleEditorChange:r})})})})]}),a!==ds-1&&e.jsx(Te,{})]},a))})},co=()=>{const{control:t}=xt();return e.jsxs("div",{children:[e.jsx(Oe,{control:t,name:"summary.label",render:({field:s})=>e.jsx(V.Item,{label:"Label",children:e.jsx(X,{...s,type:"input",placeholder:"Label"})})}),e.jsx(Oe,{control:t,name:"summary.link",render:({field:s})=>e.jsx(V.Item,{label:"Link",children:e.jsx(X,{...s,type:"input",placeholder:"Link"})})})]})},uo=({pool:t,isMigration:s,setLoadingEditor:a})=>{const{control:r}=xt(),i=t==null?void 0:t.id,[l,o]=Ve(Q.getPoolList);return o?e.jsx(Be,{active:!0}):e.jsxs("div",{children:[e.jsx(Oe,{control:r,name:"migration.label",render:({field:c})=>e.jsx(V.Item,{label:"Label",children:e.jsx(X,{...c,type:"input",placeholder:"Label"})})}),e.jsx(Oe,{control:r,name:"migration.content",render:({field:{value:c,onChange:p}})=>e.jsx(V.Item,{label:"Content",children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Pt,{setLoadingEditor:a,content:c??" ",handleEditorChange:p})})})}),s?e.jsx(Oe,{control:r,name:"migration.toPoolId",render:({field:c})=>{var h,u;const p=(u=(h=l??[])==null?void 0:h.filter(d=>d.id!==i))==null?void 0:u.map(d=>({value:String(d.id),text:d.name}));return e.jsx(V.Item,{label:"Migrate to pool",children:e.jsx(Gn,{...c,value:c.value?String(c.value):"",dropdownMatchSelectWidth:!0,dataSource:p??[]})})}}):e.jsxs(e.Fragment,{children:[e.jsx(Oe,{control:r,name:"migration.actionLabel",render:({field:c})=>e.jsx(V.Item,{label:"Label",children:e.jsx(X,{...c,type:"input",placeholder:"Action Label"})})}),e.jsx(Oe,{control:r,name:"migration.actionLink",render:({field:c})=>e.jsx(V.Item,{label:"Link",children:e.jsx(X,{...c,type:"input",placeholder:"Action link"})})})]})]})},mo=({setLoadingEditor:t})=>{const{control:s}=xt();return e.jsx("div",{children:e.jsx(Oe,{control:s,name:"apr.content",render:({field:{value:a,onChange:r}})=>e.jsx(V.Item,{label:"Content",children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Pt,{setLoadingEditor:t,content:a??" ",handleEditorChange:r})})})})})},po=()=>{const{control:t}=xt();return e.jsxs("div",{children:[e.jsx(Oe,{control:t,name:"asset.label",render:({field:s})=>e.jsx(V.Item,{label:"Label",children:e.jsx(X,{...s,type:"input",placeholder:"Label"})})}),e.jsx(Oe,{control:t,name:"asset.link",render:({field:s})=>e.jsx(V.Item,{label:"Link",children:e.jsx(X,{...s,type:"input",placeholder:"Link"})})})]})},ho=({visible:t,onClose:s,reloadPool:a})=>{const{notification:r}=Ie.useApp(),{pool:i}=oe(),[l,o]=n.useState(!1),[c,p]=n.useState(null),[h,u]=n.useState(!0),d=wa({defaultValues:{poolCard:null,headline:null,highlight:null,summary:null,migration:null,apr:null,asset:null}}),{handleSubmit:f,reset:y,getValues:g}=d,{value:x,loading:I,retry:v}=zs(async()=>{var b,E,$,D,A,S,R,L;if(!(i!=null&&i.id))return;const{data:m}=await Q.getPoolMigration(i.id);return m!=null&&m.poolNotification&&(y({poolCard:{...(b=m.poolNotification)==null?void 0:b.poolCard},headline:{...(E=m.poolNotification)==null?void 0:E.headline},highlight:Gs(ds,F=>{var j,O;return{...(O=(j=m.poolNotification)==null?void 0:j.highlight)==null?void 0:O[F],content_ref:g(`highlight.${F}.content_ref`)}}),summary:($=m.poolNotification)==null?void 0:$.summary,migration:{...(D=m.poolNotification)==null?void 0:D.migration},apr:{...(A=m.poolNotification)==null?void 0:A.apr},asset:(S=m.poolNotification)==null?void 0:S.asset},{keepValues:!1}),(L=(R=m.poolNotification)==null?void 0:R.migration)!=null&&L.toPoolId&&o(!0)),m.poolNotification},[i==null?void 0:i.id]),N=!!x,C={defaultValue:x,pool:i,isMigration:l},M=n.useMemo(()=>f(async m=>{var D,A,S,R,L,F,j,O,w,K,q,k;if(!c)return;const{key:b,type:E}=c,$={poolId:i==null?void 0:i.id,highlight:Yn(m==null?void 0:m.highlight,H=>({label:H==null?void 0:H.label,content:(H==null?void 0:H.content)??null})),poolCard:{label:((D=m==null?void 0:m.poolCard)==null?void 0:D.label)??null,content:((A=m==null?void 0:m.poolCard)==null?void 0:A.content)??null},summary:m.summary,headline:{label:((S=m==null?void 0:m.headline)==null?void 0:S.label)??null,content:((R=m==null?void 0:m.headline)==null?void 0:R.content)??null},migration:{label:(L=m==null?void 0:m.migration)==null?void 0:L.label,content:((F=m==null?void 0:m.migration)==null?void 0:F.content)??null,...l?{toPoolId:(j=m==null?void 0:m.migration)!=null&&j.toPoolId?+((O=m==null?void 0:m.migration)==null?void 0:O.toPoolId):null}:{actionLabel:(w=m==null?void 0:m.migration)==null?void 0:w.actionLabel,actionLink:(K=m==null?void 0:m.migration)==null?void 0:K.actionLink}},apr:{content:((q=m==null?void 0:m.apr)==null?void 0:q.content)??null},asset:m.asset};if(N&&(x!=null&&x.id)){let H=$[b];E==="deleted"?H=null:E==="published"?H={...H,published:{...H}}:H={...H,...((k=x==null?void 0:x[b])==null?void 0:k.published)&&{published:{...x[b].published}}},await Q.updatePoolMigration(x.id,{[b]:H})}else await Q.createPoolMigration($);r.success({message:"Success",description:`${Kn(b)}'s contents have been ${E}`}),v()}),[c,f,N,l,i==null?void 0:i.id,v,x]);return e.jsxs(ve,{onCancel:()=>{s()},footer:null,width:"fit-content",centered:!0,open:t,title:N?"Edit Notification":"Create Notification",classNames:{header:"font-medium text-lg",body:"max-h-[700px] overflow-y-auto"},children:[I&&!x&&e.jsx(Be,{active:!0}),e.jsx(Na,{...d,children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(V,{layout:"vertical",onFinish:M,children:[{Component:oo,key:"poolCard",header:"Pool Card"},{Component:lo,key:"headline",header:"Headline"},{Component:io,key:"highlight",header:"Highlight"},{Component:co,key:"summary",header:"Excutive Summary"},{Component:uo,key:"migration",header:e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{display:"inline-block",width:100},children:l?"Migration":"Promo"}),e.jsx(Vs,{size:"small",checked:l,onChange:(m,b)=>{b.stopPropagation(),b.preventDefault(),o(m)}})]})},{Component:mo,header:"Target Return",key:"apr"},{Component:po,header:"Collateral",key:"asset"}].map(({Component:m,header:b,key:E})=>e.jsx(Ue,{className:"mb-4 w-[700px]",children:e.jsx(Ms,{defaultActiveKey:[E],className:"bg-white rounded-3xl",accordion:!0,style:{content:"none"},expandIcon:({isActive:$})=>e.jsxs("div",{children:[$?e.jsx(Wn,{}):e.jsx(Bs,{}),e.jsx("span",{className:"text-sm font-bold ml-2",children:b})]}),collapsible:"icon",expandIconPosition:"start",bordered:!1,items:[{key:E,label:e.jsxs("div",{className:"flex justify-end",children:[e.jsx(U,{htmlType:"submit",type:"link",className:"text-main-green",onClick:$=>{$.stopPropagation(),p({key:E,type:"saved"})},children:"Save as Draft"}),e.jsx(U,{htmlType:"submit",type:"link",className:"text-main-green",onClick:$=>{$.stopPropagation(),p({key:E,type:"published"})},children:"Publish"}),e.jsx(U,{htmlType:"submit",type:"link",danger:!0,onClick:$=>{$.stopPropagation(),p({key:E,type:"deleted"})},children:"Delete"})]}),children:e.jsxs("div",{children:[h&&e.jsx(Be,{loading:!0,active:!0}),e.jsx(m,{...C,setLoadingEditor:u})]})}]})},E))})})})]})},go=()=>{const t=pt(),{pool:s}=oe(),[a,r,i]=Ve(Q.getPoolHolders,s.id),[l,o]=n.useState(!1),c=()=>{o(!0),Q.getPoolHoldersExport(s.id.toString()).then(u=>{const d=u.headers["content-disposition"];let f=`holders-${s.id}-${new Date().toISOString()}.csv`;if(d){const I=d.match(/filename="(.+)"/);I.length>1&&(f=I[1])}const y=new Blob([u.data],{type:"text/csv"}),g=document.createElement("a"),x=window.URL.createObjectURL(y);g.href=x,g.download=f,document.body.appendChild(g),g.click(),g.remove(),window.URL.revokeObjectURL(x),o(!1)}).catch(u=>{console.error("Failed to download CSV file",u),Pe.error(u.message),o(!1)})},[p,h]=n.useState();return e.jsxs(Ct,{children:[e.jsx("div",{className:"flex flex-row justify-end",children:e.jsx(U,{icon:e.jsx(Hn,{onPointerEnterCapture:void 0,onPointerLeaveCapture:void 0}),loading:l,onClick:()=>c(),disabled:!1,children:"Download"})}),e.jsx(Oa,{data:a==null?void 0:a.map(u=>({...u,key:u.id})),loading:r,fetchInvestors:i,onView:h}),e.jsx(Ra,{investor:p,open:!!p,onClose:()=>{h(void 0)},onViewProfile:u=>{t(`/pool-setting/${s.id}/investors/${u==null?void 0:u.address}`)}})]})},qe={assets:"assets",notes:"notes",settings:"settings",reserve:"reserve",holders:"holders"},Xo=()=>{const{message:t}=Ie.useApp(),s=pt(),a=qn(),[r,i,l]=ys(Q.getPoolDetail,{id:a.id}),[o,,c]=ys(Q.getMainFilterTemplateInPool,a.id),[p,h,u]=Ve(Q.getPoolEvents,a.id),[d,,f]=Ve(Yt.getAllAssets,{poolId:a.id,status:[Qt.FINANCED,Qt.PARTIAL_REPAY,Qt.REPAID],isPublicView:!0}),[y,g,x]=Ve(Q.getPoolTransactions,a.id),[I,v]=n.useState(!1),[N,C]=n.useState(!1),[M,m]=n.useState([]),[b,E]=n.useState(!1),[$,D]=n.useState(!1),[A,S]=n.useState(!1),[R,L]=n.useState(!1),{calculateDrawdownAmount:F,scorecards:j,loading:O,refresh:w}=na({poolId:a.id}),K=n.useMemo(()=>({...r,assets:d,poolEvents:p,mainFilterTemplate:o}),[r,d,o,p]),q=n.useCallback(()=>{L(!0),Promise.all([l(),u(),f(),x(),c(),w()]).then(()=>L(!1))},[l,c,f,u,x,w]),[k,H]=n.useState(!1),[se,de]=n.useState(!1),[ue,fe]=n.useState(void 0),[xe,ne]=n.useState(!1),[me,ye]=n.useState(!1),[Ce,et]=n.useState(!1),[Ae,Ge]=n.useState(!1),[P,B]=n.useState(!1),[_,J]=n.useState(!1),[Z,ae]=n.useState(!1),[Y,pe]=n.useState(!1),re=n.useCallback(async()=>{const Ee=await Ks.getCountries();m(Ee)},[]);n.useEffect(()=>{re()},[re]);const Se=n.useCallback(Ee=>{s(`/pool-setting/${a.id}/${Ee}`)},[a.id]),ke=n.useCallback(async()=>{await Q.closePool(K.id),s("/pool"),t.success("Pool has been closed")},[K.id]),_e=n.useCallback(async()=>{await Q.openPool(K.id),q(),t.success("Pool has been opened")},[K.id,q]),be=a.tab||qe.settings,G=d,he=!K.id||i||R||h||O,[Je,Ye]=n.useState({});return n.useEffect(()=>{(async()=>{if(K.id){const Ee=z(K,"poolEvents[0]",{});console.log("event",Ee);const qt={poolContractAddress:K.poolContractAddress,saleEventAddress:Ee.saleEventAddress,juniorSaleEventAddress:Ee.juniorSaleEventAddress,jotTokenAddress:Ee.juniorNotesTokenAddress,sotTokenAddress:Ee.notesTokenAddress};try{const wt=await sa(qt),Nt=ea(wt);Ye(Nt)}catch(wt){console.log("error get poolInfo: ",wt)}}})()},[K]),e.jsxs(zn.Provider,{value:{poolHistories:y,pool:K,poolEvents:p,note:p.length?p[p.length-1]:{},isLoadingNote:!p,assets:G,reloadPoolAssets:f,tab:be,setTab:Se,closePool:ke,openPool:_e,securityModalVisible:k,setSecurityModalVisible:H,noteUpdateVisible:ue,setNoteUpdateVisible:fe,poolSweepVisible:I,setPoolSweepVisible:v,epochSettingVisible:N,setEpochSettingVisible:C,bankAccountModalVisible:se,setBankAccountModalVisible:de,isUpdatingAssets:b,setUpdatingAssets:E,isShowUploadModal:xe,setShowUploadModal:ne,isRepaymentModalVisible:$,setRepaymentModalVisible:D,poolUpdateVisible:me,setPoolUpdateVisible:ye,isPoolParametersModalVisible:Ce,setPoolParametersModalVisible:et,isPoolParameterMinFirstLossModalVisible:Ae,setPoolParameterMinFirstLossModalVisible:Ge,reloadPool:q,poolDrawDownVisible:A,setDrawDownVisible:S,isRiskScorecardModalVisible:P,setRiskScorecardModalVisible:B,isNotiModalVisible:_,setNotiModalVisible:J,draftingDocModalVisible:Z,setDraftingDocModalVisible:ae,isEditPoolModalVisible:Y,setEditPoolModalVisible:pe,poolData:Je,calculateDrawdownAmount:F,scorecards:j},children:[K&&e.jsx(Va,{chainId:K.chainId}),e.jsx(ce,{children:e.jsxs(le,{lg:{span:20,offset:2},children:[he&&e.jsx(Be,{active:!0,loading:!0}),!he&&e.jsx(e.Fragment,{children:e.jsxs("div",{children:[e.jsx(Ua,{}),e.jsx(Ha,{}),be===qe.notes&&e.jsx(Wa,{}),be===qe.settings&&e.jsx(Ar,{}),be===qe.reserve&&e.jsx(zr,{}),be===qe.assets&&e.jsx(dr,{}),be===qe.holders&&e.jsx(go,{})]})})]})}),N&&e.jsx(Sr,{pool:K,visible:N,onClose:()=>C(!1)}),xe&&e.jsx(Yr,{onClose:()=>{ne(!1)},isOpen:!0,isUpdatingAssets:b,countries:M,reloadPool:q}),$&&e.jsx(Aa,{isVisible:$,setVisible:D,reloadPool:q}),A&&e.jsx(aa,{isOpen:A,onClose:()=>{S(!1)}}),!!ue&&e.jsx(qr,{pool:K,noteType:ue,visible:!!ue,poolEvent:K.poolEvents[0],onClose:()=>fe(!1),reloadPool:q}),k&&e.jsx(Hr,{pool:K,visible:k,onClose:()=>H(!1),reloadPool:q}),se&&e.jsx(Qr,{pool:K,visible:se,onClose:()=>de(!1)}),I&&e.jsx(to,{pool:K,visible:I,onClose:()=>v(!1)}),P&&e.jsx(Xr,{visible:P,pool:K,onClose:()=>B(!1)}),me&&e.jsx(so,{pool:K,visible:me,onClose:()=>ye(!1),reloadPool:q}),Ce&&e.jsx(no,{visible:Ce,onClose:()=>et(!1)}),Ae&&e.jsx(ro,{visible:Ae,onClose:()=>Ge(!1)}),e.jsx(ao,{isVisible:Y,onClose:()=>{pe(!1)}}),_&&e.jsx(ho,{visible:_,onClose:()=>J(!1),reloadPool:q})]})};export{qe as Tab,Xo as default};
