import{r as y,S as O,j as e,an as Z,ah as k,ak as P,ax as te,aj as A,ay as ae,R as ne,al as M,am as ue,az as K,ac as U,ad as R,aA as G,aB as le,ai as w,aC as xe,aD as oe,c as ce,T as fe,aE as he,aF as je,aG as pe,aH as ge,a6 as ye,n as be,ae as ve}from"./vendor-WQejLG7Y.js";import{p as q}from"./pool.service-DXigxJcB.js";import{a as T,l as Ne,c as Te,n as Q,d as Ae,R as Ie,p as re}from"./app-q0ws3Yx0.js";import{q as we}from"./base-CumTa13P.js";import{r as ke,f as E,g as W,n as p}from"./index-BUY2Cjej.js";import{g as Pe,a as Se}from"./asset-psWvgQPY.js";import{d as De}from"./index-YDRpzjTi.js";import{u as D}from"./util.service-DGlW4vEA.js";import{C as Ce,u as Oe}from"./usePoolData-DTvfbm5K.js";import{A as J,a as Ee}from"./assetStatus-D1v3GkIP.js";import{u as C}from"./useAsync-Dl5FScg5.js";import{l as X,P as Me}from"./pdf-DFr8ztBQ.js";import{t as B,g as Re}from"./explorer-BDD-Qifw.js";import{u as _e}from"./fetchList-Dx9pDj27.js";import{M as Le}from"./myDocumentsModal-_TegKspg.js";import{u as Fe,N as Ye}from"./NetworkMismatchAlert-BTQA0hRA.js";import"./useAsyncFn-DMoxp3xu.js";import"./attachment.service-CbFqwko5.js";const $e={getPoolMigration:"/api/v1/pool-migration/:poolId"};class He{async getPoolMigration(s){const t=await ke.getRequestInstance(),c=$e.getPoolMigration.replace(":poolId",s),h=await t.get(c),{data:o}=h;return o}}const de=new He,Ve=u=>{var f,N,_,L,H,S,F,V;const{note:s,pool:t,isClosed:c,isJunior:h,isSenior:o,poolData:n,targetAmount:i,poolValue:r,remainingAmount:m,projectedAPY:d}=u;y.useMemo(()=>{var x;return E(new O(n.totalSupplyOfSOT||0),((x=t==null?void 0:t.currency)==null?void 0:x.decimals)||18)},[(f=t==null?void 0:t.currency)==null?void 0:f.decimals,n.totalSupplyOfSOT]),y.useMemo(()=>{var x;return E(new O(n.totalSupplyOfJOT||0),((x=t==null?void 0:t.currency)==null?void 0:x.decimals)||18)},[(N=t==null?void 0:t.currency)==null?void 0:N.decimals,n.totalSupplyOfJOT]);const l=y.useMemo(()=>!!(s!=null&&s.notesTokenAddress),[s]),a=y.useMemo(()=>{var x;return E(new O(n.sotTargetAmount).minus(new O(n.sotCurrencyRaised)),((x=t==null?void 0:t.currency)==null?void 0:x.decimals)||18)},[n.sotCurrencyRaised,n.sotTargetAmount]),j=y.useMemo(()=>{var x;return E(new O(n.jotTargetAmount).minus(new O(n.jotCurrencyRaised)),((x=t==null?void 0:t.currency)==null?void 0:x.decimals)||18)},[n.jotCurrencyRaised,n.jotTargetAmount]);console.log("---> poolData",n);const I=y.useMemo(()=>{var x,Y;return E(new O(((x=n.tokenPrices)==null?void 0:x.sotPrice)||0),((Y=t==null?void 0:t.currency)==null?void 0:Y.decimals)||18)},[(_=t==null?void 0:t.currency)==null?void 0:_.decimals,(L=n.tokenPrices)==null?void 0:L.sotPrice]),g=y.useMemo(()=>{var x,Y;return E(new O(((x=n.tokenPrices)==null?void 0:x.jotPrice)||0),((Y=t==null?void 0:t.currency)==null?void 0:Y.decimals)||18)},[(H=t==null?void 0:t.currency)==null?void 0:H.decimals,(S=n.tokenPrices)==null?void 0:S.jotPrice]);if(u!=null&&u.loading)return e.jsx(Z,{active:!0});if(!s||!t)return null;const b=W(k(t,"currency.shortCode",""));return e.jsx(P,{bordered:!1,children:e.jsx("div",{className:"w-100 bg-gradient-to-b from-[#21BFFA] to-[#1ED760] rounded-3xl p-0.5",children:e.jsxs("div",{className:"w-full h-full p-0   bg-white rounded-3xl pr-4",children:[l&&e.jsx(te,{className:"bg-white rounded-3xl",accordion:!0,style:{content:"none"},expandIcon:({isActive:x})=>e.jsx("div",{className:"flex flex-col justify-center mt-4",children:x?e.jsx(ae,{}):e.jsx(ne,{})}),expandIconPosition:"end",bordered:!1,defaultActiveKey:["1","2"],items:[{key:"1",label:e.jsxs("div",{className:"py-2 p-6",children:[e.jsx("div",{className:"w-1.5 h-8 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("div",{children:e.jsx("span",{className:"font-semibold text-xl",children:"Senior tranche (SOT)"})})]}),children:e.jsxs("div",{className:"flex flex-col gap-2 px-6",children:[e.jsx("div",{className:"h-0.5 bg-[#25272614] mb-1.5"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-normal text-base text-pool-card-info",children:"Ticker"}),e.jsx("span",{className:"font-semibold text-base",children:s.ticker})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"font-normal text-base text-pool-card-info",children:["Investment capacity (",b,")"]}),e.jsx("span",{className:"font-semibold text-base",children:p(a)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"font-normal text-base text-pool-card-info",children:["Current token price (",b,")"]}),e.jsx("span",{className:"font-semibold text-base",children:p(A(I,4))})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"font-normal text-base text-pool-card-info",children:["Minimum investment (",b,")"]}),e.jsx("span",{className:"font-semibold text-base",children:p(E(s.minimumBid,(F=t==null?void 0:t.currency)==null?void 0:F.decimals))})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-normal text-base text-pool-card-info",children:"APR"}),e.jsx("span",{className:"font-semibold text-base",children:`${p((n.sotInterest||0)/1e4,2)}%`})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-normal text-base text-pool-card-info",children:"Term"}),e.jsx("span",{className:"font-semibold text-base",children:s.investmentTerms==0?"Perpetual":`${s.investmentTerms} days`})]})]})}]}),e.jsx(te,{className:"bg-white rounded-3xl",accordion:!0,style:{content:"none"},expandIcon:({isActive:x})=>e.jsx("div",{className:"flex flex-col justify-center mt-4",children:x?e.jsx(ae,{}):e.jsx(ne,{})}),expandIconPosition:"end",bordered:!1,defaultActiveKey:["1","2"],items:[{key:"2",label:e.jsxs("div",{className:"pt-2 px-6 pb-2",children:[e.jsx("div",{className:"w-1.5 h-8 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("span",{className:"font-semibold text-xl",children:"Junior tranche (JOT)"})]}),children:e.jsxs("div",{className:"flex flex-col gap-2 px-6",children:[e.jsx("div",{className:"h-0.5 bg-[#25272614] mb-1.5"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-normal text-base text-pool-card-info",children:"Ticker"}),e.jsx("span",{className:"font-semibold text-base",children:s.ticker})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"font-normal text-base text-pool-card-info",children:["Investment capacity (",b,")"]}),e.jsx("span",{className:"font-semibold text-base",children:p(j)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"font-normal text-base text-pool-card-info",children:["Current token price (",b,")"]}),e.jsx("span",{className:"font-semibold text-base",children:p(A(g,4))})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"font-normal text-base text-pool-card-info",children:["Minimum investment (",b,")"]}),e.jsx("span",{className:"font-semibold text-base",children:p(E(s.juniorMinimumBid,(V=t==null?void 0:t.currency)==null?void 0:V.decimals))})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-normal text-base text-pool-card-info",children:"Term"}),e.jsx("span",{className:"font-semibold text-base",children:s.juniorInvestmentTerm==0?"Perpetual":`${s.juniorInvestmentTerm} days`})]})]})}]})]})})})};function ie({noteType:u}){return e.jsx("div",{className:"bg-[#25272614] inline px-2 rounded-2xl text-gray-900 py-1",children:u})}const Be=({pool:u,poolEvent:s,isJunior:t,isSenior:c,investmentProgress:h,poolValue:o,remainingAmount:n,projectedAPY:i,loadingPoolData:r,isClosed:m,investmentTerms:d})=>{const l=W(k(u,"currency.shortCode",""));return e.jsx(e.Fragment,{children:e.jsxs(P,{className:"rounded-3xl w-full cursor-pointer mb-6",loading:r,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-900 font-semibold mr-2 text-lg ",children:u.name}),t?e.jsx(ie,{noteType:"Junior"}):void 0,e.jsx("span",{className:"inline-block w-2"}),c?e.jsx(ie,{noteType:"Senior"}):void 0]}),e.jsxs("div",{children:[e.jsx("span",{className:"overflow-ellipsis text-pool-card-info",children:"Originated by: "}),e.jsx("span",{className:"font-semibold",children:k(u,"originatorCompany.companyLegalName")})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"overflow-ellipsis text-pool-card-info",children:u.shortDescription}),!!s&&e.jsx(Ce,{endTime:s.closedAt||s.endTime,isClosed:m,event:s})]})]}),e.jsx(M,{className:"my-4",orientationMargin:1}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:"Projected APY (%)"}),e.jsx("span",{className:"text-base font-semibold",children:c?`${p(i)}%`:"Variable"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:["Investment capacity (",l,")"]}),e.jsx("p",{className:"mt-1 mb-0 font-semibold text-base",children:p(n)})]})]}),e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsxs("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:["Pool value (",l,")"]}),e.jsx("p",{className:" font-semibold mt-1 mb-0 text-base",children:p(o)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:"Investment Term"}),e.jsx("p",{className:"mt-1 mb-0  font-semibold text-base",children:d})]})]}),e.jsx("div",{className:"grow-0 flex flex-col justify-end",children:e.jsx(ue,{size:120,strokeLinecap:"butt",strokeWidth:"10",strokeColor:"#1AB752",format:a=>`${a}%`,type:"circle",percent:h})})]})]})})},Je=(u,s,t,c)=>{const h=w();let o=0,n=0,i=0;if(xe(u,(r,m)=>{let d=null,l=0;if(t){const a=r;l=s[m]?A(s[m].expectedPrincipalRepaymentValue+s[m].expectedInterestRepaymentValue,2):0,n=A(n+l,2),d=a.finalMaturityDate||k(a,"debtOrderContractInfo.finalMaturityDate")}else if(c){const a=r;l=a.totalAmount-a.paidAmount,n+=l,d=a.invoiceDueDate||a.paymentDueDate}else l=s[m]?s[m].principal:0,n+=l,d=w(r.startEarningInterestTime).add(r.investmentTerms,"days");if(w(d).endOf("day").isBefore(h)){let a=!1;switch(pool.assetType){case T.LENDING:r.status===Ne.repaid&&(a=!0);break;case T.INVOICE:a=!0;break;case T.NOTE_TOKEN:s[m]&&s[m].principal===0&&(a=!0);break}a||i++,o+=l}}),n===0&&o===0||K(n)||K(o)){const r=A(i/u.length*100,2);return K(r)?0:r}return console.log("calc",n,o),n?A(o/n*100,2):0},Ke=u=>{const{pool:s,loading:t,assets:c,outstandingAmount:h,poolData:o,note:n,targetAmount:i,poolValue:r,remainingAmount:m,projectedAPY:d,isClosed:l,isJunior:a,isSenior:j,loadingPoolData:I}=u,g=(s==null?void 0:s.assetType)===T.LENDING,b=(s==null?void 0:s.assetType)===T.INVOICE,{error:f,value:N=[]}=C(async()=>(s==null?void 0:s.assetType)===T.NOTE_TOKEN?await D.getMultiNoteTokenAssetsBalance(c,s):await D.getLoanAndInvoiceAssetsValues(c,s),[s==null?void 0:s.assetType,c]),{loading:_,error:L,value:H=[]}=C(async()=>{if(!(s!=null&&s.id))return;const v=await de.getPoolMigration(s.id).then($=>{var ee,se;const{published:z,...me}=((se=(ee=$==null?void 0:$.data)==null?void 0:ee.poolNotification)==null?void 0:se.highlight)||{};return z??me});return Object.values(v)??[]},[s==null?void 0:s.id]);f&&console.log(f),L&&console.log(L);const S=Number(o.currentMinFirstLoss||0)/1e4,F=W(k(s,"currency.shortCode","")),V=y.useMemo(()=>A((i-m)/i*100,2),[i,m]),x=n.investmentTerms===0?"Perpetual":K(n.investmentTerms)?"":`${A(n.investmentTerms/30)} Month${n.investmentTerms>30?"s":""}`,Y=c.reduce((v,$,z)=>($.tokenId&&(v+=N[z]||0),v),0);return e.jsx(U,{children:e.jsxs(R,{xs:24,md:24,children:[n&&s&&e.jsx(Be,{poolEvent:n,targetAmount:i,poolValue:r,remainingAmount:m,projectedAPY:d,isJunior:a,isSenior:j,investmentProgress:V,pool:s,isClosed:l,loadingPoolData:I,investmentTerms:x}),e.jsxs(P,{className:"rounded-3xl w-full mb-6",children:[e.jsx("div",{className:"text-gray-900 font-semibold mr-2",children:"Overview"}),e.jsx(M,{className:"my-4",orientationMargin:1}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-pool-card-info",children:["Asset value (",F,")"]}),e.jsx("div",{className:"text-base font-semibold",children:t?e.jsx(G,{style:{marginTop:5}}):p(Y)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"# Asset outstanding"}),e.jsx("div",{className:"text-base font-semibold",children:t?e.jsx(G,{style:{marginTop:5}}):`${c.filter(v=>v.status!==J.REPAID).length} / ${c.length}`})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"Asset quality"}),e.jsxs("div",{className:"text-base font-semibold",children:[Je(c,N,g,b),"% (Past due)"]})]})]}),e.jsx(M,{className:"my-4",orientationMargin:1}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"First loss cushion"}),e.jsx(le,{marks:{[S]:{label:`${p(S)}%`,style:{top:-56,padding:8,backgroundColor:"#1AB752",borderRadius:8,fontStyle:"bold",color:"black"}}},max:Math.max(S,100),className:"w-80 mt-14 ml-5",value:p(S),tooltip:{open:!1,formatter:v=>e.jsxs("span",{children:[v,"%"]})}})]})]}),e.jsxs(P,{className:"rounded-3xl w-full mb-6",loading:_,children:[e.jsx("div",{className:"text-gray-900 font-semibold mr-2",children:"Highlights"}),e.jsx(M,{className:"my-4",orientationMargin:1}),e.jsxs(U,{gutter:[16,16],children:[e.jsx(R,{xs:24,md:8,children:s==null?void 0:s.shortDescription}),e.jsx(R,{xs:24,md:16,children:s==null?void 0:s.paragraphSummary})]}),e.jsx("div",{className:"flex flex-row gap-4 mt-4",children:H.map((v,$)=>e.jsx(P,{children:e.jsxs("div",{children:[e.jsx("div",{children:v==null?void 0:v.label}),e.jsx("p",{children:e.jsx("div",{className:"font-normal",dangerouslySetInnerHTML:{__html:v==null?void 0:v.content}})})]})},$))})]})]})})},Ue=u=>{const{note:s,isJunior:t}=u,c=t?k(s,"juniorGeneralDocumentId"):k(s,"generalDocumentId"),{error:h,loading:o,value:n}=C(async()=>{if(c)try{const r=await X.getDocumentAttachment(c),{sasUrl:m}=r;if(m)return await X.getContentDetail(m)}catch(r){console.log("get doc failed: ",r)}},[c]),i=r=>{r.attribs&&r.attribs.srcset&&(r.attribs.srcSet=r.attribs.srcset,delete r.attribs.srcset)};return h&&console.log(h),e.jsxs(P,{loading:o,className:"rounded-3xl w-full mb-6",children:[e.jsx("div",{className:"text-gray-900 font-semibold mr-2",children:"Executive Summary"}),e.jsx(M,{className:"my-4",orientationMargin:1}),n?e.jsx("div",{className:"w-full bg-white overflow-y-auto",style:{maxHeight:"calc(100vh - 120px)"},children:Me(n,{replace:r=>{if(r.name==="img")return i(r),e.jsx("img",{...r.attribs,onError:m=>{console.log(h),m.target.classList.add("hidden")}});if(r.name==="h2")return e.jsx("strong",{children:r.children[0].data});if(r.name==="h4")return e.jsx("strong",{children:r.children[0].data})}})}):e.jsx("div",{children:"No Content"})]})},We=u=>{const{note:s,pool:t}=u,[c,h]=_e(q.getPoolTransactions,t.id),o=W(k(s,"currency.shortCode","")),n=k(s,"currency.decimals"),i=[{title:"Transaction",dataIndex:"createdTransactionHash",render:f=>e.jsx("a",{href:Re(f),target:"_blank",rel:"noreferrer",children:e.jsx("span",{children:B(f??"",6,4,10)})})},{title:"Account",dataIndex:"from",render:f=>e.jsx("a",{href:D.getWalletLink(f),target:"_blank",rel:"noreferrer",children:e.jsx("span",{children:B(f??"",6,4,10)})})},{title:"Activity",dataIndex:"transactionType",render:(f,N)=>{switch(f){case"REPAY":return"Loan repayment";case 3:return`Invoice repayment - #${k(N,"content.openItemId")}`;case 4:return"Pool setup";case 5:return"Tokenize collaterals";case 6:return"Transfer collaterals to pool";case 7:return"Change of control";case 8:return"Issuance of note";case 9:return"Issuance of junior note";case 10:return"Import collaterals";case 11:return"Export collaterals";case"SOT_PURCHASE":return`Invest ${s.ticker}_SOT`;case"DRAWDOWN":return"Drawdown";case"JOT_PURCHASE":return`Invest ${s.ticker}_JOT`;case"EPOCH_WITHDRAW":return"Epoch withdraw";case 2:default:return"Note redeemed"}}},{title:"Value",dataIndex:"amount",render:(f,N)=>f===null?"":["SOT_PURCHASE","JOT_PURCHASE","REPAY"].includes(N.transactionType)?e.jsx("div",{className:"text-main-green",children:`+${p(A(f/10**n,2))} ${o}`}):e.jsx("div",{className:"text-red-500",children:`-${p(A(f/10**n,2))} ${o}`})},{title:"Date",dataIndex:"createdTimestamp",defaultSortOrder:"descend",sorter:(f,N)=>N.createdTimestamp-f.createdTimestamp,render:f=>w(parseInt(f)*1e3).format("DD/MM/YYYY")}];if(!s||!t)return null;const{originatorCompany:r,assetType:m,name:d,createdAt:l,poolContractAddress:a}=t,{ticker:j,juniorNotesTokenAddress:I,notesTokenAddress:g}=s,b=r.isIssuer?r.companyLegalName:r.issuer;return e.jsxs(e.Fragment,{children:[e.jsxs(P,{className:"rounded-3xl w-full mb-6",children:[e.jsx("div",{className:"text-gray-900 font-semibold mr-2",children:"Highlights"}),e.jsx(M,{className:"my-4",orientationMargin:1}),e.jsxs("div",{className:"flex flex-wrap",children:[e.jsxs("div",{className:"basis-1/3 mb-4",children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"Pool name"}),e.jsx("div",{className:"font-semibold",children:d})]}),b&&e.jsxs("div",{className:"basis-1/3 mb-4",children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"Issuer"}),e.jsx("div",{className:"font-semibold",children:b})]}),e.jsxs("div",{className:"basis-1/3 mb-4",children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"Collateral type"}),e.jsx("div",{className:"font-semibold",children:Te[m]})]}),e.jsxs("div",{className:"basis-1/3 mb-4",children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"Originator"}),e.jsx("div",{className:"font-semibold",children:r==null?void 0:r.companyLegalName})]}),I&&e.jsxs("div",{className:"basis-1/3 mb-4",children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"JOT ticker and address"}),e.jsx("a",{href:D.getWalletLink(I),target:"_blank",rel:"noreferrer",children:j+"_JOT at "+B(I,6,4,10)})]}),g&&e.jsxs("div",{className:"basis-1/3 mb-4",children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"SOT ticker and address"}),e.jsx("a",{href:D.getWalletLink(g),target:"_blank",rel:"noreferrer",children:j+"_SOT at "+B(g,6,4,10)})]}),e.jsxs("div",{className:"basis-1/3 mb-4",children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"Pool contract address"}),e.jsx("a",{href:D.getWalletLink(a||""),target:"_blank",rel:"noreferrer",children:B(a||"",6,4,10)})]}),e.jsxs("div",{className:"basis-1/3 mb-4",children:[e.jsx("div",{className:"text-xs text-pool-card-info",children:"Creation Date"}),e.jsx("div",{className:"font-semibold",children:l?w(l).format("DD MMMM YYYY"):"-"})]})]})]}),e.jsxs(P,{loading:h,className:"rounded-3xl w-full mb-6",children:[e.jsx("div",{className:"text-gray-900 font-semibold mr-2",children:"Transaction history"}),e.jsx(M,{className:"my-4",orientationMargin:1}),e.jsx(oe,{columns:i,dataSource:c,pagination:!1,size:"small",scroll:(c==null?void 0:c.length)>7?{y:300}:void 0,loading:h,rowKey:f=>f.id})]})]})},ze="/assets/apy-vision-CYRKDYwU.svg",Ge=e.jsx("center",{children:e.jsx(G,{size:"small"})}),qe=u=>{const{assets:s,pool:t,loading:c}=u,h=ce(),{value:o=[]}=C(async()=>(t==null?void 0:t.assetType)===T.NOTE_TOKEN?await D.getMultiNoteTokenAssetsBalance(s):await D.getDebtAssetValues(t.poolContractAddress,s,!0,t.currency.decimals),[t==null?void 0:t.assetType]),[n,i]=y.useState([]),r=y.useCallback(async()=>{const l=s.filter(a=>a.assetType!==T.NOTE_TOKEN);if(l.length){let a=[];a=await D.getLoanAndInvoiceInterestRates(l,t),i(a)}},[s,t]);y.useEffect(()=>{r()},[s,r]);const m=[{title:"ID",dataIndex:"id",key:"id",render:(l,a)=>a.assetType===T.NOTE_TOKEN?e.jsx("span",{children:a.id}):e.jsx("span",{onClick:()=>h(`/lending-place/order-contract/${a.id}`),style:{color:"#4bb7f5",cursor:"pointer"},children:a==null?void 0:a.debtOrderContract.externalId})},{title:"Amount",dataIndex:"amount",key:"amount",render:(l,a,j)=>a.assetType==T.NOTE_TOKEN?a.amount:a.id&&a.tokenId?o.length?p(o[j]):Ge:p(a.outstandingPrincipalAmount)},{title:"APR",dataIndex:"interestRatePercentage",key:"interestRatePercentage",render:(l,a,j)=>a.assetType==T.NOTE_TOKEN?a.type===Q.SENIOR?`${a.interestRatePercentage}%`:"N/A":n.length?`${p(n[j])}%`:null},{title:"Financing date",dataIndex:"createdAt",key:"createdAt",width:"14%",render:(l,a)=>{var j;return w.unix((j=a==null?void 0:a.debtOrderContract)==null?void 0:j.financingTimestamp).format("DD/MM/YYYY")}},{title:"Maturity Date",dataIndex:"paymentDueDate",key:"paymentDueDate",render:(l,a)=>a.assetType==T.NOTE_TOKEN?"Perpetual":w(k(a,"debtOrderContract.debtOrderContractInfo.finalMaturityDate")).format("DD/MM/YYYY")},{title:"Status",dataIndex:"status",key:"status",render:(l,a)=>e.jsx(Ee,{type:Pe(a)||J.FINANCED})}],{value:d}=C(async()=>{var a,j;if(!(t!=null&&t.id))return;const{data:l}=await de.getPoolMigration(t.id);return((j=(a=l==null?void 0:l.poolNotification)==null?void 0:a.asset)==null?void 0:j.published)??null},[t==null?void 0:t.id]);return e.jsxs(e.Fragment,{children:[d&&e.jsx("div",{style:{marginTop:32},children:e.jsxs("a",{href:d.link,target:"_blank",style:{display:"flex",alignItems:"center",color:"inherit !important"},rel:"noreferrer",children:[e.jsx("img",{src:ze,width:"32",height:"32",style:{marginRight:8}}),e.jsx("span",{children:d.label})]})}),e.jsx(oe,{style:{marginTop:24},bordered:!0,loading:c,rowClassName:"font-normal",dataSource:s,columns:m,pagination:!1,scroll:{y:350,x:1e3},rowKey:l=>l.id})]})},Qe=u=>{const{pool:s,poolData:t}=u,c=y.useMemo(()=>p((t.currentMinFirstLoss||0)/1e4,2),[t.currentMinFirstLoss]),{loading:h,value:o=[]}=C(async()=>s!=null&&s.id?await X.getLegalList(s.id,null,null,Ae.PUBLISHED):void 0,[s==null?void 0:s.id]),[n,i]=y.useState(!1),[r,m]=y.useState(null);return e.jsxs(U,{gutter:[32,0],children:[e.jsx(R,{xs:24,md:24,children:e.jsxs(P,{className:"rounded-3xl w-full mb-6",children:[e.jsx("div",{className:"text-gray-900 font-semibold mr-2 mb-2",children:"Risk"}),e.jsxs("div",{className:"text-xs text-pool-card-info",children:["First loss cushion",e.jsx(fe,{title:`First loss buffer is the value of the junior token in relation to pool value. It denotes how much of the pool is protected by the junior tranche against collateral default. The minimum first loss buffer of this pool is ${c}%`,children:e.jsx(he,{className:"ml-2"})})]}),e.jsx(le,{marks:{[c]:{label:`${p(c)}%`,style:{top:-56,padding:8,backgroundColor:"#1AB752",borderRadius:8,fontStyle:"bold",color:"black"}}},max:Math.max(c,100),className:"w-80 mt-14 ml-5 mb-0",value:c,tooltip:{open:!1,formatter:d=>e.jsxs("span",{children:[d,"%"]})}})]})}),h?e.jsx(R,{xs:24,md:24,children:e.jsx(P,{loading:!0,className:"rounded-3xl w-full mb-6"})}):e.jsx(R,{xs:24,md:24,children:e.jsxs(P,{className:"rounded-3xl w-full mb-6",children:[e.jsx("div",{className:"text-gray-900 font-semibold mr-2",children:"Pool Document"}),e.jsx(M,{className:"my-4",orientationMargin:1}),!je(o)&&o.map(d=>e.jsx("div",{className:"text-main-green cursor-pointer",onClick:()=>{m({documentId:d.id}),i(!0)},children:d.name},d.id))]})}),n&&s&&r&&e.jsx(Le,{poolId:s.id,showModal:()=>i(!0),visible:n,onClose:()=>i(!1),preSelectedDocumentId:r.documentId,disableCreateNew:!0,defaultHtmlParse:!0})]})},Xe=u=>{const{note:s,pool:t}=u,[c,h]=y.useState([]);y.useEffect(()=>{(async()=>{const l=await De();if(!t)return;const a=await l.methods.getExternalTokenInfos(t.poolContractAddress).call(),j=await l.methods.getTokenPrices(a.map(g=>g.poolAddress),a.map(g=>g.noteTokenAddress)).call(),I=ge(a,j,(g,b)=>({id:null,type:g==0?Q.JUNIOR:Q.SENIOR,assetType:T.NOTE_TOKEN,amount:A(g.balance*b/10**t.currency.decimals/10**t.currency.decimals,4),interestRatePercentage:A(g.apy/Ie,2),paymentDueDate:"N/A",poolEvent:{}}));h(I)})()},[t]);const{error:o,loading:n,value:i=[]}=C(async()=>{if(t)return await Se.getAllAssets({poolId:t.id,status:[J.FINANCED,J.PARTIAL_REPAY,J.REPAID],isPublicView:!0})},[t]);if(o&&console.log(o),u.loading)return e.jsx(Z,{active:!0});if(!s||!t)return null;const r={...u,assets:i.concat(c),loading:n},m=[{key:"Overview",label:"Overview",children:e.jsx(Ke,{...r})},{key:"ExecutiveSummary",label:"Executive Summary",children:e.jsx(Ue,{...r})},{key:"Assets",label:"Assets",children:e.jsx(qe,{...r})},{key:"Risk",label:"Risk",children:e.jsx(Qe,{...r})},{key:"Activity",label:"Activity",children:e.jsx(We,{...r})}];return e.jsx(pe,{animated:{tabPane:!1,inkBar:!0},defaultActiveKey:"Overview",items:m,className:"font-semibold"})},ps=()=>{const{notification:u}=ye.useApp(),s=ce(),t=be(),h=ve().noteId,o=we.parse(t.search,{ignoreQueryPrefix:!0}),{error:n,value:i,loading:r}=C(async()=>{if(h)return await q.getNoteById(h)},[h]);n&&console.log(n);const m=i==null?void 0:i.poolId,{value:d,loading:l}=C(async()=>{if(m)return await q.getPublicPoolDetail({id:m})},[m]),{isMismatch:a}=Fe(d==null?void 0:d.chainId),{poolData:j,targetAmount:I,poolValue:g,remainingAmount:b,outstandingAmount:f,projectedAPY:N,couponAPR:_,loadingPoolData:L}=Oe({pool:d,event:i}),H=y.useMemo(()=>{if(i)return i.longSale&&i.status===re.eventStatuses.FINISHED&&i.startCycleTxHash?w(i.startEarningInterestTime).add(i.investmentTerms,"days")<w():i.longSale?!1:i.status===re.eventStatuses.FINISHED||w(i.endTime)<=w()},[i]),S=l||r,F=(o==null?void 0:o.junior)==="true",V=o!=null&&o.senior?(o==null?void 0:o.senior)==="true":!F,x={note:i,poolData:j,pool:d,isClosed:H,isJunior:F,isSenior:V,loading:S,targetAmount:I,poolValue:g,remainingAmount:b,projectedAPY:N,outstandingAmount:f,couponAPR:_,loadingPoolData:L};return e.jsxs(e.Fragment,{children:[d&&e.jsx(Ye,{chainId:d.chainId}),e.jsx("div",{className:"font-semibold bg-[#25272614] inline rounded-2xl px-4 py-2 cursor-pointer mb-4",onClick:()=>s("/invest"),children:"← Back to Open Pools"}),a?e.jsx(Z,{style:{marginTop:24},active:!0}):e.jsxs(U,{gutter:[20,20],style:{marginTop:24},children:[e.jsx(R,{xs:24,md:10,children:e.jsx(Ve,{...x})}),e.jsx(R,{xs:24,md:14,children:e.jsx(Xe,{...x})})]})]})};export{ps as default};
