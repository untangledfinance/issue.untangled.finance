import{r as s,aF as Y,ai as g,S as y,bn as $,j as r,ah as N,a6 as q,ao as H,an as J,ac as X,ad as Q,aD as Z,B as ee,bg as te}from"./vendor-WQejLG7Y.js";import{s as ae}from"./scorecard.service-xSgAmy6z.js";import{p as se,u as re,b as ne,c as oe}from"./useLendingValues-FIBZ4h3R.js";import{a as M,g as de}from"./asset-psWvgQPY.js";import{n as D,g as ce,f as L}from"./index-BUY2Cjej.js";import{S as ie}from"./SelectFromSource-BeAMiId5.js";import{a as le,A as B}from"./assetStatus-D1v3GkIP.js";import{a as h,n as ue}from"./app-q0ws3Yx0.js";import{p as R}from"./pool.service-DXigxJcB.js";import{f as me,m as fe}from"./index-YDRpzjTi.js";import{u as we}from"./useAsync-Dl5FScg5.js";function Ee({poolId:e}){const[t,m]=s.useState([]),[a,l]=s.useState(!1),d=s.useCallback(async n=>{l(!0);try{const c=await ae.getScorecards(n);c&&m(c.map(u=>({...u,isNewest:!0})))}catch(c){console.error(c)}l(!1)},[]);s.useEffect(()=>{e&&d(e)},[d,e]);const o=s.useCallback((n,c,u=0,p=0)=>n[u].daysPastDue<=c?n[u+1]?o(n,c,u+1,n[u].advanceRate):n[u].advanceRate:p,[]),f=s.useCallback(({finalMaturityDate:n,amount:c})=>{if(a||Y(t))return 0;try{const u=g().diff(se(n),"days");let p;return u<0?p=o(t,0):p=o(t,u),new y(c).multipliedBy(p).dividedBy(100).toNumber()}catch(u){return console.log(u),0}},[o,a,t]);return{scorecards:t,calculateDrawdownAmount:f,loading:a,refresh:()=>d(e)}}function he({poolId:e,status:t}){const[m,a]=s.useReducer((d,o)=>({...d,...o}),{batches:[],history:[],isLoading:!1}),l=s.useCallback(async()=>{a({isLoading:!0});const d=await M.getAllBatches({poolId:e,status:t});a({batches:$(d,"createdAt","desc"),isLoading:!1})},[e,t]);return s.useEffect(()=>{l()},[l]),m}const ye=[{dataIndex:"key",title:"ID",fixed:"left",key:"key",width:"10%",render:(e,t)=>{switch(t.assetType){case h.LENDING:return t.debtOrderContract.externalId;case h.INVOICE:return t.invoice.openItemId;default:return"N/A"}}},{dataIndex:"assetType",title:"Type",key:"assetType",width:"6%",render:(e,t)=>r.jsx("div",{className:"font-medium",color:e===h.LENDING?"green":e===h.INVOICE?"red":"blue",children:e===h.LENDING?"Loan":e===h.INVOICE?"Invoice":t.noteTokenAsset.type===ue.SENIOR?"SOT":"JOT"})},{dataIndex:"poolId",title:"Pool",key:"id",width:"18%",render:(e,t)=>t.pool?t.pool.name:r.jsx("span",{style:{color:"#00D395"},children:"Unallocated"})},{title:"Upload date",dataIndex:"createdAt",key:"createdAt",defaultSortOrder:"descend",width:"10%",render:(e,t)=>e?g(e).format("DD/MM/YYYY"):g(t.createdAt).format("DD/MM/YYYY"),sorter:(e,t)=>e.createdAt-t.createdAt},{title:"Originator",key:"creatorId",width:"8%",render:(e,t)=>N(t,"ownerCompany.companyLegalName","N/A")},{title:"Validator",key:"validator",width:"8%",render:(e,t)=>N(t,"pool.validatorMember.email","N/A")},{title:"Status",key:"status",width:"12%",render:(e,t)=>r.jsx(le,{type:de(t)})},{title:"Expected drawdown amount",dataIndex:"drawdownAmount",key:"drawdownAmount",align:"right",width:"13%",render:e=>D(e)},{title:"Due date",key:"dueDate",width:110,render:(e,t)=>{switch(t.assetType){case h.LENDING:return g(t.debtOrderContract.debtOrderContractInfo.finalMaturityDate).format("DD/MM/YYYY");case h.INVOICE:return g(t.invoice.dueDate).format("DD/MM/YYYY");case h.NOTE_TOKEN:return g(t.dueDate).format("DD/MM/YYYY");default:return"N/A"}}}];function pe({poolContractAddress:e,decimals:t}){const[m,a]=s.useState(0),[l,d]=s.useState(!1),o=s.useCallback(async()=>{d(!0);try{const c=await(await me(e)).methods.reserve().call();a(c)}catch(n){console.log({e:n})}d(!1)},[e]);s.useEffect(()=>{e&&o()},[o,e]);const f=s.useMemo(()=>new y(m).dividedBy(new y(10).pow(t)).toString(),[m,t]);return{reserveBalance:m,formattedBalance:f,loading:l}}function ge({pool:e}){const[t,m]=s.useState(0),{notification:a}=q.useApp(),[l,d]=s.useState(!1),o=s.useCallback(async()=>{d(!0);try{const{walletAddress:f}=await R.getPoolLinkedWallet(e.id);if(!f)throw a.error({message:"The pool is not yet linked to the linked wallet"}),new Error("The pool is not yet linked to the linked wallet");const n=await fe(e.currency.tokenAddress);console.log(f,e.poolContractAddress);const c=await n.methods.allowance(f,e.poolContractAddress).call();m(c)}catch(f){console.log(f)}d(!1)},[e.currency.tokenAddress,e.id,e.poolContractAddress]);return s.useEffect(()=>{e!=null&&e.id&&o()},[o,e==null?void 0:e.id]),{approvedAmount:t,loading:l}}const Te=({isOpen:e,onClose:t,batchId:m})=>{var T;const{pool:a}=re(),{batches:l,isLoading:d}=he({poolId:a==null?void 0:a.id,status:2}),[o,f]=s.useState(null),n=((T=a==null?void 0:a.currency)==null?void 0:T.decimals)||18,c=ce(N(a,"currency.shortCode","")),{formattedBalance:u,reserveBalance:p,loading:k}=pe({poolContractAddress:a.poolContractAddress,decimals:n}),{loading:j,approvedAmount:O}=ge({pool:a});s.useEffect(()=>{var i;d||Y(l)||o||f(m||((i=l[0])==null?void 0:i.id))},[l,d,o]);const[w,_]=s.useState([]),[F,x]=s.useState(!1),{drawdownValues:A}=ne({poolData:a,assets:w,callbackSuccess:()=>{}}),b=s.useMemo(()=>A[0]?L(A[0],n):new y(0),[A]),S=s.useMemo(()=>{var i;return(i=A[1])==null?void 0:i[0]},[A]),I=s.useCallback(async()=>{if(!o)return;x(!0);const i=await M.getAllAssets({status:[B.TO_BE_FINANCED],poolId:a.id,batchId:o});_(i.filter(v=>v.status===B.TO_BE_FINANCED)),x(!1)},[o,a.id]);s.useEffect(()=>{I()},[I]);const{drawdown:P,loading:V}=oe({poolData:a,assets:w,callbackSuccess:()=>{t&&t()}}),{loading:C,value:E}=we(async()=>a!=null&&a.id?(await R.getPoolLinkedWallet(a==null?void 0:a.id)).walletAddress:void 0,[a==null?void 0:a.id]),[W,G]=s.useState([]);s.useEffect(()=>{if(!w.length)return;if(!S){x(!0);return}const i=w.map((v,U)=>({...v,drawdownAmount:L(S[U],n)}));G(i),x(!1)},[w,S]);const z=s.useMemo(()=>!(w!=null&&w.length)||k||C||j||!E||new y(b).isEqualTo(0)?!0:new y(b).multipliedBy(new y(10).pow(n)).isGreaterThan(p),[w==null?void 0:w.length,n,j,k,E,C,p,b]),K={header:{backgroundColor:"transparent"},content:{borderRadius:24}};return r.jsx(H,{width:"65vw",title:r.jsx("span",{className:"text-xl bg-tr",children:"Drawdown"}),open:e,onCancel:()=>{t()},style:{minWidth:500},footer:null,styles:K,children:!!a&&r.jsx("div",{children:r.jsxs("div",{className:"mt-8",children:[d?r.jsx(J,{active:!0}):r.jsxs(r.Fragment,{children:[r.jsx(X,{className:"mb-4",children:r.jsxs(Q,{lg:3,xs:6,children:[r.jsx("span",{className:"text-ps font-semibold mb-3",children:"Batch ID"}),r.jsx(ie,{placeholder:"Select batch","data-testid":"drawdown-batch-select",items:l,loading:d,nameKey:"id",disabled:m,selectedValue:o,onSelect:i=>{f(i)}})]})}),r.jsx(Z,{"data-testid":"drawdown-table",columns:ye,dataSource:W||[],loading:F,scroll:{y:"calc(100vh - 360px)",x:1100},className:"bg-[#2527260A]",bodyStyle:{cursor:"pointer",overflowX:"auto"},pagination:!1,size:"middle",rowKey:i=>`${i.id}_${i.assetType}`}),r.jsx("div",{className:"flex justify-end mt-2",children:r.jsxs("div",{children:[r.jsxs("div",{className:"mt-2 flex gap-5 justify-between items-center",children:[r.jsx("span",{className:"text-base text-gray-500",children:"Total drawdown amount: "}),r.jsxs("span",{className:"text-lg font-bold",children:[D(b.toString())," ",c]})]}),r.jsxs("div",{className:"mt-2 flex gap-5 justify-between items-center",children:[r.jsx("span",{className:"text-base text-gray-500",children:"Total pool reserve"}),r.jsxs("span",{className:"text-lg font-bold",children:[D(u)," ",c]})]})]})})]}),r.jsx("div",{className:"my-2 flex justify-end mt-8",children:r.jsx(ee,{className:"shadow-none !h-12 w-40","data-testid":"drawdown-button",type:"primary",shape:"round",size:"large",loading:V,onClick:()=>{if(new y(b).multipliedBy(new y(10).pow(n)).isGreaterThan(O)){te.error({message:"Insufficient approved spent amount. Please contact the Issuer"});return}P()},disabled:z,children:"Drawdown"})})]})})})};export{Te as D,Ee as u};
