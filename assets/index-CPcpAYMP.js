import{a6 as fe,d as ye,r as l,aO as ce,a7 as $,j as e,ao as ge,aI as u,a9 as F,af as ve,B as D,c as Oe,ah as Y,ai as de,aj as Fe,ak as Me,al as we,am as ke,ap as je,aM as Te,aE as me,S as Ee,a8 as We,k as Le,aN as Ve,ac as Be,an as De,ad as Re}from"./vendor-WQejLG7Y.js";import{u as be,d as ze,g as _e,N as $e,n as Z}from"./index-BUY2Cjej.js";import{u as R}from"./fetchList-Dx9pDj27.js";import{p as V}from"./pool.service-DXigxJcB.js";import{g as Ge}from"./admin.service-hizXY1il.js";import{u as Ie}from"./useGetLinkedWallet-DOj7aicX.js";import{S as le,F as _}from"./SelectFromSource-BeAMiId5.js";import{c as G}from"./company.service-DgXvkGEz.js";import{c as Ce}from"./currencies.service-C4ZICYUF.js";import{h as Ke,i as qe,f as Ue}from"./index-YDRpzjTi.js";import{u as Ye,c as ue}from"./util.service-DGlW4vEA.js";import{p as He,a as ee,R as Je}from"./app-q0ws3Yx0.js";import{u as Qe,C as Xe}from"./usePoolData-DTvfbm5K.js";import{N as he}from"./NoteTokenBadge-BIE4nR0X.js";import{w as Ze}from"./web3-KXi-5q2W.js";import{d as es}from"./data.service-BjjAEJBf.js";import{m as ss}from"./member.service-DLmPl6Jz.js";import"./bank.service-B_Z2xVIm.js";const{Option:as}=ve,se={minFirstLossCushion:0,debtCeiling:0},ts={number:{range:"Must be higher than ${min} and less than or equal to ${max}"}},ae={name:"",shareSymbol:"",vaultSafeWalletAddress:"",isRequiredKYC:!0},ls=({isVisible:r,setVisible:I,reloadPools:S=()=>{}})=>{const{notification:t,message:C}=fe.useApp(),{address:w,connector:N}=ye(),{isPoolAdmin:M,isIssuer:A}=be(o=>o),j=Ie(),[h,p]=l.useState(!1),[k,c]=l.useState(0),[a,n]=l.useState(ae),[P,f]=l.useState(se),[K,T]=l.useState(!0),[E]=R(G.getAllCompanies),[y]=R(Ce.getCurrencies),[m,q]=l.useState({}),[O,H]=l.useState(),[z,J]=l.useState(),[Q,s]=l.useState([]),[d,i]=l.useState(),[g,b]=l.useState(0),L=l.useMemo(()=>E!=null&&E.length?E.filter(o=>o.isIssuer):[],[E]),X=l.useMemo(()=>[[a.name,m==null?void 0:m.companyId,P.currencyId,a.shareSymbol,ce(a.vaultSafeWalletAddress)].every(Boolean),!0],[P.currencyId,m==null?void 0:m.companyId,a.name,a.shareSymbol,a.vaultSafeWalletAddress,a.isRequiredKYC]),Ne=async o=>{const W=await G.getUsersByCompanyId(o);q({companyId:o,members:W})},[is]=$.useForm(),Se=y&&y.find(o=>o.id==P.currencyId),[cs,re]=l.useState(void 0),Ae=async()=>{var W,ne,oe,ie;const o=await Ke(ze.contracts.VaultFactory);if(p(!0),g===0)try{if(String(w).toLowerCase()!==String(j).toLowerCase())return t.error({message:`Current wallet address is not valid.
            Please connect to wallet
            ${j}`});if(!(M||A))return t.error({message:"Current wallet address does not have permission to create pool"});console.log(a);const v=await o.send("createVault",[String(Se.tokenAddress),a.name,a.shareSymbol,a.vaultSafeWalletAddress]),B=await Ye.waitForTransactionReceipt(v,N.id);H(B),console.log("createNewVaultModal.tsx - newVaultInstanceReceipt"),console.log(B);const x=await ue(V.getVaultByTx,[B.transactionHash],3e3);re((W=x==null?void 0:x.result)==null?void 0:W.id),await V.createNewVault((ne=x==null?void 0:x.result)==null?void 0:ne.id,{name:a.name,issuerCompanyId:m==null?void 0:m.companyId,kycRequired:!1}),await S(),I(!1),C.success("Create new vault successfully"),b(0)}catch(v){return console.error(v),t.error({message:(v==null?void 0:v.message)||"Something went wrong"})}finally{p(!1)}if(g===50)try{if(String(w).toLowerCase()!==String(a.vaultSafeWalletAddress).toLowerCase())return t.error({message:`Current wallet address is not valid.
            Please connect to wallet
            ${a.vaultSafeWalletAddress}`});const B=await qe(z);K&&await B.methods.enableAsyncWithdraw().send({from:a.vaultSafeWalletAddress,maxPriorityFeePerGas:null,maxFeePerGas:null}),await B.methods.setModules(Q,d).send({from:a.vaultSafeWalletAddress,maxPriorityFeePerGas:null,maxFeePerGas:null});const x=await ue(V.getVaultByTx,[O.transactionHash],3e3);re((oe=x==null?void 0:x.result)==null?void 0:oe.id),await V.createNewVault((ie=x==null?void 0:x.result)==null?void 0:ie.id,{name:a.name,issuerCompanyId:m==null?void 0:m.companyId,kycRequired:!1}),b(100),C.success("Create new vault successfully"),I(!1),b(0)}catch(v){return console.error(v),t.error({message:(v==null?void 0:v.message)||"Something went wrong"})}finally{p(!1)}};l.useEffect(()=>{r&&c(0),n(ae),f(se)},[r]);const Pe={header:{backgroundColor:"transparent"},content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(ge,{onCancel:()=>{I(!1),n(ae),f(se)},footer:null,styles:Pe,width:"65vw",open:r,title:e.jsx("span",{className:"text-lg",children:"Create new pool"}),style:{minWidth:640,paddingBottom:0},children:e.jsxs("div",{className:"w-full flex flex-col items-center",children:[e.jsx("div",{className:"lg:w-1/2 md:w-2/3 w-10/12"}),k===0&&e.jsxs("div",{className:"w-full flex flex-col items-center",children:[e.jsx("div",{className:"lg:w-1/2 md:w-2/3 w-10/12",children:e.jsxs($,{layout:"vertical",validateMessages:ts,className:"mt-5",children:[e.jsx(u,{label:"Issuer company",className:"mb-4",children:e.jsx(le,{style:{flex:1},placeholder:"Issuer company",items:L,nameKey:"companyLegalName",selectedValue:m.companyId,onSelect:async o=>{Ne(o)}})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:"16px"},children:[e.jsx(u,{label:"Vault name",className:"flex-1 mb-4",children:e.jsx(F,{placeholder:"Enter vault name",id:"name",value:a.name,onChange:o=>n({...a,name:o.target.value})})}),e.jsx(u,{label:"Share symbol",className:"flex-1 mb-4",children:e.jsx(F,{placeholder:"Share symbol",id:"name",value:a.shareSymbol,onChange:o=>n({...a,shareSymbol:o.target.value})})})]}),e.jsx(u,{label:"Currency",className:"mb-4",children:e.jsx(_,{type:"select",style:{width:"100%"},value:P.currencyId,showSearch:!0,id:"currency",placeholder:"Currency",onChange:o=>f({...P,currencyId:o}),children:y&&y.map(o=>e.jsx(as,{value:o.id,children:o.shortCode},o.shortCode))})}),e.jsx("div",{children:e.jsx($.Item,{label:"Vault's Safe Wallet address",name:"vaultSafeWalletAddress",rules:[()=>({validator(o,W){return!W||ce(W)?Promise.resolve():Promise.reject(new Error("Invalid wallet address"))}})],className:"mb-4",children:e.jsx(F,{style:{width:"100%"},placeholder:"Enter wallet address",value:a.vaultSafeWalletAddress,id:"vaultSafeWalletAddress",onChange:o=>n({...a,vaultSafeWalletAddress:o.target.value})})})})]})}),e.jsx("div",{className:"w-full flex justify-end",children:e.jsxs(D,{className:"px-4 shadow-none w-40 h-12",loading:h,disabled:!X[0],onClick:Ae,type:"primary",children:[g===0&&"Issue New Vault",g===50&&"Add Modules"]})})]})]})})};function rs({pool:r}){console.log(r);const I=Oe(),S=_e(Y(r,"currency.shortCode","")),t=r.poolEvents?r.poolEvents[0]:null,{targetAmount:C,poolValue:w,remainingAmount:N,projectedAPY:M,loadingPoolData:A}=Qe({pool:r,event:t});let j=!1;t&&(t.status===He.eventStatuses.FINISHED||de(t.endTime).diff(de(new Date),"minutes")<=0)&&(j=!0);const h=$e[r==null?void 0:r.chainId],p=l.useMemo(()=>{var a,n;return!!((n=(a=r==null?void 0:r.poolEvents)==null?void 0:a[0])!=null&&n.notesTokenAddress)},[r]),k=l.useMemo(()=>{var a,n;return!!((n=(a=r==null?void 0:r.poolEvents)==null?void 0:a[0])!=null&&n.juniorNotesTokenAddress)},[r]),c=l.useMemo(()=>Fe((C-N)/C*100,2),[C,N]);return e.jsxs(Me,{className:"bg-pool-card-bg rounded-3xl w-full cursor-pointer",onClick:()=>{I(`/vault-setting/${r.id}/notes`)},loading:A,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"min-h-[50px]",children:[e.jsx("span",{className:"text-gray-900 font-semibold mr-2 text-lg ",children:r.name}),k?e.jsx(he,{noteType:"Junior"}):void 0,e.jsx("span",{className:"inline-block w-2"}),p?e.jsx(he,{noteType:"Senior"}):void 0,h&&e.jsx("div",{className:"bg-[#25272614] inline absolute top-7 right-6 rounded-2xl text-gray-900 px-2 ",children:h.name})]}),e.jsxs("div",{className:"min-h-[100px]",children:[e.jsx("div",{className:"overflow-ellipsis text-pool-card-info",children:r.shortDescription}),!!t&&e.jsx(Xe,{endTime:t.closedAt||t.endTime,isClosed:j,event:t})]})]}),e.jsxs("div",{className:"flex flex-row",children:[e.jsxs("div",{className:"grow-[2]",children:[e.jsx("div",{className:"text-pool-card-info",children:"Projected APY (%)"}),e.jsx("div",{children:p?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"font-bold text-3xl",children:Z(M)}),e.jsx("span",{className:"text-2xl text-pool-card-info ml-1",children:"%"})]}):e.jsx("span",{className:"font-bold text-3xl",children:"Variable"})}),e.jsx("div",{className:"w-4/5",children:e.jsx(we,{className:"mt-1 mb-0",orientationMargin:1})}),e.jsxs("div",{children:[e.jsxs("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:["Pool value (",S,")"]}),e.jsx("p",{className:" font-semibold mt-1 mb-0 text-base",children:Z(w)})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:["Investment capacity (",S,")"]}),e.jsx("p",{className:"mt-1 mb-0  font-semibold text-base",children:Z(N)})]})]}),e.jsx("div",{className:"grow-0 flex flex-col justify-end",children:e.jsx(ke,{size:100,strokeLinecap:"butt",strokeWidth:"10",strokeColor:"#1AB752",format:a=>`${a}%`,type:"circle",percent:c})})]})]})}const{Option:U}=ve,{Step:pe}=je,te={name:void 0,issuerCompanyId:void 0,issuerMemberId:void 0,shortDescription:"",paragraphSummary:""},xe={minFirstLossCushion:0,debtCeiling:0,assetType:void 0,countryId:void 0,currencyId:void 0},ns=({isVisible:r,setVisible:I,reloadPools:S=()=>{},currentPool:t,setCurrentPool:C})=>{const{notification:w,message:N}=fe.useApp(),{address:M}=ye(),[A,j]=l.useState(!1),[h,p]=l.useState(0),k=Ie(),[c,a]=l.useState(te),[n,P]=l.useState(xe),[f,K]=l.useState([{}]),[T,E]=l.useState(null),[y]=R(G.getAllCompanies),[m]=R(Ce.getCurrencies),[q]=R(es.getCountries),O=m&&m.find(s=>s.id==n.currencyId),H=l.useMemo(()=>y!=null&&y.length?y.filter(s=>s.isOriginator):[],[y]),z=l.useMemo(()=>{const s=Object.values(c).every(Boolean),d=[n.assetType,n.countryId,f.every(i=>!!i.memberId&&!!i.companyId)].every(Boolean);return[s,d]},[n.assetType,n.countryId,f,c]),J=async(s,d,i)=>{let g=[];d==="companyId"&&(g=await G.getUsersByCompanyId(i));const b=Le(f,L=>{L[s][d]=i,d==="companyId"&&(L[s].members=g,delete L[s].memberId),d==="memberId"&&(L[s].memberWallet=Y(L[s].members.find(X=>X.id==i),"member_wallet[0].walletAddress"))});K(b)},Q=async()=>{j(!0);try{if(String(k).toLowerCase()!==String(M).toLowerCase())return w.error({message:`Please connect to address: ${k}`});const s=await Ue(t.poolContractAddress),d=await Promise.all(f.map(i=>ss.getWallet(i.memberId,i.companyId)));for(let i=0;i<f.length;i++){const g=f[i];if(!d[i].walletAddress){const b=Ve(g.members).email;return w.error({message:`Originator ${b} has not linked wallet`})}}console.log("---> originatorWallets: ",d);for(const i of d)await s.methods.grantRole(Ze.utils.keccak256("ORIGINATOR_ROLE"),i.walletAddress).send({from:M,maxPriorityFeePerGas:null,maxFeePerGas:null});await V.initializePool(t.id,{id:t.id,shortDescription:c.shortDescription,paragraphSummary:c.paragraphSummary,poolProfilePhoto:"",assetType:n.assetType,countryId:n.countryId,originators:f.map(i=>({memberId:i.memberId,companyId:i.companyId})),originatorWallets:d}),await V.createUpdateFilterTemplate({name:`${t.name} - filter`,isMain:!0,poolId:t.id,assetType:n.assetType}),N.success("Initialize pool successfully"),S(),I(!1)}catch(s){return console.error(s),w.error({message:(s==null?void 0:s.message)||"Something went wrong"})}finally{j(!1)}};return l.useEffect(()=>{t&&(a({...te,name:t.name,issuerCompanyId:t.ownerCompanyId,issuerMemberId:t.ownerMemberId}),P({...xe,currencyId:t.currencyId,minFirstLossCushion:t.minFirstLossCushion,debtCeiling:t.debtCeiling||"not found"}))},[t]),l.useEffect(()=>{(async()=>{if(!c.issuerCompanyId||!c.issuerCompanyId)return;const d=y.find(b=>b.id===c.issuerCompanyId);if(!d)return;const g=(await G.getUsersByCompanyId(c.issuerCompanyId)).find(b=>b.id===c.issuerMemberId);g&&E({company:d.companyLegalName,email:g.email})})()},[t,y,c.issuerCompanyId,c.issuerMemberId]),l.useEffect(()=>{r&&(p(0),K([{}]))},[r]),e.jsx(ge,{onCancel:()=>{I(!1),C(),a(te),E({company:"",email:""})},footer:null,open:r,width:"640px",title:e.jsx("span",{className:"text-lg",children:"Initialize pool"}),className:"w-full bottom-0",centered:!0,children:e.jsxs("div",{className:"w-full flex flex-col items-center",children:[e.jsx("div",{className:"lg:w-1/2 md:w-2/3 w-10/12",children:e.jsxs(je,{onChange:s=>{s===0&&p(s),z[h]&&p(s)},labelPlacement:"vertical",initial:0,type:"default",className:"whitespace-nowrap",direction:"horizontal",current:h,children:[e.jsx(pe,{title:"Overview"}),e.jsx(pe,{title:"Collateral"})]})}),e.jsxs("div",{className:"w-full",children:[h===0&&e.jsxs("div",{children:[e.jsxs($,{layout:"vertical",className:"mt-5",children:[e.jsx(u,{label:"Pool name",children:e.jsx(F,{placeholder:"Enter pool name",disabled:!0,value:c.name,readOnly:!0})}),e.jsxs("div",{className:"flex justify-between relative gap-4",children:[e.jsx(u,{label:"Issuer company",className:"flex-1",children:e.jsx(F,{disabled:!0,value:(T==null?void 0:T.company)||"",readOnly:!0})}),e.jsx(u,{label:"Issuer email",className:"flex-1",children:e.jsx(F,{disabled:!0,value:(T==null?void 0:T.email)||"",readOnly:!0})})]}),e.jsxs(u,{label:"Pool in words",children:[e.jsx(F.TextArea,{maxLength:35,className:"!h-32",placeholder:"Enter text ...",type:"textarea",value:c.shortDescription,onChange:s=>{s.target.value.length<=35&&a({...c,shortDescription:s.target.value})}}),e.jsxs("div",{className:"text-right text-gray-400 mt-2",children:[Y(c,"shortDescription.length",0),"/35"]})]}),e.jsxs(u,{label:"Paragraph summary",children:[e.jsx(F.TextArea,{maxLength:350,className:"!h-32",placeholder:"Enter text ...",type:"textarea",value:c.paragraphSummary,onChange:s=>{s.target.value.length<=350&&a({...c,paragraphSummary:s.target.value})}}),e.jsxs("div",{className:"text-right text-gray-400 mt-2",children:[Y(c,"paragraphSummary.length",0),"/350"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx(D,{loading:A,disabled:!z[0]||!T,onClick:()=>{p(h+1)},type:"primary",children:"Next"})})]}),h===1&&e.jsxs("div",{className:"w-full",children:[e.jsxs($,{layout:"vertical",className:"mt-5",children:[e.jsx(u,{label:"Collateral type",children:e.jsxs(_,{type:"select",value:n.assetType,className:"w-full",placeholder:"Collateral type",onChange:s=>P({...n,assetType:s}),children:[e.jsx(U,{value:ee.INVOICE,children:"Invoices"}),e.jsx(U,{value:ee.LENDING,children:"SME Loans"}),e.jsx(U,{value:ee.NOTE_TOKEN,children:"Note Tokens"})]})}),e.jsx(u,{label:"Country",children:e.jsx(_,{type:"select",className:"w-full",value:n.countryId,showSearch:!0,id:"country",placeholder:"Country",onChange:s=>P({...n,countryId:s}),children:q&&q.map(s=>e.jsx(U,{value:s.id,children:s.name},s.id))})}),e.jsx(u,{label:"Currency",children:e.jsx(F,{className:"w-full",placeholder:"Currency",id:"currency",disabled:!0,value:(O==null?void 0:O.tokenSymbol)||"not found",readOnly:!0})}),e.jsx(u,{label:"Originators",children:e.jsx("div",{className:"gap-3",children:f.map((s,d)=>e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex flex-1 justify-between relative gap-4",children:[e.jsx(le,{className:"w-full",placeholder:"Originator Company",items:H,nameKey:"companyLegalName",selectedValue:s.companyId,onSelect:async i=>{J(d,"companyId",i)}}),e.jsx(le,{isMember:!0,type:"select",className:"w-full",items:s.members||[],nameKey:"email",placeholder:"Originator Email",selectedValue:s.memberId,onSelect:i=>J(d,"memberId",i)})]}),!!s.companyId&&!!s.memberId&&e.jsxs(Te,{className:"mt-1 px-2",children:["*Wallet address:"," ",!!(s!=null&&s.memberWallet)&&(s==null?void 0:s.memberWallet)||"The account has not been linked to a wallet"]})]},d))})}),e.jsx(u,{label:"Min first loss buffer",tooltip:{title:"Min first loss buffer (must be greater than 0)",icon:e.jsx(me,{}),color:"white"},children:e.jsx(_,{addonAfter:"%",type:"input-number",className:"w-full",value:n.minFirstLossCushion/Je,id:"minFirstLossCushion",disabled:!0,readOnly:!0})}),e.jsx(u,{label:"Debt ceiling",tooltip:{title:"Debt ceiling - must be greater than 0",icon:e.jsx(me,{}),color:"white"},children:e.jsx(_,{type:"input-number",className:"w-full",value:new Ee(n.debtCeiling).div(10**O.decimals),id:"debtCeiling",addonAfter:(O==null?void 0:O.tokenSymbol)||e.jsx("span",{}),disabled:!0,readOnly:!0})})]}),e.jsxs("div",{className:"gap-2 mt-2",children:[h===1&&e.jsx(We,{message:`Collateral settings cannot be edited once the pool is
                  initialized. Please review it carefully!`,type:"warning",showIcon:!0}),e.jsxs("div",{className:"flex justify-end w-full mt-3 relative gap-3",children:[e.jsx(D,{onClick:()=>p(s=>s-1),children:"Back"}),e.jsx(D,{disabled:!z[1],loading:A,onClick:Q,type:"primary",children:"Initialize Pool"})]})]})]})]})]})})},os=6,Ps=()=>{const{isPoolAdmin:r,isSuperAdmin:I,isIssuer:S}=be(a=>a),[t,C,w]=R(I?Ge:V.getVaultList),[N,M]=l.useState(6),[A,j]=l.useState(!1),[h,p]=l.useState(!1),[k,c]=l.useState();return e.jsxs("div",{className:"xl:mx-10 lg:mt-6 md:mx-3 sm:mx-1",children:[(r||S)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-4xl font-bold",children:"Issue"}),e.jsx(D,{type:"primary",onClick:()=>j(!0),disabled:!(r||S),children:"Issue New Vault"})]}),e.jsx(we,{})]}),e.jsxs(Be,{gutter:[20,20],children:[C?e.jsx(De,{active:!0}):t.length===0?e.jsx("div",{children:"No Active Pools"}):e.jsx(e.Fragment,{children:t.slice(0,N).map(a=>e.jsx(Re,{xl:8,lg:12,md:12,sm:24,className:"flex",children:e.jsx(rs,{pool:a},a.id)},a.id))}),N<t.length&&e.jsx("div",{className:"flex w-full justify-center",children:e.jsx(D,{onClick:()=>M(a=>a+os),children:"View more"})})]}),A&&e.jsx(ls,{reloadPools:w,isVisible:A,setVisible:j}),h&&e.jsx(ns,{currentPool:k,setCurrentPool:c,reloadPools:w,isVisible:h,setVisible:p})]})};export{Ps as default};
