var de=Object.defineProperty;var ue=(e,n,s)=>n in e?de(e,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[n]=s;var $=(e,n,s)=>ue(e,typeof n!="symbol"?n+"":n,s);import{r,ai as C,j as a,c9 as M,aD as B,a6 as ye,d as me,ao as fe,ah as k,ak as q,al as P,S as O,aZ as Ae,c as he,ae as ge,an as xe,aM as ke,ac as F,ad as T}from"./vendor-WQejLG7Y.js";import{d as H}from"./debt-order.service-d2JwBDtB.js";import{c as Ie}from"./currencies.service-C4ZICYUF.js";import{u as Se}from"./fetchList-Dx9pDj27.js";import{A as E,a as be}from"./assetStatus-D1v3GkIP.js";import{a as v}from"./app-q0ws3Yx0.js";import{s as K}from"./scorecard.service-xSgAmy6z.js";import{a as Z}from"./contractUtils-DBsZcc68.js";import{f as Ne,u as J}from"./index-YDRpzjTi.js";import{u as Re}from"./useGetLinkedWallet-DOj7aicX.js";import{u as Ce,n as R,d as Q,r as Le,f as De}from"./index-BUY2Cjej.js";import{t as ve,g as Te}from"./explorer-BDD-Qifw.js";import{u as _}from"./util.service-DGlW4vEA.js";import{K as X}from"./KeyValueRow-CBv3cjEJ.js";import{u as j}from"./useAsync-Dl5FScg5.js";import"./bank.service-B_Z2xVIm.js";import"./useAsyncFn-DMoxp3xu.js";const Ee={display:"block",height:"30px",lineHeight:"30px"},_e=({editable:e=!1,currentRiskScore:n,setCurrentRiskScore:s,scorecards:l,isLoading:m})=>{const u=r.useMemo(()=>[{title:"Date",dataIndex:"updatedAt",key:"updatedAt",render:o=>C(o).format("DD/MM/YYYY")},{title:"Risk score",dataIndex:"name",key:"name"},{title:"Days past due",dataIndex:"daysPastDue",key:"daysPastDue",render:(o,x,c)=>c===l.length-1?`>=${o}`:`${o} - <${l[c+1].daysPastDue}`},{title:"Advance rate",dataIndex:"advanceRate",key:"advanceRate"},{title:"Interest rate",dataIndex:"interestRate",key:"interestRate"},{title:"Discount rate",dataIndex:"discountRate",key:"discountRate"},{title:"Probability of Default",dataIndex:"probabilityOfDefault",key:"probabilityOfDefault"},{title:"Loss Given Default",dataIndex:"lossGivenDefault",key:"lossGivenDefault"},e?{title:"Action",key:"action",width:130,render:(o,x,c)=>a.jsx(M,{style:Ee,value:c+1})}:null].filter(Boolean),[e,l]);return a.jsx(M.Group,{onChange:o=>{s(o.target.value)},value:+n,children:a.jsx(B,{pagination:!1,loading:m,dataSource:l.map(o=>({...o,key:o.daysPastDue})),columns:u})})},je=function({pool:e,assetTokenId:n,refresh:s}){const{notification:l}=ye.useApp(),{address:m}=me(),u=Re(),{isPoolAdmin:o}=Ce(t=>t),[x,c]=r.useState(!1),[f,d]=r.useState([]),[y,A]=r.useState(!1),[h,I]=r.useState(null),L=()=>{A(!1)};r.useEffect(()=>{const t=async()=>{c(!0);try{const g=await K.getScorecards(e.id);d(g.map(S=>({...S,isNewest:!0})))}catch(g){console.error(g)}c(!1)};e.id&&t()},[e.id]),r.useEffect(()=>{(async()=>{try{const[t]=await Z(e==null?void 0:e.poolContractAddress,[n]);I(Number(t))}catch(t){return console.log(t),I(-1),!1}})()},[n,e==null?void 0:e.poolContractAddress]);const i=async t=>{if(String(m).toLowerCase()!==String(u).toLowerCase())return l.error({message:`Current wallet address is not valid.
        Please connect to wallet
        ${u}`});try{await(await Ne(e==null?void 0:e.poolContractAddress)).methods.updateAssetRiskScore(n,t).send({from:u,maxPriorityFeePerGas:null,maxFeePerGas:null}),I(t),l.success({message:"Update risk score successfully!"}),s==null||s()}catch(g){l.error({message:"Failed to update risk score",description:g.message})}};return a.jsxs(a.Fragment,{children:[a.jsx("a",{type:"link",className:"text-blue-500 font-bold",onClick:()=>{A(!0)},children:"View detail"}),a.jsx(fe,{onCancel:L,footer:null,open:y,style:{top:8,minWidth:900,paddingBottom:0},children:a.jsxs("div",{children:[a.jsx("div",{className:"text-lg font-bold mb-4",children:"Risk score"}),a.jsx(_e,{editable:o,scorecards:f,currentRiskScore:h,setCurrentRiskScore:i,isLoading:x})]})})]})};function Pe({poolId:e,poolContractAddress:n,tokenId:s}){const[l,m]=r.useState(null),[u,o]=r.useState([]),x=r.useCallback(async()=>{if(!(!n||!s))try{const[d]=await Z(n,[s]);m(d)}catch(d){console.log(d)}},[n,s]);r.useEffect(()=>{x()},[x]);const c=r.useCallback(async()=>{if(console.log("poolId",e),!!e)try{const d=await K.getScorecards(e);o(d.map(y=>({...y,isNewest:!0})))}catch(d){console.error(d)}},[e]);r.useEffect(()=>{c()},[c]);const f=r.useMemo(()=>k(u,`[${Number(l)-1}].name`,"N/A"),[l,u]);return{riskScore:l,riskScoreType:f,scorecards:u,refresh:x}}const Oe=e=>{var c,f,d,y,A,h,I,L,i;const{value:n=[]}=j(async()=>{var t,g,S,b,N,D;return((g=(t=e==null?void 0:e.debtOrderContract)==null?void 0:t.pool)==null?void 0:g.assetType)===v.LENDING||((b=(S=e==null?void 0:e.debtOrderContract)==null?void 0:S.pool)==null?void 0:b.assetType)===v.INVOICE?await _.getLoanAndInvoiceAssetsValues([e==null?void 0:e.debtOrderContract],{...(N=e==null?void 0:e.debtOrderContract)==null?void 0:N.pool,currency:(D=e==null?void 0:e.debtOrderContract)==null?void 0:D.currency}):[]},[(f=(c=e==null?void 0:e.debtOrderContract)==null?void 0:c.pool)==null?void 0:f.assetType]),{value:s}=j(async()=>{var t,g,S,b,N,D,w,U,Y;return((g=(t=e==null?void 0:e.debtOrderContract)==null?void 0:t.pool)==null?void 0:g.assetType)===v.LENDING||((b=(S=e==null?void 0:e.debtOrderContract)==null?void 0:S.pool)==null?void 0:b.assetType)===v.INVOICE?await _.getDebtAssetValue((D=(N=e==null?void 0:e.debtOrderContract)==null?void 0:N.pool)==null?void 0:D.poolContractAddress,(w=e==null?void 0:e.debtOrderContract)==null?void 0:w.tokenId,(Y=(U=e==null?void 0:e.debtOrderContract)==null?void 0:U.currency)==null?void 0:Y.decimals):[]},[(y=(d=e==null?void 0:e.debtOrderContract)==null?void 0:d.pool)==null?void 0:y.assetType]),{riskScoreType:l,refresh:m}=Pe({poolId:(h=(A=e==null?void 0:e.debtOrderContract)==null?void 0:A.pool)==null?void 0:h.id,poolContractAddress:(L=(I=e==null?void 0:e.debtOrderContract)==null?void 0:I.pool)==null?void 0:L.poolContractAddress,tokenId:(i=e==null?void 0:e.debtOrderContract)==null?void 0:i.tokenId}),{value:u=[]}=j(async()=>{var t;return await _.getLoanAndInvoiceInterestRates([e==null?void 0:e.debtOrderContract],(t=e==null?void 0:e.debtOrderContract)==null?void 0:t.pool)},[]),x=(()=>{var b,N;const{debtOrderContract:t}=e;console.log("loanContract - debtOrderContract"),console.log(t);const g=[E.FINANCED,E.REPAID,E.PARTIAL_REPAY].includes(t==null?void 0:t.status);return[["Status",a.jsx("div",{children:a.jsx(be,{type:t==null?void 0:t.status})},t==null?void 0:t.id)],...g?[["NFT ID",(t==null?void 0:t.tokenId)&&ve((t==null?void 0:t.tokenId)??"",6,4,10)||"N/A",t==null?void 0:t.tokenId],["Amount",t.outstandingPrincipalAmount?`${R(s)} ${t.currencyTokenSymbol}`:"N/A"],["Financing rate",`${R(u[0])} %`],["Financing date",t.financingTimestamp?C.unix(t.financingTimestamp).format("DD/MM/YYYY"):"N/A"],["Maturity date",(b=t==null?void 0:t.debtOrderContractInfo)!=null&&b.finalMaturityDate?C((N=t==null?void 0:t.debtOrderContractInfo)==null?void 0:N.finalMaturityDate).format("DD/MM/YYYY"):"N/A"],["NAV",`${R(n[0])} ${t.currencyTokenSymbol}`],["Risk score",a.jsxs("div",{className:"flex items-center justify-end",children:[a.jsxs("div",{children:[l," -"]}),a.jsx(je,{refresh:m,pool:t.pool,assetTokenId:t==null?void 0:t.tokenId})]},"risk_score")]]:[]]})();return a.jsxs(q,{className:"relative bg-white-50 h-full",children:[a.jsx("div",{className:"w-1.5 h-8 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0 top-5"}),a.jsx("div",{className:"border-b-2 text-lg font-bold",children:"Asset"}),a.jsx(P,{className:"my-2"}),x.map(([t,g,S],b)=>a.jsx(X,{label:t,value:g,tooltip:S},b))]})},we=e=>{const{debtOrderContract:n}=e,[s,l]=r.useState([]),[m,u]=r.useState(null),o=r.useCallback(async()=>{var c,f;try{const d=await J();let y=`https://api.untangled.finance/api/v3/assets/${n==null?void 0:n.tokenId}?chain_id=${Q.chainId}`;try{const I=await d.methods.tokenURI(new O(n==null?void 0:n.tokenId).toString()).call();I&&(y=I)}catch(I){console.log(I)}u(y);const h=await(await Le.getRequestInstanceV2()).get(y);if(Ae((c=h==null?void 0:h.data)==null?void 0:c.attributes)){const L=((f=h==null?void 0:h.data)==null?void 0:f.attributes.filter(i=>["Asset ID","Current balance","Originator","Loan origination date","Final due date","Asset Purpose"].includes(i.trait_type))).map(i=>(i.trait_type==="Asset ID"?i.trait_type="ID":i.trait_type==="Loan origination date"?i.trait_type="Origination date":i.trait_type==="Final due date"?i.trait_type="Due date":i.trait_type==="Asset Purpose"&&(i.trait_type="Type",i.value=i.value==0?"Loan":i.value==1?"Invoice":void 0),isNaN(i.value)?C(i.value,C.ISO_8601).isValid()&&(i.value=C(i.value).format("DD/MM/YYYY")):i.value=R(i.value,2),i));l(L)}}catch(d){console.log(d)}},[n==null?void 0:n.tokenId]);r.useEffect(()=>{o()},[o]);const x=r.useMemo(()=>{const c=[];return s.forEach(f=>{c.push([f.trait_type,f.value||"-"])}),c},[s]);return a.jsxs(q,{className:"relative bg-white-50 h-full",children:[a.jsx("div",{className:"w-1.5 h-8 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0 top-5"}),a.jsxs("div",{className:"border-b-2 text-lg font-bold flex justify-between items-center",children:[a.jsx("div",{className:"border-b-2 text-lg font-bold",children:"Collateral"}),m&&a.jsx("a",{className:"text-sm",href:m,target:"_blank",rel:"noreferrer",children:"Click to view token URI"})||a.jsx("div",{})]}),a.jsx(P,{className:"my-2"}),x.map(([c,f],d)=>a.jsx(X,{label:c,value:f},d))]})},Ue={types:{ISSUE_LOAN:1,REPAY_PRINCIPAL:2,DRAWDOWN_PRINCIPAL:3,UPDATE_RISKSCORE:4,WITHDRAW_COLLATERAL:5,SELL_COLLATERAL:6,SEIZE_COLLATERAL:7,CONCLUDE_LOAN:8,CONVERT_PO_LOAN_TO_INVOICE_LOAN:9,UPDATE_DYNAMIC_DATA:10,UPLOAD:20,REJECTED:19,PARTIAL_REPAYMENT:21}},{ISSUE_LOAN:p,REPAY_PRINCIPAL:ee,DRAWDOWN_PRINCIPAL:te,UPDATE_RISKSCORE:ae,WITHDRAW_COLLATERAL:se,SELL_COLLATERAL:ne,SEIZE_COLLATERAL:re,CONCLUDE_LOAN:oe,CONVERT_PO_LOAN_TO_INVOICE_LOAN:ie,UPLOAD:Ye,REJECTED:$e,PARTIAL_REPAYMENT:ce,UPDATE_DYNAMIC_DATA:Me}=Ue.types,V={[p]:"Issue Loan",[ee]:"Repay Loan",[te]:"Financing drawdown",[ae]:"Update riskscore",[se]:"Withdraw Collateral",[ne]:"Sell Collateral",[re]:"Seize Collateral",[oe]:"Conclude Loan",[ie]:"Collateral update",[Ye]:"Collateral upload",[$e]:"Rejected",[ce]:"Partial Repayment",[Me]:"Update Dynamic Data"},Fe=e=>V[e]?V[e]:"N/A",He=(e,n)=>{const s=De(new O(e.amount),n);switch(e.type){case p:case ce:case te:return`+${R(s)}`;case ee:return`-${R(s)}`;case ae:case se:case ne:return`${s} MT ${e.commodityName}`;case re:return`${s} MT ${e.commodityName}`;case oe:return"";case ie:return`${R(k(e,"specifications.purchaseOrder.amount",""))} ${k(e,"specifications.purchaseOrder.currencyTokenSymbol","N/A")} PO -> ${R(k(e,"specifications.invoice.amount",""))} ${k(e,"specifications.invoice.currencyTokenSymbol","N/A")} invoice`;default:return"N/A"}},Ve=e=>e?a.jsx("a",{rel:"noreferrer",target:"_blank",href:Te(e),children:"View"},e):"N/A";var G,z;class le extends r.PureComponent{constructor(s){super(s);$(this,"columns",[{title:"Date",dataIndex:"date",render:s=>C(s).format("DD/MM/YYYY")},{title:"Activity",dataIndex:"type",render:s=>Fe(s)},{title:`Amount (${(z=(G=this.props.debtOrderContract)==null?void 0:G.currency)==null?void 0:z.shortCode})`,dataIndex:"amount",render:(s,l)=>{var m,u;return He(l,(u=(m=this.props.debtOrderContract)==null?void 0:m.currency)==null?void 0:u.decimals)}},{title:"TxHash",dataIndex:"transactionHash",render:s=>Ve(s)}]);this.state={tableLoading:!1}}render(){const s=this.props.history?this.props.history:[];return s.sort((l,m)=>m.id-l.id),a.jsxs(a.Fragment,{children:[a.jsx("h4",{className:"mb-3",children:"History"}),a.jsx("div",{className:"bg-gray-100 rounded-xl border border-solid border-gray-100",children:a.jsx(B,{columns:this.columns,dataSource:s,pagination:!1,size:"small",loading:this.state.tableLoading,scroll:{x:1e3}})})]})}}le.defaultProps={history:[],debtOrderContract:null};const W=(e,n)=>!Array.isArray(n)||!e?"N/A":k(n.find(s=>s.id===e),"tokenSymbol","N/A"),We=(e,n)=>({id:e.id,date:e.updatedAt,type:e.type,amount:e.amount,specifications:{purchaseOrder:{...k(e,"specifications.purchaseOrder",{}),currencyTokenSymbol:W(k(e,"specifications.purchaseOrder.currencyId",""),n)},invoice:{...k(e,"specifications.invoice",{}),currencyTokenSymbol:W(k(e,"specifications.invoice.currencyId",""),n)}},transactionHash:e.transactionHash,currencyTokenSymbol:k("currency.tokenSymbol",e),commodityName:k("commodity.name",e)||k("collateralProjectCommodity.commodity.name",e),status:e.status,updatedAt:e.updatedAt}),ct=()=>{const[e,n]=r.useState(null),[s,l]=r.useState(null),[m]=Se(Ie.getCurrencies),u=he(),{id:o}=ge(),[x,c]=r.useState(null),f=r.useCallback(async()=>{try{const y=await J();let A=`https://api.untangled.finance/api/v3/assets/${e==null?void 0:e.tokenId}?chain_id=${Q.chainId}`;try{const h=await y.methods.tokenURI(new O(e==null?void 0:e.tokenId).toString()).call();h&&(A=h)}catch(h){console.log(h)}c(A)}catch(y){console.log(y)}},[e==null?void 0:e.tokenId]);r.useEffect(()=>{f()},[f]),r.useEffect(()=>{o&&(async()=>{const A=await H.getLoanHistory(o);A.status!=="success"||l(A)})()},[o]),r.useEffect(()=>{o&&(async()=>{try{const{data:A}=await H.getDebtOrderContractById(o);n(A)}catch(A){console.log(A)}})()},[o]);const d=s?s.data.map(y=>We(y,m)):null;return e?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"font-semibold bg-[#25272614] inline-block rounded-2xl px-4 py-2 cursor-pointer mb-4",onClick:()=>u(-1),children:"‚Üê Back"}),a.jsx("a",{className:"text-sm",href:x,target:"_blank",rel:"noreferrer",children:a.jsxs(ke,{className:"text-2xl font-bold",children:["Asset #",o]})}),a.jsx(P,{}),a.jsxs(F,{type:"flex",gutter:10,children:[a.jsx(T,{lg:12,xs:24,children:a.jsx(Oe,{debtOrderContract:e})}),a.jsx(T,{lg:12,xs:24,children:a.jsx(we,{debtOrderContract:e})})]}),a.jsx(F,{type:"flex",gutter:10,children:a.jsx(T,{span:24,children:a.jsx(le,{history:d,debtOrderContract:e})})})]}):a.jsx(xe,{})};export{ct as default};
