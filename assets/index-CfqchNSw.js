import{r as a,aF as Ye,ai as ke,S as he,aR as Wt,aj as pe,ar as lt,ah as Z,j as e,ak as Xe,aS as Ta,an as Re,am as ka,T as it,P as ne,ac as ge,ad as ue,al as Be,aD as ot,aM as ss,aT as Ss,c as gt,Y as Le,ao as fe,at as Da,aU as Ns,B as U,aV as Ea,ax as Ys,aW as La,n as ys,L as Ma,aG as Ks,d as nt,aq as Hs,D as Pa,bg as Ke,ap as ut,bm as Is,aQ as us,af as at,aK as Ze,k as He,aX as Fa,a9 as De,aY as qt,aZ as Oa,a6 as Ae,aA as Jt,aJ as Oe,a_ as Ra,a$ as Va,b0 as Ua,b1 as qs,b2 as Ba,b3 as Js,a7 as F,s as _a,b4 as zs,b5 as $a,b6 as ms,b7 as Wa,bn as Ga,b8 as Gt,b9 as Qs,ba as Ya,bb as Ka,bc as Ha,Q as qa,av as Ja,a8 as Zs,W as bs,bd as Xs,be as za,bf as Qa,aB as Za,a as Xa,aO as It,aI as en,l as tn,bh as sn,R as ea,bi as ta,bj as an,ag as nn,bk as rn,ay as ln,bl as on,bo as cn,ae as dn}from"./vendor-WQejLG7Y.js";import{l as we,p as un,_ as mn,b as pn,c as hn,a as gn}from"./useLendingValues-FIBZ4h3R.js";import{a as Ct,g as fn}from"./asset-psWvgQPY.js";import{g as rt,f as ct,d as js,n as X,u as Je,i as tt,a as xn,h as yn,e as bn}from"./index-BUY2Cjej.js";import{d as sa}from"./data.service-BjjAEJBf.js";import{p as te}from"./pool.service-DXigxJcB.js";import{i as zt,l as Ts,f as Qt,m as jn,e as ks,d as vn,n as as,o as wn,p as Cn,E as An,q as Sn}from"./index-YDRpzjTi.js";import{u as qe}from"./fetchList-Dx9pDj27.js";import{u as Me,c as Mt}from"./util.service-DGlW4vEA.js";import{N as Ds}from"./NoteTokenBadge-BIE4nR0X.js";import{V as Yt,R as Kt,a as xe,p as We,b as Es,e as Ls,d as _e,n as aa}from"./app-q0ws3Yx0.js";import{R as Nn,A as In,a as Tn,f as kn,b as Dn,c as En,s as vs,D as Ln,C as Mn,P as Pn,M as Fn,d as On,i as Pt,S as na,U as Rn,e as Vn,T as Un,g as Bn,u as _n,I as $n,h as Ms,j as Zt,k as bt,l as Ge,m as Wn,F as Gn,n as Yn}from"./index.esm-DBiWbtWd.js";import{q as ws}from"./base-CumTa13P.js";import{F as re,S as Te}from"./SelectFromSource-BeAMiId5.js";import{c as Dt}from"./company.service-DgXvkGEz.js";import{s as $t}from"./scorecard.service-xSgAmy6z.js";import{S as Kn,l as se,E as Ht,a as Et,P as ra,D as la,e as oa}from"./pdf-DFr8ztBQ.js";import{a as ps}from"./attachment.service-CbFqwko5.js";import{u as ia}from"./useAsyncRetry-CUd0kvgC.js";import{a as Hn,A as Lt}from"./assetStatus-D1v3GkIP.js";import{u as ca}from"./useAsync-Dl5FScg5.js";import{b as ht}from"./bank.service-B_Z2xVIm.js";import{d as pt}from"./debt-order.service-d2JwBDtB.js";import{t as qn,a as Jn,g as da}from"./explorer-BDD-Qifw.js";import{u as zn}from"./useGetLinkedWallet-DOj7aicX.js";import{u as Qn}from"./useCopyToClipboard-ChYDdG2_.js";import{w as Zn}from"./web3-KXi-5q2W.js";import{S as Xn}from"./index-DvfaoUYF.js";import{I as Ft,a as er,b as tr}from"./investorDrawer-DiX6z8wE.js";import{N as sr}from"./NetworkMismatchAlert-BTQA0hRA.js";import"./AntdIcon-Bh4kV9XY.js";import"./useAsyncFn-DMoxp3xu.js";import"./admin.service-hizXY1il.js";import"./kycProgress-CsJgu1it.js";const ua=a.createContext({poolHistories:[],pool:{},poolEvents:[],note:{},isLoadingNote:{},assets:[],reloadPoolAssets:we.identity,tab:null,setTab:we.identity,closePool:we.identity,openPool:we.identity,securityModalVisible:!1,setSecurityModalVisible:we.identity,noteUpdateVisible:!1,setNoteUpdateVisible:we.identity,addAssetVisible:!1,setAddAssetVisible:we.identity,poolSweepVisible:!1,setPoolSweepVisible:we.identity,setEpochSettingVisible:we.identity,isUpdatingAssets:!1,setUpdatingAssets:we.identity,isShowUploadModal:!1,setShowUploadModal:we.identity,isRepaymentModalVisible:!1,setRepaymentModalVisible:we.identity,poolUpdateVisible:!1,setPoolUpdateVisible:we.identity,bankAccountModalVisible:!1,setBankAccountModalVisible:we.identity,setAddModulesModalVisible:we.identity,reloadPool:we.identity,poolDrawDownVisible:!1,setDrawDownVisible:we.identity,updateCollateralVisible:!1,setUpdateCollateralVisible:we.identity,isPoolParametersModalVisible:!1,setPoolParametersModalVisible:we.identity,isPoolParameterMinFirstLossModalVisible:!1,setPoolParameterMinFirstLossModalVisible:we.identity,isRiskScorecardModalVisible:!1,setRiskScorecardModalVisible:we.identity,isNotiModalVisible:!1,setNotiModalVisible:we.identity,draftingDocModalVisible:!1,setDraftingDocModalVisible:we.identity,calculateDrawdownAmount:we.identity,scorecards:[]}),ce=()=>a.useContext(ua);function ar({poolId:t}){const[s]=a.useState([]),[n]=a.useState(!1),r=a.useCallback(async()=>{},[]);a.useEffect(()=>{},[r,t]);const o=a.useCallback((l,c,d=0,u=0)=>l[d].daysPastDue<=c?l[d+1]?o(l,c,d+1,l[d].advanceRate):l[d].advanceRate:u,[]),i=a.useCallback(({finalMaturityDate:l,amount:c})=>{if(n||Ye(s))return 0;try{const d=ke().diff(un(l),"days");let u;return d<0?u=o(s,0):u=o(s,d),new he(c).multipliedBy(u).dividedBy(100).toNumber()}catch(d){return console.log(d),0}},[o,n,s]);return{scorecards:s,calculateDrawdownAmount:i,loading:n,refresh:()=>r()}}function nr({vaultContractAddress:t,decimals:s}){const[n,r]=a.useState(void 0),[o,i]=a.useState(!1),l=a.useCallback(async()=>{i(!0);try{const u=await(await zt(t)).methods.totalAssets().call();r(u)}catch(d){console.log({e:d})}i(!1)},[t]);a.useEffect(()=>{t&&l()},[l,t]);const c=a.useMemo(()=>{if(!Wt(n))return new he(n).dividedBy(new he(10).pow(s)).toString()},[n,s]);return{vaultLiquidity:n,formattedBalance:c,loading:o}}function rr({vaultContractAddress:t,decimals:s}){const[n,r]=a.useState(0),[o,i]=a.useState(!1),l=a.useCallback(async()=>{i(!0);try{if(!t)return 0;const d=await(await zt(t)).methods.convertToAssets(10**Yt).call().then(u=>pe(lt(u,s),6));r(d)}catch(c){console.log({e:c})}i(!1)},[s,t]);return a.useEffect(()=>{t&&l()},[l,t]),{reserveBalance:n,formattedBalance:n,loading:o}}const lr=(t=[],s=18)=>t.map(n=>({name:n.poolId,date:kn(Dn(n.dateTimestamp,new Date(n.dateTimestamp).getTimezoneOffset()),"yyyy/MM/dd"),amt:ct(new he(n.poolValue),s)})),or=()=>{var M,y,C,S,E;const{pool:t,poolData:s}=ce(),[n,r]=a.useState(void 0),o=rt(Z(t,"currency.shortCode","")),[i,l]=a.useState([]),{formattedBalance:c}=nr({vaultContractAddress:t.vaultContractAddress,decimals:((M=t==null?void 0:t.currency)==null?void 0:M.decimals)||18}),{formattedBalance:d}=rr({vaultContractAddress:t.vaultContractAddress,decimals:((y=t==null?void 0:t.currency)==null?void 0:y.decimals)||18}),u=async()=>{var m;try{const x=await te.getVaultValues(t.id);l(lr(x,(m=t==null?void 0:t.currency)==null?void 0:m.decimals))}catch{l([])}},p=a.useMemo(()=>Z(t,"poolEvents[0]"),[t]),h=a.useMemo(()=>!!Z(p,"juniorNotesTokenAddress"),[p]),g=a.useMemo(()=>!!Z(p,"notesTokenAddress"),[p]),v=a.useMemo(()=>{var m;if(s.sotTargetAmount||s.jotTargetAmount)return ct(new he(s.sotTargetAmount).plus(s.jotTargetAmount),((m=t==null?void 0:t.currency)==null?void 0:m.decimals)||18)},[(C=t==null?void 0:t.currency)==null?void 0:C.decimals,s.jotTargetAmount,s.sotTargetAmount]),f=a.useMemo(()=>{var m;if(s.sotTargetAmount||s.jotTargetAmount)return ct(new he(s.sotTargetAmount).plus(s.jotTargetAmount).minus(new he(s.sotCurrencyRaised).plus(s.jotCurrencyRaised)),((m=t==null?void 0:t.currency)==null?void 0:m.decimals)||18)},[(S=t==null?void 0:t.currency)==null?void 0:S.decimals,s.jotTargetAmount,s.sotTargetAmount,s.totalSupplyOfJOT,s.totalSupplyOfSOT]),j=a.useMemo(()=>1e5/Kt||0,[t==null?void 0:t.interestRateSot]);return a.useEffect(()=>{Me.getVaultTotalValueLocked(t).then(m=>{r(m)}),u()},[t]),e.jsx(Xe,{className:"bg-gradient-to-b from-cyan-500 to-green-500 mb-6 border-0 [&>.ant-card-body]:p-0.5 overflow-hidden",children:e.jsxs("div",{className:"bg-gray-50 p-6 rounded-[14px]",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("span",{className:"text-lg font-bold",children:`${t.name??""} `}),e.jsxs("div",{className:"tag-group",children:[h&&e.jsx(Ds,{noteType:"Junior"}),g&&e.jsx(Ds,{noteType:"Senior"}),"  ",e.jsx("a",{href:`${js.explorerUrl}/address/${t==null?void 0:t.vaultContractAddress}`,target:"_blank",className:"text-blue-500 underline",rel:"noreferrer",children:e.jsx(Ta,{})})]})]}),t.shortDescription&&e.jsx("div",{className:"text-gray-500",children:String(t.shortDescription).length>150?String(t.shortDescription).substring(0,150)+"...":t.shortDescription})]}),e.jsxs("div",{children:[e.jsx("span",{children:"Issued by"}),e.jsx("span",{className:"font-bold ml-1",children:(E=t==null?void 0:t.issuerCompany)==null?void 0:E.companyLegalName})]})]}),e.jsx("hr",{className:"h-px my-4 bg-gray-200 border-0"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:" flex-1 grid grid-cols-4 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col justify-start h-40",children:[e.jsxs("p",{className:"text-gray-500 text-xs m-0",children:["Total Value Locked(",o,")"]}),e.jsx("p",{className:"text-xl font-bold m-0",children:Wt(n)?e.jsx(Re.Button,{loading:!0,active:!0}):X(n||0)}),e.jsx(Nn,{className:"w-full h-20",children:e.jsxs(In,{width:500,height:100,data:i,syncId:"anyId",margin:{top:10,right:30,left:0,bottom:0},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"colorUv",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#1ED76080",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#21BFFA00",stopOpacity:0})]})}),e.jsx(Tn,{type:"monotone",dataKey:"amt",stroke:"#1ED760",fill:"url(#colorUv)"})]})})]})}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 text-xs m-0",children:"30 day yield annualised"}),e.jsx("p",{className:"text-md font-bold m-0",children:h?"Variable":`${j}%`})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 text-xs m-0 mt-3",children:["Liquidity (",o,")"]}),e.jsx("p",{className:"text-md font-bold m-0",children:Wt(c)?e.jsx(Re.Button,{loading:!0,active:!0}):X(c||0)})]})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-500 text-xs m-0",children:" "}),e.jsx("p",{className:"text-md font-bold m-0",children:" "})]}),e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-gray-500 text-xs m-0 mt-3",children:["NAV (",o,")"]}),e.jsx("p",{className:"text-md font-bold m-0",children:X(d||0)})]})]})]})]}),e.jsx("div",{className:"flex flex-col justify-start items-center",children:p&&e.jsx(ka,{strokeLinecap:"butt",strokeWidth:"10",type:"circle",strokeColor:"#1AB752",size:125,percent:pe((v-f)/v*100,2),format:m=>e.jsxs("div",{className:"text-sm font-bold",children:[m,"%"]})})})]})]})})},yt=({label:t,value:s,tooltip:n=""})=>e.jsxs("div",{className:"flex justify-between my-4",children:[e.jsx("span",{className:"text-gray-400 text-md",children:t}),e.jsx(it,{placement:"top",title:n,children:e.jsx("span",{className:"text-gray-800 text-md",children:s})})]});yt.propTypes={label:ne.oneOfType([ne.string,ne.element]),value:ne.oneOfType([ne.string,ne.element]),tooltip:ne.string};const ir=()=>{var c;const{pool:t,isLoadingNote:s,poolData:n,tab:r}=ce(),o=rt(Z(t,"currency.shortCode",""));console.log("tab",r);const i=a.useMemo(()=>ct(new he(n.totalAssets||0),Yt),[n.totalAssets]),l=a.useMemo(()=>{var d;return ct(new he(n.convertToAssets||0),((d=t==null?void 0:t.currency)==null?void 0:d.decimals)||18)},[(c=t==null?void 0:t.currency)==null?void 0:c.decimals,n.convertToAssets]);return s?e.jsx(Re,{loading:s}):r!==st.notes?null:e.jsx(ge,{gutter:16,children:e.jsx(ue,{xs:12,lg:12,children:e.jsxs(Xe,{className:"bg-gray-50",children:[e.jsx("div",{className:"w-1.5 h-8 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0 top-5"}),e.jsx("div",{className:"border-b-2 text-lg font-bold",children:"Shares"}),e.jsx(Be,{className:"my-2"}),e.jsx(yt,{label:"Amount outstanding",value:`${X(i||0)}`}),e.jsx(yt,{label:`Current price (${o})`,value:`${X(l,4)}`}),e.jsx(yt,{label:`Current value (${o})`,value:`${X((i||0)*l)}`})]})})})},cr=()=>{const{poolHistories:t,isLoadingNote:s,pool:n,note:r}=ce(),o=n.currency.decimals;console.log("poolHistories",t);const i=[{title:"Date",dataIndex:"createdTimestamp",defaultSortOrder:"ascend",sorter:(l,c)=>c.createdTimestamp-l.createdTimestamp,render:l=>ke(parseInt(l)*1e3).format("HH:mm:ss DD/MM/YYYY")},{title:"Address",dataIndex:"from",render:l=>e.jsx("a",{href:Jn(l),target:"_blank",rel:"noreferrer",children:qn(l,6,4,10)})},{title:"Activity",dataIndex:"transactionType",render:(l,c)=>{switch(l){case"REPAY":return"Loan repayment";case 3:return`Invoice repayment - #${Z(c,"content.openItemId")}`;case 4:return"Pool setup";case 5:return"Tokenize collaterals";case 6:return"Transfer collaterals to pool";case 7:return"Change of control";case 8:return"Issuance of note";case 9:return"Issuance of junior note";case 10:return"Import collaterals";case 11:return"Export collaterals";case"SOT_PURCHASE":return`Invest ${r.ticker}_SOT`;case"DRAWDOWN":return"Drawdown";case"JOT_PURCHASE":return`Invest ${r.ticker}_JOT`;case"EPOCH_WITHDRAW":return"Epoch withdraw";case 2:default:return"Note redeemed"}}},{title:"Value",dataIndex:"amount",render:l=>l===null?"":l>0?`${X(pe(l/10**o,2))}`:l<0?`${X(pe(l/10**o,2))}`:"0"},{title:"",dataIndex:"createdTransactionHash",render:l=>e.jsx(e.Fragment,{children:l&&e.jsx("a",{target:"_blank",rel:"noreferrer",href:da(l),children:"Explorer"})})}];return e.jsx("div",{className:"w-full overflow-x-auto z-10",children:e.jsx(ot,{columns:i,dataSource:t||[],pagination:!1,size:"small",scroll:{x:"100%"},loading:s,className:"w-full border-none overflow-x-auto",rowKey:l=>l.id})})},Ps=4,Qe={ACTIVE:1,FUll:2,OUT_OF_RANGE:3},ns={[Qe.ACTIVE]:"text-green-500",[Qe.FUll]:"text-yellow-500",[Qe.OUT_OF_RANGE]:"text-red-500"},Fs={[Qe.ACTIVE]:"bg-green-500",[Qe.FUll]:"bg-yellow-500",[Qe.OUT_OF_RANGE]:"bg-red-500"},dr=()=>{const{pool:t,poolData:s,setPoolParametersModalVisible:n,setPoolParameterMinFirstLossModalVisible:r}=ce(),o=rt(Z(t,"currency.shortCode","")),i=Z(t,"currency.decimals",18),{isPoolAdmin:l}=Je(v=>v),c=a.useMemo(()=>lt((s==null?void 0:s.debtCeiling)||0,i),[i,s==null?void 0:s.debtCeiling]),d=a.useMemo(()=>lt(new he(s==null?void 0:s.jotCurrencyRaised).plus(s==null?void 0:s.sotCurrencyRaised),i),[i,s==null?void 0:s.jotCurrencyRaised,s==null?void 0:s.sotCurrencyRaised]),u=a.useMemo(()=>+d<+c?Qe.ACTIVE:+d==+c?Qe.FUll:Qe.OUT_OF_RANGE,[c,d]),p=a.useMemo(()=>lt((s==null?void 0:s.minFirstLossCushion)||0,Ps),[s==null?void 0:s.minFirstLossCushion]),h=a.useMemo(()=>lt((s==null?void 0:s.currentMinFirstLoss)||0,Ps),[s==null?void 0:s.currentMinFirstLoss]),g=a.useMemo(()=>+h>+p?Qe.ACTIVE:Qe.OUT_OF_RANGE,[p,h]);return e.jsxs("div",{className:"flex flex-wrap gap-3 justify-between",children:[e.jsxs(Xe,{className:"bg-gray-50 grow",children:[e.jsxs("div",{className:"border-b-2 text-md font-bold",children:["Debt ceiling (",o,")"]}),e.jsx(Be,{className:"my-2"}),e.jsxs("div",{className:"flex justify-between items-center gap-2",children:[e.jsx("div",{className:"grow",children:e.jsxs("div",{className:"flex justify-between my-4",children:[e.jsx("span",{className:"text-gray-400 text-md shrink-0 mr-3",children:`Target Value (${o})`}),e.jsx("span",{className:"text-gray-800 text-md",children:X(pe(c,2))})]})}),l&&e.jsx("button",{className:"text-xs border-none rounded-2xl h-6 w-12 cursor-pointer bg-[#25272614]",onClick:()=>n(!0),children:"Edit"})]}),e.jsx(yt,{label:e.jsxs(e.Fragment,{children:["Actual Value (",o,")",e.jsx(it,{title:"Total investment amount of JOT and SOT",trigger:"click",children:e.jsx(Ss,{className:"cursor-pointer ml-1"})})]}),value:e.jsxs(ss,{className:`flex items-center gap-2 text-xs ${ns[u]}`,children:[e.jsx("div",{className:`w-2.5 h-2.5 rounded-full ${Fs[u]}`}),X(pe(d,2))]})}),[Qe.OUT_OF_RANGE,Qe.FUll].includes(u)&&e.jsx(ss,{className:`${ns[u]} text-xs`,children:"Debt ceiling reached! No more investment can be made."})]}),e.jsxs(Xe,{className:"bg-gray-50 grow",children:[e.jsx("div",{className:"border-b-2 text-md font-bold",children:"Minimum first loss"}),e.jsx(Be,{className:"my-2"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{className:"grow",children:e.jsx(yt,{label:"Target Value",value:`${X(p)}%`})}),l&&e.jsx("button",{className:"text-xs border-none rounded-2xl h-6 w-12 cursor-pointer bg-[#25272614]",onClick:()=>r(!0),children:"Edit"})]}),e.jsx(yt,{label:e.jsxs(e.Fragment,{children:["Actual Value",e.jsx(it,{title:"Outstanding investment amount of JOT over the total investment (%)",trigger:"click",children:e.jsx(Ss,{className:"cursor-pointer ml-1"})})]}),value:e.jsxs(ss,{className:`flex items-center gap-2 text-xs ${ns[g]}`,children:[e.jsx("div",{className:`w-2.5 h-2.5 rounded-full ${Fs[g]}`}),X(pe(h,2)),"%"]})})]})]})};function Ut({index:t,onClick:s,title:n}){return e.jsxs("div",{className:"flex items-center justify-start gap-2 py-3 border-0 border-b border-solid border-gray-100 cursor-pointer",onClick:s,children:[e.jsx("div",{className:"w-5 h-5 flex items-center justify-center rounded-full border border-solid border-green-500 text-xs",children:t}),e.jsx("div",{children:n})]})}var hs=(t=>(t[t.ACTIVE=1]="ACTIVE",t[t.CLOSED=6]="CLOSED",t))(hs||{});const rs=({condition:t=!0,title:s,onClick:n})=>t?{title:s,onClick:n}:null;function ma({defaultActiveKey:t,isShowFull:s,setShowFull:n}){const{closePool:r,openPool:o,pool:i,setBankAccountModalVisible:l,setAddModulesModalVisible:c,setDrawDownVisible:d,setEditPoolModalVisible:u,setEpochSettingVisible:p,setNoteUpdateVisible:h,setPoolSweepVisible:g,setPoolUpdateVisible:v,setRepaymentModalVisible:f,setSecurityModalVisible:j,setShowUploadModal:M,setUpdatingAssets:y,setNotiModalVisible:C,poolData:S}=ce(),E=gt(),{isOriginator:m,isIssuer:x}=Je(q=>q),[D,_]=a.useState(!1),T=a.useCallback(()=>!m&&!i.uploadAssetLegalDocumentId?(Le.error("Pool owner hasn't setup Collateral Purchase Agreement"),!1):!0,[m,i.uploadAssetLegalDocumentId]),w=x||m,A=x||m,O=!m,P=a.useMemo(()=>w?[{condition:x,title:"Add modules",onClick:()=>{c(!0)}},{condition:x,title:"Link remote wallet",onClick:()=>{l(!0)}},{condition:x,title:"Review info",onClick:()=>{u(!0)}},{condition:x,title:"Create notification",onClick:()=>{C(!0)}},{condition:x&&i.status!=hs.CLOSED,title:"Close from view",onClick:()=>{fe.confirm({title:"Close pool from view",content:e.jsx("p",{children:"Are you sure you want to close this pool?"}),closable:!0,maskClosable:!0,styles:{content:{borderRadius:24,backgroundColor:"#F0F0F0"}},okText:"OK",icon:null,centered:!0,okButtonProps:{className:"bg-[#1ED760] hover:bg-[#1ED760] shadow-none h-10 text-black w-20",style:{backgroundColor:"#1ED760"},type:"primary"},cancelButtonProps:{className:"bg-[#25272614] shadow-none h-10 w-20"},cancelText:"Cancel",width:"30vw",style:{minWidth:500},onOk:r})}},{condition:x&&i.status==hs.CLOSED,title:"Open to view",onClick:()=>{fe.confirm({title:"Open vault to view",content:e.jsx("p",{children:"Are you sure you want to open this pool?"}),closable:!0,maskClosable:!0,styles:{content:{borderRadius:24,backgroundColor:"#F0F0F0"}},okText:"OK",icon:null,centered:!0,okButtonProps:{className:"bg-[#1ED760] hover:bg-[#1ED760] shadow-none h-10 text-black w-20",style:{backgroundColor:"#1ED760"},type:"primary"},cancelButtonProps:{className:"bg-[#25272614] shadow-none h-10 w-20"},cancelText:"Cancel",width:"30vw",style:{minWidth:500},onOk:o})}}].map(K=>rs(K)).filter(Boolean):[],[w,x,l,E,i.id,u,C,r]),V=a.useMemo(()=>{if(!O)return[];const q=!!Z(i,"poolEvents[0]")&&!Z(i,"poolEvents[0].canceledAt");return[{condition:x,title:"Generate and sign doc",onClick:()=>{E(`/vault-setting/${i.id}/settings?tab=doc_generated`)}},{condition:x&&q,title:"Update note",onClick:()=>{h(!0)}},{condition:x,title:"Manage epoch",onClick:()=>{E(`/vault-setting/${i.id}$/reserve`)}}].map(B=>rs(B)).filter(Boolean)},[O,i,x,j,h,g,p,E]),b=a.useMemo(()=>A?[{condition:x,title:"Add/remove",onClick:()=>{E(`/vault-setting/${i.id}/assets`)}},{condition:x,title:"Update",onClick:()=>{v(!0)}},{condition:m,title:"Upload collaterals",onClick:()=>{T()&&(y(!1),M(!0))}},{condition:m,title:"Drawdown",onClick:()=>{d(!0)}},{condition:m,title:"Repay",onClick:()=>{T()&&f(!0)}}].map(K=>rs(K)).filter(Boolean):[],[A,x,m,E,i.id,v,T,y,M,d,f]),R=a.useMemo(()=>[!Ye(P)&&{key:"pools_setting",label:e.jsx("div",{className:"font-bold",children:"Settings"}),children:e.jsx("div",{className:"flex flex-col pb-4",children:P.map((q,K)=>e.jsx(Ut,{index:K+1,title:q.title,onClick:q.onClick},K))}),className:"border-0 !border-b !border-solid !border-gray-200"},!Ye(V)&&{key:"issue_note",label:e.jsx("div",{className:"font-bold",children:"Shares"}),className:"border-0 !border-b !border-solid !border-gray-200",children:e.jsx("div",{className:"flex flex-col pb-4",children:V.map((q,K)=>{if(q.title==="Update note"){const B=Number(lt((S==null?void 0:S.minFirstLossCushion)||0,4))>=100;return e.jsx(Da,{overlayInnerStyle:{padding:7},arrow:!1,placement:"bottom",open:D,trigger:"click",content:e.jsxs("div",{className:"flex flex-col",children:[!B&&e.jsxs("button",{className:"rounded-lg group border-none cursor-pointer bg-white hover:bg-[#25272614] py-3 px-3",onClick:()=>{h("SOT"),_(!1)},children:["Update Senior note"," ",e.jsx(Ns,{className:"invisible group-hover:visible ml-2",style:{color:"#818884"}})]}),e.jsxs("button",{className:"rounded-lg group border-none cursor-pointer bg-white hover:bg-[#25272614] py-3 px-3",onClick:()=>{h("JOT"),_(!1)},children:["Update Junior note"," ",e.jsx(Ns,{className:"invisible group-hover:visible ml-2",style:{color:"#818884"}})]})]}),children:e.jsx(Ut,{index:K+1,title:q.title,onClick:()=>_(!D)})},K)}return e.jsx(Ut,{index:K+1,title:q.title,onClick:q.onClick},K)})})},!Ye(b)&&{key:"manage_assets",label:e.jsx("div",{className:"font-bold",children:"Assets"}),className:"border-0 !rounded-none",children:e.jsx("div",{className:"flex flex-col pb-4",children:b.map((q,K)=>e.jsx(Ut,{index:K+1,title:q.title,onClick:q.onClick},K))})}].filter(Boolean),[D,V,b,S==null?void 0:S.minFirstLossCushion,P,h]);return e.jsxs("div",{className:`bg-gray-50 rounded-2xl border-gray-200 border border-solid relative ${s&&"w-full"||"w-0.5 border-0 border-r-2 border-green-500 h-96"}`,children:[e.jsx(U,{className:"flex items-center justify-center p-0 bg-green-400 absolute -right-4 top-8",icon:e.jsx(Ea,{rotate:s?0:180}),onClick:()=>{n(!s)}}),e.jsxs("div",{className:s&&"visible"||"invisible",children:[e.jsx("div",{className:"p-4 border-0 border-b border-solid border-gray-200",children:e.jsx("div",{className:"text-lg font-bold mb-2",children:"Manage"})}),e.jsx(Ys,{defaultActiveKey:t,accordion:!0,expandIcon:({isActive:q})=>e.jsx(La,{rotate:q?90:0}),ghost:!0,onChange:q=>{console.log(q)},expandIconPosition:"end",items:R})]})]})}ma.propTypes={defaultActiveKey:ne.arrayOf(ne.oneOf(["pools_setting","issue_note","manage_assets"]))};function At({defaultActiveKey:t,children:s}){const{isIssuer:n,isOriginator:r}=Je(c=>c),o=a.useMemo(()=>n||r,[n,r]),[i,l]=a.useState(!0);return e.jsx(ge,{gutter:24,children:e.jsx(ue,{span:24,children:e.jsxs("div",{className:"flex w-full gap-6",children:[o&&e.jsx("div",{className:`flex-none ${i&&"w-[280px]"||"w-[10px]"}`,children:e.jsx(ma,{defaultActiveKey:t,isShowFull:i,setShowFull:l})}),e.jsx("div",{className:"flex-1 max-w-full overflow-hidden",children:e.jsx(Xe,{className:"vault-setting-tabs bg-gray-50",children:s})})]})})})}At.propTypes={defaultActiveKey:ne.arrayOf(ne.oneOf(["pools_setting","issue_note","manage_assets"]))};const ur=[{name:"Shares",key:"notes"}];function mr(){const t=ys(),s=gt(),{isLoadingNote:n}=ce(),r=ws.parse(t.search),o=["notes","transactions","pool_parameters"].includes(r.tab)&&r.tab||"notes";return e.jsx(At,{defaultActiveKey:["issue_note"],children:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex gap-2 mb-4",children:ur.map(i=>e.jsx(U,{className:`${o===i.key&&"bg-green-500"||"bg-gray-200"} !rounded-lg text-xs`,onClick:()=>{s(t.pathname+`?tab=${i.key}`)},children:i.name},i.key))}),!n&&e.jsxs(e.Fragment,{children:[o==="notes"&&e.jsx(ir,{}),o==="transactions"&&e.jsx(cr,{}),o==="pool_parameters"&&e.jsx(dr,{})]})]})})}const pr=()=>{const{isSuperAdmin:t,isPoolAdmin:s,isIssuer:n}=Je(g=>g),{pool:r,tab:o,setTab:i}=ce(),l=a.useMemo(()=>r.isOriginator,[r]),c=s||t||r.isServicer||l||r.access&&r.access.includes(0),d=!l,u=!l,p=n,h=[...c?[{key:st.assets,label:"Assets"}]:[],...d?[{key:st.notes,label:"Shares"}]:[],...u?[{key:st.reserve,label:"Liquidity"}]:[],...p?[{key:st.holders,label:"Holders"}]:[],{key:st.settings,label:"Settings"}];return e.jsx(Ma,{className:"bg-white mt-6 px-2",children:e.jsx(Ks,{activeKey:o,onChange:g=>i(g),tabPosition:"top",items:h})})},pa=({pool:t,assets:s,onNextStep:n})=>{gt();const{address:r,chainId:o}=nt(),i=async d=>{try{const u=await Me.getVaultModules(t),p=await Ts(u[1]),h=t.chainId==o?1:0,g=await p.send("updateAsset",[d.address],h),v=await Me.waitForTransactionReceipt(g,connector.id);Le.success("Token information has been updated")}catch(u){console.log(u),Ke.error({message:u.message||"Something went wrong!"})}},l=async d=>{try{if(String(r).toLowerCase()!==String(t.safeWalletAddress).toLowerCase())return Ke.error({message:`Current wallet address is not valid.
            Please connect to wallet
            ${t.safeWalletAddress}`});const u=await Me.getVaultModules(t),h=await(await Ts(u[1])).send("removeAsset",[d.address]),g=await Me.waitForTransactionReceipt(h,connector.id);Le.success("Token information has been removed")}catch(u){console.log(u),Ke.error({message:u.message||"Something went wrong!"})}},c=[{title:"Token",dataIndex:"symbol",key:"symbol",width:"18%"},{title:"Price",dataIndex:"price",key:"price"},{title:"Balance",dataIndex:"balance",key:"balance"},{title:"Value",dataIndex:"value",key:"value",width:"20%"},{title:"Token %",dataIndex:"tokenPercent",key:"tokenPercent"},{title:"Action",key:"action",render:(d,u)=>{const p=[{key:"1",label:e.jsx("a",{onClick:()=>i(u),children:"Update"})},{key:"2",label:e.jsx("a",{onClick:()=>l(u),children:"Remove"})}];return e.jsx(Hs,{size:"middle",children:e.jsx(Pa,{menu:{items:p},trigger:["click"],children:e.jsx("a",{children:"..."})})})}}];return e.jsxs("div",{children:[e.jsx(ot,{style:{marginTop:15},bordered:!0,dataSource:s,columns:c,pagination:!0,scroll:{y:350,x:1e3},rowKey:d=>d.id}),n?e.jsx(U,{type:"primary",size:"large",style:{width:"100%",marginTop:20},onClick:n,children:"Continue"}):null]})},{Step:ls}=ut,Os={[xe.LENDING]:"SME Loans",[xe.INVOICE]:"Invoices"},hr={"<":"$lt",">=":"$gte",between:"$between"},gr=t=>{let s={};return t.forEach(n=>{const r=n.conditions[0],o={[hr[r.operation]]:r.operation==="between"?[parseFloat(r.value1),parseFloat(r.value2)]:parseFloat(r.value)};n.key==="AND"?s={...s,[r.variable]:o}:s={$or:[{...s},{[r.variable]:o}]}}),s},fr=({pool:t={},visible:s,onClose:n})=>{const[r,o]=a.useState(0),[i,l]=a.useState(!1),[c,d]=a.useState([]),[u,p]=a.useState([{key:"AND",conditions:[{}]}]);a.useEffect(()=>{s&&o(0),p([{key:"AND",conditions:[{}]}])},[s]);const h=a.useMemo(()=>{let g=!0;return u.forEach(v=>{v.conditions.forEach(f=>{(f.variable===void 0||!f.operation)&&(g=!1),f.operation==="between"&&(!f.value1||!f.value2)&&(g=!1),f.operation!=="between"&&!f.value&&(g=!1)})}),g},[u]);return e.jsx(fe,{onCancel:()=>{n()},footer:null,width:"100vw",open:s,style:{top:0,minWidth:r===1?1100:650,paddingBottom:0},children:e.jsxs("div",{style:{height:`calc(100vh - ${r===1?20:100}px)`,width:r===1?1100:650,margin:"0 auto",marginTop:r===1?20:100},children:[e.jsxs(ut,{progressDot:!0,current:r,children:[e.jsx(ls,{title:"Filter"}),e.jsx(ls,{title:"Review"}),e.jsx(ls,{title:"Transfer"})]}),s&&r===0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{children:"Collateral Filtering Criteria"}),e.jsx(re,{readonly:!0,placeholder:"Collateral type",id:"assetType",value:Os[t.assetType]})]}),s&&r===1&&e.jsx(pa,{pool:t,assets:c,assetType:t.assetType}),s&&r===2&&e.jsxs(e.Fragment,{children:[e.jsx("div",{children:"Transfer"}),e.jsx("center",{style:{fontSize:16,color:"#070A0E",padding:"0 50px",marginBottom:50},children:e.jsxs("labe",{children:["We are transferring your ",c.length," collaterals to the pool now.",e.jsx("br",{})," We will notify you when the transfer is complete."]})})]}),e.jsx("div",{style:{width:"100%",marginTop:20},children:e.jsxs(U,{loading:i,disabled:r===0&&!h,onClick:async()=>{if(r===2)location.reload();else{if(r===0){l(!0);const g=gr(u),f=Os[t.assetType]==="Invoices"?xe.INVOICE:xe.LENDING,j=await te.getAssetsByCriteria(f,g);l(!1),d(j)}if(r===1){if(!c.length)return o(r-1);l(!0),await te.transferAssetsToPool(t.id,c.map(g=>g.id)),l(!1)}o(r+1)}},type:"primary",style:{width:"100%"},children:[r===0&&"Continue",r===1&&(c.length?"Transfer to Pool":"Back to Filer collaterals"),r===2&&"Go to Pool collaterals"]})})]})})},xr=()=>{const[t,s]=a.useState(!1),{pool:n,setShowUploadModal:r,reloadPool:o}=ce();return e.jsxs("div",{children:[e.jsx("div",{onClick:()=>{r(!0),o()},children:"+ Transfer Collaterals to Pool"}),e.jsx(fr,{pool:n,visible:t,onClose:()=>s(!1)})]})},yr=[{chainId:1,symbol:"USDC",name:"USD Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/3408.png",decimals:6,address:"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"},{chainId:1,symbol:"USDT",name:"Tether USD",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/825.png",decimals:6,address:"0xdAC17F958D2ee523a2206206994597C13D831ec7"},{chainId:1,symbol:"DAI",name:"DAI Stablecoin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/4943.png",decimals:18,address:"0x6B175474E89094C44Da98b954EedeAC495271d0F"}],br=[{chainId:137,symbol:"USDC",name:"USD Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/3408.png",decimals:6,address:"0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"},{chainId:137,symbol:"fakeUSDC",name:"fake USD Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/3408.png",decimals:6,address:"0x3AD4E117eE7c074D989E33dbE3d92450E373a820"},{chainId:137,symbol:"USDT",name:"Tether USD",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/825.png",decimals:6,address:"0xc2132D05D31c914a87C6611C10748AEb04B58e8F"}],jr=[{chainId:42220,symbol:"USDC",name:"USD Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/3408.png",decimals:6,address:"0xceba9300f2b948710d2653dd7b07f33a8b32118c"}],vr=[{chainId:8453,symbol:"USDC",name:"USD Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/3408.png",decimals:6,address:"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"}],wr=[{chainId:44787,symbol:"USDC",name:"USD Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/3408.png",decimals:6,address:"0xe3398bab66b00f2e4ae551968b9a91d064186b66"}],Cr=[{chainId:tt.AMOY,symbol:"USDC",name:"USD Official Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/825.png",decimals:6,address:"0x41E94Eb019C0762f9Bfcf9Fb1E58725BfB0e7582"},{chainId:tt.AMOY,symbol:"USDCU",name:"USD Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/825.png",decimals:6,address:"0x6f48Ef99a294d5C9F394A0a08f4149b1f350441a"}],Ar=[{chainId:tt.SEPOLIA,symbol:"USDC",name:"USD Official Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/825.png",decimals:6,address:"0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238"}],Sr=[{chainId:tt.BASE_SEPOLIA,symbol:"USDC",name:"USD Official Coin",logoURI:"https://s2.coinmarketcap.com/static/img/coins/64x64/825.png",decimals:6,address:"0x036CbD53842c5426634e7929541eC2318f3dCF7e"}],Nr={[tt.ETHERIUM]:yr,[tt.POLYGON]:br,[tt.CELO]:jr,[tt.BASE]:vr,[tt.ALFAJORES]:wr,[tt.AMOY]:Cr,[tt.SEPOLIA]:Ar,[tt.BASE_SEPOLIA]:Sr};function Ir(){const{pool:t}=ce(),s=[],[n,r]=a.useState([]);return a.useEffect(()=>{(async()=>{if(!t)return;const i=await te.getVaultAssets(t.vaultContractAddress);let l=0;const d=i.map(u=>{const p=u.balance/Math.pow(10,u.decimals),h=lt(u.price,t.currency.decimals),g=Number(p)*Number(h);l+=g||0;const v=Nr[u.chainId].find(f=>Is(f.address)==Is(u.address))||{};return{symbol:u.assetId,iconURI:v.logoURI,address:u.address,chainId:u.chainId,price:`${t.currency.tokenSymbol}${X(h,2)}`,balance:X(p),value:`${t.currency.tokenSymbol}${X(g)}`,_value:g,tokenPercent:100}}).map(u=>({...u,tokenPercent:us(u._value)?void 0:X(u._value/l*100,2)}));r(d)})()},[t]),e.jsx(ge,{gutter:16,children:e.jsxs(ue,{xs:24,lg:24,children:[t.isOriginator&&t.status===We.statuses.PENDING_ASSETS&&e.jsx(xr,{}),t.status!==We.statuses.PENDING_ASSETS&&e.jsx(e.Fragment,{children:e.jsx(pa,{pool:t,assets:s.concat(n),assetType:t.assetType})})]})})}const{Option:Rs,OptGroup:Vs}=at,Tr=({formula:t,setFormula:s,currentVariables:n})=>e.jsxs("div",{style:{marginTop:10},children:[e.jsx(Be,{children:"Computation"}),e.jsxs("center",{children:[e.jsx(re,{style:{marginTop:20,height:110},placeholder:"Formula",type:"textarea",value:t,onChange:r=>s(r.target.value)}),n.length?e.jsx("div",{style:{marginTop:10},children:"Please define the value for below variables:"}):null,n.map((r,o)=>e.jsxs("div",{children:[r,":"," ",e.jsxs(re,{onChange:i=>{const l=t.replace(r,i);s(l)},type:"select",style:{width:200,marginTop:10,marginLeft:10,display:"inline-block"},showSearch:!0,id:"beneficiary",children:[e.jsx(Vs,{label:"Lending",children:Es.calculationFieldsForSMELoans.map(i=>e.jsx(Rs,{value:i.value,children:i.name},i.value))}),e.jsx(Vs,{label:"Invoice",children:Es.calculationFieldsForInvoices.map(i=>e.jsx(Rs,{value:i.value,children:i.name},i.value))})]})]},o))]})]}),kr=({actionData:t={},setActionData:s})=>e.jsxs("div",{style:{marginTop:10},children:[e.jsx(Be,{children:"Action"}),e.jsx(Ze,{onChange:n=>{s({...t,isEmailNotificationEnable:n.target.checked||!1})},checked:t.isEmailNotificationEnable,children:"Email notification"}),e.jsx("center",{children:e.jsx(re,{style:{marginTop:20,height:110},placeholder:"Recipient emails",type:"textarea",value:t.recipientEmails,onChange:n=>s({...t,recipientEmails:n.target.value})})})]});function St(t,s){let n=s.conditions;for(let r=0;r<t.length;r++){const o=t[r];n=n[o].conditions}return n}const Dr=[{name:"Current balance",value:"outstandingPrincipalAmount"},{name:"Original loan balance",value:"principalAmount"}],{Option:ze,OptGroup:Po}=at,ha=({level:t=0,operations:s,setConditionGroup:n,rootConditionGroup:r,onChangeCondition:o,onChangeMatchType:i,conditionGroup:l,addCriteria:c,removeCriteria:d,addGroup:u,questionnaires:p,indexList:h,removeGroup:g,assetType:v,isTemplateBuilder:f,isTrigger:j=!1,calculationName:M})=>{const{match:y,conditions:C}=l,S=t%2===0?"bg-gray-50":"bg-gray-100";return e.jsxs(Xe,{className:`mt-4 [&_.ant-select]:!h-10 [&_.ant-input]:!h-10 [&_.ant-card-body]:p-4 ${S}`,children:[e.jsx("div",{className:"[&_.ant-select]:!h-8 text-left inline-block",children:e.jsxs(at,{onChange:i,value:y,className:"[&>.ant-select-selector]:!rounded-2xl [&>.ant-select-selector]:!bg-gray-200",children:[e.jsx(ze,{value:"ALL",children:"Match ALL"}),e.jsx(ze,{value:"ANY",children:"Match ANY"})]})}),e.jsxs("div",{className:"float-right inline-block mr-2",children:[e.jsx(U,{onClick:u,type:"link",className:"px-1 text-green-600",children:"Add group"}),e.jsx(U,{onClick:c,type:"link",className:"px-1 text-green-600 ml-3",children:"Add criteria"}),g&&e.jsx(U,{onClick:g,type:"link",className:"px-2 text-red-600 ml-3",children:"Remove"})]}),e.jsx(Be,{}),C.map((E,m)=>E.match?e.jsx(ha,{level:t+1,isTemplateBuilder:f,assetType:v,operations:s,conditionGroup:E,rootConditionGroup:r,setConditionGroup:n,questionnaires:p,addCriteria:()=>{const x=[...h,m],D=He(r,_=>{St(x,_).push({})});n(D)},removeCriteria:x=>{const D=[...h,m],_=He(r,T=>{St(D,T).splice(x,1)});n(_)},addGroup:()=>{const x=[...h,m],D=He(r,_=>{St(x,_).push({conditions:[],match:"ALL"})});n(D)},removeGroup:()=>{const x=He(r,D=>{St(h,D).splice(m,1)});n(x)},onChangeCondition:(x,D,_)=>{const T=[...h,m],w=He(r,A=>{const O=St(T,A);O[x][D]=_});n(w)},indexList:[...h,m],onChangeMatchType:x=>{const D=He(r,_=>{let T=_.conditions;for(let w=0;w<h.length;w++){const A=h[w];T=T[A].conditions}T[m].match=x});n(D)},calculationName:M,isTrigger:j},m):e.jsxs(ge,{style:{marginTop:20},gutter:16,className:`[&_.ant-select-selector]:!${S} [&_.ant-input]:!${S}`,children:[e.jsx(ue,{span:7,children:j?e.jsx(re,{type:"select",className:"w-full",value:E.attribute,id:"attribute",placeholder:"Select attribute",onChange:x=>o(m,"attribute",x),children:e.jsx(ze,{value:`$${En(M)}`,children:M})}):e.jsx(re,{type:"select",className:"w-full",value:E.attribute,id:"attribute",placeholder:"Select attribute",onChange:x=>o(m,"attribute",x==="currency.shortCode2"?"currency.shortCode":x),children:Dr.map(x=>e.jsx(ze,{value:x.value,children:x.name},x.value))})}),e.jsx(ue,{span:8,children:e.jsxs(re,{type:"select",className:"w-full",value:E.operation,id:"operation",placeholder:"Select operation",onChange:x=>o(m,"operation",x),children:[e.jsx(ze,{value:"equals",children:"equals"}),e.jsx(ze,{value:"not equals",children:"not equals"}),e.jsx(ze,{value:"greater than",children:"greater than"}),e.jsx(ze,{value:"greater than or equals",children:"greater than or equals"}),e.jsx(ze,{value:"less than",children:"less than"}),e.jsx(ze,{value:"less than or equals",children:"less than or equals"})]})}),e.jsx(ue,{span:7,children:E.attribute==="status"?e.jsxs(re,{type:"select",className:"w-full",value:E.value,id:"value",placeholder:"Enter value",onChange:x=>o(m,"value",x),children:[e.jsx(ze,{value:"paid",children:"Paid"}),e.jsx(ze,{value:"performing",children:"Performing"}),e.jsx(ze,{value:"non-performing",children:"Non performing"})]}):e.jsx(re,{type:"input-number-v2",className:"w-full",value:E.value,id:"value",placeholder:"Enter value",onChange:x=>o(m,"value",x)})}),e.jsx(ue,{span:2,className:"flex items-center justify-center",children:e.jsx(U,{className:"bg-gray-300 w-8 h-8 px-1",onClick:()=>d(m),children:e.jsx(Fa,{className:"text-lg"})})})]},m))]})},{Option:mt}=at,Ee={FILTER:0,CASHFLOW:1,REPORT:2},Er={equals:"$eq","not equals":"$ne","less than":"$lt","less than or equals":"$lte","greater than":"$gt","greater than or equals":"$gte"},Lr=({pool:t,isGeneralPurpose:s=!1,assetType:n,questionnaires:r=[],isBlockConditionVisible:o,setBlockConditionVisible:i,conditionGroup:l,setConditionGroup:c,isEditting:d=!1,setEditting:u=()=>{},onSaveAssetFilter:p=()=>{},operations:h=[],criteriaName:g,isViewingClauseDetail:v,isLoadingClause:f,shouldHideRemoveBtn:j,onCancel:M=()=>{},isTemplateBuilder:y=!1,templateId:C,reloadReportTemplate:S=()=>{},filterTemplateId:E=null,reportTemplateId:m=null,clauseDetail:x={},formula:D,setFormula:_,isTrigger:T=!1,currentActionData:w=null})=>{const[A,O]=a.useState(d&&g||""),[P,V]=a.useState(!1),[b,R]=a.useState(!1),[q,K]=a.useState([]),[B,N]=a.useState(0),[J,le]=a.useState([]),[me,ye]=a.useState([]),[W,Q]=a.useState(null),[z,oe]=a.useState(null),[k,be]=a.useState({}),[$e]=qe(Dt.getAllCompanies),[Se,Pe]=a.useState(!1),[L,G]=a.useState(""),[$,ee]=a.useState(w||(t&&t.owner?{recipientEmails:t.owner.email}:{}));console.log("templateId",C);const[ae,ie]=a.useState("");a.useEffect(()=>{if(x){if(Pe(x&&x.id?!x.beneficiaryCompanyId:!1),x.reportTemplateId){N(Ee.REPORT);const Y=Z(x,"reportContent.calculationFormula","");G(Y==="EMPTY_FORMULA"?"":Y)}else N(x.calculationFormula?Ee.CASHFLOW:Ee.FILTER),G(x.calculationFormula==="EMPTY_FORMULA"?"":x.calculationFormula);x.id&&be({...x})}},[x]);const H=a.useMemo(()=>$e.filter(Y=>new RegExp(ae,"gi").test(Y.companyLegalName)),[ae,$e]),je=a.useCallback(async Y=>{const Ce=await te.getPoolFilterTemplates(Y),et=await te.getListReportTemplate(Y);le(Ce),ye(et)},[]);a.useEffect(()=>{E&&E!==W&&Q(E)},[E]),a.useEffect(()=>{m&&m!==z&&oe(m)},[m]),a.useEffect(()=>{je(t?t.id:null)},[t]);const de=async(Y,Ce,et)=>{const Ie=He(l,dt=>{dt.conditions[Y][Ce]=et});c(Ie)},Fe=()=>{const Y=He(l,Ce=>{Ce.conditions.push({conditions:[],match:"ALL"})});c(Y)},Ve=()=>{const Y=He(l,Ce=>{Ce.conditions.push({})});c(Y)},Ne=Y=>{const Ce=He(l,et=>{et.conditions.splice(Y,1)});c(Ce)};a.useEffect(()=>{d&&O(g)},[g]),a.useEffect(()=>{if(D||L){const Y=Me.getVariablesFromFormula(D||L);K(Y)}},[D,L]);const Ue=a.useMemo(()=>{if(!A)return!0;const Y=Ie=>!Ie.operation||!Ie.attribute?!0:Ie.value===""||Number.isNaN(+`${Ie.value}`),Ce=Ie=>Ie.some(dt=>Oa(dt.conditions)?Ce(dt.conditions):Y(dt));return Ce(l.conditions)},[A,l.conditions]);return e.jsx(fe,{style:{top:100},mask:!1,open:o,title:"",width:"700px",footer:null,onCancel:()=>{O(""),i(!1),u(!1),v||c({conditions:[{}],match:"ALL"}),Pe(!1),N(Ee.FILTER),be({}),G(""),M()},className:"[&_.ant-select]:!h-10 [&_.ant-input]:!h-10 [&>.ant-modal-content]:rounded-2xl",children:f?e.jsx(Re,{active:!0,loading:!0}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xl font-bold",children:T?`${g} trigger`:d?`Editing ${y?"column":"criteria"}`:`Create new ${y?"column":"criteria"}`}),!T&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-md mt-4 mb-1",children:[y?"Column":"Criteria"," name"]}),e.jsx(De,{placeholder:`Enter ${y?"column":"criteria"} name`,value:A,onChange:Y=>O(Y.target.value)})]}),!T&&!y&&s&&e.jsxs("div",{children:[e.jsx("div",{className:"text-md mt-4 mb-1",children:"Criteria type"}),e.jsxs(re,{type:"select",onChange:Y=>N(Y),value:B,placeholder:"Criteria type",children:[e.jsx(mt,{value:0,children:"Filter"}),e.jsx(mt,{value:1,children:"Cashflow"}),e.jsx(mt,{value:2,children:"Report"})]}),B===Ee.FILTER&&e.jsxs(re,{type:"select",style:{width:200,marginTop:20,marginLeft:20,display:"inline-block"},onChange:Y=>c({...l,filterName:Y}),value:l.filterName,placeholder:"Filter type",children:[e.jsx(mt,{value:"exclusionFilter",children:"Exclusions"}),e.jsx(mt,{value:"ineligibleFilter",children:"Ineligibles"}),e.jsx(mt,{value:"reserveFilter",children:"Reserves"})]}),B===Ee.FILTER&&e.jsx(Te,{style:{display:"inline-block",width:200,marginLeft:20},placeholder:"Filter template",items:J,nameKey:"templateName",selectedValue:W,onSelect:Y=>Q(Y)}),B===Ee.REPORT&&e.jsx(Te,{style:{display:"inline-block",width:200,marginLeft:20},placeholder:"Report template",items:me,nameKey:"templateName",selectedValue:z,onSelect:Y=>oe(Y)})]}),!T&&!y&&B===Ee.FILTER&&!s&&e.jsxs("div",{children:[e.jsx("div",{className:"text-md mt-4 mb-1",children:"Criteria type"}),e.jsx(re,{type:"select",onChange:Y=>c({...l,filterName:Y}),value:l.filterName,placeholder:"Filter type",children:e.jsx(mt,{value:"exclusionFilter",children:"Exclusions"})})]}),(!s||s&&(B===Ee.FILTER||B===Ee.REPORT))&&e.jsxs(e.Fragment,{children:[e.jsx(Be,{}),e.jsx("div",{className:"text-lg font-bold",children:"Conditions"}),e.jsx(ha,{isTemplateBuilder:y,assetType:n,operations:h,rootConditionGroup:l,conditionGroup:l,setConditionGroup:c,rootGroup:l,addCriteria:Ve,removeCriteria:Ne,addGroup:Fe,questionnaires:r,indexList:[],onChangeCondition:de,onChangeMatchType:Y=>{c({...l,match:Y})},calculationName:A,isTrigger:T}),e.jsx("div",{className:"mt-5 text-right mr-2",children:kt(l)})]}),B===Ee.CASHFLOW&&e.jsxs("center",{children:[e.jsx(re,{style:{width:200,marginTop:10},onChange:Y=>be({...k,groupName:Y.target.value}),value:k.groupName,placeholder:"Group name"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(Ze,{checked:Se,onChange:Y=>Pe(Y.target.checked),children:"Send to the investors"})}),!Se&&e.jsx(re,{placeholder:"Beneficiary",type:"select",style:{width:200,marginTop:10},autocomplete:!1,onSearch:Y=>ie(Y),onSelect:Y=>{be({...k,beneficiaryCompanyId:Y})},value:k.beneficiaryCompanyId,filterOption:!1,children:H.map(Y=>e.jsx(mt,{value:Y.id,children:Y.companyLegalName},Y.id))})]}),(y||B===Ee.CASHFLOW&&!Se||B===Ee.REPORT)&&e.jsx(Tr,{assetType:n,formula:D||L,setFormula:_||G,currentVariables:q}),T&&e.jsx(kr,{actionData:$,setActionData:ee}),e.jsxs("div",{className:"flex mt-5 text-right items-center justify-between gap-2 mt-2",children:[d&&!T&&!v&&!j&&e.jsx(qt,{onConfirm:async()=>{R(!0),await te.deleteAssetFilter(C,l.id),Le.success("Delete criteria successfully"),S(),R(!1),i(!1)},title:"Are you sure？",okText:"Yes",cancelText:"No",children:e.jsx(U,{type:"danger",className:"flex-1 h-10 bg-gray-300",loading:b,children:"Remove"})}),e.jsx(U,{type:"primary",className:"flex-1 h-10",disabled:Ue,loading:P,onClick:async()=>{if(V(!0),console.log("generalPurpose, criteriaType",s,B),!s||B===Ee.FILTER)await p({id:l.id,name:A,poolFilterName:l.filterName,[T?"triggerConditions":"poolFilterConditions"]:Tt(l),[T?"triggerDisplayFomula":"displayFormula"]:kt(l),[T?"triggerConditionArr":"poolFilterConditionArr"]:l,templateId:C,filterTemplateId:W,poolId:t?t.id:null,actionData:$},Ee.FILTER),y?Le.success(`${d?"Update":"Create new"} column successfully`):Le.success(`${d?"Update":"Create new"} clause successfully`);else if(B===Ee.CASHFLOW){const Y=[...t.cashFlow];Y.includes(k.groupName)||Y.push(k.groupName);const Ce=await te.createUpdateCashflow({id:k.id,beneficiaryCompanyId:Se?null:k.beneficiaryCompanyId,cashFlow:Y,name:A,groupName:k.groupName,calculationFormula:Se?"EMPTY_FORMULA":L,poolId:t?t.id:null,assetType:t.assetType,actionData:$});await p(null,Ee.CASHFLOW,Ce),Le.success(`${d?"Update":"Create new"} clause successfully`)}else B===Ee.REPORT&&(await p({id:l.id,name:A,poolFilterName:l.filterName,poolFilterConditions:Tt(l),displayFormula:kt(l),poolFilterConditionArr:l,templateId:C,reportTemplateId:z,reportContent:{calculationFormula:L,conditions:Tt(l),poolFilterConditions:Tt(l),displayFormula:kt(l),poolFilterConditionArr:l},poolId:t?t.id:null,calculationFormula:Se?"EMPTY_FORMULA":L,actionData:$},Ee.REPORT),Le.success(`${d?"Update":"Create new"} clause successfully`));V(!1),i(!1),S()},children:"Save"})]})]})})};function Tt(t){let s={};const n=t.match==="ALL"?"AND":"OR";return t.conditions.map(r=>{if(r.match)s={...s,[`$${r.match==="ALL"?"and":"or"}`]:[{...Tt(r)}]};else{const o={[Er[r.operation]]:isNaN(r.value)?r.value:parseFloat(r.value)};s={...s,[r.attribute]:o}}}),{[`$${n==="AND"?"and":"or"}`]:Object.keys(s).map(r=>({[r]:s[r]}))}}function kt(t){let s="";const n=t.match==="ALL"?" AND ":" OR ";return t.conditions.map(r=>{r.match?s+=` (${kt(r)})${n}`:s+=""+Mr(r.operation,r.attribute,r.value)+n}),s.substr(s.length-5)===" AND "?s=s.slice(0,-5):s.substr(s.length-4)===" OR "&&(s=s.slice(0,-4)),s}function Mr(t,s="",n=""){let r="";switch(isNaN(n)&&(n=`"${n}"`),console.log(t),t){case"equals":r=`${s} = "${n}"`;break;case"not equals":r=`${s} ≠ "${n}"`;break;case"greater than or equals":r=`${s} ≥ "${n}"`;break;case"greater than":r=`${s} > "${n}"`;break;case"less than":r=`${s} < "${n}"`;break;case"less than or equals":r=`${s} ≤ "${n}"`;break;case"contains":r=`Contains(${s}, "${n}")`;break;case"does not contains":r=`NotContains(${s}, "${n}")`;break}return r}const Pr=()=>{const{message:t}=Ae.useApp(),{pool:s}=ce(),{isIssuer:n}=Je(m=>m),[r,o,i]=qe(te.getPoolFilterTemplates,s.id),l=a.useMemo(()=>Ye(r)?null:r.find(({isMain:m})=>m===1),[r]),c=a.useCallback(async()=>{const m=await te.createUpdateFilterTemplate({name:`${s.name} - filter`,isMain:!0,poolId:s.id,assetType:s.assetType});return await i(),m},[s.assetType,s.id,s.name,i]),[d,u]=a.useState(!1),[p,h]=a.useState({conditions:[{}],match:"ALL",name:""}),[g,v]=a.useState(!1),[f,j]=a.useState({}),M=a.useCallback(async m=>{await te.createUpdateAssetFilter(l==null?void 0:l.id,m.poolFilterName,m),i()},[i,l==null?void 0:l.id]),y=a.useCallback(async m=>{await te.deleteAssetFilter(l==null?void 0:l.id,m),i()},[i,l==null?void 0:l.id]),C=a.useMemo(()=>(l==null?void 0:l.exclusionFilter)||[],[l==null?void 0:l.exclusionFilter]),S=m=>{h({...m.poolFilterConditionArr,name:m.name,id:m.id}),v(!0),u(!0)},E=a.useRef(!1);return a.useEffect(()=>{!o&&!(l!=null&&l.id)&&E.current===!1&&(E.current=!0,c())},[c,o,l==null?void 0:l.id]),e.jsxs(e.Fragment,{children:[o&&e.jsx(Re,{}),!o&&e.jsxs(Xe,{className:"bg-gray-50",title:"Excluded collaterals",extra:n?e.jsx(U,{className:"bg-gray-200",onClick:()=>{u(!0),h({conditions:[{}],match:"ALL",name:"",filterName:"exclusionFilter"})},children:"Add criteria"}):null,children:[!o&&!(l!=null&&l.id)&&E.current===!0&&e.jsx("p",{children:"Filter not found!"}),!o&&(l==null?void 0:l.id)&&e.jsxs(e.Fragment,{children:[Ye(C)&&e.jsx("p",{children:"No condition found!"}),!Ye(C)&&C.map((m,x)=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-200 p-2 rounded-lg px-3 mb-2",children:[e.jsx("div",{className:"font-bold",children:`${x+1}. ${m.name}`}),e.jsx("div",{className:"flex gap-2",children:n&&e.jsxs(e.Fragment,{children:[e.jsx(U,{type:"link",className:"text-green-500 px-1",onClick:()=>S(m),children:"Edit"}),e.jsx(qt,{onConfirm:async()=>{j({...f,[m.id]:!0}),await y(m.id),j({...f,[m.id]:!0}),t.success("Delete criteria successfully")},title:"Are you sure？",okText:"Yes",cancelText:"No",children:e.jsx(U,{type:"link",className:"text-red-500 px-1",children:f[m.id]?e.jsx(Jt,{size:"small"}):"Remove"})})]})})]},x))]})]}),d&&e.jsx(Lr,{assetType:s.assetType,conditionGroup:p,setConditionGroup:h,isBlockConditionVisible:d,setBlockConditionVisible:m=>{u(m),!m&&v(!1)},reloadReportTemplate:i,onSaveAssetFilter:M,isEditting:g,setEditting:v,criteriaName:p.name,templateId:l==null?void 0:l.id,currencyShortCode:Z("pool","currency.shortCode")})]})},Fr=({scorecards:t,isLoading:s})=>{var o;console.log(t);const n=((o=t==null?void 0:t[0])==null?void 0:o.discountRate)??void 0,r=a.useMemo(()=>[{title:"Date",width:120,dataIndex:"updatedAt",render:i=>ke(i).format("DD/MM/YYYY")},{title:"Risk score",dataIndex:"name",width:"120px"},{title:"Days past due",dataIndex:"daysPastDue",render:(i,l,c)=>c===t.length-1?`>=${i}`:`${i} - <${t[c+1].daysPastDue}`},{title:"Advance rate (%)",dataIndex:"advanceRate",align:"right"},{title:"Interest rate (%)",dataIndex:"interestRate",align:"right"},{title:"Probability of default (%)",dataIndex:"probabilityOfDefault",align:"right"},{title:"Loss given default (%)",dataIndex:"lossGivenDefault",align:"right"}].filter(Boolean),[t]);return e.jsxs("div",{className:"flex flex-col items-stretch",children:[e.jsxs(ge,{className:"flex items-center gap-2",children:[e.jsx("div",{className:"font-semibold",children:"Discount rate"}),e.jsx(Oe,{autoComplete:"off",placeholder:"Discount rate",precision:2,suffix:"%",min:0,size:"middle",readOnly:!0,value:n})]}),e.jsx(ot,{scroll:{x:1100},pagination:!1,loading:s,dataSource:t.map(i=>({...i,key:i.name})),columns:r})]})},Or=()=>{const{pool:t}=ce(),[s,n]=a.useState(!1),[r,o]=a.useState([]);return a.useEffect(()=>{const i=async()=>{n(!0);try{const l=await $t.getScorecards(t.id);l&&o(l.map(c=>(delete c.children,{...c,isNewest:!0})))}catch(l){console.error(l)}n(!1)};t.id&&i()},[t.id]),e.jsx("div",{className:"z-10",children:e.jsx(Fr,{scorecards:r,isLoading:s})})},Rr=[{name:"Assets",key:"assets"}];function Vr(){const{isLoadingNote:t,setRiskScorecardModalVisible:s,setAddAssetVisible:n}=ce(),r=ys(),[o]=a.useState(!1),{isPoolAdmin:i}=Je(p=>p),l=gt(),c=ws.parse(r.search),d=["assets","risk_score","filter"].includes(c.tab)&&c.tab||"assets",u=async()=>{n(!0)};return e.jsx(At,{defaultActiveKey:["manage_assets"],children:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex mb-4 justify-between",children:[e.jsx("div",{className:"flex gap-2 items-center",children:Rr.map(p=>e.jsx(U,{className:`${d===p.key&&"bg-green-500"||"bg-gray-200"} !rounded-lg text-xs`,onClick:()=>{l(r.pathname+`?tab=${p.key}`)},children:p.name},p.key))}),d==="risk_score"&&i&&e.jsx(U,{onClick:()=>{s(!0)},children:"Edit"}),d==="assets"&&e.jsx(U,{loading:o,onClick:u,disabled:!1,children:"Add Asset"})]}),!t&&d==="assets"&&e.jsx(Ir,{}),!t&&d==="filter"&&e.jsx(Pr,{}),d==="risk_score"&&e.jsx(Or,{})]})})}const ga=({visible:t,onClose:s,documentId:n,reloadDocument:r,onSignCallback:o})=>{const{message:i}=Ae.useApp(),[l,c]=a.useState(null),[d,u]=a.useState(""),[p,h]=a.useState(!1),[g,v]=a.useState({signAsPersonal:!1,signAsBusiness:!1}),{user:f}=Je(y=>y);a.useEffect(()=>{setTimeout(()=>{if(document.getElementById("signature-pad")&&!l){const y=new Kn(document.getElementById("signature-pad"),{backgroundColor:"rgba(255, 255, 255, 0)",penColor:"rgb(0, 0, 0)"});c(y)}},500)},[t]);const j=a.useCallback(async()=>{if(l&&!l.isEmpty()){const y=l.toDataURL("image/png"),C=y.length-22,S=4*Math.ceil(C/3)*.5624896334383812+1,{sasUrl:E,uniqueKey:m}=await se.getUploadSignatureUrl(n,{file_name:"signature",file_size:S,file_type:"image/png"});return await ps.uploadSignature(E,y),m}},[l,n]),M=()=>{l&&l.clear(),u(""),v({signAsPersonal:!1,signAsBusiness:!1}),s()};return e.jsxs(fe,{style:{zIndex:1e3},open:t,onCancel:M,footer:null,children:[e.jsx("b",{style:{fontSize:20},children:"Sign document"}),e.jsx("center",{children:e.jsx("div",{style:{marginTop:20,width:300,height:200,border:"1px solid #e8e8e8",boxShadow:"0 1px 4px rgba(0, 0, 0, 0.27), 0 0 40px rgba(0, 0, 0, 0.08) inset"},children:e.jsx("canvas",{id:"signature-pad",className:"signature-pad",width:"300",height:"200"})})}),e.jsx("center",{children:e.jsx(De,{value:d,onChange:y=>u(y.target.value),placeholder:"Name",style:{marginTop:10,width:300}})}),e.jsx("div",{style:{marginTop:10},children:"I agree my signature above to be a valid means of signing."}),e.jsx("div",{style:{marginTop:10},children:e.jsxs(Ze,{checked:g.signAsBusiness,onChange:y=>v({...g,signAsBusiness:y.target.checked}),children:["Sign on behalf of ",f==null?void 0:f.companyName]})}),e.jsx("div",{style:{marginTop:10},children:e.jsxs(Ze,{checked:g.signAsPersonal,onChange:y=>v({...g,signAsPersonal:y.target.checked}),children:["Sign as ",f==null?void 0:f.name]})}),e.jsxs("div",{style:{marginTop:10,textAlign:"right"},children:[e.jsx(U,{onClick:()=>l&&l.clear(),children:"Clear signature"}),e.jsx(U,{style:{margin:"0 10px"},onClick:M,children:"Cancel"}),e.jsx(U,{loading:p,onClick:async()=>{h(!0);try{const y=await j();await se.insertSignatureIntoDocument(n,{signerName:d,signatureFile:{uniqueKey:y}}),h(!1),M(),i.success("Signed successfull"),r(n),setTimeout(()=>{o&&o()},2e3)}catch(y){i.error(y.message||"Signing failed")}h(!1)},disabled:!d||!g.signAsBusiness||!g.signAsPersonal,type:"primary",children:"Sign"})]})]})};ga.propTypes={visible:ne.bool,onClose:ne.func,reloadDocument:ne.func,onSignCallback:ne.func};const Cs=({visible:t,onClose:s,disableEdit:n,reloadGeneratedList:r,isSign:o,onCreateNewDocument:i,disableCreateNew:l=!1,preSelectedDocumentId:c,shouldSign:d,defaultHtmlParse:u})=>{const{message:p}=Ae.useApp(),{userId:h,companyId:g}=Je(K=>K),[v,f]=a.useState(c),[j,M]=a.useState(null),[y,C]=a.useState({}),[S,E]=a.useState(!1),[m,x]=a.useState(!1),[D,_]=a.useState(!1),[T,w]=a.useState(!1),A=a.useRef(),O=async K=>{try{_(!0);const[B,{sasUrl:N}]=await Promise.all([se.getDocumentById(K),se.getDocumentAttachment(K)]),J=await se.getDocumentContentViaURL(N);M(J),console.log("getDocumentDetail - documentDetail: ",B),C(B)}finally{_(!1)}};a.useEffect(()=>{v&&O(v)},[v]);const P=()=>{f(null),M(null)},V=Z(y,"creatorId")===h&&Z(y,"creatorCompanyId")===g,b=y.status===Ls.status.SIGNED,R=Z(y,"category")===Ls.category.LEGAL,q=async()=>{j&&(w(!0),oa(j,`${y.name}.pdf`),w(!1))};return e.jsxs(fe,{onCancel:()=>{s(),P()},footer:null,width:"100vw",open:t,style:{top:0,padding:0},children:[e.jsx(ge,{children:e.jsx(ue,{xs:{span:18,offset:3},children:e.jsxs("div",{style:{height:"calc(100vh - 70px)",width:"100%",marginTop:20},children:[!l&&!v&&i&&e.jsx(U,{onClick:()=>{i(),s()},style:{marginBottom:20,marginLeft:20},type:"primary",size:"large",children:"+ New Document"}),D&&e.jsx(Re,{active:!0,loading:!0}),!D&&v&&j&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{marginBottom:20},children:[d&&!o&&R&&e.jsx(U,{onClick:()=>x(!0),className:"mr-2",type:"primary",children:"Sign"}),j&&e.jsx(U,{style:{marginRight:10},onClick:q,loading:T,children:"Download"}),V&&e.jsxs(e.Fragment,{children:[!n&&!b&&e.jsx(U,{onClick:()=>{Ht.dispatch(Et.EDIT_MY_DOCUMENT,{documentId:v,templateId:y.templateId,questions:y.legal_template.legal_questions}),s(),P()},style:{marginRight:10},type:"primary",children:"Edit"}),!b&&e.jsx(U,{loading:S,onClick:async()=>{E(!0),await se.deleteDocument(v),E(!1),s(),P(),p.success("Delete document successfully")},type:"danger",children:"Delete"})]})]}),e.jsx("div",{ref:A,children:u?e.jsx("div",{className:"w-full bg-white overflow-y-auto",style:{maxHeight:"calc(100vh - 120px)"},id:"doc-content",children:ra(j)}):e.jsx(la,{doc:j})})]})]})})}),e.jsx(ga,{reloadDocument:O,documentId:y.id,visible:m,onClose:()=>{x(!1),s(),r()}})]})};Cs.propTypes={visible:ne.bool,onClose:ne.func,reloadGeneratedList:ne.func,poolId:ne.number,isSign:ne.bool,disableEdit:ne.bool,onCreateNewDocument:ne.func,disableCreateNew:ne.bool,preSelectedDocumentId:ne.number,viewOnly:ne.bool,defaultHtmlParse:ne.bool};const fa=({visible:t,onClose:s,documentId:n,defaultHtmlParse:r})=>{const[o,i]=a.useState(null),[l,c]=a.useState(!1),[d,u]=a.useState(!1),p=async g=>{try{c(!0);const{sasUrl:v}=await se.getSignedDocumentAttachment(g),f=await se.getDocumentContentViaURL(v);i(f)}catch(v){console.log("getDocumentDetail error",v)}finally{c(!1)}};a.useEffect(()=>{n&&p(n)},[n]);const h=async()=>{o&&(u(!0),await oa(o),u(!1))};return e.jsx(fe,{onCancel:s,footer:null,width:"100vw",open:t,style:{top:0,padding:0},children:e.jsx(ge,{children:e.jsx(ue,{xs:{span:18,offset:3},children:e.jsxs("div",{style:{height:"calc(100vh - 70px)",width:"100%",marginTop:20},children:[l&&e.jsx(Re,{active:!0,loading:!0}),!l&&o&&e.jsxs(e.Fragment,{children:[e.jsx(U,{style:{marginRight:10,marginBottom:20},onClick:h,loading:d,children:"Download"}),r?e.jsx("div",{className:"w-full bg-white overflow-y-auto",style:{maxHeight:"calc(100vh - 120px)"},id:"doc-content",children:ra(o)}):e.jsx(la,{doc:o})]})]})})})})};fa.propTypes={visible:ne.bool,onClose:ne.func,documentId:ne.string,defaultHtmlParse:ne.bool};const Ur={[_e.category.LEGAL]:"Legal document",[_e.category.GENERAL]:"General document"},Br=({pool:t={},category:s,isNeedReload:n})=>{const{setDraftingDocModalVisible:r}=ce(),{notification:o}=Ae.useApp(),{isIssuer:i,isOriginator:l}=Je(w=>w),[c,d]=a.useState({}),[u,p]=a.useState(!1),[h,g]=a.useState(null),[v,f]=a.useState(null),[j,M]=a.useState({}),{loading:y,value:C=[],retry:S}=ia(async()=>{if(!t.id||!n)return;const w=await se.getLegalVaultList(t.id,s);return(await se.getDocumentsMetadata(w.map(O=>O.id))).forEach(({id:O,numberOfSignedDocuments:P})=>{const V=w.find(b=>b.id===O);V&&(V.numberOfSignedDocuments=P)}),w},[t.id,s,n]),E=(w,A)=>{M(O=>({...O,[w]:{...O[w]??{},...A}}))},m=async w=>{try{d({...c,[w]:!0}),await se.deleteDoc(w),S(),o.success({description:"Document has been deleted!"})}catch(A){A!=null&&A.message&&o.error({description:A==null?void 0:A.message})}finally{d({...c,[w]:!1})}},x=w=>{g({documentId:w.id,isSign:w.isSign}),p(!0)},D=w=>{f(w)},_=async(w,A)=>{if(w)try{E(A.id,{loading:!0});const O=await se.getAllInvestorsSignedDocumentsByPool(A.id,A.poolId);E(A.id,{data:O})}catch{o.error({description:"Failed to load signed documents"})}finally{E(A.id,{loading:!1})}},T=[{title:"Document name",dataIndex:"name",width:150,key:"name"},{title:"Category",dataIndex:"category",width:100,key:"category",render(w,A){return Ur[Z(A,"category")]}},{title:"Date created",dataIndex:"createdAt",width:100,key:"createdAt",render:w=>ke(w).format("DD/MM/YYYY")},{title:"Date updated",dataIndex:"updatedAt",width:100,key:"updatedAt",render:w=>ke(w).format("DD/MM/YYYY")},{title:"Action",width:100,render:(w,A)=>e.jsxs("div",{children:[e.jsx(it,{placement:"top",title:"View detail",children:e.jsx(U,{type:"text",icon:e.jsx(Ua,{}),onClick:()=>x(A)})}),i&&A.numberOfSignedDocuments===0&&e.jsx(it,{placement:"top",title:"Delete document",children:e.jsx(qt,{onConfirm:()=>m(A.id),title:"Are you sure？",okText:"Yes",cancelText:"No",children:c[A.id]?e.jsx(Jt,{size:"small"}):e.jsx(U,{type:"text",icon:e.jsx(qs,{style:{color:"red"}})})})})]})},{title:"Publish",dataIndex:"isPublish",key:"isPublish",width:100,render:(w,A)=>e.jsx(Ze,{checked:w,disabled:l,onChange:async()=>{try{await se.publishDocs(A.id,!w),S(),o.success({description:"Publish status has been updated"})}catch(O){console.log({err:O}),O!=null&&O.message&&o.error({description:O==null?void 0:O.message})}}})}];return e.jsxs("div",{children:[e.jsx(ot,{loading:y,dataSource:C,columns:T,rowKey:w=>w.id,expandable:{onExpand:_,expandIcon:({expanded:w,onExpand:A,record:O})=>O.numberOfSignedDocuments===0||O.category===_e.category.GENERAL?null:w?e.jsx(Ra,{onClick:P=>A(O,P)}):e.jsx(Va,{onClick:P=>A(O,P)}),expandedRowRender:w=>{if(!j[w.id])return null;const{loading:A,data:O}=j[w.id];return e.jsx(_r,{loading:A,data:O,onClick:P=>{D(P.id)}})}},pagination:!1}),u&&e.jsx(Cs,{defaultHtmlParse:!0,poolId:t.id,visible:u,onClose:()=>{p(!1)},reloadGeneratedList:S,preSelectedDocumentId:h==null?void 0:h.documentId,isSign:h==null?void 0:h.isSign,investorSigned:h==null?void 0:h.investorSigned,disableCreateNew:!0,shouldSign:!0,onCreateNewDocument:()=>r(!0)}),v&&e.jsx(fa,{defaultHtmlParse:!0,visible:!0,onClose:()=>f(null),documentId:v})]})},_r=({onClick:t,loading:s,data:n})=>{const r=[{title:"Date",dataIndex:"updatedAt",key:"updatedAt",render:o=>ke(o).format("DD/MM/YYYY HH:mm:ss")},{title:"Name",dataIndex:"name",key:"name"},{title:"Status",dataIndex:"signatureAttached",key:"signatureAttached",render:()=>"Signed"}];return e.jsx(ot,{loading:s,columns:r.concat([{render:(o,i)=>e.jsx(U,{type:"link",onClick:()=>t(i),children:"View detail"})}]),dataSource:n??[],rowKey:o=>o.id})},$r=()=>{const{pool:t}=ce();return e.jsx(Br,{pool:t,isNeedReload:!0})},Wr=({setResult:t})=>{const[s,n]=a.useState(!1),r=o=>{const i=o.target.files[0],l=new FileReader;i&&(n(!0),l.onload=async function(c){const d=c.target.result,u={type:"document",mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"},p=await se.getPresignedURL(u),{key:h,url:g}=p;await se.uploadFileByPresignedUrl(g,d);const{url:v}=await se.getPrivateUrlFromUploadedFile({key:h}),{url:f}=await se.getConvertedFileByPrivateUrl({url:v}),j=await se.getHtmlPageFromDownloadablePrivateUrl(f);j&&t(j),n(!1)},l.readAsArrayBuffer(i))};return e.jsxs("div",{className:"relative mb-4",children:[e.jsx(De,{id:"convert-doc",type:"file",onChange:r,accept:".docx",className:"!hidden",disabled:s}),e.jsx("label",{htmlFor:"convert-doc",children:e.jsxs("span",{className:"rounded-lg py-2 px-3 inline-block border border-solid border-gray-200 cursor-pointer hover:border-green-300",children:[s?e.jsx(Jt,{indicator:e.jsx(Ba,{style:{fontSize:16,marginRight:"4px"},spin:!0})}):e.jsx(Js,{className:"mr-1 text-lg"}),"Import docx"]})})]})},Gr=({templateDetails:t,setTemplateDetails:s})=>e.jsx(Xe,{children:e.jsxs(F,{wrapperCol:{span:24},labelCol:{span:24},children:[e.jsx(F.Item,{label:"Name",className:"mb-4",children:e.jsx(De,{placeholder:"Name",id:"name",value:t.name,onChange:n=>s({...t,name:n.target.value})})}),e.jsx(F.Item,{label:"Version",className:"mb-4",children:e.jsx(De,{placeholder:"Version",id:"version",value:t.version,onChange:n=>s({...t,version:n.target.value})})}),e.jsx(F.Item,{label:"Description",className:"mb-4",children:e.jsx(De,{placeholder:"Description",id:"desc",value:t.desc,onChange:n=>s({...t,desc:n.target.value})})}),e.jsx(F.Item,{label:"Category",className:"mb-4",children:e.jsx(at,{placeholder:"Category",id:"category",value:t.category,onChange:n=>s({...t,category:n}),options:[{value:_e.category.LEGAL,label:e.jsx("span",{children:"Legal template"})},{value:_e.category.GENERAL,label:e.jsx("span",{children:"General template"})}]})}),e.jsx(F.Item,{label:"Draft",className:"mb-4",children:e.jsx(Ze,{checked:t.isDraft,onChange:n=>s({...t,isDraft:n.target.checked}),children:"Indicates draft version of template. No valid legal documents will be created from it if checked."})}),e.jsx(F.Item,{label:"Private",className:"mb-4",children:e.jsx(Ze,{checked:t.isPrivate,defaultChecked:t.isPrivate,onChange:n=>s({...t,isPrivate:n.target.checked}),children:"Will not be seen by anyone else on the profile."})})]})}),Bt=vs.input`
  border: 0;
  background-image: linear-gradient(#009688, #009688), linear-gradient(#d2d2d2, #d2d2d2);
  background-size:
    0 2px,
    100% 1.5px;
  font-size: 15px;
  background-repeat: no-repeat;
  background-position:
    center bottom,
    center calc(100% - 1px);
  background-color: rgba(0, 0, 0, 0);
  transition: background 0s ease-out;
  padding: 0;
  float: none;
  box-shadow: none;
  border-radius: 0;
  display: block;
  width: 100%;
  height: 34px;
  line-height: 1.42857;
  color: #555555;
  outline: none;

  ::placeholder {
    color: #a9a9a9;
  }

  &:focus {
    outline: none;
    background-image: linear-gradient(#009688, #009688), linear-gradient(#d2d2d2, #d2d2d2);
    background-size:
      100% 2px,
      100% 1px;
    box-shadow: none;
    transition-duration: 0.3s;
    padding: 0;
    float: none;
    border: 0;
    border-radius: 0;
  }
`,Us=vs.select`
  border: 0;
  box-shadow: none;
  border-radius: 0;
  background-image: linear-gradient(#009688, #009688), linear-gradient(#d2d2d2, #d2d2d2);
  background-size:
    0 2px,
    100% 1.5px;
  font-size: 15px;
  background-repeat: no-repeat;
  background-position:
    center bottom,
    center calc(100% - 1px);
  background-color: rgba(0, 0, 0, 0);
  transition: background 0s ease-out;
  padding: 0;
  float: none;
  display: block;
  width: 100%;
  height: 34px;
  line-height: 1.42857;
  color: #555555;
  outline: none;

  &:focus {
    outline: none;
  }
`,xa=({onChangeQuestion:t,item:s,index:n,blockConditions:r,onlyOne:o=!1})=>e.jsx("div",{style:{paddingLeft:o?0:100},children:e.jsxs(ge,{children:[!o&&e.jsx(ue,{span:3,children:e.jsx("div",{style:{paddingTop:7,textAlign:"right",fontWeight:"bold",paddingRight:20,color:"rgba(0, 0, 0, 0.84)",textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden"},children:s.variableDisplay})}),e.jsxs(ue,{span:o?24:21,children:[e.jsx(Bt,{value:s.content,onChange:i=>t(n,"content",i.target.value),placeholder:"Type related question"}),e.jsx(Bt,{value:s.hint,onChange:i=>t(n,"hint",i.target.value),placeholder:"Type question hint"}),s.answerType==="select"&&e.jsx(Bt,{value:s.options?s.options.selections:"",onChange:i=>t(n,"options.selections",i.target.value),placeholder:"Type options separated by ;"}),e.jsxs(ge,{gutter:32,children:[e.jsx(ue,{span:8,children:e.jsxs(Us,{value:s.answerType,onChange:i=>t(n,"answerType",i.target.value),children:[e.jsx("option",{value:"text",children:"Text"}),e.jsx("option",{value:"currency",children:"Currency"}),e.jsx("option",{value:"number",children:"Number"}),e.jsx("option",{value:"date",children:"Date"}),e.jsx("option",{value:"select",children:"Select"})]})}),e.jsx(ue,{span:16,children:e.jsx(Bt,{value:s.defaultValue,onChange:i=>t(n,"defaultValue",i.target.value),placeholder:"Insert a default value"})})]}),e.jsx(ge,{style:{marginTop:10},children:e.jsx(Ze,{checked:s.isRequired,onChange:i=>t(n,"isRequired",i.target.checked),children:"Required field"})}),e.jsx(ge,{style:{marginTop:10},children:e.jsxs(Us,{style:{width:300},value:s.showCondition,onChange:i=>{t(n,"showOnlyWithBlockId",i.target.value),t(n,"showCondition",i.target.value)},children:[e.jsx("option",{value:null,children:"Always displayed"}),e.jsx("optgroup",{label:"-- Visibility conditions --"}),Object.keys(r||[]).map(i=>{if(i&&r[i])return e.jsx("option",{value:r[i].blockKey,children:r[i].displayFormula},r[i])})]})})]})]})}),Yr=({isQuestionDrawerVisible:t,selectedWord:s,onClose:n,blockConditions:r,onSave:o=()=>{}})=>{const[i,l]=a.useState([]),[c,d]=a.useState(null),[u,p]=a.useState(!1),[h,g]=a.useState([]),{text:v,id:f}=s??{};a.useEffect(()=>{let y=!0;return(async()=>{try{const{data:C}=await te.getPoolQuestionKey();y&&g(C)}catch(C){console.error(C)}})(),()=>{y=!1}},[]);const j=()=>{c&&(o({fieldId:c,selectedWord:s}),n())},M=()=>{Ht.dispatch(Et.EDITOR_CANCEL_MARK_WORD),n()};return e.jsxs(_a,{maskClosable:!1,closeIcon:!1,open:!!t,title:u?"Questionnaire setting":"Variable mapping",placement:"right",width:400,onClose:n,children:[e.jsx(zs,{style:{marginBottom:10},checked:u,onChange:async y=>{p(y)},checkedChildren:"Custom value",unCheckedChildren:"Mapping fields"}),e.jsx("div",{style:{margin:"20px 0 10px 0"},children:v}),u?e.jsx(xa,{onlyOne:!0,onChangeQuestion:(y,C,S)=>{const E=He(i,m=>{C==="options.selections"?m[y].options={...m[y].options||{},selections:S}:m[y][C]=S});l(E)},item:i[0],index:0,blockConditions:r}):e.jsx(Te,{style:{width:220},placeholder:"Variable mapping",items:h,nameKey:"name",selectedValue:c,onSelect:y=>{d(y)}}),e.jsxs("div",{style:{marginTop:20,textAlign:"right"},children:[e.jsx(U,{onClick:M,children:"Cancel"}),e.jsx(U,{onClick:j,style:{marginLeft:10},type:"primary",children:"Save"})]})]})},Kr=vs.div`
  background-color: white;
  margin: 1px 0 10px;
  padding: 8px;
  border-radius: 3px;
  border: 1px solid #ddd;
  height: 230px;
`,Hr=(t,s,n)=>{const r=Array.from(t),[o]=r.splice(s,1);return r.splice(n,0,o),r},qr=({questionnaires:t,setQuestionnaires:s,blockConditions:n,isLegalDocument:r,answers:o,setAnswers:i=()=>{}})=>{const l=d=>{if(!d.destination)return;const u=Hr(t,d.source.index,d.destination.index),p=He(u,h=>{h.forEach((g,v)=>g.variableOrder=v)});s(p)},c=async(d,u,p)=>{const h=He(t,f=>{u==="options.selections"?f[d].options={...f[d].options||{},selections:p}:f[d][u]=p}),g=t[d]||{id:null},v=He(o,f=>{f[g.id]={...f[g.id]||{},value:p}});s(h),i(v)};return e.jsx(Ln,{onDragEnd:l,children:e.jsx(Mn,{droppableId:"droppable",children:(d,u)=>e.jsxs("div",{...d.droppableProps,ref:d.innerRef,children:[t.map((p,h)=>{if(!Me.checkIsMappingValue(p.defaultValue)){if(p.showOnlyWithBlockId&&!p.showCondition){const g=Object.keys(n).find(v=>n[v].id===p.showOnlyWithBlockId);g&&c(h,"showCondition",n[g].blockKey)}return e.jsx(Pn,{draggableId:p.questionId||`${p.id}`,index:h,children:(g,v)=>e.jsxs(Kr,{ref:g.innerRef,...g.draggableProps,children:[e.jsx(Fn,{className:"m-3 float-left",...g.dragHandleProps}),e.jsx(xa,{blockConditions:n,onChangeQuestion:c,item:p,index:h})]})},p.questionId||`${p.id}`)}}),d.placeholder]})})})},os="data-fieldid",Jr=({pool:t,templateId:s,shouldCreateNewTemplate:n,answers:r,setShouldCreateNewTemplate:o=()=>{},closeModal:i=()=>{},reloadTemplates:l=()=>{},setTemplateId:c=()=>{},setAnswers:d=()=>{},onGenerateDocument:u=p=>{}})=>{const{message:p}=Ae.useApp(),[h,g]=a.useState(!1),[v,f]=a.useState(null),[j,M]=a.useState(!1),[y,C]=a.useState(!1),[S,E]=a.useState({category:_e.category.LEGAL}),[m,x]=a.useState([]),[D,_]=a.useState([]),[T,w]=a.useState([]),[A,O]=a.useState(null),[P,V]=a.useState({}),[b,R]=a.useState(!1),[q,K]=a.useState({}),B=L=>{const G=[];for(let $=0;$<L.length;$++){const ee=L[$],ae=ee.getAttribute("id"),ie=ee.getAttribute(os),H=ee.textContent;G.push({questionId:`_${Math.floor(Math.random()*1e12)}`,variableId:ae,variableOrder:$,variableDisplay:H,variableNumber:1,defaultValue:ie})}return G},N=()=>{if(!A)return[];const{markers:L}=J();return B(L)},J=()=>{const G=(A==null?void 0:A.getData()).replaceAll("<p>&nbsp;</p>",""),$=new DOMParser().parseFromString(G,"text/html"),ee=$.querySelectorAll("mark[id]");for(const ie of ee){const H=q[ie.id];H&&ie.setAttribute(os,H.fieldId)}return{content:$.body.innerHTML,markers:ee}},le=async L=>{g(!0);try{const G=await se.getTemplateDetailV1(L),[$]=await Promise.allSettled([se.getBlocks(L)]);await me(L);const ee=$.status=="fulfilled"?$.value:[];if(G.documentFile.uniqueKey){const ae={};try{const ie=await se.getDocumentContentURL(L);await ye(ie.sasUrl),ee.map(H=>{ae[H.blockKey]={...H.content,id:H.id}})}catch(ie){console.log("err on set data",ie)}_(ae)}E(G),g(!1)}catch(G){console.log("err: ",G)}},me=async L=>{const G=await se.getQuestionList(L);x(G)},ye=async L=>{const G=await se.getDocumentContentViaURL(L);f(G)},W=async()=>{try{C(!0),await u(S)}finally{C(!1)}},Q=async(L="")=>{if(!A)return;const{content:G}=J();let $="",ee="";if(G){if(L){const{sasUrl:ae}=await se.getUploadTemplateFileUrl(s);$=ae,ee=L}else{const{sasUrl:ae,uniqueKey:ie}=await ps.getFileUploadUrl("legal-template","legal-template",G.length,"text/html");$=ae,ee=ie}return await ps.upload($,G),ee}return""},z=L=>{const G=[];if(Object.keys(D).forEach($=>{D[$]&&D[$].blockKey&&G.push({id:D[$].id,showIfNotAnswer:D[$].showIfNotAnswer,blockKey:D[$].blockKey,content:D[$],formula:D[$].formula,displayFormula:D[$].displayFormula})}),L&&typeof L.content=="string"){const $={showIfNotAnswer:L.showIfNotAnswer,blockKey:L.blockKey,content:L,formula:L.formula,displayFormula:L.displayFormula,clauseId:L.clauseId};G.push($),_({...D,[L.blockKey]:$})}return G},oe=async L=>{const G=await se.getBlocks(L),$={};return G.map(ee=>{$[ee.blockKey]={...ee.content,id:ee.id}}),_($),$},k=async(L="")=>{if(!L||!A)return;const G=await oe(L),$=N();await se.postQuestions({templateId:L,questions:$.map((ee,ae)=>{let ie=null;return ee.showCondition&&G[ee.showCondition]&&(ie=G[ee.showCondition].id),{...ee,showOnlyWithBlockId:ie}})})},be=async(L=[],G=[])=>{const $=await Q(),ee=await se.createNewTemplate({...S,vaultId:t?t.id:null,category:S.category||0,documentFile:{uniqueKey:$},legalClauseIds:G});await se.postNewBlocks({templateId:ee.id,blocks:L.map(ae=>({...ae,id:void 0}))}),await k(ee.id),c(ee.id),p.success("Create new template successfully"),o(!1),i(),E({category:_e.category.LEGAL}),t||history.push("/legal-documents")},$e=async(L=[])=>{const G=z(L),{content:$}=J(),ee=$.match(/clause-id\\="(\d+)"/g)||[],ae={...S.legalClauseIds||{}};ee.forEach(H=>{const je=H.match(/\d+/)[0];ae[je]||(ae[je]=+je)});let ie=mn.get(S,"documentFile.uniqueKey","");ie=await Q(ie),await se.updateTemplate(S.id,{...S,poolId:t?t.id:null,documentFile:{uniqueKey:ie},legalClauseIds:ae}),await Promise.all([se.postNewBlocks({templateId:s,blocks:G}),se.deleteBlocks({templateId:s,blockIds:T})]),w([]),await k(s),await me(s),p.success("Update template successfully"),l()},Se=async(L=null)=>{const{content:G}=J();if(!G.trim()){p.error("Template content cannot be empty!");return}const $=G.match(/clause-id\\="(\d+)"/g)||[],ee={...S.legalClauseIds||{}};$.forEach(ie=>{const H=ie.match(/\d+/)[0];ee[H]||(ee[H]=+H)}),console.log("onCreateUpdateTemplate - results: ",$),M(!0);const ae=z(L);!s||n?await be(ae,ee):await $e(),M(!1)},Pe=({fieldId:L,selectedWord:G})=>{L&&K($=>({...$,[G.id]:{...G,fieldId:L}}))};return a.useEffect(()=>{if(v){const G=new DOMParser().parseFromString(v,"text/html").querySelectorAll("mark[id]");for(const $ of G){const ee=$.getAttribute(os),ae=$.getAttribute("id"),ie=$.textContent;ee&&ae&&K(H=>({...H,[ae]:{text:ie,id:ae,fieldId:ee}}))}}},[v]),a.useEffect(()=>{s&&le(s)},[s]),a.useEffect(()=>(Ht.subscribe(Et.LEGAL_EDITOR_MARK_A_WORD,({text:L,id:G})=>{const $=N();x($),V({text:L,id:G}),R(!0)}),()=>{Ht.unSubscribeEvents([Et.LEGAL_EDITOR_MARK_A_WORD,Et.LEGAL_EDITOR_REMOVE_A_MARKER])}),[A,m]),e.jsxs(e.Fragment,{children:[h?e.jsx(Re,{loading:!0,active:!0}):e.jsxs("div",{className:"relative mt-2",children:[e.jsx(Ks,{animated:{tabPane:!1,inkBar:!0},defaultActiveKey:"Overview",items:[{key:"Overview",label:"Overview",children:e.jsx(Gr,{templateDetails:S,setTemplateDetails:E})},{key:"Template",label:"Template",style:{height:500},forceRender:!0,children:e.jsxs("div",{className:"h-full",children:[e.jsx(Wr,{setResult:f}),e.jsx(On,{setEditorState:O,content:v})]})},{key:"questionnaires",label:"Questionnaires",style:{height:500},children:e.jsx("div",{className:"h-full",children:e.jsx(qr,{questionnaires:m,setQuestionnaires:x,answers:r,setAnswers:d})})}],className:"font-semibold h-full"}),e.jsxs(ge,{className:"absolute top-1 right-0",children:[e.jsxs(U,{className:"mr-2",loading:j,disabled:!S.name||!S.version,onClick:Se,size:"large",type:"primary",children:[e.jsx($a,{})," Save template"]}),!n&&e.jsx(U,{loading:y,onClick:W,size:"large",type:"dashed",children:"Generate document"})]})]}),b&&e.jsx(Yr,{isQuestionDrawerVisible:b,blockConditions:D,selectedWord:P,onClose:()=>R(!1),onSave:Pe})]})},zr={[_e.category.LEGAL]:"Legal template",[_e.category.GENERAL]:"General template"},Qr=({pool:t,reloadPool:s})=>{const{isSuperAdmin:n,isIssuer:r}=Je(T=>T),[o,i,l]=qe(se.getVaultTemplateList,t?t.id:null),[c,d]=a.useState({}),[u,p]=a.useState(!1),[h,g]=a.useState(null),[v,f]=a.useState(!1),[j,M]=a.useState(null),[y,C]=a.useState({}),[S,E]=a.useState(new Set),m=()=>{p(!1),g(null),l()},x=async T=>{E(w=>new Set(w).add(T.id));try{let w=j;if(!w){const O=await se.createNewDocument({id:j,vaultId:t==null?void 0:t.id,templateId:T.id,name:T.name});M(O.id),w=O.id}const A=[];Object.keys(y).map(O=>A.push({questionId:O,value:y[O].value,id:y[O].id})),await se.createAnswers({documentId:w,answers:A}),Le.success("Generated document successfully"),m()}catch(w){console.log(w),Le.error("Please check your anwsers again")}finally{E(w=>(w.delete(T.id),new Set(w)))}},D=async T=>{try{d({...c,[T]:!0}),await se.deleteTemplate(T),l(),Le.success("Delete template successfully")}catch(w){console.log(w),Le.error("Something wrong! Cannot delete template")}finally{d({...c,[T]:!1})}},_=[{title:"Template title",dataIndex:"name",key:"name"},{title:"Category",dataIndex:"category",key:"category",render(T){return zr[T]}},{title:"Date updated",dataIndex:"updatedAt",key:"updatedAt",render:T=>ke(T).format("DD/MM/YYYY")},{title:"Action",key:"action",render:(T,w)=>{const A=n||r;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(it,{placement:"top",title:"Edit document",children:e.jsx(U,{type:"text",icon:e.jsx(ms,{}),onClick:()=>{g(w.id),f(!1),p(!0)}})}),e.jsx(it,{placement:"top",title:"Generate document",children:e.jsx(U,{type:"text",icon:e.jsx(Wa,{}),loading:S.has(w.id),onClick:()=>x(w)})}),A&&e.jsx(it,{placement:"top",title:"Delete document",children:e.jsx(qt,{onConfirm:()=>D(w.id),title:"Are you sure？",okText:"Yes",cancelText:"No",children:c[w.id]?e.jsx(Jt,{size:"small"}):e.jsx(U,{type:"text",icon:e.jsx(qs,{style:{color:"red"}})})})})]})}}];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("div",{className:"absolute right-0 -top-12",children:e.jsxs(U,{className:"!bg-transparent border-solid border-[#1ED760] border-2 text-black !rounded-xl shadow-none",onClick:()=>{p(!0),f(!0)},type:"primary",children:[e.jsx(Js,{})," New Template"]})}),e.jsx(ot,{dataSource:o,columns:_,loading:i,pagination:!1,rowKey:T=>T.id})]}),u&&e.jsx(fe,{onCancel:()=>{p(!1),g(null)},footer:null,width:"70%",open:u,style:{top:0},centered:!0,children:e.jsx("div",{className:"pt-5 h-screen overflow-auto",children:e.jsx(Jr,{shouldCreateNewTemplate:v,closeModal:m,setTemplateId:g,templateId:h,pool:t,reloadPool:s,reloadTemplates:l,setShouldCreateNewTemplate:f,onGenerateDocument:x,answers:y,setAnswers:C})})})]})},Zr=()=>{const{pool:t,reloadPool:s}=ce();return e.jsx(ge,{gutter:16,style:{padding:"0 24px"},children:e.jsx(ue,{xs:24,lg:24,children:e.jsx(Qr,{pool:t,reloadPool:()=>{s()}})})})};function Xr(){const{isOriginator:t}=Je(c=>c),{isLoadingNote:s}=ce(),n=ws.parse(window.location.search),r=gt(),o=ys(),i=[{name:"Doc generated",key:"doc_generated"},!t&&{name:"Doc template",key:"doc_template"}].filter(Boolean),l=["doc_generated","doc_template"].includes(n.tab)&&n.tab||"doc_generated";return e.jsx(At,{defaultActiveKey:["pools_setting"],children:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex gap-2 mb-4",children:i.map(c=>e.jsx(U,{className:`${l===c.key&&"bg-green-500"||"bg-gray-200"} !rounded-lg text-xs`,onClick:()=>{r(o.pathname+`?tab=${c.key}`)},children:c.name},c.key))}),!s&&l==="doc_generated"&&e.jsx($r,{}),!s&&l==="doc_template"&&e.jsx(Zr,{})]})})}const el=function({pool:t,visible:s,onClose:n}){const{message:r}=Ae.useApp(),[o,i]=a.useState(0),[l,c]=a.useState(0),[d,u]=a.useState(!0),p=t.id,[h,g]=a.useState(!1),v=async()=>{var M,y;u(!0);try{const C=await te.getEpochSetting(p);i(((M=C==null?void 0:C.result)==null?void 0:M.epochInterval)||0),c(((y=C==null?void 0:C.result)==null?void 0:y.epochInterval)||0)}catch(C){console.log(C)}u(!1)};a.useEffect(()=>{v()},[]);const f=async()=>{g(!0);try{await te.updateEpochSetting(p,parseInt(l)),i(l),n(),r.success("Update epoch successfully")}catch{r.error("Update epoch failed")}g(!1)},j={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(fe,{onCancel:n,footer:null,width:"35vw",centered:!0,style:{minWidth:410},open:s,styles:j,children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-lg mb-6",children:"Set epoch duration"}),d?e.jsx(Re,{}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2",children:"Epoch duration"}),e.jsx("div",{children:e.jsx(De,{value:l,placeholder:"Enter number",onChange:M=>c(M.target.value),suffix:"days",type:"number"})}),e.jsx("div",{className:"mt-8",children:e.jsx(U,{className:"shadow-none w-full mb-1 h-10",type:"primary",onClick:()=>f(),disabled:l===o,loading:h,children:"Submit"})})]})]})})};function tl({poolId:t,status:s}){const[n,r]=a.useReducer((i,l)=>({...i,...l}),{batches:[],history:[],isLoading:!1}),o=a.useCallback(async()=>{r({isLoading:!0});const i=await Ct.getAllBatches({poolId:t,status:s});r({batches:Ga(i,"createdAt","desc"),isLoading:!1})},[t,s]);return a.useEffect(()=>{o()},[o]),n}const sl=[{dataIndex:"key",title:"ID",fixed:"left",key:"key",width:"10%",render:(t,s)=>{switch(s.assetType){case xe.LENDING:return s.debtOrderContract.externalId;case xe.INVOICE:return s.invoice.openItemId;default:return"N/A"}}},{dataIndex:"assetType",title:"Type",key:"assetType",width:"6%",render:(t,s)=>e.jsx("div",{className:"font-medium",color:t===xe.LENDING?"green":t===xe.INVOICE?"red":"blue",children:t===xe.LENDING?"Loan":t===xe.INVOICE?"Invoice":s.noteTokenAsset.type===aa.SENIOR?"SOT":"JOT"})},{dataIndex:"poolId",title:"Pool",key:"id",width:"18%",render:(t,s)=>s.pool?s.pool.name:e.jsx("span",{style:{color:"#00D395"},children:"Unallocated"})},{title:"Upload date",dataIndex:"createdAt",key:"createdAt",defaultSortOrder:"descend",width:"10%",render:(t,s)=>t?ke(t).format("DD/MM/YYYY"):ke(s.createdAt).format("DD/MM/YYYY"),sorter:(t,s)=>t.createdAt-s.createdAt},{title:"Originator",key:"creatorId",width:"8%",render:(t,s)=>Z(s,"ownerCompany.companyLegalName","N/A")},{title:"Validator",key:"validator",width:"8%",render:(t,s)=>Z(s,"pool.validatorMember.email","N/A")},{title:"Status",key:"status",width:"12%",render:(t,s)=>e.jsx(Hn,{type:fn(s)})},{title:"Expected drawdown amount",dataIndex:"drawdownAmount",key:"drawdownAmount",align:"right",width:"13%",render:t=>X(t)},{title:"Due date",key:"dueDate",width:110,render:(t,s)=>{switch(s.assetType){case xe.LENDING:return ke(s.debtOrderContract.debtOrderContractInfo.finalMaturityDate).format("DD/MM/YYYY");case xe.INVOICE:return ke(s.invoice.dueDate).format("DD/MM/YYYY");case xe.NOTE_TOKEN:return ke(s.dueDate).format("DD/MM/YYYY");default:return"N/A"}}}];function al({poolContractAddress:t,decimals:s}){const[n,r]=a.useState(0),[o,i]=a.useState(!1),l=a.useCallback(async()=>{i(!0);try{const u=await(await Qt(t)).methods.reserve().call();r(u)}catch(d){console.log({e:d})}i(!1)},[t]);a.useEffect(()=>{t&&l()},[l,t]);const c=a.useMemo(()=>new he(n).dividedBy(new he(10).pow(s)).toString(),[n,s]);return{reserveBalance:n,formattedBalance:c,loading:o}}function nl({pool:t}){const[s,n]=a.useState(0),{notification:r}=Ae.useApp(),[o,i]=a.useState(!1),l=a.useCallback(async()=>{i(!0);try{const{walletAddress:c}=await te.getPoolLinkedWallet(t.id);if(!c)throw r.error({message:"The pool is not yet linked to the linked wallet"}),new Error("The pool is not yet linked to the linked wallet");const d=await jn(t.currency.tokenAddress);console.log(c,t.poolContractAddress);const u=await d.methods.allowance(c,t.poolContractAddress).call();n(u)}catch(c){console.log(c)}i(!1)},[t.currency.tokenAddress,t.id,t.poolContractAddress]);return a.useEffect(()=>{t!=null&&t.id&&l()},[l,t==null?void 0:t.id]),{approvedAmount:s,loading:o}}const rl=({isOpen:t,onClose:s,batchId:n})=>{var b;const{pool:r}=ce(),{batches:o,isLoading:i}=tl({poolId:r==null?void 0:r.id,status:2}),[l,c]=a.useState(null),d=((b=r==null?void 0:r.currency)==null?void 0:b.decimals)||18,u=rt(Z(r,"currency.shortCode","")),{formattedBalance:p,reserveBalance:h,loading:g}=al({poolContractAddress:r.poolContractAddress,decimals:d}),{loading:v,approvedAmount:f}=nl({pool:r});a.useEffect(()=>{var R;i||Ye(o)||l||c(n||((R=o[0])==null?void 0:R.id))},[o,i,l]);const[j,M]=a.useState([]),[y,C]=a.useState(!1),{drawdownValues:S}=pn({poolData:r,assets:j,callbackSuccess:()=>{}}),E=a.useMemo(()=>S[0]?ct(S[0],d):new he(0),[S]),m=a.useMemo(()=>{var R;return(R=S[1])==null?void 0:R[0]},[S]),x=a.useCallback(async()=>{if(!l)return;C(!0);const R=await Ct.getAllAssets({status:[Lt.TO_BE_FINANCED],poolId:r.id,batchId:l});M(R.filter(q=>q.status===Lt.TO_BE_FINANCED)),C(!1)},[l,r.id]);a.useEffect(()=>{x()},[x]);const{drawdown:D,loading:_}=hn({poolData:r,assets:j,callbackSuccess:()=>{s&&s()}}),{loading:T,value:w}=ca(async()=>r!=null&&r.id?(await te.getPoolLinkedWallet(r==null?void 0:r.id)).walletAddress:void 0,[r==null?void 0:r.id]),[A,O]=a.useState([]);a.useEffect(()=>{if(!j.length)return;if(!m){C(!0);return}const R=j.map((q,K)=>({...q,drawdownAmount:ct(m[K],d)}));O(R),C(!1)},[j,m]);const P=a.useMemo(()=>!(j!=null&&j.length)||g||T||v||!w||new he(E).isEqualTo(0)?!0:new he(E).multipliedBy(new he(10).pow(d)).isGreaterThan(h),[j==null?void 0:j.length,d,v,g,w,T,h,E]),V={header:{backgroundColor:"transparent"},content:{borderRadius:24}};return e.jsx(fe,{width:"65vw",title:e.jsx("span",{className:"text-xl bg-tr",children:"Drawdown"}),open:t,onCancel:()=>{s()},style:{minWidth:500},footer:null,styles:V,children:!!r&&e.jsx("div",{children:e.jsxs("div",{className:"mt-8",children:[i?e.jsx(Re,{active:!0}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"mb-4",children:e.jsxs(ue,{lg:3,xs:6,children:[e.jsx("span",{className:"text-ps font-semibold mb-3",children:"Batch ID"}),e.jsx(Te,{placeholder:"Select batch","data-testid":"drawdown-batch-select",items:o,loading:i,nameKey:"id",disabled:n,selectedValue:l,onSelect:R=>{c(R)}})]})}),e.jsx(ot,{"data-testid":"drawdown-table",columns:sl,dataSource:A||[],loading:y,scroll:{y:"calc(100vh - 360px)",x:1100},className:"bg-[#2527260A]",bodyStyle:{cursor:"pointer",overflowX:"auto"},pagination:!1,size:"middle",rowKey:R=>`${R.id}_${R.assetType}`}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsxs("div",{children:[e.jsxs("div",{className:"mt-2 flex gap-5 justify-between items-center",children:[e.jsx("span",{className:"text-base text-gray-500",children:"Total drawdown amount: "}),e.jsxs("span",{className:"text-lg font-bold",children:[X(E.toString())," ",u]})]}),e.jsxs("div",{className:"mt-2 flex gap-5 justify-between items-center",children:[e.jsx("span",{className:"text-base text-gray-500",children:"Total pool reserve"}),e.jsxs("span",{className:"text-lg font-bold",children:[X(p)," ",u]})]})]})})]}),e.jsx("div",{className:"my-2 flex justify-end mt-8",children:e.jsx(U,{className:"shadow-none !h-12 w-40","data-testid":"drawdown-button",type:"primary",shape:"round",size:"large",loading:_,onClick:()=>{if(new he(E).multipliedBy(new he(10).pow(d)).isGreaterThan(f)){Ke.error({message:"Insufficient approved spent amount. Please contact the Issuer"});return}D()},disabled:P,children:"Drawdown"})})]})})})},gs=t=>{if(!t)return t;const s={...t},n=[],r=Object.keys(s);return r.map(o=>{const i=n.indexOf(s[o]);i>=0&&(delete s[r[i]],n[i]=null),n.push(s[o])}),s},ya=(t,s)=>{if(!t||!s)return t;const n=gs(t);return s=gs(s),Object.keys(s).map(o=>{const l=Object.keys(n).find(c=>c!==o&&n[c]===s[o]);l&&delete n[l],n[o]=s[o]}),n},ll={"document currency":"invoiceCurrency",ledger:"ledger",country:"country","document reference":"openItemId","parent (trust) number":"parentTrustNumber","account number":"accountRefNumber","invoice date":"invoiceDate","net value":"netAmount","vat amount":"taxAmount","gross value":"grossAmount","eligible value":"eligibleAmount","primary ineligible":"eligibleForPool","primary ineligible reason":"ineligibleReason.primaryIneligible","ineligible - approved receivables debtor jurisdiction":"ineligibleReason.approvedReceivablesDebtorJurisdiction","ineligible - debtor insolvency":"ineligibleReason.debtorInsolvency","ineligible - receivables ageing":"ineligibleReason.receivablesAgeing","ineligible - payment term":"ineligibleReason.paymentTerm","ineligible - cross ageing":"ineligibleReason.crossAgeing","ineligible - other ineligible":"ineligibleReason.other","exclusion - intercompany trade":"exclusionReason.intercompanyTrade","exclusion - debtor contract issues - re ban on assignment and confidentiality":"exclusionReason.debtorContractIssues","exclusion - debtor unapproved jurisdiction":"exclusionReason.debtorUnapprovedJurisdiction","customer email":"buyerEmail","matched customer name":"buyerName","payment due date":"invoiceDueDate","invoice due date":"invoiceDueDate","open item id":"openItemId","debtor id":"debtorId","purchase/sales order":"purchaseSalesOrder","dispute code":"disputeCode","ineligible invoice flag":"ineligibleFlag","selling entity code":"sellingEntityCode","payment method":"externalPaymentMethod","external payment method":"externalPaymentMethod","external status":"externalStatus","invoice status":"externalStatus","debtor name":"debtorName","debtor address 1":"debtorAddress1","debtor address 2":"debtorAddress2","debtor address 3":"debtorAddress3","debtor address 4":"debtorAddress4","debtor address1":"debtorAddress1","debtor address2":"debtorAddress2","debtor address3":"debtorAddress3","debtor address4":"debtorAddress4","debtor country":"debtorCountry","debtor contact name":"debtorContactName","debtor contact phone number":"debtorContactPhoneNumber","debtor entity registered number":"debtorEntityRegisteredNumber","asset score":"riskscore"},ol={"pool cut-off date":"poolCutoffDate","pool identifier":"poolIdentifier","loan identifier":"loanIdentifier",originator:"originator","servicer identifier":"servicerIdentifier","servicer name":"servicerName","borrower identifier":"borrowerIdentifier","group company identifier":"groupCompanyIdentifier",country:"country",postcode:"postcode","borrower basel iii segment":"borrowerSegment","loan origination date":"startedDate","borrower email":"debtorEmail","original loan balance":"principalAmount","current balance":"outstandingPrincipalAmount","loan denomination currency":"currencySymbol","obligor legal form / business type":"businessType","current interest rate":"interestRatePercentage","final maturity date":"finalMaturityDate","liquidation ratio":"liquidationRatio","min collateral ratio":"minCollateralRatio","originator affiliate":"originatorAffiliate","asset type":"assetType",seniority:"seniority","bank internal loss given default (lgd) estimate":"LGD","nace industry code":"NACEIndustryCode","securitised loan amount":"securitisedLoanAmount","type of loan":"typeOfLoan","balloon amount":"balloonAmount","payment type":"paymentType","principal payment frequency":"principalPaymentFrequency","interest payment frequency":"interestPaymentFrequency","amortization type":"amortizationType","interest cap rate":"interestCapRate","interest floor rate":"interestFloorRate","interest rate type":"interestRateType","current interest rate index":"currentInterestRateIndex","current interest rate margin":"currentInterestRateMargin","interest reset period":"interestResetPeriod","interest arrears amount":"interestArrearsAmount","number of days in interest arrears":"numberOfDaysInInterestArrears","principal arrears amount":"principalArrearsAmount","number of days in principal arrears":"numberOfDaysInPrincipalArrears","default date":"defaultDate","default amount":"defaultAmount","cumulative recoveries":"cumulativeRecoveries","allocated losses":"allocatedLosses","date loss allocated":"dateLossAllocated","loan hedged":"loanHedged","asset score":"riskscore"},il={"pool cut-off date":"poolCutoffDate","cut-off date":"poolCutoffDate","cross collateralisation in counterparty group":"nplCounterpartyInfo.crossCollateralisationInCounterpartyGroup","counterparty role":"nplCounterpartyInfo.counterpartyRole","legal type of counterparty":"nplCounterpartyInfo.legalTypeOfCounterparty","date of last contact":"nplCounterpartyInfo.dateOfLastContact","name of insolvency/restructuring proceedings":"nplCounterpartyInfo.nameOfInsolvencyRestructuringProceedings","additional name of insolvency/restructuring proceedings":"nplCounterpartyInfo.additionalNameOfInsolvencyRestructuringProceedings","legal procedure type":"nplCounterpartyInfo.legalProcedureType","description of legal procedure type":"nplCounterpartyInfo.descriptionOfLegalProcedureType","commencement date of insolvency/restructuring proceedings":"nplCounterpartyInfo.commencementDateOfInsolvencyRestructuringProceedings","stage reached in insolvency/restructuring procedure":"nplCounterpartyInfo.stageReachedInInsolvencyRestructuringProcedure","additional stage reached in insolvency/restructuring procedure":"nplCounterpartyInfo.additionalStageReachedInInsolvencyRestructuringProcedure","insolvency practitioner appointed":"nplCounterpartyInfo.insolvencyPractitionerAppointed","date of appointment":"nplCounterpartyInfo.dateOfAppointment","proof of claim filed by the seller":"nplCounterpartyInfo.proofOfClaimFiledByTheSeller","distribution made to the seller":"nplCounterpartyInfo.distributionMadeToTheSeller","notice for procedure termination":"nplCounterpartyInfo.noticeForProcedureTermination","date of external demand issuance":"nplCounterpartyInfo.dateOfExternalDemandIssuance","date when reservation of rights letter was issued":"nplCounterpartyInfo.dateWhenReservationOfRightsLetterWasIssued","jurisdiction of court":"nplCounterpartyInfo.jurisdictionOfCourt","date of obtaining order for possession":"nplCounterpartyInfo.dateOfObtainingOrderForPossession","comments on other litigation related process":"nplCounterpartyInfo.commentsOnOtherLitigationRelatedProcess","date origination":"startedDate","asset class":"assetType",purpose:"purpose","amortization type":"amortizationType","loan currency":"currencySymbol","principal balance":"principalAmount","total balance":"outstandingPrincipalAmount","current interest rate":"interestRatePercentage","current interest rate type":"interestRateType","current interest margin":"currentInterestRateMargin","interest cap rate":"interestCapRate","interest floor rate":"interestFloorRate","principal payment frequency":"principalPaymentFrequency","interest payment frequency":"interestPaymentFrequency","date of default":"defaultDate","balance at default":"defaultAmount","governing law of loan agreement":"nplInfo.governingLawOfLoanAgreement","product type":"nplInfo.productType","description of bespoke repayment":"nplInfo.descriptionOfBespokeRepayment","final bullet repayment":"nplInfo.finalBulletRepayment","current maturity date":"nplInfo.currentMaturityDate","description of current interest rate type":"nplInfo.descriptionOfCurrentInterestRateType","current interest base rate":"nplInfo.currentInterestBaseRate","legal balance":"nplInfo.legalBalance","current interest rate reference":"nplInfo.currentInterestRateReference","start date of interest only period":"nplInfo.startDateOfInterestOnlyPeriod","end date of interest only period":"nplInfo.endDateOfInterestOnlyPeriod","start date of current fixed interest period":"nplInfo.startDateOfCurrentFixedInterestPeriod","end date of current fixed interest period":"nplInfo.endDateOfCurrentFixedInterestPeriod","current reversion interest rate":"nplInfo.currentReversionInterestRate","last payment date":"nplInfo.lastPaymentDate","last payment amount":"nplInfo.lastPaymentAmount","interest payment frequency":"nplInfo.interestPaymentFrequency","total past-due amount":"nplInfo.totalPastDueAmount","days in past-due":"nplInfo.daysInPastDue","loan status":"nplInfo.loanStatus","non-performing reason":"nplInfo.nonPerformingReason","charge-off date":"nplInfo.chargeoffDate","syndicated loan":"nplInfo.syndicatedLoan","syndicated portion":"nplInfo.syndicatedPortion",securitised:"nplInfo.securitised","marp applicable":"nplInfo.marpApplicable","marp entry":"nplInfo.marpEntry","marp status":"nplInfo.marpStatus","history of legal unpaid balances":"nplInplHistoricalInfo.historyOfLegalUnpaidBalances","history of past - due balances":"nplInplHistoricalInfo.historyOfPastDueBalances","history of total repayments":"nplInplHistoricalInfo.historyOfTotalRepayments","history of repayments - not from asset sales":"nplInplHistoricalInfo.historyOfRepaymentsNotFromAssetSales","history of repayments - from asset sales":"nplInplHistoricalInfo.historyOfRepaymentsFromAssetSales","type of identifier":"nplExternalCollection.typeOfIdentifier","cash recoveries":"nplExternalCollection.cashRecoveries","costs accrued":"nplExternalCollection.costsAccrued","repayment plan":"nplExternalCollection.repaymentPlan","type of identifier":"nplForbearance.typeOfIdentifier","type of forbearance":"nplForbearance.typeOfForbearance","description of forbearance":"nplForbearance.descriptionOfForbearance","date of first forbearance":"nplForbearance.dateOfFirstForbearance","number of historical forbearance":"nplForbearance.numberOfHistoricalForbearance","principal forgiveness":"nplForbearance.principalForgiveness","date of principal forgiveness":"nplForbearance.dateOfPrincipalForgiveness","start date of forbearance":"nplForbearance.startDateOfForbearance","end date of forbearance":"nplForbearance.endDateOfForbearance","repayment amount under forbearance":"nplForbearance.repaymentAmountUnderForbearance","repayment frequency under forbearance":"nplForbearance.repaymentFrequencyUnderForbearance","type of property":"nplPropertyCollateral.typeOfProperty","type of occupancy":"nplPropertyCollateral.typeOfOccupancy","address of property":"nplPropertyCollateral.addressOfProperty","city of property":"nplPropertyCollateral.cityOfProperty","geographic region of property":"nplPropertyCollateral.geographicRegionOfProperty","property postcode":"nplPropertyCollateral.propertyPostcode","property country":"nplPropertyCollateral.propertyCountry",tenure:"nplPropertyCollateral.tenure","remaining term of leasehold":"nplPropertyCollateral.remainingTermOfLeasehold","building area (m2)":"nplPropertyCollateral.buildingAreaM","building area (m2) lettable":"nplPropertyCollateral.buildingAreaMLettable","building area (m2) occupied":"nplPropertyCollateral.buildingAreaMOccupied","land area (m2)":"nplPropertyCollateral.landAreaM","latest valuation amount":"nplPropertyCollateral.latestValuationAmount","date of latest valuation":"nplPropertyCollateral.dateOfLatestValuation","internal/external latest valuation":"nplPropertyCollateral.internalExternalLatestValuation","type of latest valuation":"nplPropertyCollateral.typeOfLatestValuation","latest estimated rental value":"nplPropertyCollateral.latestEstimatedRentalValue","current annual passing rent":"nplPropertyCollateral.currentAnnualPassingRent","current opex and overheads":"nplPropertyCollateral.currentOpexAndOverheads","planned capex next 12m":"nplPropertyCollateral.plannedCapexNextM","current net operating income":"nplPropertyCollateral.currentNetOperatingIncome","amount of vat payable":"nplPropertyCollateral.amountOfVatPayable","completion of property":"nplPropertyCollateral.completionOfProperty","percentage complete":"nplPropertyCollateral.percentageComplete","enforcement status":"nplPropertyCollateral.enforcementStatus","enforcement status third parties":"nplPropertyCollateral.enforcementStatusThirdParties","mortgage amount":"nplRelationshipInfo.mortgageAmount","lien position":"nplRelationshipInfo.lienPosition","higher ranking loan":"nplRelationshipInfo.higherRankingLoan","collateral type":"nplNonPropertyCollateral.collateralType",description:"nplNonPropertyCollateral.description","currency of collateral":"nplNonPropertyCollateral.currencyOfCollateral","guarantee amount":"nplNonPropertyCollateral.guaranteeAmount","latest valuation amount":"nplNonPropertyCollateral.latestValuationAmount","date of latest valuation":"nplNonPropertyCollateral.dateOfLatestValuation","type of latest valuation":"nplNonPropertyCollateral.typeOfLatestValuation","enforcement status":"nplNonPropertyCollateral.enforcementStatus","lien position":"nplRelationshipNonProperty.lienPosition","higher ranking loan":"nplRelationshipNonProperty.higherRankingLoan","currency of enforcement":"nplEnforcement.currencyOfEnforcement","indicator of enforcement":"nplEnforcement.indicatorOfEnforcement","enforcement description":"nplEnforcement.enforcementDescription","court appraisal amount":"nplEnforcement.courtAppraisalAmount","date of court appraisal":"nplEnforcement.dateOfCourtAppraisal","current market status":"nplEnforcement.currentMarketStatus","on market price":"nplEnforcement.onMarketPrice","offer price":"nplEnforcement.offerPrice","sale agreed price":"nplEnforcement.saleAgreedPrice","gross sale proceeds":"nplEnforcement.grossSaleProceeds","costs at end of sale":"nplEnforcement.costsAtEndOfSale","net sale proceeds":"nplEnforcement.netSaleProceeds","collateral repossessed date":"nplEnforcement.collateralRepossessedDate","prepare property for sale date":"nplEnforcement.preparePropertyForSaleDate","property on market date":"nplEnforcement.propertyOnMarketDate","on market offer date":"nplEnforcement.onMarketOfferDate","sale agreed date":"nplEnforcement.saleAgreedDate","contracted date":"nplEnforcement.contractedDate","sold date":"nplEnforcement.soldDate","first auction date":"nplEnforcement.firstAuctionDate","court auction reserve price for first auction":"nplEnforcement.courtAuctionReservePriceForFirstAuction","next auction date":"nplEnforcement.nextAuctionDate","court auction reserve price for next auction":"nplEnforcement.courtAuctionReservePriceForNextAuction","last auction date":"nplEnforcement.lastAuctionDate","court auction reserve price for last auction":"nplEnforcement.courtAuctionReservePriceForLastAuction","number of failed auctions":"nplEnforcement.numberOfFailedAuctions","indicator of receivership":"nplEnforcement.indicatorOfReceivership","pool identifier":"poolIdentifier","loan identifier":"loanIdentifier",originator:"originator","servicer identifier":"servicerIdentifier","servicer name":"servicerName","borrower identifier":"borrowerIdentifier","group company identifier":"groupCompanyIdentifier",country:"country",postcode:"postcode","business type":"businessType","borrower basel iii segment":"borrowerSegment","borrower email":"debtorEmail","obligor legal form / business type":"businessType","obligor legal form":"businessType","business type":"businessType","final maturity date":"finalMaturityDate","liquidation ratio":"liquidationRatio","min collateral ratio":"minCollateralRatio","originator affiliate":"originatorAffiliate",seniority:"seniority","bank internal loss given default (lgd) estimate":"LGD","nace industry code":"NACEIndustryCode","securitised loan amount":"securitisedLoanAmount","type of loan":"typeOfLoan","balloon amount":"balloonAmount","payment type":"paymentType","current interest rate index":"currentInterestRateIndex","interest reset period":"interestResetPeriod","interest arrears amount":"interestArrearsAmount","number of days in interest arrears":"numberOfDaysInInterestArrears","principal arrears amount":"principalArrearsAmount","number of days in principal arrears":"numberOfDaysInPrincipalArrears","cumulative recoveries":"cumulativeRecoveries","allocated losses":"allocatedLosses","date loss allocated":"dateLossAllocated","loan hedged":"loanHedged"},ba=[{id:1,name:"SME Loans",labelsMapping:ol},{id:2,name:"Invoices",labelsMapping:ll},{id:3,name:"SME NPL",labelsMapping:il}],cl=["startedDate","currencySymbol","loanIdentifier","finalMaturityDate","outstandingPrincipalAmount","principalAmount"],ja={PLEDGE:1};function fs({isUnrecognizedColumn:t,label:s,onEdit:n}){return t?e.jsxs("div",{onClick:n,className:"cursor-pointer",children:[e.jsx("span",{className:"text-red-400 mr-1",children:"Not recognized"}),e.jsx(ms,{})]}):e.jsxs("div",{onClick:n,className:"cursor-pointer",children:[e.jsx("span",{className:"mr-1",children:s||""}),e.jsx(ms,{})]})}const va=a.createContext({stepAction:{next:()=>{},prev:()=>{},force:()=>{}},currentStep:0,isFetchingAssetMapping:!1,rawFile:{},setRawFile:()=>{},assetsMapping:{},setAssetsMapping:()=>{},columns:[],setColumns:()=>{},assets:[],setAssets:()=>{},selectedColumn:null,setSelectedColumn:()=>{},validator:null,setValidator:()=>{},validationType:3,setValidationType:()=>{},assetPurpose:ja.PLEDGE,setAssetPurpose:()=>{},dataset:null,setDataset:()=>{},dataType:"ACTUAL",setDataType:()=>{},memberMetadata:null,isUploading:!1,setUploading:()=>{},assetsClass:null,mappingAsset:()=>{},resetMapping:()=>{},validateInvoiceAssets:()=>{},agreementModalVisible:!1,setAgreementModalVisible:()=>{},startUploading:()=>{},selectedAssets:[],setSelectedAssets:()=>{}}),wa=({children:t,countries:s})=>{var Pe;const{address:n}=nt(),{message:r,notification:o}=Ae.useApp(),{pool:i}=ce(),[l,c]=a.useState(ja.PLEDGE),[d,u]=a.useState(null),[p,h]=a.useState("ACTUAL"),[g,v]=a.useState(3),[f,j]=a.useState(null),[M,y]=a.useState({}),[C,S]=a.useState(null),[E,m]=a.useState([]),[x,D]=a.useState([]),[_,T]=a.useState(null),[w,A]=a.useState(!1),[O,P]=a.useState(!1),[V,b]=a.useState([]),[R,q]=a.useState(!0),[K,B]=a.useState(0),[N,J]=a.useState(""),le=a.useMemo(()=>ba.find(L=>L.id===xe.LENDING),[]),[me,ye]=a.useState(gs(le.labelsMapping)),W=a.useRef(null),Q=a.useCallback(async()=>{try{const L=await xn.getProfile();if(T(L.data.metadata),L.data.metadata&&L.data.metadata.assetsMapping&&L.data.metadata.assetsMapping[xe.LENDING]){const G=L.data.metadata.assetsMapping[xe.LENDING];W.current=ya(le.labelsMapping,G),ye(W.current)}}catch(L){console.log(L)}q(!1)},[le.labelsMapping]),z=async()=>{const{walletAddress:L}=await ht.getLinkedWallet();console.log("{ walletAddress: linkedWalletAddress }: ",{walletAddress:L}),J(L)};a.useEffect(()=>{z()},[]),a.useEffect(()=>{Q()},[Q]);const oe=a.useCallback(()=>{K!==3&&B(K+1)},[K]),k=a.useCallback(()=>{K!=0&&B(K-1)},[K]),be=(L,G)=>{const $=G||me,ee=L.data[0].map((H,je)=>{var de,Fe;return H&&(H=(de=H==null?void 0:H.trim)==null?void 0:de.call(H)),$[(Fe=H==null?void 0:H.toLowerCase)==null?void 0:Fe.call(H)]?H:`NOT_RECOGNIZED_${je}`}),ae=[];for(let H=1;H<L.data.length;H++){const je={};L.data[H].forEach((de,Fe)=>{var Ue;const Ve=ee[Fe],Ne=(Ue=Ve==null?void 0:Ve.toLowerCase)==null?void 0:Ue.call(Ve);je[$[Ne]||Ve]=de}),ae.push(je)}const ie=ee.map((H,je)=>{var Ne;const de=(Ne=H==null?void 0:H.toLowerCase)==null?void 0:Ne.call(H),Fe=H.includes("NOT_RECOGNIZED_"),Ve=(()=>{if(le!=null&&le.labelsMapping&&$[de]){const Ue=Object.keys(le==null?void 0:le.labelsMapping).find(Y=>(le==null?void 0:le.labelsMapping[Y])===$[de]);return Ue?Gt(Ue):Gt(de)}return L.data[0][je]})();return{title:e.jsx(fs,{isUnrecognizedColumn:Fe,label:Ve,onEdit:()=>{S(je)}}),dataIndex:$[de]||H,key:$[de]||H,width:200,wordWrap:"break-word",wordBreak:"break-word",originalLabel:L.data[0][je]}});m(ie),D(ae)},$e=()=>{be(M,W.current),ye(W.current)},Se=a.useCallback(async(L,G)=>{var $,ee,ae,ie;if(!L)return P(!0);A(!0);try{const H=($=i==null?void 0:i.validatorMember)==null?void 0:$.email;let je=null;switch(p==="TEST"&&d&&(je=d),le.id){case 2:{(await Pt.bulkUploadTransfer(i.id,{dataset:je,receivableItems:Pt.makeFormDataForBulkUpload(V,{countries:s,needToBeAcceptedByBuyer:g===2}),approverEmail:H,approveNeeded:g!==3,assetPurpose:l,signature:L,signerName:G})).message==="success"&&B(4);break}case 3:await pt.bulkUploadTransfer(i.id,{dataset:je,data:pt.makeFormDataForNplBulkUpload(V,{countries:s}),approverEmail:H,approveNeeded:g!==3,assetPurpose:l,signature:L,signerName:G});break;case 1:default:{if(n&&((ee=n==null?void 0:n.toLowerCase)==null?void 0:ee.call(n))!==((ae=N==null?void 0:N.toLowerCase)==null?void 0:ae.call(N)))return o.error({message:`Current wallet address is not valid. Please connect to wallet ${N}`});const de=await pt.bulkUploadTransfer(i.id,{dataset:je,data:pt.makeFormDataForBulkUpload(V,{countries:s}),approverEmail:H,approveNeeded:g!==3,assetPurpose:l,signature:L,signerName:G,LATReceiver:N}),Fe=Object.keys(de.errors||{}).filter(Ve=>{var Ne,Ue;return((Ue=(Ne=de==null?void 0:de.errors)==null?void 0:Ne[Ve])==null?void 0:Ue.length)>0}).length||0;if(Fe>0)throw new Error(`${Fe} collaterals have been failed to upload`);if(((ie=de==null?void 0:de.debtOrderContracts)==null?void 0:ie.length)>0){const Ne={dataset:null,data:(de==null?void 0:de.debtOrderContracts).map(Ue=>Ue.id),approverEmail:H,approveNeeded:g!==3,assetPurpose:l,LATReceiver:N};await pt.getMintLATParam(i==null?void 0:i.id,Ne)}B(4)}}A(!1),P(!1)}catch(H){console.log("Upload-lending error: ",H),r.error("Fail to upload collaterals"),P(!1),A(!1)}},[(Pe=i==null?void 0:i.validatorMember)==null?void 0:Pe.email,i.id,p,d,le.id,V,s,g,l,n]);return e.jsxs(va.Provider,{value:{stepAction:{next:oe,prev:k,force:L=>{B(L)}},currentStep:K,rawFile:M,setRawFile:y,assetsMapping:me,setAssetsMapping:ye,columns:E,setColumns:m,assets:x,setAssets:D,selectedColumn:C,setSelectedColumn:S,validator:f,setValidator:j,validationType:g,setValidationType:v,assetPurpose:l,setAssetPurpose:c,dataset:d,setDataset:u,dataType:p,setDataType:h,memberMetadata:_,isUploading:w,setUploading:A,assetsClass:le,mappingAsset:be,resetMapping:$e,agreementModalVisible:O,setAgreementModalVisible:P,startUploading:Se,countries:s,selectedAssets:V,setSelectedAssets:b,isFetchingAssetMapping:R},children:[e.jsx(e.Fragment,{children:t}),!!O&&e.jsx(na,{legalDocumentId:i.uploadAssetLegalDocumentId,visible:O,needSigner:!0,onClose:()=>{P(!1)},onSubmit:Se})]})};wa.propTypes={children:ne.element};const ft=()=>a.useContext(va);function dl({validatorCompanyId:t}){const[s,n]=a.useState([]),r=a.useCallback(async o=>{const i=await Dt.getUsersByCompanyId(o);n(i)},[]);return a.useEffect(()=>{t&&r(t)},[r,t]),{validators:s}}const{Option:is}=at;function ul(){const{stepAction:t,validationType:s,setValidationType:n,validator:r,setValidator:o,setRawFile:i,mappingAsset:l,isFetchingAssetMapping:c}=ft(),{pool:d}=ce(),{validators:u}=dl({validatorCompanyId:d.validatorCompanyId}),[p,h]=a.useState({}),[g,v]=a.useState(!1);a.useEffect(()=>{const{validatorMemberId:y}=d;let C;y?C=1:C=3,n(C),o(y)},[d,n,o]);const f=a.useCallback(y=>{const C=y.target.files[0];h({name:C.name,file:C})},[]),j=a.useMemo(()=>ba.find(y=>y.id===xe.LENDING),[]),M=()=>{v(!0),Vn.parse(p.file,{skipEmptyLines:!0,complete:function(y){i(y),l(y),v(!1),t.next()}})};return e.jsx(ge,{gutter:[16],children:e.jsx(ue,{xs:24,md:{span:20,offset:2},children:e.jsx(Xe,{children:e.jsxs(F,{layout:"vertical",className:"mt-5",children:[e.jsx(F.Item,{label:"CSV File",children:e.jsx(Rn,{id:"collateralProjectFile",uploadedFileData:{},fileData:{fileName:p==null?void 0:p.name},onFileChange:y=>f(y),placeholder:"Choose a CSV file",accept:".csv"})}),e.jsx(F.Item,{label:"Approval options",children:e.jsxs(re,{type:"select",value:s,placeholder:"Approval options",disabled:!0,defaultValue:!0,onChange:y=>n(y),children:[e.jsxs(is,{value:1,children:[j.id===2?"Invoice":"Loan"," to be approved"]}),j.id===2&&e.jsx(is,{value:2,children:"Invoice to be accepted by Buyer"}),e.jsx(is,{value:3,children:"No Validator"})]})}),s===1&&e.jsx(F.Item,{label:"Validator",children:e.jsx(Te,{isMember:!0,type:"select",allowNewValue:!0,items:u,nameKey:"email",disabled:!0,placeholder:"Validator",selectedValue:r,onSelect:y=>{o(y)}})}),e.jsx("div",{className:"flex justify-end mt-5",children:e.jsx(U,{type:"primary",loading:g||c,disabled:c||!(p!=null&&p.file),onClick:()=>{M()},children:"Next"})})]})})})})}const Ca=({columns:t,datasource:s})=>e.jsx("div",{style:{overflowX:"auto"},children:e.jsx(Un,{bordered:!0,width:t.length*250,headerStyle:{textTransform:"capitalize"},height:300,headerHeight:50,rowHeight:50,rowCount:s.length,rowGetter:({index:n})=>s[n],children:t.map(n=>e.jsx(Bn,{headerRenderer:()=>n.title,dataKey:n.dataIndex,width:250},n.dataIndex))})});Ca.propTypes={columns:ne.array,datasource:ne.array};const ml=Qs.memo(Ca),{Option:Bs}=at,pl=[{name:"number",value:"number"},{name:"text",value:"text"},{name:"date",value:"datetime"},{name:"bool",value:"bool"}],hl=({onClose:t,selectedColumn:s,onChangeFieldName:n})=>{const{assetsClass:r}=ft(),[o,i]=a.useState({value:null}),[l,c]=a.useState(null),u=(()=>{const h=[{name:"Create a new field...",value:"NEW_FIELD"}];return r!=null&&r.labelsMapping&&Object.keys(r==null?void 0:r.labelsMapping).forEach(g=>{var v,f;h.push({name:(f=(v=Gt(g))==null?void 0:v.replace)==null?void 0:f.call(v,/_/g," "),value:r==null?void 0:r.labelsMapping[g]})}),h})(),p=(h,g)=>g.props.children.toLowerCase().includes(h.toLowerCase());return e.jsxs(fe,{onOk:()=>{n(o.value==="NEW_FIELD"?{value:l,name:l}:o),i({value:null}),c(null)},okText:"Confirm",open:s!==null,okButtonProps:{disabled:o.value===null||o.value==="NEW_FIELD"&&!l},onCancel:()=>{t(),i({value:null}),c(null)},title:"Edit column label",width:500,children:[e.jsx("div",{children:e.jsx("b",{children:"Select a field for this column"})}),e.jsx(at,{value:o.value,onChange:h=>{const g=u.find(v=>v.value===h);i(g)},style:{width:300,margin:"5px 0"},showSearch:!0,filterOption:p,children:u.map((h,g)=>e.jsx(Bs,{value:h.value,children:h.name},g))}),o.value==="NEW_FIELD"&&e.jsxs(ge,{gutter:12,style:{marginTop:20},children:[e.jsxs(ue,{span:12,children:[e.jsx("div",{children:e.jsx("b",{children:"Create a field label"})}),e.jsx(De,{onChange:h=>c(h.target.value),style:{width:"100%",margin:"5px 0"}})]}),e.jsxs(ue,{span:12,children:[e.jsx("div",{children:e.jsx("b",{children:"Select a data type"})}),e.jsx(at,{style:{width:"100%",margin:"5px 0"},showSearch:!0,children:pl.map((h,g)=>e.jsx(Bs,{value:h.value,children:h.name},g))})]})]})]})};function gl({isUpdatingAssets:t,countries:s,reloadPool:n,onClose:r}){const{assets:o,columns:i,stepAction:l,isUploading:c,dataset:d,dataType:u,setUploading:p,assetsClass:h,validationType:g,memberMetadata:v,assetsMapping:f,resetMapping:j,selectedColumn:M,setSelectedColumn:y,setAssetsMapping:C,setColumns:S,setAssets:E}=ft(),{pool:m}=ce(),x=a.useMemo(()=>i.filter(({key:V})=>!!V.includes("NOT_RECOGNIZED_")).length,[i]),D=a.useCallback(async()=>{p(!0);let V=null;switch(u==="TEST"&&d&&(V=d),h.id){case 2:await Pt.bulkUpdate({dataset:V,data:Pt.makeFormDataForBulkUpload(o,{countries:s,needToBeAcceptedByBuyer:g===2})});break;default:await pt.bulkUpdate({dataset:V,data:pt.makeFormDataForBulkUpload(o,{countries:s})})}r(),n(),Le.success("Update assets successfully"),p(!1)},[p,u,d,h.id,r,n,o,s,g]),_=a.useCallback(({value:V,name:b})=>{const R=i[M].dataIndex,q=i[M].originalLabel.toLowerCase(),K=V,B=V,N=f[K]||B,J=Ya(i.map(z=>z.dataIndex).filter(z=>{var oe;return(oe=z==null?void 0:z.toLowerCase)==null?void 0:oe.call(z).includes("NOT_RECOGNIZED_")}).map(z=>+z.split("_")[2]))+1,le={},me=i.findIndex(z=>z.key===N);console.log({selectedColumn:M,replaceIndex:J,replaceAnotherColumnIndex:me,columns:i});let ye=!1;M!==me&&(ye=!0,console.log(`NOT_RECOGNIZED_${J}`),le[me]={$set:{title:e.jsx(fs,{isUnrecognizedColumn:!0,label:`NOT_RECOGNIZED_${J}`,onEdit:()=>{y(me)}}),dataIndex:`NOT_RECOGNIZED_${J}`,key:`NOT_RECOGNIZED_${J}`,width:200,wordWrap:"break-word",wordBreak:"break-word",originalLabel:`NOT_RECOGNIZED_${J}`}});const W=_n(i,{[M]:{$set:{title:e.jsx(fs,{isUnrecognizedColumn:!1,label:b,onEdit:()=>{y(M)}}),dataIndex:N,key:N,width:200,wordWrap:"break-word",wordBreak:"break-word",originalLabel:q}},...le});console.log("newColumns",W);const Q=o.map(z=>{const oe=z[R];if(delete z[R],ye){const k=z[N];return delete z[N],{...z,[`NOT_RECOGNIZED_${J}`]:k,[N]:oe}}else return{...z,[N]:oe}});C(ya(f,{[q]:f[K]||B})),S(W),E(Q),y(null)},[i,M,f,o,C,S,E,y]),T=cl,w=a.useMemo(()=>!o||!o[0]?T:Ka(T,Object.keys(o[0])),[o,T]),[A,O]=a.useState(!1),P=a.useCallback(async()=>{if(!(!o||!o[0])&&!(w.length>0))if(t)await D();else{O(!0);const V=v?{...v,assetsMapping:v.assetsMapping?{...v.assetsMapping,[m.assetType]:{...f}}:{[m.assetType]:{...f}}}:{assetsMapping:{[m.assetType]:{...f}}};try{await Ct.createUpdateMemberMetadata(V)}catch(b){console.log(b)}O(!1),u==="TEST"?l.force(3):l.force(2)}},[o,f,u,w.length,t,v,m.assetType,D,l]);return e.jsx(ge,{gutter:[16],children:e.jsxs(ue,{xs:24,children:[e.jsxs(Xe,{className:"mb-4",children:[e.jsxs("div",{className:"flex flex-row justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:"Assets recognized"}),e.jsx("div",{className:"font-bold",children:o.length})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:"Columns will be imported."}),e.jsx("div",{className:"font-bold",children:i.length-x})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mt-3 mb-0 text-xs text-pool-card-info ",children:"columns will NOT be imported."}),e.jsx("div",{className:"font-bold",children:x})]}),e.jsx("div",{children:e.jsx(U,{onClick:j,children:"Reset Mapping"})})]}),e.jsx(Be,{}),e.jsxs("div",{className:"font-bold",children:["Required Fields (",T.length-w.length,"/",T.length,")",e.jsx("div",{className:"flex flex-row gap-4 flex-wrap mt-4",children:(T==null?void 0:T.length)&&T.map(V=>{var R,q;const b=Object.keys((h==null?void 0:h.labelsMapping)||{}).find(K=>(h==null?void 0:h.labelsMapping[K])===V);return e.jsxs("div",{className:"flex gap-1",children:[e.jsx(Ha,{style:{color:w.includes(V)?"red":"#00cc68"}}),e.jsx("div",{children:(q=(R=Gt(b))==null?void 0:R.replace)==null?void 0:q.call(R,/_/g," ")})]},V)})})]})]}),e.jsxs(Xe,{children:[e.jsx(ml,{columns:i,datasource:o}),e.jsxs("div",{className:"flex justify-end mt-4",children:[e.jsx(U,{onClick:()=>{l.force(0)},className:"mr-2",children:"Previous"}),e.jsx(U,{loading:c||A,onClick:P,disabled:w.length>0||A,type:"primary",children:t?"Update assets":u==="ACTUAL"?"Next":"Import assets"})]}),e.jsx(hl,{selectedColumn:M,onClose:()=>y(null),onChangeFieldName:_})]})]})})}function fl(){const{assets:t,countries:s,validationType:n,assetPurpose:r}=ft(),{pool:o,calculateDrawdownAmount:i}=ce(),[l,c]=a.useState(!1),d=a.useCallback(async()=>{c(!0);try{const p={receivableItems:Pt.makeFormDataForBulkUpload(t,{countries:s,needToBeAcceptedByBuyer:n===2}),assetPurpose:r};return await Ct.validateUploadingInvoiceAssets(o==null?void 0:o.id,p)}finally{c(!1)}},[r,t,s,o==null?void 0:o.id,n]),u=a.useCallback(async p=>{c(!0);try{const h={...p||{},data:pt.makeFormDataForBulkUpload(t,{countries:s}),assetPurpose:r},g=await Ct.validateUploadingLoanAssets(o==null?void 0:o.id,h);return g.errors&&(g.errors=g.errors.map(v=>qa([v]))),g}finally{c(!1)}},[r,t,i,s,o==null?void 0:o.id]);return{validateInvoiceAssets:d,validateLoanAssets:u,loading:l}}function xl({isOpen:t,onClose:s,errors:n,onContinue:r}){const{assets:o}=ft(),i=a.useMemo(()=>{const l=(o||[]).length,c=l-n.length;return{totalAsset:l,totalValidAsset:c,isAllowContinue:c>0}},[o,n]);return e.jsxs(fe,{open:t,title:"Cannot import collaterals",onOk:s,onCancel:s,footer:[e.jsx(U,{onClick:s,children:"Close"},"back"),i.isAllowContinue&&e.jsx(U,{type:"primary",onClick:r,children:i.totalAsset===i.totalValidAsset&&"Continue"||"Continue Anyway"},"ok")||!1].filter(Boolean),children:[e.jsxs("div",{style:{fontSize:20,marginBottom:4,fontWeight:"bold"},children:[i.totalValidAsset,"/",i.totalAsset," collaterals valid"]}),!Ye(n)&&n.map(l=>e.jsxs("p",{children:[Number(l.rowId)+1,": ",l.msg]},l.rowId))]})}const _s=(t,s,n,r,o)=>{const i=[],l=!t.id,c=rt(Z(t,"currency.shortCode")),d=t.assets.reduce((u,p)=>u+(p.outstandingPrincipalAmount||0),0);return l||i.push({id:"avc1",title:e.jsx("b",{children:"Total Assets"}),isTitleOnly:!0,GBP:`${c} ${X(Z(o,"totalAssetsAmount",0))}`,assetsCount:X(Z(o,"totalAssets",0))}),i.push({id:"avc2",title:e.jsx("b",{children:"Excluded Assets"}),filterType:"exclusionFilter"}),s.map((u,p)=>{i.push({id:u.id,title:`${p+1}. ${u.name}`,GBP:`${c} ${X(Z(o,`excludedAssets[${u.id}].excludedAmount`,0))}`,assetsCount:X(Z(o,`excludedAssets[${u.id}].excludedAssets`,0)),criteria:u})}),l||i.push({id:"avc3",title:"Total Excluded Assets",GBP:`${c} ${X(Z(o,"excludedAssets.totalValue.totalExcludedValue",0))}`,assetsCount:X(Z(o,"excludedAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),l||i.push({id:"avc4",title:"Total 'Included' Outstanding Balance",GBP:`${c} ${X(Z(o,"totalAssetsAmount",0)-Z(o,"excludedAssets.totalValue.totalExcludedValue",0))}`,assetsCount:X(Z(o,"totalAssets",0)-Z(o,"excludedAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),i.push({id:"avc5",title:e.jsx("b",{children:"Ineligible Assets"}),filterType:"ineligibleFilter"}),n.map((u,p)=>{i.push({id:u.id,title:`${p+1}. ${u.name}`,GBP:`${c} ${X(Z(o,`ineligibleAssets[${u.id}].excludedAmount`,0))}`,assetsCount:X(Z(o,`ineligibleAssets[${u.id}].excludedAssets`,0)),criteria:u})}),l||i.push({id:"avc6",title:"Total Ineligible Assets",GBP:`${c} ${X(Z(o,"ineligibleAssets.totalValue.totalExcludedValue",0))}`,assetsCount:X(Z(o,"ineligibleAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),i.push({id:"avc7",title:e.jsx("b",{children:"Reserve Assets"}),filterType:"reserveFilter"}),r.map((u,p)=>{i.push({id:u.id,title:`${p+1}. ${u.name}`,GBP:`${c} ${X(Z(o,`reserveAssets[${u.id}].excludedAmount`,0))}`,assetsCount:X(Z(o,`reserveAssets[${u.id}].excludedAssets`,0)),criteria:u})}),l||i.push({id:"avc8",title:"Total Reserve Assets",GBP:`${c} ${X(Z(o,"reserveAssets.totalValue.totalExcludedValue",0))}`,assetsCount:X(Z(o,"reserveAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),l||i.push({id:"avc9",title:"Net Ineligible Assets Balance",GBP:`${c} ${X(d-Z(o,"ineligibleAssets.totalValue.totalExcludedValue",0)-Z(o,"reserveAssets.totalValue.totalExcludedValue",0))}`,assetsCount:X(Z(o,"totalAssets",0)-Z(o,"excludedAssets.totalValue.totalExcludedAssets",0)-Z(o,"ineligibleAssets.totalValue.totalExcludedAssets",0)-Z(o,"reserveAssets.totalValue.totalExcludedAssets",0)),isTitleOnly:!0}),i},yl=()=>{const{notification:t}=Ae.useApp(),{pool:s}=ce(),{stepAction:n,assets:r,setAssets:o}=ft(),[i,l]=a.useState(!1),{validateLoanAssets:c,loading:d}=fl(),[u,p]=a.useState(!1),[h,g]=a.useState(null),[v,f]=qe(te.getPoolFilterTemplates,s.id),j=a.useMemo(()=>Ye(v)?null:v.find(({isMain:A})=>A===1),[v]);console.log("filterTemplates:",v);const[M,y]=a.useState({}),[C,S]=a.useState(!1),E=a.useCallback(async A=>{var O,P;S(!0);try{const V=await c({templateId:A});y(V==null?void 0:V.assetsReport)}catch(V){t.error({description:((P=(O=V==null?void 0:V.response)==null?void 0:O.data)==null?void 0:P.message)??"Something wrong. Please try again"})}finally{S(!1)}},[c]);a.useEffect(()=>{s.id&&(j!=null&&j.id)&&!f&&E(j==null?void 0:j.id)},[s,j,E,f]);const m=a.useMemo(()=>(j==null?void 0:j.exclusionFilter)||[],[j==null?void 0:j.exclusionFilter]),x=a.useMemo(()=>(j==null?void 0:j.ineligibleFilter)||[],[j==null?void 0:j.ineligibleFilter]),D=a.useMemo(()=>(j==null?void 0:j.reserveFilter)||[],[j==null?void 0:j.reserveFilter]),_=s.id?_s(s,m,x,D,M):_s({assets:[],id:null},m,x,D,{}),T=s.id?[{title:"",dataIndex:"title",key:"title"},{title:"# Assets",dataIndex:"assetsCount",key:"assetsCount"},{title:"Outstanding Amount",dataIndex:"GBP",key:"GBP"}]:[{title:"",dataIndex:"title",key:"title"}],w=async()=>{var A,O;l(!0),g(null);try{const P=await c();if(Ye(P==null?void 0:P.errors))n.next();else{const V=Object.keys(P.errors).filter(b=>!Ye(P.errors[b])).map(b=>({rowId:Number(b),msg:P.errors[b].join(", ")}));if(!Ye(V)){p(!0),g(V);return}n.next()}}catch(P){t.error({description:((O=(A=P==null?void 0:P.response)==null?void 0:A.data)==null?void 0:O.message)??"Something wrong. Please try again"})}finally{l(!1)}};return e.jsx(ge,{gutter:[16],children:e.jsxs(ue,{xs:24,children:[j!=null&&j.id?e.jsx(ot,{loading:C,dataSource:_,columns:T,pagination:!1,rowKey:A=>A.id}):e.jsx(Re,{active:!0}),e.jsxs("div",{className:"flex justify-end mt-4",children:[e.jsx(U,{onClick:()=>{n.prev()},className:"mr-4",children:"Previous"}),e.jsx(U,{type:"primary",loading:f||d||i,disabled:f||d||i,onClick:w,children:"Next"})]}),u&&e.jsx(xl,{isOpen:u,onClose:()=>{p(!1)},errors:h||[],onContinue:()=>{const A=h.map(P=>+P.rowId),O=r.filter((P,V)=>!A.includes(V));o(O),setTimeout(()=>{n.next()})}})]})})},bl={[xe.LENDING]:"green",[xe.INVOICE]:"red",[xe.NOTE_TOKEN]:"blue"};function jl(t,s){switch(t){case xe.LENDING:return"Loan";case xe.INVOICE:return"Invoice";case xe.NOTE_TOKEN:return s===aa.SENIOR?"SOT":"JOT";default:return"No Data"}}function vl(){const{assets:t,startUploading:s,isUploading:n,stepAction:r,setSelectedAssets:o}=ft(),{pool:i,calculateDrawdownAmount:l}=ce(),[c,d]=a.useState(t.map((h,g)=>g));a.useEffect(()=>{o(t)},[t,o]);const u={selectedRowKeys:c,onChange:(h,g)=>{console.log(h),d(h),o(g)}},p=a.useMemo(()=>[{title:"Loan ID",dataIndex:"loanIdentifier"},{title:"Asset Type",dataIndex:"assetType",render:h=>e.jsx(Ja,{color:bl[h],children:jl(xe.LENDING)})},{title:"Outstanding balance",dataIndex:"outstandingPrincipalAmount",render:h=>h},{title:"Expected drawdown amount",dataIndex:"Expected drawdown amount",render:(h,g)=>l({finalMaturityDate:g.finalMaturityDate,amount:g.outstandingPrincipalAmount})},{title:"Loan Denomination Currency",dataIndex:"currencySymbol",render:h=>h},{title:"Loan Origination Date",dataIndex:"startedDate"},{title:"Final Maturity Date",dataIndex:"finalMaturityDate"}],[l]);return e.jsx(ge,{gutter:[16],children:e.jsxs(ue,{xs:24,children:[e.jsx(ot,{pagination:!1,scroll:{y:600,x:800},rowSelection:u,columns:p,dataSource:t.map((h,g)=>({key:g,...h}))}),e.jsxs("div",{className:"flex justify-end mt-4",children:[e.jsx(U,{onClick:()=>{r.prev()},className:"mr-2",children:"Previous"}),e.jsx(U,{type:"primary",loading:n,disabled:n,onClick:()=>{n||s()},children:"Upload"})]})]})})}function wl(){const t=gt();return e.jsx(ge,{gutter:[16],children:e.jsx(ue,{xs:24,md:{span:20,offset:2},children:e.jsx(Xe,{children:e.jsx("div",{children:e.jsxs("center",{style:{fontSize:24,color:"black",marginBottom:20},children:[e.jsx("img",{src:$n,alt:"img-success"}),e.jsx("div",{className:"font-bold mt-4 mb-4",children:"Assets uploaded"}),e.jsx("div",{className:"text-xs text-pool-card-info mb-4",children:"Once approved, your assets are ready to be minted and financed"}),e.jsx(U,{type:"primary",onClick:()=>{t("/portfolio/assets")},style:{marginTop:20},children:"Go to the asset dashboard"})]})})})})})}const Aa=({onClose:t,isOpen:s,isUpdatingAssets:n,reloadPool:r})=>{const{currentStep:o,stepAction:i}=ft(),[l]=qe(sa.getCountries),c=a.useMemo(()=>{if(!s&&!l)return null;switch(o){case 0:return e.jsx(ul,{});case 1:return e.jsx(gl,{isUpdatingAssets:n,countries:l,reloadPool:r,onClose:t});case 2:return e.jsx(yl,{reloadPool:r});case 3:return e.jsx(vl,{});case 4:return e.jsx(wl,{})}},[l,o,s,n,t,r]);return e.jsx(fe,{onCancel:()=>{t(),i.force(0)},footer:null,width:"100vw",style:{top:0,paddingBottom:0},open:s,className:"h-screen upload-asset-modal",children:e.jsx(ge,{children:e.jsxs(ue,{xs:{span:24},md:{span:16,offset:4},children:[e.jsx("div",{className:"flex justify-between",children:e.jsx("span",{className:"text-4xl font-bold",children:"Upload Collaterals"})}),e.jsx(Be,{}),e.jsxs(ut,{current:o,className:"mb-8",children:[e.jsx(ut.Step,{title:"Upload Data File"}),e.jsx(ut.Step,{title:"Map Data Fields"}),e.jsx(ut.Step,{title:"Review & Filter"}),e.jsx(ut.Step,{title:"Confirm upload"})]}),e.jsx("div",{children:c})]})})})};Aa.propTypes={onClose:ne.func,isOpen:ne.bool,isUpdatingAssets:ne.bool,reloadPool:ne.func};const Cl=t=>e.jsx(wa,{countries:t.countries,children:e.jsx(Aa,{...t})}),Al=({pool:t,event:s,auctionOverview:n,trusteeCompany:r,servicerCompany:o,currency:i={},enableJuniorToken:l=!1,enableSeniorToken:c=!1,canShowSeniorConfig:d=!0})=>{t.assetType,xe.LENDING,a.useMemo(()=>Me.getExtraInfoFromAssets(t),[t]);const[u,p]=a.useState(!1),[h,g]=a.useState(null),{setDraftingDocModalVisible:v}=ce(),f=a.useMemo(()=>t.minFirstLossCushion/Kt,[t.minFirstLossCushion]);return e.jsxs(e.Fragment,{children:[u&&e.jsx(Cs,{defaultHtmlParse:!0,poolId:t.id,showModal:()=>p(!0),visible:u,onClose:()=>p(!1),preSelectedDocumentId:h==null?void 0:h.documentId,disableCreateNew:!0,onCreateNewDocument:()=>v(!0)}),e.jsxs(ge,{gutter:30,style:{padding:20},"data-testid":"sale-note-review",children:[e.jsx(ue,{md:24,lg:12,children:e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative h-fit mb-4",children:[e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Note"})}),e.jsx(Be,{className:"my-3"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Note type"}),e.jsx("span",{className:"font-semibold",children:s.targetAmount&&s.juniorTargetAmount?"Dual Note":"Single Note"})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Trustee"}),e.jsx("span",{className:"font-semibold",children:Z(r,"companyLegalName","")})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Servicer"}),e.jsx("span",{className:"font-semibold",children:Z(o,"companyLegalName","")})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"First loss cushion"}),e.jsxs("span",{className:"font-semibold",children:[f,"%"]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Debt ceiling"}),e.jsxs("span",{className:"font-semibold",children:[X(new he(t.debtCeiling).div(10**i.decimals).toNumber())," ",rt(i.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Expiry date"}),e.jsx("span",{className:"font-semibold",children:s.investmentTerms>0?`${s.investmentTerms} days`:"Perpetual"})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Epoch duration"}),e.jsxs("span",{className:"font-semibold",children:[s.epochInterval," days"]})]})]})]})}),e.jsxs(ue,{md:24,lg:12,children:[l&&e.jsx(e.Fragment,{children:e.jsx(ge,{children:e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative w-full",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("b",{style:{color:"black"},children:"Junior Note"}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Target amount"}),e.jsxs("span",{className:"font-semibold",children:[X(s.juniorTargetAmount)," ",rt(i.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Start time"}),e.jsx("span",{className:"font-semibold",children:s.juniorStartTime.format("HH:mm:ss DD/MM/YYYY")})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Initial amount to start SOT sale"}),e.jsxs("span",{className:"font-semibold",children:[s.juniorInitialAmount," ",rt(i.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Minimum Bid"}),e.jsxs("span",{className:"font-semibold",children:[s.juniorMinimumBid," ",rt(i.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Junior subscription agreement"}),e.jsx("a",{className:"shrink-0",onClick:()=>{g({documentId:s.juniorLegalDocumentId}),p(!0)},children:e.jsx("span",{className:"text-[#4C7FEF] font-semibold",children:"View document"})})]})]})]})})}),d&&c&&e.jsx(e.Fragment,{children:e.jsxs(ge,{className:"pt-5",children:[e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative w-full",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("b",{style:{color:"black"},children:"Senior Note"}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Target amount"}),e.jsxs("span",{className:"font-semibold",children:[X(s.targetAmount)," ",rt(i.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Start time"}),e.jsx("span",{className:"font-semibold",children:s.startTime.format("HH:mm:ss DD/MM/YYYY")})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"APR"}),e.jsxs("span",{className:"font-semibold",children:[s.apy,"%"]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Minimum Bid"}),e.jsxs("span",{className:"font-semibold",children:[s.minimumBid," ",rt(i.shortCode)]})]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"Senior subscription agreement"}),e.jsx("a",{className:"shrink-0",onClick:()=>{g({documentId:s.legalDocumentId}),p(!0)},children:e.jsx("span",{className:"text-[#4C7FEF] font-semibold",children:"View document"})})]})]})]}),n.eventSaleType===We.eventSaleTypes.DUTCH_AUCTION&&e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{children:"End time"}),e.jsx("div",{children:ke(s.endTime).format("DD/MM/YYYY")})]})]})})]})]})]})},{Option:wt}=at,{Step:cs}=ut,$s=10**4,Sl=(t,s,n,r)=>r?s===0&&n===0?!1:s*100/(s+n)>=t:n>0,ds=2,Ws=1,_t=3,Nl=({pool:t,visible:s,onClose:n,reloadPool:r=()=>{}})=>{const{notification:o}=Ae.useApp(),{address:i,connector:l}=nt(),[c,d]=a.useState(0),u=a.useMemo(()=>t.minFirstLossCushion/$s,[t.minFirstLossCushion]),[p,h]=a.useState(Ws),[g,v]=a.useMemo(()=>u===0?[!1,!0]:u===100?[!0,!1]:[!0,!0],[u]),[f,j]=a.useState({firstLossCushion:u,currencyId:t.currencyId}),{bankAccountModalVisible:M,setBankAccountModalVisible:y}=ce(),[C]=qe(Dt.getAllCompanies),[S,E]=a.useState(null),[m,x]=a.useState(null),[D,_]=a.useState([]),[T,w]=a.useState(null),[A,O]=a.useState(null),[P,V]=a.useState([]),[b,R]=a.useState({eventSaleType:We.eventSaleTypes.NORMAL_SALE_SOT,intervalType:"Day",targetAmount:0,juniorTargetAmount:0,juniorInitialAmount:0,juniorMinBid:0}),[q,K]=a.useState(14);a.useEffect(()=>()=>{const ve=f.firstLossCushion;if(!isNaN(ve)&&t.assetValue>0){const I=pe((1-ve/100)*t.assetValue,2);R({...b,targetAmount:I,juniorTargetAmount:ve>0?pe(t.assetValue-I,2):0})}},[f]);const[B,N]=a.useState(!1),[J,le]=a.useState(!1),[me]=qe(se.getVaultDocuments,t.id,_e.category.LEGAL,_e.status.SIGNED),[ye,W]=a.useState(null),[Q,z]=a.useState(null),[oe,k]=a.useState(null),[be,$e]=a.useState(null),[Se]=qe(se.getVaultDocuments,t.id,_e.category.GENERAL),[Pe,L]=a.useState(null),[G,$]=a.useState(null),[ee,ae]=a.useState(null),[ie,H]=a.useState(!1),je=a.useCallback(async ve=>{const I=await Dt.getUsersByCompanyId(ve);_(I)},[]),de=t.currency.decimals;a.useEffect(()=>{p==_t&&(n(),r())},[p]),a.useEffect(()=>{S&&je(S)},[S]);const[Fe,Ve]=a.useState("");a.useEffect(()=>{(async()=>{const{walletAddress:I}=await ht.getLinkedWallet();Ve(I)})().then()},[]);const Ne=a.useCallback(async ve=>{const I=await Dt.getUsersByCompanyId(ve);V(I)},[]);a.useEffect(()=>{T&&Ne(T)},[T]),a.useEffect(()=>{s&&d(0)},[s]);const Ue=b.eventSaleType===We.eventSaleTypes.DIRECT_ALLOCATION,Y=a.useMemo(()=>u>0&&u<=100,[u]),Ce=a.useMemo(()=>u>0&&u<100,[u]);console.log("noteSetup - minFirstLoss"),console.log(u);const{loading:et,value:Ie}=ca(async()=>!(t!=null&&t.id)||M?void 0:(await te.getPoolLinkedWallet(t==null?void 0:t.id)).walletAddress,[t==null?void 0:t.id,M]),dt=async()=>{N(!0);const ve=b.targetAmount,I=b.juniorTargetAmount,jt=f.firstLossCushion;if(!Sl(jt,I,ve,Y)){o.error({message:"SOT Target Amount and JOT Target Amount must satisfy First Loss Cushion"}),N(!1);return}if(t&&t.debtCeiling&&b.juniorTargetAmount+b.targetAmount>Number(t.debtCeiling)){o.error({message:`Issuer can not set target investment amount > Debt ceiling (${t.debtCeiling})`}),N(!1);return}if(c===1){let xt=1;b.intervalType==="Hour"?xt=1/24:b.intervalType==="Minute"&&(xt=1/24/60);const vt={apy:b.apy,assetGeneralDocumentId:ee,benchmarkRate:b.benchmarkRate,creditRating:f.creditRating,endTime:b.endTime,eventSaleType:b.eventSaleType,firstLossCushion:f.firstLossCushion,generalDocumentId:Pe,investmentTerms:b.investmentTerm,epochInterval:q,juniorGeneralDocumentId:G,juniorInitialAmount:b.juniorInitialAmount,juniorInvestmentTerm:b.juniorInvestmentTerm,juniorLegalDocumentId:oe,juniorEntityLegalDocumentId:be,juniorMinimumBid:b.juniorMinBid,juniorStartTime:b.juniorStartTime,juniorTargetAmount:b.juniorTargetAmount,legalDocumentId:ye,entityLegalDocumentId:Q,minimumBid:b.minBid,paymentSchedule:b.paymentSchedule,priceChangePerInterval:b.priceChange,projectedAPY:f.projectedAPY,reservedAPY:b.maxAPY,securityRegistration:f.securityRegistration,seniority:f.seniority,servicerCompanyId:T,servicerMemberId:A,startAPY:b.minAPY,startEarningInterestTime:f.startEarningInterestTime,startTime:b.startTime,targetAmount:b.targetAmount,ticker:f.ticker,timeInterval:b.timeInterval*xt,tranchingAt:f.tranchingAt,trusteeCompanyId:S,trusteeMemberId:m};le(vt)}N(!1),d(c+1)},Sa=async()=>{if(N(!0),!await te.getPoolLinkedWallet(t==null?void 0:t.id))return N(!1),y(!0);try{if(i!=new bs().utils.toChecksumAddress(Fe))return N(!1),o.error({message:"Current wallet address is not valid.",description:`Please connect to wallet ${Fe}`});const I=J.ticker;await(async()=>{if(u<=0||u>=100||!J.targetAmount)return;const jt=pe(J.targetAmount*10**de).toLocaleString("fullwide",{useGrouping:!1}),xt=await ks(),vt=pe(b.minBid*10**de).toLocaleString("fullwide",{useGrouping:!1}),Ot={issuerTokenController:Fe,pool:t.poolContractAddress,minBidAmount:vt,ticker:I,totalCap:jt,openingTime:pe(new Date(J.startTime).getTime()/1e3),saleType:J.eventSaleType};console.log("noteSetup - (event)"),console.log(J);const Rt=jt,Vt=b.apy*$s;console.log("initialJOTAmount",{tgeParam:Ot,cap:Rt,interestRate:Vt});const ts=await xt.send("setUpTGEForSOT",[Ot,Vt]),Ia=await Me.waitForTransactionReceipt(ts,l==null?void 0:l.id);await Mt(te.checkSOTEvent,[t.id,Ia.transactionHash],3e3)})(),N(!1),Le.success("The sale is launching, please wait for a few minute."),h(_t)}catch(I){console.log("ERR",I),Le.error({title:"Transaction failed",content:I.message}),N(!1)}},Na=async()=>{try{N(!0);const ve=await ks(),I=pe(J.juniorTargetAmount*10**de).toLocaleString("fullwide",{useGrouping:!1}),jt=pe(J.juniorInitialAmount*10**de).toLocaleString("fullwide",{useGrouping:!1}),xt=pe(b.juniorMinBid*10**de).toLocaleString("fullwide",{useGrouping:!1}),vt={issuerTokenController:Fe,pool:t.poolContractAddress,minBidAmount:xt,totalCap:I,openingTime:pe(new Date(J.juniorStartTime).getTime()/1e3),ticker:J.ticker,saleType:We.eventSaleTypes.NORMAL_SALE_JOT},Ot=I,Rt=jt;console.log("initialJOTAmount",{tgeParam:vt,jotCap:Ot,initialJOTAmount:Rt});const Vt=await ve.send("setUpTGEForJOT",[vt,Rt]),ts=await Me.waitForTransactionReceipt(Vt,l==null?void 0:l.id);await Mt(te.checkJOTEvent,[t.id,ts.transactionHash],3e3),await te.createEvent(t.id,Xs(J,["apy","assetGeneralDocumentId","firstLossCushion","generalDocumentId","investmentTerms","epochInterval","juniorGeneralDocumentId","juniorInvestmentTerm","juniorLegalDocumentId","juniorEntityLegalDocumentId","legalDocumentId","entityLegalDocumentId","servicerCompanyId","servicerMemberId","trusteeCompanyId","trusteeMemberId"])),N(!1),v?h(ds):(h(_t),Le.success("The sale is launching, please wait for a few minute."))}catch(ve){console.log("ERR",ve),Le.error({title:"Transaction failed",content:ve.message}),N(!1)}},Xt=!f.firstLossCushion||f.firstLossCushion<=100,es=a.useMemo(()=>{switch(c){case 0:return!f.ticker||!S||!m||!T||!A||b.investmentTerm==null||Ce&&(!Object.values(We.eventSaleTypes).includes(b.eventSaleType)||!ye||!Q)?!0:Y&&(!b.juniorInvestmentTerm==null||!oe||!be);case 1:{let ve=!0;v&&(b==null?void 0:b.eventSaleType)===We.eventSaleTypes.NORMAL_SALE_SOT&&(ve=b.apy>0&&b.startTime&&!us(b.minBid));let I=!0;return g&&(I=!us(b.juniorMinBid)&&b.juniorStartTime),!ve||!I}}},[b.apy,b.eventSaleType,b.investmentTerm,b.juniorInvestmentTerm,b.juniorMinBid,b.juniorStartTime,b.minBid,b.startTime,c,Q,g,v,Y,Ce,be,oe,ye,f.ticker,T,A,S,m]),As={header:{backgroundColor:"transparent"},content:{borderRadius:24,backgroundColor:"#F0F0F0"}};if(!et&&!Ie)return e.jsx(fe,{centered:!0,title:"Link your wallet",open:s,styles:As,okText:"Link wallet",icon:null,okButtonProps:{className:"bg-[#1ED760] hover:bg-[#1ED760] shadow-none h-11 text-black w-30",style:{backgroundColor:"#1ED760"},type:"primary"},cancelButtonProps:{className:"bg-[#25272614] shadow-none h-11 w-20",type:"disable"},cancelText:"Cancel",width:"30vw",style:{minWidth:500},onCancel:()=>{n(),d(0)},onOk:()=>y(!0),children:e.jsxs("div",{className:"my-6",children:[e.jsx("p",{children:"You have not link your wallet to the pool yet"}),e.jsx("p",{className:"font-semibold",children:"Please, link the wallet first to continue."})]})});if(!et&&Ie){let ve;return p==ds?ve=e.jsx(U,{className:"shadow-none w-40 h-12",loading:B,disabled:es,onClick:()=>Sa(),type:"primary",children:"Set up SOT"}):p==Ws&&(ve=e.jsx(U,{className:"shadow-none w-40 h-12",loading:B,disabled:es,onClick:()=>Na(),type:"primary",children:v?"Set up JOT":"Issue note"})),e.jsxs(fe,{onCancel:()=>{n(),d(0)},footer:null,width:"64vw",open:s,style:{minWidth:500,paddingBottom:0},styles:As,children:[ie&&e.jsx(na,{visible:ie,onClose:()=>H(!1),onSubmit:void 0,legalDocumentId:oe}),e.jsxs("div",{className:"sm:w-full lg:w-2/3 xl:w-1/2 m-auto mt-5",children:[e.jsxs(ut,{current:c,labelPlacement:"vertical",type:"default",className:"whitespace-nowrap mb-4",children:[e.jsx(cs,{title:"Structure note",className:"font-semibold"}),e.jsx(cs,{title:"Structure sale",className:"font-semibold"}),e.jsx(cs,{title:"Launch sale",className:"font-semibold"})]}),!et&&!Ie&&e.jsx("div",{style:{marginTop:4},children:e.jsx(Zs,{message:e.jsxs(e.Fragment,{children:["You have not linked wallet to the pool. Pool-2-pool investment cannot be made without linked wallet."," ",e.jsx(U,{variant:"link",onClick:()=>{y(!0)},children:"setup here"})]}),type:"warning",showIcon:!0})}),s&&c===0&&e.jsxs(F,{labelCol:{span:24},wrapperCol:{span:24},"data-testid":"sale-note-setup",children:[e.jsx(F.Item,{name:"ticker",label:"Ticker",className:"mb-4",children:e.jsx(De,{placeholder:"Ticker",maxLength:10,id:"ticker",value:f.ticker,onChange:I=>j({...f,ticker:I.target.value})})}),e.jsx(F.Item,{name:"general_document",label:"General document",className:"mb-4",children:e.jsx(Te,{placeholder:"Select/ Enter general document",items:Se,nameKey:"name",dateKey:"createdAt",selectedValue:Pe,onSelect:I=>{L(I),$(I)}})}),e.jsxs("div",{className:"flex flex-row gap-3",children:[e.jsx("div",{className:"w-1/2",children:e.jsx(F.Item,{label:"Trustee",className:"mb-4",children:e.jsx(Ms,{isCompany:!0,notShowAtBegin:!0,items:C,allowNewValue:!1,nameKey:"companyLegalName",placeholder:"Select/ Enter trustee",selectedValue:S,onSelect:I=>E(I)})})}),e.jsx("div",{className:"w-1/2",children:e.jsx(F.Item,{label:"Trustee Email",className:"mb-4",children:e.jsx(Te,{isMember:!0,items:D||[],allowNewValue:!1,nameKey:"email",placeholder:"Select/ Enter trustee email",selectedValue:m,onSelect:I=>x(I)})})})]}),e.jsxs("div",{className:"flex flex-row gap-3",children:[e.jsx("div",{className:"w-1/2",children:e.jsx(F.Item,{label:"Servicer",className:"mb-4",children:e.jsx(Ms,{isCompany:!0,notShowAtBegin:!0,items:C,allowNewValue:!1,nameKey:"companyLegalName",placeholder:"Select/ Enter servicer",selectedValue:T,onSelect:I=>w(I)})})}),e.jsx("div",{className:"w-1/2",children:e.jsx(F.Item,{name:"servicer_email",label:"Servicer Email",className:"mb-4",children:e.jsx(Te,{isMember:!0,items:P||[],allowNewValue:!1,nameKey:"email",placeholder:"Select/ Enter servicer email",selectedValue:A,onSelect:I=>O(I)})})})]}),e.jsx(F.Item,{label:"First Loss Cushion",className:"mb-4",children:e.jsx(Oe,{className:"w-full",suffix:"%",placeholder:"First Loss Cushion (%)",value:f.firstLossCushion,disabled:!0})}),f.tranchingAt=="asset"&&e.jsx(F.Item,{name:"general_document",label:"General document",className:"mb-4",children:e.jsx(Te,{placeholder:"General document",items:Se,nameKey:"name",selectedValue:ee,onSelect:I=>ae(I)})}),e.jsx(F.Item,{label:"Currency",className:"mb-4",children:e.jsx(De,{value:t.currency.shortCode,showSearch:!0,id:"currency",placeholder:"Currency",disabled:!0})}),e.jsx(F.Item,{label:"Expiry date",className:"mb-4",children:e.jsx(Oe,{min:0,className:"w-full",precision:0,suffix:"Day(s)",value:b.investmentTerm,placeholder:"Expiry date",onChange:I=>R({...b,investmentTerm:I,juniorInvestmentTerm:I})})}),e.jsx(F.Item,{label:"Epoch withdrawal duration",children:e.jsx(Oe,{min:0,precision:0,className:"w-full",suffix:"Day(s)",type:"input-number",placeholder:"Epoch withdrawal duration",value:q,onChange:I=>K(I)})}),Xt&&Ce&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Senior Note"})}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsx(F.Item,{hidden:!0,children:e.jsxs(re,{type:"select",value:b.eventSaleType,style:{width:"100%",marginTop:10},placeholder:"Sale type",onChange:I=>R({...b,eventSaleType:I}),children:[e.jsx(wt,{value:We.eventSaleTypes.DUTCH_AUCTION,children:"Auction"}),e.jsx(wt,{value:We.eventSaleTypes.NORMAL_SALE_SOT,children:"Normal Sale"})]})}),e.jsx(F.Item,{label:"Target Amount",className:"mb-4",children:e.jsx(Oe,{min:0,className:"w-full",type:"input-number",placeholder:"Target Amount",precision:2,value:b.targetAmount,suffix:t.currency.shortCode,disabled:t.assetValue>0,onChange:I=>R({...b,targetAmount:I})})}),e.jsx(F.Item,{label:"Legal document",className:"mb-4",children:e.jsx(Te,{placeholder:"Legal document",items:me.filter(I=>I.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:ye,onSelect:I=>W(I)})}),e.jsx(F.Item,{label:"Corporate Legal document",className:"mb-4",children:e.jsx(Te,{placeholder:"Corporate Legal document",items:me.filter(I=>I.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:Q,onSelect:I=>z(I)})})]}),Y&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative mt-6",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Junior Note"})}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsx(F.Item,{hidden:!0,children:e.jsx(re,{type:"select",value:b.juniorEventSaleType||We.eventSaleTypes.DIRECT_ALLOCATION,style:{width:"100%",marginTop:10},placeholder:"Sale type",onChange:I=>R({...b,junioEventSaleType:I}),children:e.jsx(wt,{value:We.eventSaleTypes.DIRECT_ALLOCATION,children:"Normal Sale"})})}),e.jsx(F.Item,{label:"Target Amount",className:"mb-4",children:e.jsx(Oe,{min:0,className:"w-full",type:"input-number",placeholder:"Target Amount",suffix:t.currency.shortCode,precision:2,value:b.juniorTargetAmount,disabled:t.assetValue>0,onChange:I=>R({...b,juniorTargetAmount:I})})}),e.jsx(F.Item,{label:"Initial JOT",className:"mb-4",children:e.jsx(Oe,{className:"w-full",min:0,placeholder:"Initial JOT",precision:2,value:b.juniorInitialAmount,suffix:t.currency.shortCode,disabled:t.assetValue>0,onChange:I=>R({...b,juniorInitialAmount:I})})}),e.jsx(F.Item,{label:"Legal document",children:e.jsx(Te,{placeholder:"Legal document",items:me.filter(I=>I.isSign),nameKey:"name",dateKey:"createdAt",selectedValue:oe,onSelect:I=>k(I)})}),e.jsx(F.Item,{label:"Corporate Legal document",className:"mb-4",children:e.jsx(Te,{placeholder:"Corporate Legal document",items:me.filter(I=>I.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:be,onSelect:I=>$e(I)})})]})]}),s&&c===1&&e.jsxs(F,{labelCol:{span:24},wrapperCol:{span:24},children:[Xt&&Ce&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Senior Note"})}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),!Ue&&e.jsxs(e.Fragment,{children:[e.jsx(F.Item,{label:"Start time",className:"mb-4",children:e.jsx(re,{type:"date-picker",placeholder:"Select start time",value:b.startTime,onChange:I=>R({...b,startTime:I})})}),b.eventSaleType===We.eventSaleTypes.DUTCH_AUCTION&&e.jsx(re,{style:{marginTop:20},type:"date-picker",placeholder:"End time",value:b.endTime,onChange:I=>R({...b,endTime:I})})]}),[We.eventSaleTypes.SIMPLE_SUBSCRIPTION,We.eventSaleTypes.DIRECT_ALLOCATION,We.eventSaleTypes.NORMAL_SALE_SOT].includes(b.eventSaleType)?e.jsx(F.Item,{label:"APY",className:"mb-4",children:e.jsx(Oe,{className:"w-full",value:b.apy,placeholder:"Enter APY",suffix:"%",onChange:I=>R({...b,apy:I})})}):e.jsxs(e.Fragment,{children:[e.jsx(re,{style:{marginTop:20},placeholder:"Start APY (%)",value:b.minAPY,onChange:I=>R({...b,minAPY:I.target.value})}),e.jsx(re,{style:{width:"100%",marginTop:20},placeholder:"Reserved APY (%)",value:b.maxAPY,onChange:I=>R({...b,maxAPY:I.target.value})}),e.jsxs(ge,{gutter:16,children:[e.jsx(ue,{span:12,children:e.jsx(re,{value:b.timeInterval,style:{width:"100%",marginTop:20},placeholder:"Time interval",onChange:I=>R({...b,timeInterval:I.target.value})})}),e.jsx(ue,{span:12,children:e.jsxs(re,{type:"select",value:b.intervalType,style:{width:"100%",marginTop:20},placeholder:"Interval Type",onChange:I=>R({...b,intervalType:I}),children:[e.jsx(wt,{value:"Day",children:"Day"}),e.jsx(wt,{value:"Hour",children:"Hour"}),e.jsx(wt,{value:"Minute",children:"Minute"})]})})]}),e.jsx(re,{value:b.priceChange,style:{width:"100%",marginTop:20},placeholder:"Price change at each interval (%)",onChange:I=>R({...b,priceChange:I.target.value})})]}),e.jsx(F.Item,{label:"Minimum Bid",className:"mb-4",children:e.jsx(Oe,{className:"w-full",placeholder:"Enter minimum bid",value:b.minBid,onChange:I=>R({...b,minBid:I})})})]}),Y&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative mt-6",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Junior Note"})}),e.jsx("div",{className:"h-[1px] bg-[#25272614] my-4"}),e.jsx(F.Item,{className:"mb-4",label:"Start time",children:e.jsx(re,{type:"date-picker",placeholder:"Select start time",value:b.juniorStartTime,onChange:I=>R({...b,juniorStartTime:I})})}),e.jsx(F.Item,{label:"Minimum Bid",className:"mb-4",children:e.jsx(Oe,{min:0,className:"w-full",placeholder:"Enter minimum bid",value:b.juniorMinBid,onChange:I=>R({...b,juniorMinBid:I})})})]})]})]}),e.jsx("div",{children:s&&c===2&&e.jsx(Al,{pool:t,event:J,auctionOverview:b,isDirectAllocation:Ue,enableJuniorToken:Y,enableSeniorToken:Ce,trusteeCompany:C.find(I=>I.id==S),servicerCompany:C.find(I=>I.id==T),currency:t.currency,canShowSeniorConfig:Xt})}),e.jsxs("div",{className:"w-full flex justify-end gap-4 mt-4",children:[c>0&&p!=_t&&!(g&&p==ds)&&e.jsx(U,{onClick:()=>d(I=>I-1),type:"disable",className:"shadow-none w-40 h-12 bg-[#25272614] hover:bg-[#25272614]",children:"Previous"}),c===0&&e.jsx("div",{}),c==2&&ve,c!=2&&e.jsx(U,{className:"shadow-none w-40 h-12",loading:B,disabled:es,onClick:()=>dt(),type:"primary",children:"Continue"})]})]})}},Il=({pool:t,noteType:s="SOT",poolEvent:n,visible:r,onClose:o,reloadPool:i=()=>{}})=>{const{notification:l,message:c}=Ae.useApp(),d=t.currency.decimals,{connector:u}=nt(),[p,h]=a.useState(new he(n.targetAmount).div(10**d).toNumber()),[g,v]=a.useState(new he(n.juniorTargetAmount).div(10**d).toNumber()),[f,j]=a.useState(new he(n.minimumBid).div(10**d).toNumber()),[M,y]=a.useState(new he(n.juniorMinimumBid).div(10**d).toNumber()),[C,S]=a.useState(!1),[E,m]=a.useState(n.legalDocumentId),[x,D]=a.useState(n.entityLegalDocumentId),[_,T]=a.useState(n.generalDocumentId),[w,A]=a.useState(n.juniorLegalDocumentId),[O,P]=a.useState(n.juniorEntityLegalDocumentId),V=n.yieldValue,[b]=qe(se.getVaultDocuments,t.id,_e.category.LEGAL,_e.status.SIGNED),[R]=qe(se.getVaultDocuments,t.id,_e.category.GENERAL),q=async N=>{if(t&&t.debtCeiling&&N.targetAmount+N.juniorTargetAmount>Number(t.debtCeiling)){l.error({message:`Issuer can not set target investment amount > Debt ceiling (${t.debtCeiling})`});return}if(!isNaN(N.targetAmount)&&N.targetAmount+N.juniorTargetAmount<0)return c.error("Junior minimum bid must not be less than 0");const J=N.targetAmount*10**d,le=N.minimumBid*10**d,me=N.juniorTargetAmount*10**d,ye=N.juniorMinimumBid*10**d,W=n.targetAmount!==J||n.minimumBid!==le,Q=n.juniorTargetAmount!==me||n.juniorMinimumBid!==ye;if(n.saleEventAddress&&!W||n.juniorSaleEventAddress&&!Q)return;const{walletAddress:z}=await ht.getLinkedWallet(),oe=[n.saleEventAddress&&{tgeAddress:n.saleEventAddress,totalCap:pe(N.targetAmount*10**d).toLocaleString("fullwide",{useGrouping:!1}),minBidAmount:pe(N.minimumBid*10**d).toLocaleString("fullwide",{useGrouping:!1})},n.juniorSaleEventAddress&&{tgeAddress:n.juniorSaleEventAddress,totalCap:pe(N.juniorTargetAmount*10**d).toLocaleString("fullwide",{useGrouping:!1}),minBidAmount:pe(N.juniorMinimumBid*10**d).toLocaleString("fullwide",{useGrouping:!1})}].filter(Boolean),be=await(await getSecuritizationManagerContractWagmi()).send("updateTgeInfo",[oe]);await Me.waitForTransactionReceipt(be,u==null?void 0:u.id)},K=a.useCallback(async()=>{S(!0);try{const N={yieldValue:pe(+V,2),targetAmount:pe(+p,2),minimumBid:pe(+f,2),legalDocumentId:E,entityLegalDocumentId:x,generalDocumentId:_,juniorLegalDocumentId:w,juniorEntityLegalDocumentId:O,juniorTargetAmount:pe(+g,2),juniorMinimumBid:pe(+M,2)};if(console.log("dataToUpdate",N),isNaN(N.yieldValue)||N.yieldValue<0)return c.error("Yield must not be less than 0");await q(N),await te.updateNote(t.id,Xs(N,["legalDocumentId","entityLegalDocumentId","generalDocumentId","juniorLegalDocumentId","juniorEntityLegalDocumentId"])),o(),i(),c.success("Note issuance has been updated")}catch(N){console.log(N),l.error({message:N.message||"Something went wrong!"})}finally{S(!1)}},[x,_,O,w,M,g,E,c,f,l,o,t.id,i,p,V]),B={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(fe,{onCancel:o,footer:null,width:"40vw",open:r,style:{minWidth:500},styles:B,children:e.jsxs("div",{className:"bg-transparent",children:[e.jsxs("p",{className:"font-medium text-lg mb-6",children:["Update ",s=="SOT"?"senior":"junior"," note issuance"]}),e.jsxs(F,{wrapperCol:{span:24},labelCol:{span:24},children:[e.jsx(F.Item,{label:"Collateral value",children:e.jsx(Oe,{placeholder:"Collateral value",value:t.assetValue,disabled:!0})}),s=="SOT"&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative h-fit mb-4",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Senior note"})}),e.jsx(Be,{className:"my-3"}),e.jsx(F.Item,{label:"Debt Ceiling",className:"mb-4",children:e.jsx(Oe,{placeholder:"Debt Ceiling",className:"w-full",suffix:t.currency.shortCode,min:0,precision:2,value:X(p),disabled:!0})}),e.jsx(F.Item,{label:"Minimum Bid",className:"mb-4",children:e.jsx(Oe,{className:"w-full",placeholder:"Minimum Bid",suffix:t.currency.shortCode,value:f,min:0,onChange:N=>j(N)})}),e.jsx(F.Item,{label:"Legal document",className:"mb-4",children:e.jsx(Te,{placeholder:"Legal document",items:b.filter(N=>N.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:E,onSelect:N=>m(N)})}),e.jsx(F.Item,{label:"Corporate Legal document",className:"mb-4",children:e.jsx(Te,{placeholder:"Corporate Legal document",items:b.filter(N=>N.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:x,onSelect:D})}),e.jsx(F.Item,{label:"General document",className:"mb-4",children:e.jsx(Te,{placeholder:"General document",items:R,nameKey:"name",dateKey:"createdAt",selectedValue:_,onSelect:N=>T(N)})})]}),s=="JOT"&&e.jsxs("div",{className:"rounded-2xl bg-[#2527260A] p-4 relative h-fit mb-4",children:[e.jsx("div",{className:"w-1.5 h-5 bg-gradient-to-r from-green-500 to-blue-400 rounded-e-md absolute left-0"}),e.jsx("p",{className:"my-0",children:e.jsx("b",{children:"Junior note"})}),e.jsx(Be,{className:"my-3"}),e.jsx(F.Item,{label:"Debt Ceiling",className:"mb-4",children:e.jsx(Oe,{min:0,className:"w-full",suffix:t.currency.shortCode,precision:2,placeholder:"Debt Ceiling",value:X(g),disabled:!0})}),e.jsx(F.Item,{label:"Minimum Bid",className:"mb-4",children:e.jsx(Oe,{min:0,className:"w-full",suffix:t.currency.shortCode,placeholder:"Minimum Bid",value:M,onChange:N=>y(N)})}),e.jsx(F.Item,{label:"Legal document",className:"mb-4",children:e.jsx(Te,{placeholder:"Legal document",items:b.filter(N=>N.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:w,onSelect:N=>A(N)})}),e.jsx(F.Item,{label:"Corporate Legal document",className:"mb-4",children:e.jsx(Te,{placeholder:"Corporate Legal document",items:b.filter(N=>N.isSign),dateKey:"createdAt",nameKey:"name",selectedValue:O,onSelect:P})}),e.jsx(F.Item,{label:"General document",className:"mb-4",children:e.jsx(Te,{placeholder:"General document",items:R,nameKey:"name",dateKey:"createdAt",selectedValue:_,onSelect:N=>T(N)})})]}),e.jsx("div",{style:{width:"100%",marginTop:20},children:e.jsx(U,{className:"shadow-none w-full mb-4 h-11",loading:C,disabled:!1,onClick:K,type:"primary",children:"Update"})})]})]})})};function Tl({poolContractAddress:t,decimals:s}){const[n,r]=a.useState(void 0),[o,i]=a.useState(!1),l=a.useCallback(async()=>{i(!0);try{const u=await(await Qt(t)).methods.reserve().call();r(u)}catch(d){console.log({e:d})}i(!1)},[t]);a.useEffect(()=>{t&&l()},[l,t]);const c=a.useMemo(()=>{if(!Wt(n))return new he(n).dividedBy(new he(10).pow(s)).toString()},[n,s]);return{reserveBalance:n,formattedBalance:c,loading:o}}const kl={open:1,close:2,executing:3,executed:4};function Dl(){var le,me,ye;const{pool:t}=ce(),{message:s}=Ae.useApp(),{formattedBalance:n}=Tl({poolContractAddress:t.poolContractAddress,decimals:(le=t==null?void 0:t.currency)==null?void 0:le.decimals}),r=(me=t==null?void 0:t.currency)==null?void 0:me.shortCode,[o,i]=a.useState([]),[l,c]=a.useState(!1),[d,u]=a.useState({startEpoch:"",endEpoch:"",enabledStartTransaction:!1,formattedSotPrice:"",formattedJotPrice:"",totalSotPrice:"",totalJotPrice:"",totalwithdraw:""}),[p,h]=a.useState(0),[g,v]=a.useState(),[f,j]=a.useState(!1),[M,y]=a.useState(!1),[C,S]=a.useState(!1),{address:E,connector:m}=nt();zn();const[x,D]=a.useState(!1),[_,T]=a.useState(!1),[w,A]=a.useState([]);Zt(async()=>{const W=await Me.getVaultModules(t);v(W[0]);const Q=await as(W[0]);console.log("epochList.tsx - withdrawModuleContract"),console.log(W[0]);const z=await Q.call("totalSharesWithdraw",[]);console.log("epochList.tsx - totalSharesWithdraw"),console.log(z),console.log("epochList.tsx - Number(totalSharesWithdraw.toString()"),console.log(Number(z.toString())),h(Number(z.toString())/10**Yt)});const O=async()=>{j(!0);try{i([].filter(Q=>Q.requestUsd!=0)||[])}catch(W){console.log(W)}j(!1)},P=async()=>{var W,Q,z,oe;y(!0);try{const k=[],be=await vn();k!=null&&k.sotTokenAddress&&c(!0);let $e=0,Se=0;k!=null&&k.jotTokenAddress&&(k!=null&&k.sotTokenAddress)?[$e,Se]=await be.methods.getTokenPrices([k==null?void 0:k.poolAddress,k==null?void 0:k.poolAddress],[k==null?void 0:k.sotTokenAddress,k==null?void 0:k.jotTokenAddress]).call():k!=null&&k.jotTokenAddress?[Se]=await be.methods.getTokenPrices([k==null?void 0:k.poolAddress],[k==null?void 0:k.jotTokenAddress]).call():k!=null&&k.sotTokenAddress&&([$e]=await be.methods.getTokenPrices([k==null?void 0:k.poolAddress],[k==null?void 0:k.sotTokenAddress]).call());const Pe=Number(lt($e,t.currency.decimals)),L=Number(lt(Se,t.currency.decimals)),G=Number(lt(k==null?void 0:k.totalSot,t.currency.decimals)),$=Number(lt(k==null?void 0:k.totalJot,t.currency.decimals)),ee=Pe*G||0,ae=L*$||0;u({startEpoch:ke((W=k==null?void 0:k.epoch)==null?void 0:W.startEpoch).format("DD/MM/YYYY"),endEpoch:ke.unix((Q=k==null?void 0:k.epoch)==null?void 0:Q.endEpoch).format("HH:mm DD/MM/YYYY"),enabledStartTransaction:ke(new Date).isAfter(ke((z=k==null?void 0:k.epoch)==null?void 0:z.endEpoch)),status:(oe=k==null?void 0:k.epoch)==null?void 0:oe.status,formattedTotalSot:G,formattedTotalJot:$,formattedSotPrice:X(Pe),formattedJotPrice:X(L),totalSotPrice:X(ee),totalJotPrice:X(ae),totalwithdraw:X(ee+ae)})}catch(k){console.log(k)}y(!1)};a.useEffect(()=>{O(),P()},[]);const V=async()=>{S(!0);try{if(String(E).toLowerCase()!==String(t.safeWalletAddress).toLowerCase())return S(!1),Ke.error({message:`Current wallet address is not valid.
            Please connect to wallet
            ${t.safeWalletAddress}`});const W=await zt(js.contracts.Vault),Q=await as(g),z=N*p*10**Yt/100;console.log("epochList.tsx - _openAmount"),console.log(z);const oe=await Q.send("open",[z]),k=await Me.waitForTransactionReceipt(oe,m.id);P(),s.success("Epoch execution started")}catch{s.error("Start epoch failed")}S(!1)},b=async()=>{D(!0);try{if(String(E).toLowerCase()!==String(t.safeWalletAddress).toLowerCase())return D(!1),Ke.error({message:`Current wallet address is not valid.
            Please connect to wallet
            ${t.safeWalletAddress}`});const W=await Me.getVaultModules(t),Q=await as(W[0]);console.log("epochList.tsx - moduleAddresses[0]"),console.log(W[0]);const z=await Q.send("close",[]),oe=await Me.waitForTransactionReceipt(z,m.id);P(),s.success("Epoch closed successfully")}catch{s.error("Close epoch failed")}finally{D(!1)}},R=async W=>{T(!0);try{const Q=await te.getListEpochTransactionHistory(t.id,W);A(Q||[])}catch(Q){console.log(Q)}},q=[{title:"TxHash",dataIndex:"tx",key:"tx",render:W=>e.jsx("a",{target:"_blank",rel:"noreferrer",href:da(W),children:W})},{title:"Created At",dataIndex:"createdAt",key:"createdAt",render:W=>ke.unix(W).format("DD/MM/YYYY HH:mm:ss")}],K=[{title:"Start date",dataIndex:"startTime",key:"startTime",defaultSortOrder:"descend",render:(W,Q)=>W?ke.unix(W).format("DD/MM/YYYY"):ke.unix(Q.startTime).format("DD/MM/YYYY"),sorter:(W,Q)=>W.startTime-Q.startTime},{title:"Requested",dataIndex:"requestUsd",key:"requestUsd",align:"right",render:W=>X(ct(W,t.currency.decimals))},{title:"Executed",key:"executedUsd",align:"right",dataIndex:"executedUsd",render:W=>X(ct(W,t.currency.decimals))},{title:"% Executed",align:"right",key:"executed",render:(W,Q)=>{const z=Z(Q,"executedUsd",0),oe=Z(Q,"requestUsd",0);return`${pe(Number(z)===0?0:Number(z)/Number(oe)*100)}%`}},{title:"Rolled over",key:"rolledover",align:"right",render:(W,Q)=>{const z=Z(Q,"executedUsd",0),oe=Z(Q,"requestUsd",0);return`${X(ct(Number(oe)-Number(z),t.currency.decimals))}`}},{title:"",key:"option",render:(W,Q)=>e.jsx(U,{type:"primary",onClick:()=>R(Q==null?void 0:Q.epochId),children:"View transactions"})}],B=a.useMemo(()=>za(Qa(kl,W=>W==d.status)),[d]),[N,J]=a.useState(0);return e.jsxs(e.Fragment,{children:[e.jsx(fe,{width:"50%",title:"Epoch execution transactions",open:_,footer:null,onCancel:()=>T(!1),children:e.jsx(ot,{columns:q,dataSource:w||[],pagination:!1,size:"large",rowKey:W=>W.subId})}),M?e.jsx(Re,{active:!0}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex flex-row justify-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"shrink-0 grow bg-gray-50 border border-solid border-[#25272629] rounded-2xl",children:[e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Reserve balance ",(ye=t==null?void 0:t.currency)==null?void 0:ye.shortCode]}),e.jsx("p",{className:"font-semibold text-lg mt-2",children:X(n)}),e.jsx(Za,{marks:{[N]:{label:`${X(N)}`,style:{top:-56,padding:8,backgroundColor:"#1AB752",borderRadius:8,fontStyle:"bold",color:"black"}}},max:Math.max(0,100),className:"w-80 mt-14 ml-5",onChange:J,value:N,tooltip:{open:!1,formatter:W=>e.jsxs("span",{children:[W,"%"]})}}),e.jsx("div",{className:"h-10",children:e.jsx(U,{type:"primary",onClick:V,loading:C,disabled:!1,children:"Fulfill request"})})]}),e.jsx(Be,{className:"my-0"}),e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"mb-3 text-md font-bold",children:"Current epoch"}),e.jsxs("div",{className:"mb-3 flex flex-row justify-between items-center",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Status"}),e.jsx("span",{className:"text-md font-bold",children:B})]}),e.jsxs("div",{className:"flex flex-row justify-between items-center",children:[e.jsx("span",{className:"text-xs text-gray-500 mr-2",children:"Total shares withdraw"}),e.jsx("span",{className:"text-md font-bold",children:p})]})]})]}),e.jsxs("div",{className:"basis-[40%] grow bg-gray-50 p-6 border border-solid border-[#25272629] rounded-2xl",children:[e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx("div",{className:"text-md font-bold",children:"Withdrawal Request"}),e.jsx("div",{children:e.jsx(U,{type:"primary",onClick:b,loading:x,disabled:!1,children:"Close epoch"})})]}),e.jsx(Be,{className:"my-4"}),l&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row justify-between gap-4",children:[e.jsxs("div",{className:"pr-6 gap-1",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"SOT amount"}),e.jsx("div",{className:"text-md font-bold",children:d.formattedTotalSot})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"rounded-full bg-[#25272614] w-6 h-6 flex justify-center items-center",children:e.jsx("div",{className:"border w-2 h-2 border-solid rotate-45"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Token Price (",r,")"]}),e.jsx("div",{className:"text-md font-bold",children:d.formattedSotPrice})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"rounded-full bg-[#25272614] w-6 h-6 flex justify-center items-center",children:e.jsx("div",{className:"border w-2 h-2 border-solid rotate-45"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Withdrawal amount (",r,")"]}),e.jsx("div",{className:"text-md font-bold",children:d.totalSotPrice})]})]})]}),e.jsx(Be,{})]}),e.jsxs("div",{className:"flex flex-row justify-between gap-4",children:[e.jsxs("div",{className:"pr-6",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"JOT amount"}),e.jsx("div",{className:"text-md font-bold",children:d.formattedTotalJot})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"rounded-full bg-[#25272614] w-6 h-6 flex justify-center items-center",children:e.jsx("div",{className:"border w-2 h-2 border-solid rotate-45"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Token Price (",r,")"]}),e.jsx("div",{className:"text-md font-bold",children:d.formattedJotPrice})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"rounded-full bg-[#25272614] w-6 h-6 flex justify-center items-center",children:e.jsx("div",{className:"border w-2 h-2 border-solid rotate-45"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Withdrawal amount (",r,")"]}),e.jsx("div",{className:"text-md font-bold",children:d.totalJotPrice})]})]})]}),e.jsx(Be,{}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsxs("span",{className:"text-md font-bold",children:["Total (",r,")"]}),e.jsx("span",{className:"font-bold text-lg text-[#117B37]",children:d.totalwithdraw})]})]})]})}),e.jsxs(ge,{gutter:[16,16],style:{padding:"12px 24px"},children:[e.jsx(ue,{xs:24,lg:24,children:e.jsx("div",{className:"text-md font-bold",children:"Epoch History"})}),e.jsx(ue,{xs:24,lg:24,children:e.jsx(ot,{columns:K,dataSource:o||[],loading:f,bodyStyle:{cursor:"pointer",overflowX:"auto"},pagination:!1,size:"middle",rowKey:W=>W.id})})]})]})}function El(){const{isLoadingNote:t}=ce();return e.jsx(At,{defaultActiveKey:["issue_note"],children:e.jsx(e.Fragment,{children:!t&&e.jsx(Dl,{})})})}const Ll=function({pool:t,visible:s,onClose:n}){const{address:r}=nt(),{notification:o}=Ae.useApp(),[i,l]=a.useState(null),[c,d]=a.useState(!0),u=t.id,[p,h]=a.useState(!1),[g,v]=Qn(),[f,j]=a.useState(""),[M,y]=a.useState(),C=async()=>{d(!0);try{const x=await te.getVaultLinkedWallet(u);l(x.walletAddress)}catch(x){console.log(x)}d(!1)},S=async()=>{h(!0);try{const{walletAddress:x}=await ht.getLinkedWallet();if(r!=new bs().utils.toChecksumAddress(x))return h(!1),o.error({message:"Invalid wallet address.",description:`Please connect to wallet ${x}`});const D=await zt(t.vaultContractAddress),{transactionHash:_}=await D.methods.setRemoteSafeAddress(M,f).send({from:x,maxPriorityFeePerGas:null,maxFeePerGas:null}),T=await Mt(te.getVaultWalletByTx,[_],3e3);n()}catch(x){console.log("link pool wallet failed: ",x)}h(!1)};Zt(()=>C());const E={header:{backgroundColor:"transparent"},content:{borderRadius:24,backgroundColor:"#F0F0F0"}},{chains:m}=Xa();return e.jsx(fe,{onCancel:n,footer:null,centered:!0,width:"35vw",open:s,title:e.jsx("span",{className:"text-lg bg-tr",children:"Link remote wallet"}),style:{minWidth:500},styles:E,children:e.jsx("div",{className:"w-full pt-8",children:c?e.jsx(Re,{active:!0}):i?e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium my-2 text-[#393C3A]",children:"Linked wallet address"}),e.jsx(De,{className:"mb-4",value:i,disabled:!0,"data-testid":"pool-link-wallet-token",suffix:e.jsx(it,{title:i===g.value?"Copied":"Copy",onClick:()=>{v(i.toString())},children:e.jsx("div",{className:"rounded-2xl bg-[#25272614] py-1 px-3 cursor-pointer",children:"Copy"})})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs font-medium mb-2 text-[#393C3A]",children:"Linked wallet address"}),e.jsx("div",{className:"mb-4",children:e.jsxs(F,{children:[e.jsx(F.Item,{name:"poolWallet",rules:[()=>({validator(x,D){return!D||It(D)?Promise.resolve():Promise.reject(new Error("Invalid wallet address"))}})],children:e.jsx(De,{value:f,placeholder:"Enter pool's wallet",onChange:x=>j(x.target.value),"data-testid":"pool-link-wallet-input",suffix:e.jsx(it,{title:f===g.value?"Copied":"Copy",onClick:()=>{v(f.toString())},children:e.jsx("div",{className:"rounded-2xl bg-[#25272614] py-1 px-3 cursor-pointer",children:"Copy"})})})}),e.jsx("div",{className:"text-xs font-medium mb-2 text-[#393C3A]",children:"Chain"}),e.jsx(F.Item,{className:"mb-4",children:e.jsx(re,{type:"select",style:{width:"100%"},value:M,showSearch:!0,id:"currency",placeholder:"Chain ID",onChange:x=>{y(x)},children:m.map(x=>e.jsx(Option,{value:x.id,children:x.name+" ("+x.id+")"},x.id))})})]})}),e.jsx("div",{children:e.jsx(U,{className:"shadow-none h-10 mt-2",type:"primary",block:!0,disabled:!f||!M,onClick:()=>S(),loading:p,"data-testid":"pool-link-wallet-button",children:"Link wallet"})})]})})})},Ml="0x0000000000000000000000000000000000000000",Nt=t=>t==Ml,Pl=function({pool:t,visible:s,onClose:n}){const{address:r,connector:o}=nt(),{notification:i}=Ae.useApp(),[l,c]=a.useState(!0),[d,u]=a.useState(!1),[p,h]=a.useState(!0),[g,v]=a.useState(!0),[f,j]=a.useState(!1),[M,y]=a.useState(!1),[C,S]=a.useState(!1),[E,m]=a.useState([]),[x,D]=a.useState(),[_,T]=a.useState(),[w,A]=a.useState(),[O,P]=a.useState(),[V,b]=a.useState(),R=async()=>{try{c(!0);const B=await Me.getVaultModules(t);!Nt(B[0])&&D(B[0]),!Nt(B[1])&&T(B[1]),!Nt(B[2])&&A(B[2]),!Nt(B[3])&&P(B[3]),!Nt(B[4])&&b(B[4]),c(!1)}catch(B){console.log(B)}},q=async()=>{u(!0);try{if(r!=new bs().utils.toChecksumAddress(t.safeWalletAddress))return u(!1),i.error({message:"Invalid wallet address.",description:`Please connect to wallet ${t.safeWalletAddress}`});const N=tn([g?1:null,f?2:null,M?3:null,C?4:null]);if(!Ye(N)){const le=await(await wn()).send("newModule",[t.vaultContractAddress,N]),me=await Me.waitForTransactionReceipt(le,o.id);console.log("createNewVaultModal.tsx - createModulesTransactionReceipt"),console.log(me);const W=me.logs.filter(k=>k.address==js.contracts.ModuleFactory.toLowerCase()).map(k=>Zn.eth.abi.decodeLog([{indexed:!1,internalType:"address",name:"module",type:"address"},{indexed:!1,internalType:"uint256",name:"moduleType",type:"uint256"},{indexed:!1,internalType:"uint256",name:"timestamp",type:"uint256"}],k.data,k.topics.slice(1))).map(k=>k.module),Q=await Cn(t.vaultContractAddress);if(p){const k=await Q.send("enableAsyncWithdraw",[]),be=await Me.waitForTransactionReceipt(k,o.id)}const z=await Q.send("setModules",[W,N]),oe=await Me.waitForTransactionReceipt(z,o.id);m(N),await te.createNewVault(t.id,{kycRequired:N.includes(2)}),await R()}}catch(B){console.log("link pool wallet failed: ",B)}u(!1)};Zt(()=>R());const K={header:{backgroundColor:"transparent"},content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(fe,{onCancel:n,footer:null,centered:!0,width:"43vw",open:s,title:e.jsx("span",{className:"text-lg bg-tr",children:"Deploy vault modules"}),style:{minWidth:500},styles:K,children:e.jsx("div",{className:"w-full pt-8",children:l?e.jsx(Re,{active:!0}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-4",children:e.jsx(F,{children:e.jsxs(en,{label:"",className:"mb-4",children:[e.jsxs("div",{className:"w-full my-1 flex justify-between",children:[e.jsx(Ze,{checked:p,onChange:B=>h(B.target.checked),children:"Asynchronous withdrawal"}),e.jsx("span",{className:"self-end",children:x})]}),e.jsxs("div",{className:"w-full my-1 flex justify-between",children:[e.jsx(Ze,{checked:g,onChange:B=>v(B.target.checked),children:"Valuation"}),e.jsx("span",{className:"self-end",children:_})]}),e.jsxs("div",{className:"w-full my-1 flex justify-between",children:[e.jsx(Ze,{checked:f,onChange:B=>j(B.target.checked),children:"Authentication"}),e.jsx("span",{className:"self-end",children:w})]}),e.jsxs("div",{className:"w-full my-1 flex justify-between",children:[e.jsx(Ze,{checked:M,onChange:B=>y(B.target.checked),children:"Fees"}),e.jsx("span",{className:"self-end",children:O})]}),e.jsxs("div",{className:"w-full my-1 flex justify-between",children:[e.jsx(Ze,{checked:C,onChange:B=>S(B.target.checked),children:"Cross chain deposit"}),e.jsx("span",{className:"self-end",children:V})]})]})})}),e.jsx("div",{className:"w-full flex justify-end",children:e.jsx(U,{className:"px-4 shadow-none w-40 h-12",type:"primary",disabled:!1,onClick:()=>q(),loading:d,"data-testid":"pool-link-wallet-button",children:"Add Modules"})}),e.jsx("div",{className:"w-full flex justify-end mt-3",children:e.jsx(Zs,{className:"w-fit",message:"Connect value's safe to add modules to vault",type:"info",showIcon:!0})})]})})})},Gs=0,Fl=1,Ol=function({pool:t,visible:s,onClose:n}){const{address:r}=nt(),{isPoolAdmin:o}=Je(y=>y),[i,l]=a.useState(!1),[c,d]=a.useState(!1),[u,p]=a.useState([]),[h,g]=a.useState(Gs),{assets:v,reloadPoolAssets:f}=ce(),j=async()=>{if(!o)return Ke.error({message:"Invalid wallet address",description:"The linked wallet has no POOL_ADMIN role"});const{walletAddress:y}=await ht.getLinkedWallet();if(String(r).toLowerCase()!==String(y).toLowerCase())return Ke.error({message:"Invalid wallet address",description:`Please connect to wallet: ${y} to proceed`});d(!0);try{await $t.setScorecardsToContract(t.poolContractAddress,u,r),Ke.success({message:"Success",description:"Updated scorecards successfully"}),g(Fl)}catch(C){console.error("Error update scorecards",C),Ke.error({message:"Error",description:"Something wrong. Unable to update scorecards"})}d(!1)},M=async()=>{if(!o)return Ke.error({message:"Invalid wallet address",description:"The linked wallet has no POOL_ADMIN role"});const{walletAddress:y}=await ht.getLinkedWallet();if(String(r).toLowerCase()!==String(y).toLowerCase())return Ke.error({message:"Invalid wallet address",description:`Please connect to wallet: ${y} to proceed`});d(!0);try{const C=sn(v,10);for(const S of C)await $t.updateBatchAssetRiskScore(t.poolContractAddress,S.map(E=>E.tokenId),r);Ke.success({message:"Success",description:"Updated all assets successfully"}),window.location.reload()}catch(C){console.error("Error update scorecards",C),Ke.error({message:"Error",description:"Something wrong. Unable to update scorecards"})}d(!1)};return a.useEffect(()=>{const y=async()=>{l(!0);try{const C=await $t.getScorecards(t.id);p(C.map(S=>({...S,isNewest:!0})))}catch(C){console.error(C)}l(!1)};t.id&&y()},[t.id]),e.jsx(fe,{onCancel:n,footer:null,title:"Risk score",centered:!0,width:"fit-content",open:s,style:{top:0,minWidth:900,paddingBottom:0},children:e.jsxs("div",{children:[e.jsx(Xn,{editable:!0,scorecards:u,isLoading:i,setScorecards:p}),e.jsxs("div",{className:"w-full flex items-center flex-col mt-4 gap-4",children:[e.jsx("label",{style:{fontSize:14,color:"#070A0E"},children:"Please review the scorecard carefully before updating!"}),e.jsxs("div",{style:{display:"flex",gap:"12px",width:"360px"},children:[e.jsx(U,{onClick:n,type:"secondary",style:{width:"100%"},children:"Close"}),h==Gs?e.jsx(U,{disabled:i||u.length===0,loading:c,onClick:j,type:"primary",style:{width:"100%"},children:"Update"}):e.jsx(U,{disabled:i||u.length===0,loading:c,onClick:M,type:"primary",style:{width:"100%"},children:"Update asset risk score"})]})]})]})})},Rl=An.abi,Vl=({pool:t,visible:s,onClose:n})=>{const{address:r}=nt(),{notification:o}=Ae.useApp(),[i,l]=a.useState(""),[c,d]=a.useState(!1),[u,p]=a.useState(!1),[h,g]=a.useState(0),[v,f]=a.useState(0),[j,M]=a.useState(null),[y,C]=a.useState(-1),S=async(D,_)=>{const T=await yn(),w=new T.eth.Contract(Rl,D.currency.tokenAddress),{balanceOf:A,allowance:O,decimals:P}=w.methods,V=await Promise.all([A(_).call(),P().call()]);let{[0]:b,[1]:R}=V;R=new he(R).toNumber();const q=new he(b).div(Math.pow(10,R)).toNumber();C(R),g(+q);const K=await O(_,D.poolContractAddress).call();f(pe(K.toString()/10**R,R)),p(K>0),M(w)},E=async()=>{if(y===-1)return;if((r==null?void 0:r.toLowerCase())!==i.toLowerCase())return o.error({message:"Invalid wallet address.",description:`Please connect to wallet ${i}`,style:{width:"calc(100% + 20px)"}});d(!0);const D=+v*Math.pow(10,y);try{await j.methods.approve(t.poolContractAddress,D.toLocaleString("fullwide",{useGrouping:!1})).send({from:i,maxPriorityFeePerGas:null,maxFeePerGas:null}),o.success({message:"Approved spend reserve successfully"})}catch(_){console.error(_),o.error({message:"Approve failed",description:_.message})}finally{d(!1),n()}};Zt(async()=>{const{walletAddress:D}=await te.getPoolLinkedWallet(t.id);l(D)}),a.useEffect(()=>{t&&!Ye(i)&&S(t,i).catch(console.log)},[t,i]);const m=t==null?void 0:t.currency.shortCode,x={header:{backgroundColor:"transparent"},content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(fe,{onCancel:n,footer:null,centered:!0,width:"35vw",open:s,title:e.jsx("span",{className:"text-lg bg-tr",children:"Manage reserve"}),style:{minWidth:500},styles:x,children:e.jsxs("div",{className:"mt-6",children:[e.jsxs(F,{wrapperCol:{span:24},labelCol:{span:24},children:[e.jsx(F.Item,{label:"External wallet address",children:e.jsx(De,{value:i,readOnly:!0,disabled:!0})}),e.jsx(F.Item,{label:"Approved spend amount",children:e.jsxs(Hs.Compact,{className:"w-full",children:[e.jsx(De,{rootClassName:"w-full",className:"w-full",placeholder:"0",value:v,type:"number",onChange:D=>f(Math.min(+D.target.value,h))}),e.jsx(at,{style:{width:"20%"},onMouseUp:D=>{D.stopPropagation()},bordered:!0,suffixIcon:e.jsx(ea,{style:{color:"black"},color:"black"}),value:m,disabled:!1,children:e.jsx(at.Option,{value:m,children:m})}),e.jsx(U,{className:"!rounded-r-md shadow-none text-center flex items-center text-xs",type:"primary",onClick:()=>f(h),children:"MAX"})]})})]}),e.jsx("div",{className:"w-full mt-8",children:e.jsx(U,{className:"shadow-none h-10",loading:c,disabled:!j,onClick:()=>E(),type:"primary",style:{width:"100%",marginBottom:20},children:"Submit"})})]})})},Ul=({pool:t,visible:s,onClose:n,reloadPool:r})=>{const{message:o}=Ae.useApp(),[i,l]=a.useState(!1),[c,d]=a.useState(t.uploadAssetLegalDocumentId),[u]=qe(se.getLegalVaultList,t.id,_e.category.LEGAL,_e.SIGNED);return e.jsx(fe,{onCancel:n,footer:null,width:"fit-content",open:s,centered:!0,style:{top:0,minWidth:500,paddingBottom:0},children:e.jsxs("div",{style:{width:500,margin:"0 auto",marginTop:20},children:[e.jsx("div",{children:"Originator"}),e.jsx(Te,{style:{width:"100%",marginTop:20},placeholder:"Legal document",items:u,dateKey:"createdAt",nameKey:"name",selectedValue:c,onSelect:p=>d(p)}),e.jsx("div",{style:{width:"100%",marginTop:20},children:e.jsx(U,{loading:i,disabled:!1,onClick:async()=>{l(!0);try{await te.updateUploadCollateralDocId(t.id,{uploadAssetLegalDocumentId:c}),r(),n(),o.success("Pool is updated succesfully")}catch(p){console.log(p)}finally{l(!1)}},type:"primary",style:{width:"100%",marginBottom:20},children:"Submit"})})]})})},Bl=function({visible:t,onClose:s}){var M;const{notification:n}=Ae.useApp(),{pool:r,reloadPool:o,poolData:i}=ce(),{isPoolAdmin:l}=Je(y=>y),{address:c}=nt(),d=r.currency.decimals,u=a.useMemo(()=>new he(r.debtCeiling).div(10**d).toNumber(),[r.debtCeiling]),[p,h]=a.useState(u),[g,v]=a.useState(!1),f=async(y,C)=>{try{v(!0);const{walletAddress:S}=await ht.getLinkedWallet();if(String(c).toLowerCase()!==String(S).toLowerCase())throw new Error(`Current wallet address is not valid. Please connect to wallet ${S}`);if(!l)throw new Error("Current wallet address does not have permission to create pool");const E=await Qt(r.poolContractAddress);if(y.debtCeiling){if(Number(y.debtCeiling)<0)throw new Error("Debt Ceiling must be greater than 0");const m=pe(y.debtCeiling*10**r.currency.decimals).toLocaleString("fullwide",{useGrouping:!1}),x=await E.methods.setDebtCeiling(m).send({from:c,maxPriorityFeePerGas:null,maxFeePerGas:null});console.log("--->debtCeiling",m,x),await Mt(te.getUpdateDebtCeilingByTx,[x.transactionHash],3e3)}C&&C(),o(),s(),n.success({message:"Pool parameter updated successfully!"})}catch(S){n.error({message:S.message||"Something went wrong"})}v(!1)},j={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(fe,{onCancel:s,footer:null,width:"35vw",centered:!0,style:{minWidth:410},open:t,styles:j,children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-lg mb-6",children:"Edit target value of debt ceiling"}),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2",children:"Target Value"}),e.jsx("div",{children:e.jsx(Oe,{className:"w-full",min:0,value:p,placeholder:"Enter number",onChange:y=>h(y),suffix:(M=r==null?void 0:r.currency)==null?void 0:M.shortCode,disabled:!l,type:"number"})}),e.jsx("div",{className:"mt-8",children:e.jsx(U,{className:"shadow-none w-full mb-1 h-10",type:"primary",onClick:()=>f({debtCeiling:p}),disabled:p==u||!p||!l||p<=0,loading:g,children:"Save"})})]})]})})},_l=({isVisible:t,onClose:s})=>{const{notification:n}=Ae.useApp(),{pool:r,reloadPool:o}=ce(),[i,l]=a.useState(!1),[c,d]=a.useState({});a.useEffect(()=>{t&&d({...r,id:r.id,name:r.name,shortDescription:r.shortDescription||"",paragraphSummary:r.paragraphSummary||"",creatorCompanyId:r.creatorCompanyId,poolProfilePhoto:r.poolProfilePhoto})},[t,r]);const u=async()=>{try{l(!0);const h={...c,name:c.name,shortDescription:c.shortDescription,paragraphSummary:c.paragraphSummary};await te.updateVault(c.id,h),l(!1),s(!1),Le.success("Update pool successfully"),o()}catch(h){return console.error(h),n.error({message:(h==null?void 0:h.message)||"Something went wrong"})}finally{l(!1)}},p={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(fe,{onCancel:()=>{s(),d({})},footer:null,width:"35vw",centered:!0,open:t,style:{minWidth:500},styles:p,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-lg mb-6",children:"Edit pool information"}),e.jsxs(F,{wrapperCol:{span:24},labelCol:{span:24},children:[e.jsx(F.Item,{label:"Name",className:"mb-4",children:e.jsx(De,{placeholder:"Name",id:"name",value:c.name,onChange:h=>d({...c,name:h.target.value})})}),e.jsx(F.Item,{label:"Pool in words",className:"mb-3",children:e.jsx(De.TextArea,{maxLength:350,style:{height:110},placeholder:"Enter text...",type:"textarea",value:c.shortDescription,onChange:h=>{h.target.value.length<=350&&d({...c,shortDescription:h.target.value})}})}),e.jsxs("div",{style:{float:"right",color:"#858585",marginTop:5},children:[Z(c,"shortDescription.length",0),"/350"]}),e.jsx("div",{style:{clear:"both"}}),e.jsx(F.Item,{label:"Paragraph summary",className:"w-full",children:e.jsx(De.TextArea,{className:"w-full",maxLength:350,style:{height:110},placeholder:"Enter text...",type:"textarea",value:c.paragraphSummary,onChange:h=>{h.target.value.length<=350&&d({...c,paragraphSummary:h.target.value})}})}),e.jsxs("div",{style:{float:"right",color:"#858585",marginBottom:10,marginTop:5},children:[Z(c,"paragraphSummary.length",0),"/350"]})]}),e.jsx("div",{style:{width:"100%",marginTop:20},children:e.jsx(U,{className:"shadow-none h-12",loading:i,disabled:!c.name||!c.shortDescription,onClick:u,type:"primary",style:{width:"100%"},children:"Update"})})]})})},$l=function({visible:t,onClose:s}){const{notification:n}=Ae.useApp(),{pool:r,reloadPool:o,poolData:i}=ce(),{isPoolAdmin:l}=Je(j=>j),{address:c}=nt(),d=a.useMemo(()=>r.minFirstLossCushion/Kt),[u,p]=a.useState(d),[h,g]=a.useState(!1),v=async(j,M)=>{try{g(!0);const{walletAddress:y}=await ht.getLinkedWallet();if(String(c).toLowerCase()!==String(y).toLowerCase())throw new Error(`Current wallet address is not valid. Please connect to wallet ${y}`);if(!l)throw new Error("Current wallet address does not have permission to create pool");const C=await Qt(r.poolContractAddress);if(j.minFirstLossCushion){if(Number(j.minFirstLossCushion)<0||Number(j.minFirstLossCushion)>100)throw new Error("Min First Loss Cushion must be between 0 to 100");const S=pe(j.minFirstLossCushion*Kt).toLocaleString("fullwide",{useGrouping:!1}),E=await C.methods.setMinFirstLossCushion(S).send({from:c,maxPriorityFeePerGas:null,maxFeePerGas:null});console.log("--->minFirstLossCushion",S,E),await Mt(te.getUpdateMinFirstLossByTx,[E.transactionHash],3e3)}M&&M(),o(),s(),n.success({message:"Pool parameter updated successfully!"})}catch(y){n.error({message:y.message||"Something went wrong"})}g(!1)},f={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(fe,{onCancel:s,footer:null,width:"35vw",centered:!0,style:{minWidth:410},open:t,styles:f,children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-lg mb-6",children:"Edit target value of minimum first loss"}),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2",children:"Target Value"}),e.jsx("div",{children:e.jsx(Oe,{className:"w-full",value:u,placeholder:"Enter number",onChange:j=>p(j),min:0,max:100,suffix:"%",disabled:!l,type:"number"})}),e.jsx("div",{className:"mt-8",children:e.jsx(U,{className:"shadow-none w-full mb-1 h-10",type:"primary",onClick:()=>v({minFirstLossCushion:u}),disabled:!l||u==d||!u||u<=0||u>100,loading:h,children:"Save"})})]})]})})},Wl=({setLoadingEditor:t})=>{const{control:s}=bt();return e.jsxs("div",{children:[e.jsx(Ge,{control:s,name:"poolCard.label",render:({field:n})=>e.jsx(F.Item,{label:"Label",children:e.jsx(re,{type:"input",...n,placeholder:"Label"})})}),e.jsx(Ge,{control:s,name:"poolCard.content",render:({field:{value:n,onChange:r}})=>e.jsx(F.Item,{label:"Content",children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Ft,{setLoadingEditor:t,content:n??" ",handleEditorChange:r})})})})]})},Gl=({setLoadingEditor:t})=>{const{control:s}=bt();return e.jsxs("div",{children:[e.jsx(Ge,{control:s,name:"headline.label",render:({field:n})=>e.jsx(F.Item,{label:"Label",children:e.jsx(re,{...n,type:"input",placeholder:"Label"})})}),e.jsx(Ge,{control:s,name:"headline.content",render:({field:{onChange:n,value:r}})=>e.jsx(F.Item,{label:"Content",children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Ft,{setLoadingEditor:t,content:r??" ",handleEditorChange:n})})})})]})},xs=3,Yl=({setLoadingEditor:t})=>{const{control:s}=bt();return e.jsx("div",{children:ta(xs,n=>e.jsxs(Qs.Fragment,{children:[e.jsxs("div",{children:[e.jsx(Ge,{control:s,name:`highlight.${n}.label`,render:({field:r})=>e.jsx(F.Item,{label:`Hightlight Label ${n+1}`,children:e.jsx(re,{type:"input",...r,placeholder:`Hightlight Label ${n+1}`})})}),e.jsx(Ge,{control:s,name:`highlight.${n}.content`,render:({field:{onChange:r,value:o}})=>e.jsx(F.Item,{label:`Highlight Content ${n+1}`,children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Ft,{setLoadingEditor:t,content:o??" ",handleEditorChange:r})})})})]}),n!==xs-1&&e.jsx(Be,{})]},n))})},Kl=()=>{const{control:t}=bt();return e.jsxs("div",{children:[e.jsx(Ge,{control:t,name:"summary.label",render:({field:s})=>e.jsx(F.Item,{label:"Label",children:e.jsx(re,{...s,type:"input",placeholder:"Label"})})}),e.jsx(Ge,{control:t,name:"summary.link",render:({field:s})=>e.jsx(F.Item,{label:"Link",children:e.jsx(re,{...s,type:"input",placeholder:"Link"})})})]})},Hl=({pool:t,isMigration:s,setLoadingEditor:n})=>{const{control:r}=bt(),o=t==null?void 0:t.id,[i,l]=qe(te.getPoolList);return l?e.jsx(Re,{active:!0}):e.jsxs("div",{children:[e.jsx(Ge,{control:r,name:"migration.label",render:({field:c})=>e.jsx(F.Item,{label:"Label",children:e.jsx(re,{...c,type:"input",placeholder:"Label"})})}),e.jsx(Ge,{control:r,name:"migration.content",render:({field:{value:c,onChange:d}})=>e.jsx(F.Item,{label:"Content",children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Ft,{setLoadingEditor:n,content:c??" ",handleEditorChange:d})})})}),s?e.jsx(Ge,{control:r,name:"migration.toPoolId",render:({field:c})=>{var u,p;const d=(p=(u=i??[])==null?void 0:u.filter(h=>h.id!==o))==null?void 0:p.map(h=>({value:String(h.id),text:h.name}));return e.jsx(F.Item,{label:"Migrate to pool",children:e.jsx(an,{...c,value:c.value?String(c.value):"",dropdownMatchSelectWidth:!0,dataSource:d??[]})})}}):e.jsxs(e.Fragment,{children:[e.jsx(Ge,{control:r,name:"migration.actionLabel",render:({field:c})=>e.jsx(F.Item,{label:"Label",children:e.jsx(re,{...c,type:"input",placeholder:"Action Label"})})}),e.jsx(Ge,{control:r,name:"migration.actionLink",render:({field:c})=>e.jsx(F.Item,{label:"Link",children:e.jsx(re,{...c,type:"input",placeholder:"Action link"})})})]})]})},ql=({setLoadingEditor:t})=>{const{control:s}=bt();return e.jsx("div",{children:e.jsx(Ge,{control:s,name:"apr.content",render:({field:{value:n,onChange:r}})=>e.jsx(F.Item,{label:"Content",children:e.jsx("div",{className:"h-[200px] block",children:e.jsx(Ft,{setLoadingEditor:t,content:n??" ",handleEditorChange:r})})})})})},Jl=()=>{const{control:t}=bt();return e.jsxs("div",{children:[e.jsx(Ge,{control:t,name:"asset.label",render:({field:s})=>e.jsx(F.Item,{label:"Label",children:e.jsx(re,{...s,type:"input",placeholder:"Label"})})}),e.jsx(Ge,{control:t,name:"asset.link",render:({field:s})=>e.jsx(F.Item,{label:"Link",children:e.jsx(re,{...s,type:"input",placeholder:"Link"})})})]})},zl=({visible:t,onClose:s,reloadPool:n})=>{const{notification:r}=Ae.useApp(),{pool:o}=ce(),[i,l]=a.useState(!1),[c,d]=a.useState(null),[u,p]=a.useState(!0),h=Wn({defaultValues:{poolCard:null,headline:null,highlight:null,summary:null,migration:null,apr:null,asset:null}}),{handleSubmit:g,reset:v,getValues:f}=h,{value:j,loading:M,retry:y}=ia(async()=>{var x,D,_,T,w,A,O,P;if(!(o!=null&&o.id))return;const{data:m}=await te.getVaultMigration(o.id);return m!=null&&m.poolNotification&&(v({poolCard:{...(x=m.poolNotification)==null?void 0:x.poolCard},headline:{...(D=m.poolNotification)==null?void 0:D.headline},highlight:ta(xs,V=>{var b,R;return{...(R=(b=m.poolNotification)==null?void 0:b.highlight)==null?void 0:R[V],content_ref:f(`highlight.${V}.content_ref`)}}),summary:(_=m.poolNotification)==null?void 0:_.summary,migration:{...(T=m.poolNotification)==null?void 0:T.migration},apr:{...(w=m.poolNotification)==null?void 0:w.apr},asset:(A=m.poolNotification)==null?void 0:A.asset},{keepValues:!1}),(P=(O=m.poolNotification)==null?void 0:O.migration)!=null&&P.toPoolId&&l(!0)),m.poolNotification},[o==null?void 0:o.id]),C=!!j,S={defaultValue:j,pool:o,isMigration:i},E=a.useMemo(()=>g(async m=>{var T,w,A,O,P,V,b,R,q,K,B,N;if(!c)return;const{key:x,type:D}=c,_={vaultId:o==null?void 0:o.id,highlight:nn(m==null?void 0:m.highlight,J=>({label:J==null?void 0:J.label,content:(J==null?void 0:J.content)??null})),poolCard:{label:((T=m==null?void 0:m.poolCard)==null?void 0:T.label)??null,content:((w=m==null?void 0:m.poolCard)==null?void 0:w.content)??null},summary:m.summary,headline:{label:((A=m==null?void 0:m.headline)==null?void 0:A.label)??null,content:((O=m==null?void 0:m.headline)==null?void 0:O.content)??null},migration:{label:(P=m==null?void 0:m.migration)==null?void 0:P.label,content:((V=m==null?void 0:m.migration)==null?void 0:V.content)??null,...i?{toPoolId:(b=m==null?void 0:m.migration)!=null&&b.toPoolId?+((R=m==null?void 0:m.migration)==null?void 0:R.toPoolId):null}:{actionLabel:(q=m==null?void 0:m.migration)==null?void 0:q.actionLabel,actionLink:(K=m==null?void 0:m.migration)==null?void 0:K.actionLink}},apr:{content:((B=m==null?void 0:m.apr)==null?void 0:B.content)??null},asset:m.asset};if(C&&(j!=null&&j.id)){let J=_[x];D==="deleted"?J=null:D==="published"?J={...J,published:{...J}}:J={...J,...((N=j==null?void 0:j[x])==null?void 0:N.published)&&{published:{...j[x].published}}},await te.updatePoolMigration(j.id,{[x]:J})}else await te.createPoolMigration(_);r.success({message:"Success",description:`${rn(x)}'s contents have been ${D}`}),y()}),[c,g,C,i,o==null?void 0:o.id,y,j]);return e.jsxs(fe,{onCancel:()=>{s()},footer:null,width:"fit-content",centered:!0,open:t,title:C?"Edit Notification":"Create Notification",classNames:{header:"font-medium text-lg",body:"max-h-[700px] overflow-y-auto"},children:[M&&!j&&e.jsx(Re,{active:!0}),e.jsx(Gn,{...h,children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(F,{layout:"vertical",onFinish:E,children:[{Component:Wl,key:"poolCard",header:"Pool Card"},{Component:Gl,key:"headline",header:"Headline"},{Component:Yl,key:"highlight",header:"Highlight"},{Component:Kl,key:"summary",header:"Excutive Summary"},{Component:Hl,key:"migration",header:e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{display:"inline-block",width:100},children:i?"Migration":"Promo"}),e.jsx(zs,{size:"small",checked:i,onChange:(m,x)=>{x.stopPropagation(),x.preventDefault(),l(m)}})]})},{Component:ql,header:"Target Return",key:"apr"},{Component:Jl,header:"Collateral",key:"asset"}].map(({Component:m,header:x,key:D})=>e.jsx(Xe,{className:"mb-4 w-[700px]",children:e.jsx(Ys,{defaultActiveKey:[D],className:"bg-white rounded-3xl",accordion:!0,style:{content:"none"},expandIcon:({isActive:_})=>e.jsxs("div",{children:[_?e.jsx(ln,{}):e.jsx(ea,{}),e.jsx("span",{className:"text-sm font-bold ml-2",children:x})]}),collapsible:"icon",expandIconPosition:"start",bordered:!1,items:[{key:D,label:e.jsxs("div",{className:"flex justify-end",children:[e.jsx(U,{htmlType:"submit",type:"link",className:"text-main-green",onClick:_=>{_.stopPropagation(),d({key:D,type:"saved"})},children:"Save as Draft"}),e.jsx(U,{htmlType:"submit",type:"link",className:"text-main-green",onClick:_=>{_.stopPropagation(),d({key:D,type:"published"})},children:"Publish"}),e.jsx(U,{htmlType:"submit",type:"link",danger:!0,onClick:_=>{_.stopPropagation(),d({key:D,type:"deleted"})},children:"Delete"})]}),children:e.jsxs("div",{children:[u&&e.jsx(Re,{loading:!0,active:!0}),e.jsx(m,{...S,setLoadingEditor:p})]})}]})},D))})})})]})},Ql=()=>{const t=gt(),{pool:s}=ce(),[n,r,o]=qe(te.geVaultHolders,s.id),[i,l]=a.useState(!1),c=()=>{l(!0),te.getVaultHoldersExport(s.id.toString()).then(p=>{const h=p.headers["content-disposition"];let g=`holders-${s.id}-${new Date().toISOString()}.csv`;if(h){const M=h.match(/filename="(.+)"/);M.length>1&&(g=M[1])}const v=new Blob([p.data],{type:"text/csv"}),f=document.createElement("a"),j=window.URL.createObjectURL(v);f.href=j,f.download=g,document.body.appendChild(f),f.click(),f.remove(),window.URL.revokeObjectURL(j),l(!1)}).catch(p=>{console.error("Failed to download CSV file",p),Le.error(p.message),l(!1)})},[d,u]=a.useState();return e.jsxs(At,{children:[e.jsx("div",{className:"flex flex-row justify-end",children:e.jsx(U,{icon:e.jsx(on,{onPointerEnterCapture:void 0,onPointerLeaveCapture:void 0}),loading:i,onClick:()=>c(),disabled:!1,children:"Download"})}),e.jsx(er,{data:n==null?void 0:n.map(p=>({...p,key:p.id})),loading:r,fetchInvestors:o,onView:u}),e.jsx(tr,{investor:d,open:!!d,onClose:()=>{u(void 0)},onViewProfile:p=>{t(`/vault-setting/${s.id}/investors/${p==null?void 0:p.address}`)}})]})},Zl=({pool:t,visible:s,onClose:n,reloadPool:r=()=>{}})=>{const{notification:o,message:i}=Ae.useApp(),[l,c]=a.useState(!1),[d,u]=a.useState(),[p,h]=a.useState(),[g,v]=a.useState(),[f,j]=a.useState(),{address:M,connector:y}=nt(),C=a.useMemo(()=>[It(d),It(g),cn(f),f>0].every(Boolean),[d,g,f]),S=async()=>{c(!0);try{await te.addVaultAsset(t.vaultContractAddress,p,d,g,f),n(),r(),i.success("Note issuance has been updated")}catch(m){console.log(m),o.error({message:m.message||"Something went wrong!"})}finally{c(!1)}},E={content:{borderRadius:24,backgroundColor:"#F0F0F0"}};return e.jsx(fe,{onCancel:n,footer:null,width:"20vw",open:s,style:{minWidth:450},styles:E,children:e.jsxs("div",{className:"bg-transparent",children:[e.jsx("p",{className:"font-medium text-lg mb-6",children:"Add asset"}),e.jsxs(F,{wrapperCol:{span:24},labelCol:{span:24},children:[e.jsx(F.Item,{label:"Asset Name",name:"id",className:"mb-2",children:e.jsx(De,{style:{width:"100%"},placeholder:"Enter asset name",value:d,id:"id",onChange:m=>{console.log("addAsset.tsx - e.target.value"),console.log(m.target.value),console.log("Set asset name"),h(m.target.value)}})}),e.jsx(F.Item,{label:"Token Address",name:"vaultSafeWalletAddress",rules:[()=>({validator(m,x){return!x||It(x)?Promise.resolve():Promise.reject(new Error("Invalid wallet address"))}})],className:"mb-2",children:e.jsx(De,{style:{width:"100%"},placeholder:"Enter wallet address",value:d,id:"tokenAddress",onChange:m=>{console.log("addAsset.tsx - e.target.value"),console.log(m.target.value),console.log("addAsset.tsx - 147"),u(m.target.value)}})}),e.jsx(F.Item,{label:"Oracle",name:"oracle",rules:[()=>({validator(m,x){return!x||It(x)?Promise.resolve():Promise.reject(new Error("Invalid wallet address"))}})],className:"mb-2",children:e.jsx(De,{style:{width:"100%"},placeholder:"Enter wallet address",value:g,id:"oracle",onChange:m=>v(m.target.value)})}),e.jsx(F.Item,{label:"Chain ID",className:"mb-2",children:e.jsx(Oe,{type:"number",placeholder:"Chain ID",className:"w-full",min:1,step:1,precision:0,value:f,onChange:m=>j(m)})}),e.jsx("div",{style:{width:"100%",marginTop:30},children:e.jsx(U,{className:"shadow-none w-full mb-4 h-11",loading:l,disabled:!C,onClick:S,type:"primary",children:"Add"})})]})]})})},st={assets:"assets",notes:"notes",settings:"settings",reserve:"reserve",holders:"holders"},Fo=()=>{const{message:t}=Ae.useApp(),s=gt(),n=dn(),[r,o,i]=gn(te.getVaultDetail,{id:n.id}),l={id:1084,createdAt:1727269159e3,updatedAt:1727269159e3,creatorMemberId:"e4f16370-8f4e-11ee-b57a-31a5686de2c9",poolId:6417,templateName:"TAN-Test25091 - filter",isMain:1,assetType:1,originalId:null},c=[],[d,,u]=qe(Ct.getAllAssets,{poolId:n.id,status:[Lt.FINANCED,Lt.PARTIAL_REPAY,Lt.REPAID],isPublicView:!0}),p={poolAddress:"0xde5a7c2981725d927c3d588682ccf2142d3d6218",jotAddress:null,tgeJOTAddress:null,sotAddress:null,tgeSOTAddress:null,createdTimestamp:"1727269052",totalJOTAmount:"0",totalSOTAmount:"0",poolActivities:[],activities:[]},[h,g]=a.useState(!1),[v,f]=a.useState(!1),[j,M]=a.useState([]),[y,C]=a.useState(!1),[S,E]=a.useState(!1),[m,x]=a.useState(!1),[D,_]=a.useState(!1),{calculateDrawdownAmount:T,loading:w,refresh:A}=ar({poolId:n.id}),O=[{id:16538,createdAt:1727269075e3,updatedAt:1727269075e3,name:"A",advanceRate:100,penaltyRate:150,interestRate:17,discountRate:10.01,gracePeriod:15,collectionPeriod:30,writeOffAfterGracePeriod:0,writeOffAfterCollectionPeriod:0,probabilityOfDefault:0,lossGivenDefault:25,poolId:6417,creatorMemberId:null,creatorCompanyId:null,daysPastDue:0,isCutOff:!1,status:1,children:[],isNewest:!0},{id:16539,createdAt:1727269075e3,updatedAt:1727269075e3,name:"B",advanceRate:100,penaltyRate:150,interestRate:17,discountRate:10.01,gracePeriod:15,collectionPeriod:30,writeOffAfterGracePeriod:1.7361,writeOffAfterCollectionPeriod:0,probabilityOfDefault:5,lossGivenDefault:50,poolId:6417,creatorMemberId:null,creatorCompanyId:null,daysPastDue:1,isCutOff:!1,status:1,children:[],isNewest:!0},{id:16540,createdAt:1727269075e3,updatedAt:1727269075e3,name:"C",advanceRate:100,penaltyRate:150,interestRate:17,discountRate:10.01,gracePeriod:15,collectionPeriod:30,writeOffAfterGracePeriod:2.8935,writeOffAfterCollectionPeriod:5.787,probabilityOfDefault:10,lossGivenDefault:50,poolId:6417,creatorMemberId:null,creatorCompanyId:null,daysPastDue:30,isCutOff:!1,status:1,children:[],isNewest:!0},{id:16541,createdAt:1727269075e3,updatedAt:1727269075e3,name:"D",advanceRate:100,penaltyRate:150,interestRate:17,discountRate:10.01,gracePeriod:15,collectionPeriod:30,writeOffAfterGracePeriod:5.787,writeOffAfterCollectionPeriod:11.5741,probabilityOfDefault:20,lossGivenDefault:75,poolId:6417,creatorMemberId:null,creatorCompanyId:null,daysPastDue:60,isCutOff:!1,status:1,children:[],isNewest:!0},{id:16542,createdAt:1727269075e3,updatedAt:1727269075e3,name:"E",advanceRate:100,penaltyRate:150,interestRate:17,discountRate:10.01,gracePeriod:15,collectionPeriod:30,writeOffAfterGracePeriod:11.5741,writeOffAfterCollectionPeriod:11.5741,probabilityOfDefault:40,lossGivenDefault:100,poolId:6417,creatorMemberId:null,creatorCompanyId:null,daysPastDue:90,isCutOff:!1,status:1,children:[],isNewest:!0},{id:16543,createdAt:1727269075e3,updatedAt:1727269075e3,name:"F",advanceRate:0,penaltyRate:150,interestRate:100,discountRate:10.01,gracePeriod:15,collectionPeriod:30,writeOffAfterGracePeriod:11.5741,writeOffAfterCollectionPeriod:11.5741,probabilityOfDefault:100,lossGivenDefault:100,poolId:6417,creatorMemberId:null,creatorCompanyId:null,daysPastDue:365,isCutOff:!1,status:1,children:[],isNewest:!0}],P=a.useMemo(()=>({...r,assets:d,poolEvents:c,mainFilterTemplate:l}),[r,d]),V=a.useCallback(()=>{_(!0),Promise.all([i()]).then(()=>_(!1))},[i,u,A]),[b,R]=a.useState(!1),[q,K]=a.useState(!1),[B,N]=a.useState(!1),[J,le]=a.useState(void 0),[me,ye]=a.useState(!1),[W,Q]=a.useState(!1),[z,oe]=a.useState(!1),[k,be]=a.useState(!1),[$e,Se]=a.useState(!1),[Pe,L]=a.useState(!1),[G,$]=a.useState(!1),[ee,ae]=a.useState(!1),[ie,H]=a.useState(!1),je=a.useCallback(async()=>{const Ie=await sa.getCountries();M(Ie)},[]);a.useEffect(()=>{je()},[je]);const de=a.useCallback(Ie=>{s(`/vault-setting/${n.id}/${Ie}`)},[n.id]),Fe=a.useCallback(async()=>{await te.closeVault(P.id),s("/vault"),t.success("Vault has been closed")},[P.id]),Ve=a.useCallback(async()=>{await te.openVault(P.id),V(),t.success("Vault has been opened")},[P.id,V]),Ne=n.tab||st.settings,Ue=d,Y=!P.id||o||D||w,[Ce,et]=a.useState({});return a.useEffect(()=>{(async()=>{if(P.id)try{const Ie=await Sn(P.vaultContractAddress),dt=bn(Ie);et(dt)}catch(Ie){console.log("error get poolInfo: ",Ie)}})()},[P]),e.jsxs(ua.Provider,{value:{poolHistories:p,pool:P,poolEvents:c,note:c.length?c[c.length-1]:{},isLoadingNote:!c,assets:Ue,reloadPoolAssets:u,tab:Ne,setTab:de,closePool:Fe,openPool:Ve,securityModalVisible:b,setSecurityModalVisible:R,noteUpdateVisible:J,setNoteUpdateVisible:le,addAssetVisible:me,setAddAssetVisible:ye,poolSweepVisible:h,setPoolSweepVisible:g,epochSettingVisible:v,setEpochSettingVisible:f,bankAccountModalVisible:q,setBankAccountModalVisible:K,addModulesModalVisible:B,setAddModulesModalVisible:N,isUpdatingAssets:y,setUpdatingAssets:C,isShowUploadModal:W,setShowUploadModal:Q,isRepaymentModalVisible:S,setRepaymentModalVisible:E,poolUpdateVisible:z,setPoolUpdateVisible:oe,isPoolParametersModalVisible:k,setPoolParametersModalVisible:be,isPoolParameterMinFirstLossModalVisible:$e,setPoolParameterMinFirstLossModalVisible:Se,reloadPool:V,poolDrawDownVisible:m,setDrawDownVisible:x,isRiskScorecardModalVisible:Pe,setRiskScorecardModalVisible:L,isNotiModalVisible:G,setNotiModalVisible:$,draftingDocModalVisible:ee,setDraftingDocModalVisible:ae,isEditPoolModalVisible:ie,setEditPoolModalVisible:H,poolData:Ce,calculateDrawdownAmount:T,scorecards:O},children:[P&&e.jsx(sr,{chainId:P.chainId}),e.jsx(ge,{children:e.jsxs(ue,{lg:{span:20,offset:2},children:[Y&&e.jsx(Re,{active:!0,loading:!0}),!Y&&e.jsx(e.Fragment,{children:e.jsxs("div",{children:[e.jsx(or,{}),e.jsx(pr,{}),Ne===st.notes&&e.jsx(mr,{}),Ne===st.settings&&e.jsx(Xr,{}),Ne===st.reserve&&e.jsx(El,{}),Ne===st.assets&&e.jsx(Vr,{}),Ne===st.holders&&e.jsx(Ql,{})]})})]})}),v&&e.jsx(el,{pool:P,visible:v,onClose:()=>f(!1)}),W&&e.jsx(Cl,{onClose:()=>{Q(!1)},isOpen:!0,isUpdatingAssets:y,countries:j,reloadPool:V}),S&&e.jsx(Yn,{isVisible:S,setVisible:E,reloadPool:V}),m&&e.jsx(rl,{isOpen:m,onClose:()=>{x(!1)}}),!!J&&e.jsx(Il,{pool:P,noteType:J,visible:!!J,poolEvent:P.poolEvents[0],onClose:()=>le(!1),reloadPool:V}),me&&e.jsx(Zl,{pool:P,visible:me,onClose:()=>ye(!1),reloadPool:V}),b&&e.jsx(Nl,{pool:P,visible:b,onClose:()=>R(!1),reloadPool:V}),q&&e.jsx(Ll,{pool:P,visible:q,onClose:()=>K(!1)}),B&&e.jsx(Pl,{pool:P,visible:B,onClose:()=>N(!1)}),h&&e.jsx(Vl,{pool:P,visible:h,onClose:()=>g(!1)}),Pe&&e.jsx(Ol,{visible:Pe,pool:P,onClose:()=>L(!1)}),z&&e.jsx(Ul,{pool:P,visible:z,onClose:()=>oe(!1),reloadPool:V}),k&&e.jsx(Bl,{visible:k,onClose:()=>be(!1)}),$e&&e.jsx($l,{visible:$e,onClose:()=>Se(!1)}),e.jsx(_l,{isVisible:ie,onClose:()=>{H(!1)}}),G&&e.jsx(zl,{visible:G,onClose:()=>$(!1),reloadPool:V})]})};export{st as Tab,Fo as default};
